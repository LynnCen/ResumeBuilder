# RFC 16: SSR é‰´æƒæµç¨‹æ ‡å‡†åŒ–æè®®

> **æ–‡æ¡£æ¥æº**  
> Confluence: https://doc.huanleguang.com/pages/viewpage.action?pageId=415244577

---

## æ–‡æ¡£æ¦‚è¿°

æœ¬ RFC æå‡ºäº† **SSR åœºæ™¯ä¸‹é¡µé¢çº§é‰´æƒæµç¨‹çš„æ ‡å‡†åŒ–æ–¹æ¡ˆ**ï¼Œé€šè¿‡è¡Œä¸šé€šç”¨çš„è®¤è¯æµç¨‹æ¥æé«˜ç«™ç‚¹çš„å¯ç”¨æ€§å’Œç¨³å®šæ€§ã€‚

**æ ¸å¿ƒç›®æ ‡**ï¼š
- ğŸ¯ ç»Ÿä¸€ SSR é‰´æƒæµç¨‹
- ğŸ”’ è§£å†³æ°´åˆå¤±è´¥é—®é¢˜
- ğŸš« é¿å…ç¼“å­˜æ±¡æŸ“
- âœ… ç¬¦åˆ HTTP è¯­ä¹‰
- ğŸŒ è·¨ç«¯ä¸€è‡´ä½“éªŒ

**çŠ¶æ€**ï¼š
- âœ… ä¸åŸºå»ºå›¢é˜Ÿè¾¾æˆå…±è¯†
- âœ… ä¸ä¸šåŠ¡ç›¸å…³å›¢é˜Ÿè¾¾æˆå…±è¯†
- âœ… è¾“å‡ºæ’æœŸ
- âœ… è¾“å‡º PR
- âœ… å·²ä¸Šçº¿

**ç›¸å…³é“¾æ¥**ï¼š
- [ä¼šè®®æ²Ÿé€šå¤‡å¿˜å½•](https://doc.huanleguang.com/wiki/pages/viewpage.action?pageId=415262669)
- [æ’æœŸè®¡åˆ’](https://pingcode.intra.gaoding.com/pjm/projects/SREJC/backlog/652692bfa5244157b8845984)

---

## ä¸€ã€ä»‹ç»

### 1.1 æ–‡æ¡£èŒƒå›´

**æœ¬ RFC æ¶µç›–**ï¼š
- âœ… é¡µé¢çº§çš„é‰´æƒæµç¨‹
- âœ… SSR ç¯å¢ƒä¸‹çš„è®¤è¯å¤„ç†
- âœ… æµè§ˆå™¨ã€App WebView çš„ç»Ÿä¸€æ–¹æ¡ˆ

**ä¸åœ¨èŒƒå›´å†…**ï¼š
- âŒ API çš„é‰´æƒï¼ˆAPI æœ‰ç‹¬ç«‹çš„é‰´æƒæœºåˆ¶ï¼‰
- âŒ å¾®æœåŠ¡é—´çš„è®¤è¯
- âŒ å…·ä½“çš„ Token æ ¼å¼è®¾è®¡

### 1.2 å†å²èƒŒæ™¯

**æ—©æœŸå°è¯•**ï¼š
- å¤šä¸ªæŠ€æœ¯æ–‡æ¡£æˆ– PR æ¶‰åŠè¿‡è¿™ä¸ªé—®é¢˜
- å› ä¸ºå„ç§åŸå› æ²¡æœ‰ç»§ç»­æ¨è¿›
- å½“åˆçš„ä¸€äº›ç»“è®ºä¹Ÿä¸¢å¤±äº†

**ç°åœ¨**ï¼š
- âœ… SSR å·²æˆä¸ºä¸»æµæ¶æ„
- âœ… æŠ€æœ¯æ ˆæ›´åŠ æˆç†Ÿ
- âœ… ä¸šåŠ¡åœºæ™¯æ›´åŠ æ¸…æ™°
- âœ… æ˜¯æ—¶å€™æ ‡å‡†åŒ–äº†

---

## äºŒã€åŠ¨æœº

### 2.1 æ ¸å¿ƒé—®é¢˜

**èƒŒæ™¯**ï¼š
- å¦‚ä»Šæˆ‘ä»¬å·²ç»æ˜¯ **SSR ä¼˜å…ˆ**çš„ç½‘ç«™æ¶æ„
- ä½†ç•™ä¸‹äº†ä¸€ä¸ªæ¨¡ç³Šçš„é—®é¢˜ï¼š**SSR åº”å½“å¦‚ä½•å¤„ç†è®¤è¯å¤±è´¥çš„æƒ…å†µï¼Ÿ**

### 2.2 ç°çŠ¶åˆ†æ

**å½“å‰ç­–ç•¥**ï¼š

```
SSR é˜¶æ®µè®¤è¯å¤±è´¥
   â†“
HTTP Status 200 + æœªç™»å½•çŠ¶æ€çš„é¡µé¢
   â†“
å®¢æˆ·ç«¯ JS å¤„ç†ç™»å½• Token åˆ·æ–°
   â†“
é‡æ–°è®¤è¯ã€é‡æ–°æ¸²æŸ“ç»„ä»¶
```

**é—®é¢˜è¡¨ç°**ï¼š

| é˜¶æ®µ | çŠ¶æ€ | é—®é¢˜ |
|------|------|------|
| **æœåŠ¡ç«¯æ¸²æŸ“** | æœªç™»å½• | è¾“å‡ºæœªç™»å½•çš„ HTML |
| **å®¢æˆ·ç«¯æ°´åˆ** | å·²ç™»å½• | Token åˆ·æ–°æˆåŠŸï¼ŒçŠ¶æ€å˜ä¸ºå·²ç™»å½• |
| **ç»“æœ** | ä¸ä¸€è‡´ | ğŸ”´ æ°´åˆå¤±è´¥ã€ç¼“å­˜æ±¡æŸ“ |

### 2.3 é—®é¢˜ä¸€ï¼šæ— æ³•ç‚¹å‡»çš„é”™è¯¯

**ç°è±¡æˆªå›¾**ï¼š

![æ— æ³•ç‚¹å‡»çš„é”™è¯¯](attachments/image2024-11-14_10-55-31.png)

**é—®é¢˜åˆ†æ**ï¼š

**Vue/React çš„è¦æ±‚**ï¼š
- ç»„ä»¶åœ¨æœåŠ¡ç«¯ä¸å®¢æˆ·ç«¯çŠ¶æ€å¿…é¡»ä¿æŒä¸€è‡´
- çŠ¶æ€ä¸ä¸€è‡´æ—¶æ¡†æ¶ä¼šå°è¯•é”™è¯¯æ¢å¤

**æˆ‘ä»¬çš„ç°çŠ¶**ï¼š
- æœåŠ¡ç«¯ï¼šæœªç™»å½•çŠ¶æ€
- å®¢æˆ·ç«¯ï¼šç™»å½•çŠ¶æ€
- ç»“æœï¼šè¿åäº†ä¸€è‡´æ€§è¦æ±‚

**æ¡†æ¶é”™è¯¯æ¢å¤çš„é—®é¢˜**ï¼š

```
å‰ç«¯æ¡†æ¶å®£ç§°èƒ½å¤„ç†çŠ¶æ€ä¸ä¸€è‡´ï¼š
   â”œâ”€ æŠ›å¼ƒæœåŠ¡ç«¯æ¸²æŸ“çš„ HTML
   â””â”€ å®Œå…¨ç”±å®¢æˆ·ç«¯é‡æ–°è¾“å‡º HTML
      â†“
   ç„¶è€Œè¿™ä¸ªæ‰¿è¯ºå¹¶é 100% å¯é ï¼
```

**å®é™…æƒ…å†µ**ï¼š

1. **Vue 2 çš„ BUG**ï¼š
   ```
   å½“é‡åˆ° v-if æŒ‡ä»¤çš„å€¼ï¼ˆçŠ¶æ€ï¼‰åŒç«¯ä¸ä¸€è‡´æ—¶
      â†“
   Vue 2 ä¼šå´©æºƒä¸”æ— æ³•æ¢å¤ âŒ
   ```

2. **ä¸¥é‡çš„é¡µé¢é—ªçƒ**ï¼š
   ```
   æœåŠ¡ç«¯è¾“å‡ºï¼šæœªç™»å½•é¡µé¢ï¼ˆå¤§é‡å†…å®¹ï¼‰
      â†“
   å®¢æˆ·ç«¯æ°´åˆï¼šç™»å½•é¡µé¢ï¼ˆå®Œå…¨ä¸åŒçš„å†…å®¹ï¼‰
      â†“
   é”™è¯¯æ¢å¤ï¼šé‡æ–°æ¸²æŸ“æ•´ä¸ªé¡µé¢
      â†“
   ç”¨æˆ·ä½“éªŒï¼šä¸¥é‡é—ªçƒ âŒ
   ```

**ç»“è®º**ï¼š

> æˆ‘ä»¬ SSR é¢å¯¹ç™»å½•è¿‡æœŸçš„é—®é¢˜å’Œä½¿ç”¨ Vue è¿˜æ˜¯ jQuery å…¶å®æ²¡æœ‰å…³ç³»ï¼Œ  
> é æ¡†æ¶æˆ–è€…æ‰‹å·¥å¤„ç†è¿™ç§ç»†èŠ‚éƒ½æ˜¯ä¸å¯é çš„ã€‚

### 2.4 é—®é¢˜äºŒï¼šç¼“å­˜æ±¡æŸ“

**é—®é¢˜æè¿°**ï¼š

```
SSR è®¤è¯å¤±è´¥
   â†“
è¿”å› HTTP Status 200
   +
Cache-Control: max-age=600
   â†“
CDN ç¼“å­˜è¿™ä¸ª"æœªç™»å½•"çš„é¡µé¢
   â†“
å…¶ä»–ç”¨æˆ·è®¿é—®ä¹Ÿçœ‹åˆ°"æœªç™»å½•"é¡µé¢
   â†“
å³ä½¿ä»–ä»¬æ˜¯ç™»å½•çŠ¶æ€ï¼âŒ
```

**å½±å“**ï¼š
- ğŸ”´ å·²ç™»å½•ç”¨æˆ·çœ‹åˆ°æœªç™»å½•é¡µé¢
- ğŸ”´ ç¼“å­˜äº†é”™è¯¯çš„å†…å®¹
- ğŸ”´ éœ€è¦ç­‰å¾…ç¼“å­˜è¿‡æœŸï¼ˆ10åˆ†é’Ÿï¼‰

**ç¤ºä¾‹åœºæ™¯**ï¼š

```
æ—¶é—´çº¿ï¼š
10:00 - ç”¨æˆ· A Token è¿‡æœŸï¼Œè®¿é—®é¦–é¡µ
        â†’ SSR è¿”å› 200 + æœªç™»å½•é¡µé¢
        â†’ CDN ç¼“å­˜è¿™ä¸ªé¡µé¢ï¼ˆ10åˆ†é’Ÿï¼‰

10:01 - ç”¨æˆ· Bï¼ˆå·²ç™»å½•ï¼‰è®¿é—®é¦–é¡µ
        â†’ CDN è¿”å›ç¼“å­˜çš„"æœªç™»å½•"é¡µé¢
        â†’ ç”¨æˆ· B çœ‹åˆ°æœªç™»å½•çŠ¶æ€ âŒ

10:05 - ç”¨æˆ· Cï¼ˆå·²ç™»å½•ï¼‰è®¿é—®é¦–é¡µ
        â†’ ä¾ç„¶æ˜¯ç¼“å­˜çš„"æœªç™»å½•"é¡µé¢ âŒ

10:10 - ç¼“å­˜è¿‡æœŸï¼Œæ¢å¤æ­£å¸¸
```

---

## ä¸‰ã€æè®®å†…å®¹

### 3.1 æ ¸å¿ƒæè®®

> **æè®®**ï¼šé‡‡ç”¨è¡Œä¸šä¸»æµçš„é‰´æƒä¸šåŠ¡æµç¨‹ï¼Œåœ¨ç¬¦åˆ HTTP Status è¯­ä¹‰çš„å‰æä¸‹ä¿è¯ç™»å½•çŠ¶æ€åœ¨å¤šä¸ªç«¯çš„ä¸€è‡´ï¼Œå½»åº•é¿å…å…·ä½“æŠ€æœ¯æ ˆã€ä¸šåŠ¡é€»è¾‘å¤„ç†ä¸å½“å¯¼è‡´çš„ç¨³å®šæ€§éšæ‚£ã€‚

### 3.2 å…³é”®åŸåˆ™

| åŸåˆ™ | è¯´æ˜ | æ”¶ç›Š |
|------|------|------|
| **HTTP è¯­ä¹‰æ­£ç¡®** | è®¤è¯å¤±è´¥è¿”å› 401 | âœ… ç¬¦åˆæ ‡å‡†ã€CDN ä¸ç¼“å­˜ |
| **çŠ¶æ€ä¸€è‡´** | æœåŠ¡ç«¯å®¢æˆ·ç«¯ç™»å½•çŠ¶æ€ä¸€è‡´ | âœ… é¿å…æ°´åˆå¤±è´¥ |
| **è‡ªåŠ¨ç»­ç­¾** | Token å¯ç»­æœŸæ—¶è‡ªåŠ¨åˆ·æ–° | âœ… æå‡ç”¨æˆ·ä½“éªŒ |
| **è·¨ç«¯ç»Ÿä¸€** | Web/App ç»Ÿä¸€çš„å¤„ç†æµç¨‹ | âœ… é™ä½ç»´æŠ¤æˆæœ¬ |

---

## å››ã€è¯¦ç»†è®¾è®¡

### 4.1 æ•´ä½“æµç¨‹å›¾

![SSR é‰´æƒæµç¨‹](attachments/image2024-11-14_15-35-39.png)

**æµç¨‹æ¦‚è§ˆ**ï¼š

```
ç”¨æˆ·è¯·æ±‚é¡µé¢
   â†“
SSR é‰´æƒæ£€æŸ¥
   â”œâ”€ æˆåŠŸ â†’ æ¸²æŸ“é¡µé¢
   â””â”€ å¤±è´¥ â†’ è¿”å› 401 + Location å¤´
      â†“
æµè§ˆå™¨æ”¶åˆ° 401
   â†“
é‡å®šå‘åˆ° /sso
   â†“
SSO å†æ¬¡éªŒè¯
   â”œâ”€ å¯ç»­æœŸ â†’ 302 + åˆ·æ–° Token â†’ è¿”å›ä¸šåŠ¡é¡µé¢
   â””â”€ å®Œå…¨è¿‡æœŸ â†’ æ˜¾ç¤ºç™»å½•é¡µé¢
```

### 4.2 SSR ç«¯æµç¨‹

**æ­¥éª¤è¯¦è§£**ï¼š

**æ­¥éª¤ 1ï¼šæ¥æ”¶è¯·æ±‚å¹¶éªŒè¯**

```javascript
// SSR æœåŠ¡
app.get('/dashboard', async (req, res) => {
  // è°ƒç”¨ User API æˆ–ç›´æ¥éªŒè¯ JWT
  const authResult = await verifyAuth(req.headers.cookie);
  
  if (!authResult.success) {
    // è®¤è¯å¤±è´¥
    return res.status(401)
      .header('Location', `/sso?redirect=${encodeURIComponent(req.url)}`)
      .send(renderErrorPage('éœ€è¦ç™»å½•'));
  }
  
  // è®¤è¯æˆåŠŸï¼Œæ¸²æŸ“é¡µé¢
  const html = await renderPage(req, authResult.user);
  res.send(html);
});
```

**æ­¥éª¤ 2ï¼šè¿”å› 401 çŠ¶æ€**

```
HTTP/1.1 401 Unauthorized
Location: /sso?redirect=/dashboard
Content-Type: text/html

<!DOCTYPE html>
<html>
  <head>
    <title>éœ€è¦ç™»å½•</title>
  </head>
  <body>
    <p>æ­£åœ¨è·³è½¬åˆ°ç™»å½•é¡µé¢...</p>
  </body>
</html>
```

**å…³é”®ç‰¹æ€§**ï¼š

| ç‰¹æ€§ | è¯´æ˜ | ä½œç”¨ |
|------|------|------|
| **HTTP 401** | è¡¨ç¤ºæœªæˆæƒ | CDN ä¸ä¼šç¼“å­˜æ­¤å“åº” |
| **Location å¤´** | é‡å®šå‘åœ°å€ | æµè§ˆå™¨è‡ªåŠ¨é‡å®šå‘ |
| **redirect å‚æ•°** | åŸå§‹è¯·æ±‚çš„ URL | ç™»å½•åè¿”å›åŸé¡µé¢ |

**æ­¥éª¤ 3ï¼šéªŒè¯æ–¹å¼é€‰æ‹©**

**æ–¹å¼ Aï¼šè°ƒç”¨ User API**

```javascript
async function verifyAuth(cookie) {
  const response = await fetch('https://api.gaoding.com/user/info', {
    headers: { Cookie: cookie }
  });
  
  if (response.ok) {
    return { success: true, user: await response.json() };
  }
  
  return { success: false };
}
```

**ä¼˜ç‚¹**ï¼š
- âœ… æœ€æ–°çš„ç”¨æˆ·ä¿¡æ¯
- âœ… æœåŠ¡ç«¯æ§åˆ¶æƒé™
- âœ… å¯ä»¥å¤„ç†å¤æ‚çš„é‰´æƒé€»è¾‘

**ç¼ºç‚¹**ï¼š
- âš ï¸ å¢åŠ ä¸€æ¬¡ç½‘ç»œè¯·æ±‚
- âš ï¸ ä¾èµ– User API å¯ç”¨æ€§

**æ–¹å¼ Bï¼šç›´æ¥éªŒè¯ JWT**

```javascript
import jwt from 'jsonwebtoken';

async function verifyAuth(cookie) {
  const token = parseCookie(cookie).access_token;
  
  try {
    const decoded = jwt.verify(token, process.env.JWT_SECRET);
    return { success: true, user: decoded };
  } catch (error) {
    return { success: false };
  }
}
```

**ä¼˜ç‚¹**ï¼š
- âœ… æ— éœ€é¢å¤–è¯·æ±‚
- âœ… æ€§èƒ½æ›´å¥½
- âœ… é™ä½å¯¹ User API çš„ä¾èµ–

**ç¼ºç‚¹**ï¼š
- âš ï¸ æ— æ³•å®æ—¶åŠé”€ Token
- âš ï¸ ç”¨æˆ·ä¿¡æ¯å¯èƒ½ä¸æ˜¯æœ€æ–°çš„

**æ¨è**ï¼š
- ğŸ¯ ä¸€èˆ¬é¡µé¢ï¼šä½¿ç”¨ JWT éªŒè¯ï¼ˆæ€§èƒ½ä¼˜å…ˆï¼‰
- ğŸ¯ æ•æ„Ÿé¡µé¢ï¼šè°ƒç”¨ User APIï¼ˆå®‰å…¨ä¼˜å…ˆï¼‰

### 4.3 Web æµè§ˆå™¨ç«¯æµç¨‹

#### ä¸šåŠ¡è·¯ç”±å¤„ç†

**æ­¥éª¤ 1ï¼šæµè§ˆå™¨æ¥æ”¶ 401 å“åº”**

```javascript
// æµè§ˆå™¨è¡Œä¸ºï¼ˆè‡ªåŠ¨ï¼‰
fetch('/dashboard')
  .then(response => {
    if (response.status === 401) {
      // æµè§ˆå™¨çœ‹åˆ° Location å¤´ï¼Œè‡ªåŠ¨é‡å®šå‘
      window.location.href = response.headers.get('Location');
    }
  });
```

**æ­¥éª¤ 2ï¼šç™»å½• SDK ä¼˜å…ˆä½¿ç”¨ Cookies**

```javascript
// ç™»å½• SDK
class AuthSDK {
  getToken() {
    // âœ… ä¼˜å…ˆä» Cookie è·å–ï¼ˆæœåŠ¡ç«¯å¯ä»¥æ›´æ–°ï¼‰
    const token = this.getTokenFromCookie();
    
    if (token) {
      return token;
    }
    
    // é™çº§ï¼šä» localStorage è·å–
    return localStorage.getItem('access_token');
  }
  
  getTokenFromCookie() {
    const cookies = document.cookie.split(';');
    for (const cookie of cookies) {
      const [key, value] = cookie.trim().split('=');
      if (key === 'access_token') {
        return value;
      }
    }
    return null;
  }
}
```

**ä¸ºä»€ä¹ˆä¼˜å…ˆä½¿ç”¨ Cookieï¼Ÿ**

| å­˜å‚¨æ–¹å¼ | æœåŠ¡ç«¯å¯æ›´æ–° | è·¨åŸŸæ”¯æŒ | å®‰å…¨æ€§ | æ¨è |
|---------|------------|---------|--------|------|
| **Cookie** | âœ… æ˜¯ | âœ… æ”¯æŒ | âœ… HttpOnly | ğŸ¯ æ¨è |
| **localStorage** | âŒ å¦ | âŒ ä¸æ”¯æŒ | âš ï¸ æ˜“å— XSS | âš ï¸ é™çº§ |

#### SSO è·¯ç”±å¤„ç†

**SSO è·¯ç”±çš„èŒè´£**ï¼š

```javascript
// /sso è·¯ç”±
app.get('/sso', async (req, res) => {
  const redirectUrl = req.query.redirect || '/';
  
  // å†æ¬¡éªŒè¯ Token
  const authResult = await verifyAndRefreshAuth(req.headers.cookie);
  
  if (authResult.success) {
    // æƒ…å†µ 1ï¼šToken å¯ç»­æœŸ
    if (authResult.refreshed) {
      // æ›´æ–° Cookie
      res.cookie('access_token', authResult.newToken, {
        httpOnly: true,
        secure: true,
        maxAge: 7 * 24 * 60 * 60 * 1000  // 7å¤©
      });
      
      // é‡å®šå‘å›ä¸šåŠ¡é¡µé¢
      return res.redirect(302, redirectUrl);
    }
    
    // æƒ…å†µ 2ï¼šToken ä¾ç„¶æœ‰æ•ˆï¼ˆå¯èƒ½æ˜¯ç½‘ç»œæŠ–åŠ¨ï¼‰
    return res.redirect(302, redirectUrl);
  }
  
  // æƒ…å†µ 3ï¼šå®Œå…¨è¿‡æœŸï¼Œæ˜¾ç¤ºç™»å½•é¡µé¢
  res.send(renderLoginPage(redirectUrl));
});
```

**å¤„ç†æµç¨‹å›¾**ï¼š

```
/sso æ”¶åˆ°è¯·æ±‚
   â†“
éªŒè¯ Token
   â”œâ”€ æœ‰æ•ˆ â†’ 302 é‡å®šå‘å›ä¸šåŠ¡é¡µé¢
   â”œâ”€ å¯ç»­æœŸ â†’ åˆ·æ–° Token + 302 é‡å®šå‘
   â””â”€ å®Œå…¨è¿‡æœŸ â†’ æ˜¾ç¤ºç™»å½•é¡µé¢
```

**å“åº”ç¤ºä¾‹**ï¼š

**åœºæ™¯ Aï¼šToken ç»­æœŸæˆåŠŸ**

```
HTTP/1.1 302 Found
Location: /dashboard
Set-Cookie: access_token=new_token; HttpOnly; Secure; Max-Age=604800
Set-Cookie: refresh_token=new_refresh; HttpOnly; Secure; Max-Age=2592000
```

**åœºæ™¯ Bï¼šToken å®Œå…¨è¿‡æœŸ**

```
HTTP/1.1 200 OK
Content-Type: text/html

<!DOCTYPE html>
<html>
  <head><title>ç™»å½•</title></head>
  <body>
    <form action="/api/login" method="POST">
      <input name="username" />
      <input name="password" type="password" />
      <button type="submit">ç™»å½•</button>
    </form>
  </body>
</html>
```

### 4.4 App WebView ç«¯æµç¨‹

**ç‰¹æ®Šè€ƒè™‘**ï¼š

> App ç«¯æœ‰è‡ªå·±çš„ Token æ‰˜ç®¡æ–¹æ³•ï¼Œåº”å½“é¿å…æœåŠ¡ç«¯å’Œå®¢æˆ·ç«¯éƒ½åœ¨åˆ· Token é€ æˆå†²çªã€‚

**æµç¨‹è®¾è®¡**ï¼š

**æ­¥éª¤ 1ï¼šå¿½ç•¥ Location å¤´**

```java
// Android WebView
webView.setWebViewClient(new WebViewClient() {
    @Override
    public boolean shouldOverrideUrlLoading(WebView view, String url) {
        if (url.startsWith("/sso")) {
            // âŒ ä¸æ‰§è¡Œé‡å®šå‘
            // âœ… äº¤ç»™åŸç”Ÿå¤„ç†
            handleAuthByNative();
            return true;
        }
        return false;
    }
    
    @Override
    public void onReceivedHttpError(WebView view, WebResourceRequest request, WebResourceResponse errorResponse) {
        if (errorResponse.getStatusCode() == 401) {
            // Token è¿‡æœŸï¼ŒåŸç”Ÿå¤„ç†
            handleAuthByNative();
        }
    }
});
```

```swift
// iOS WKWebView
func webView(_ webView: WKWebView, decidePolicyFor navigationResponse: WKNavigationResponse, decisionHandler: @escaping (WKNavigationResponsePolicy) -> Void) {
    if let httpResponse = navigationResponse.response as? HTTPURLResponse {
        if httpResponse.statusCode == 401 {
            // Token è¿‡æœŸï¼ŒåŸç”Ÿå¤„ç†
            handleAuthByNative()
            decisionHandler(.cancel)
            return
        }
    }
    decisionHandler(.allow)
}
```

**æ­¥éª¤ 2ï¼šåŸç”Ÿåˆ·æ–° Token**

```java
// Android
private void handleAuthByNative() {
    // æƒ…å†µ 1ï¼šToken å¯ç»­æœŸ
    if (TokenManager.canRefresh()) {
        String newToken = TokenManager.refresh();
        
        // é‡æ–°åŠ è½½é¡µé¢ï¼ˆæºå¸¦æ–° Tokenï¼‰
        webView.loadUrl(currentUrl, Map.of(
            "Authorization", "Bearer " + newToken
        ));
    } 
    // æƒ…å†µ 2ï¼šå®Œå…¨è¿‡æœŸ
    else {
        // æ˜¾ç¤ºåŸç”Ÿç™»å½•é¡µé¢
        startActivity(new Intent(this, LoginActivity.class));
    }
}
```

**å®Œæ•´æµç¨‹**ï¼š

```
App WebView è¯·æ±‚é¡µé¢
   â†“
æ”¶åˆ° 401 å“åº”
   â†“
æ‹¦æˆª 401ï¼ˆä¸æ‰§è¡Œé‡å®šå‘ï¼‰
   â†“
æ£€æŸ¥ Token æ˜¯å¦å¯ç»­æœŸ
   â”œâ”€ å¯ç»­æœŸ
   â”‚    â†“
   â”‚  åŸç”Ÿåˆ·æ–° Token
   â”‚    â†“
   â”‚  æºå¸¦æ–° Token é‡æ–°è¯·æ±‚
   â”‚    â†“
   â”‚  æˆåŠŸ
   â”‚
   â””â”€ å®Œå…¨è¿‡æœŸ
        â†“
      æ˜¾ç¤ºåŸç”Ÿç™»å½•é¡µé¢
```

**å…³é”®å·®å¼‚**ï¼š

| æ“ä½œ | Web æµè§ˆå™¨ | App WebView |
|------|-----------|-------------|
| **æ”¶åˆ° 401** | è‡ªåŠ¨é‡å®šå‘åˆ° /sso | æ‹¦æˆªï¼Œä¸é‡å®šå‘ |
| **Token åˆ·æ–°** | æœåŠ¡ç«¯åˆ·æ–° | åŸç”Ÿåˆ·æ–° |
| **Token å­˜å‚¨** | Cookie | åŸç”Ÿå­˜å‚¨ |
| **ç™»å½•é¡µé¢** | Web ç™»å½•é¡µ | åŸç”Ÿç™»å½•é¡µ |

---

## äº”ã€ä»£æ›¿æ–¹æ¡ˆ

### 5.1 æ–¹æ¡ˆ Aï¼šæ‰‹åŠ¨ç»­ç­¾å…ç™»

**é˜¿é‡Œäº‘çš„æ–¹æ¡ˆ**ï¼š

![é˜¿é‡Œäº‘æ‰‹åŠ¨ç»­ç­¾](attachments/image2024-11-14_11-37-50.png)

**å·¥ä½œæ–¹å¼**ï¼š

```
Token è¿‡æœŸ
   â†“
æ˜¾ç¤ºæç¤ºé¡µé¢ï¼š"æ‚¨çš„ç™»å½•å·²è¿‡æœŸï¼Œè¯·ç‚¹å‡»æŒ‰é’®åˆ·æ–°"
   â†“
ç”¨æˆ·ç‚¹å‡»"åˆ·æ–°"æŒ‰é’®
   â†“
åˆ·æ–° Token
   â†“
è¿”å›åŸé¡µé¢
```

**å¯¹æ¯”åˆ†æ**ï¼š

| ç‰¹æ€§ | é˜¿é‡Œäº‘æ–¹æ¡ˆ | æœ¬ RFC æ–¹æ¡ˆ |
|------|-----------|------------|
| **ç”¨æˆ·æ“ä½œ** | éœ€è¦ç‚¹å‡»æŒ‰é’® | è‡ªåŠ¨åˆ·æ–° |
| **ä½“éªŒ** | é¢å¤–ä¸€æ­¥æ“ä½œ | æ— æ„ŸçŸ¥ |
| **å®ç°å¤æ‚åº¦** | ä½ | ä¸­ |
| **é€‚ç”¨åœºæ™¯** | å®‰å…¨æ€§è¦æ±‚é«˜çš„åœºæ™¯ | ä¸€èˆ¬ä¸šåŠ¡åœºæ™¯ |

**ä»€ä¹ˆæ—¶å€™ä½¿ç”¨æ‰‹åŠ¨ç»­ç­¾ï¼Ÿ**

- âœ… é‡‘èã€æ”¯ä»˜ç­‰é«˜å®‰å…¨åœºæ™¯
- âœ… éœ€è¦ç”¨æˆ·ç¡®è®¤èº«ä»½
- âœ… é•¿æ—¶é—´æœªæ“ä½œåçš„ç»­ç­¾

### 5.2 å…¶ä»–å¤‡é€‰æ–¹æ¡ˆ

**æ–¹æ¡ˆ Bï¼šå®¢æˆ·ç«¯å®Œå…¨æ¥ç®¡é‰´æƒ**

```
SSR ä¸åšé‰´æƒï¼Œè¿”å›æœªç™»å½•é¡µé¢
   â†“
å®¢æˆ·ç«¯ JS æ£€æŸ¥ç™»å½•çŠ¶æ€
   â†“
å¦‚æœå·²ç™»å½•ï¼Œé‡æ–°æ¸²æŸ“ä¸ºç™»å½•çŠ¶æ€
```

**é—®é¢˜**ï¼š
- âŒ è¿å SSR åŸåˆ™ï¼ˆæœåŠ¡ç«¯å®¢æˆ·ç«¯çŠ¶æ€ä¸ä¸€è‡´ï¼‰
- âŒ ä¸¥é‡çš„é¡µé¢é—ªçƒ
- âŒ SEO ä¸å‹å¥½

**æ–¹æ¡ˆ Cï¼šæœåŠ¡ç«¯å§‹ç»ˆè¿”å›ç™»å½•çŠ¶æ€é¡µé¢**

```
SSR é˜¶æ®µä¸ç®¡Tokenæ˜¯å¦æœ‰æ•ˆ
   â†“
éƒ½è¿”å›ç™»å½•çŠ¶æ€çš„é¡µé¢
   â†“
å®¢æˆ·ç«¯å†éªŒè¯ï¼Œæ— æ•ˆåˆ™é‡æ–°æ¸²æŸ“
```

**é—®é¢˜**ï¼š
- âŒ ç¼“å­˜æ±¡æŸ“æ›´ä¸¥é‡
- âŒ å¯èƒ½æ³„éœ²æ•æ„Ÿä¿¡æ¯
- âŒ å®¢æˆ·ç«¯éœ€è¦é‡æ–°æ¸²æŸ“æ•´ä¸ªé¡µé¢

---

## å…­ã€å¾…è®¨è®ºçš„é—®é¢˜

### 6.1 é—®é¢˜ 1ï¼šJWT éªŒè¯çš„æ½œåœ¨éšæ‚£

**é—®é¢˜**ï¼š

> å¦‚æœ SSR ç›´æ¥éªŒè¯ JWT è€Œéè¯·æ±‚ User API è¿›è¡Œç™»å½•è®¤è¯ï¼Œæœ‰å“ªäº›æ½œåœ¨éšæ‚£ï¼Ÿ

**åˆ†æ**ï¼š

**JWT éªŒè¯çš„é—®é¢˜**ï¼š

| é—®é¢˜ | è¯´æ˜ | å½±å“ |
|------|------|------|
| **æ— æ³•å®æ—¶åŠé”€** | JWT ä¸€æ—¦ç­¾å‘ï¼Œåœ¨è¿‡æœŸå‰éƒ½æœ‰æ•ˆ | ğŸ”´ ç”¨æˆ·æ³¨é”€å Token ä¾ç„¶å¯ç”¨ |
| **ä¿¡æ¯å¯èƒ½è¿‡æœŸ** | JWT ä¸­çš„ç”¨æˆ·ä¿¡æ¯æ˜¯ç­¾å‘æ—¶çš„å¿«ç…§ | âš ï¸ æƒé™å˜æ›´æ— æ³•å®æ—¶ç”Ÿæ•ˆ |
| **ä¾èµ–å¯†é’¥å®‰å…¨** | å¯†é’¥æ³„éœ²ï¼Œæ‰€æœ‰ Token éƒ½ä¸å®‰å…¨ | ğŸ”´ å®‰å…¨é£é™© |

**å»ºè®®**ï¼š

```javascript
// æ··åˆæ–¹æ¡ˆ
async function verifyAuth(cookie) {
  // æ­¥éª¤ 1ï¼šå…ˆéªŒè¯ JWT
  const jwtValid = verifyJWT(cookie);
  if (!jwtValid) {
    return { success: false };
  }
  
  // æ­¥éª¤ 2ï¼šå¯¹äºæ•æ„Ÿæ“ä½œï¼Œå†è°ƒç”¨ User API
  if (isSensitiveRoute(req.url)) {
    return await callUserAPI(cookie);
  }
  
  // æ­¥éª¤ 3ï¼šä¸€èˆ¬é¡µé¢ç›´æ¥ä½¿ç”¨ JWT
  return { success: true, user: jwtValid };
}
```

### 6.2 é—®é¢˜ 2ï¼šæ— é™é‡å®šå‘

**é—®é¢˜**ï¼š

> SSO å’Œä¸šåŠ¡ URL ä¹‹é—´å¯èƒ½ä¼šäº§ç”Ÿæ— é™çš„é‡å®šå‘â€”â€”è¿™æ˜¯å¦æ˜¯ä¸€ä¸ªé—®é¢˜ï¼Ÿè¿™ä¸ªé—®é¢˜æ˜¯å¦éœ€è¦è§£å†³ï¼Ÿ

**åœºæ™¯åˆ†æ**ï¼š

```
/dashboard (401) â†’ /sso â†’ /dashboard (401) â†’ /sso â†’ ...
```

**ä½•æ—¶å‘ç”Ÿ**ï¼š
- Token å®Œå…¨è¿‡æœŸ
- SSO éªŒè¯å¤±è´¥ä½†æ²¡æœ‰æ˜¾ç¤ºç™»å½•é¡µ
- é€»è¾‘é”™è¯¯

**è§£å†³æ–¹æ¡ˆ**ï¼š

```javascript
// æ–¹æ¡ˆ Aï¼šè®¡æ•°å™¨
app.get('/sso', (req, res) => {
  const retryCount = parseInt(req.query.retry || '0');
  
  if (retryCount > 3) {
    // è¶…è¿‡3æ¬¡ï¼Œå¼ºåˆ¶æ˜¾ç¤ºç™»å½•é¡µ
    return res.send(renderLoginPage());
  }
  
  const authResult = await verifyAuth(req);
  if (!authResult.success) {
    return res.send(renderLoginPage());
  }
  
  res.redirect(req.query.redirect + `?retry=${retryCount + 1}`);
});

// æ–¹æ¡ˆ Bï¼šæ—¶é—´çª—å£
app.get('/sso', (req, res) => {
  const timestamp = Date.now();
  const lastAttempt = req.cookies.last_auth_attempt;
  
  if (lastAttempt && timestamp - lastAttempt < 5000) {
    // 5ç§’å†…å¤šæ¬¡é‡å®šå‘ï¼Œå¼ºåˆ¶æ˜¾ç¤ºç™»å½•é¡µ
    return res.send(renderLoginPage());
  }
  
  res.cookie('last_auth_attempt', timestamp, { maxAge: 10000 });
  // ...
});
```

### 6.3 é—®é¢˜ 3ï¼šå†å² App ç‰ˆæœ¬å…¼å®¹æ€§

**é—®é¢˜**ï¼š

> æ­¤ RFC æ˜¯å¦å¯¹å†å² App ç‰ˆæœ¬æœ‰å½±å“ï¼Ÿ

**åˆ†æ**ï¼š

**æ—§ç‰ˆ App çš„è¡Œä¸º**ï¼š

| App ç‰ˆæœ¬ | æ˜¯å¦æ‹¦æˆª 401 | è¡Œä¸º | å½±å“ |
|---------|------------|------|------|
| **æ–°ç‰ˆï¼ˆæ”¯æŒï¼‰** | âœ… æ‹¦æˆª | åŸç”Ÿå¤„ç† | âœ… æŒ‰é¢„æœŸå·¥ä½œ |
| **æ—§ç‰ˆï¼ˆä¸æ”¯æŒï¼‰** | âŒ ä¸æ‹¦æˆª | è·Ÿéšé‡å®šå‘åˆ° /sso | âš ï¸ éœ€è¦å¤„ç† |

**å…¼å®¹æ–¹æ¡ˆ**ï¼š

```javascript
// SSO è·¯ç”±è¯†åˆ« App
app.get('/sso', (req, res) => {
  const userAgent = req.headers['user-agent'];
  const appVersion = parseAppVersion(userAgent);
  
  // æ—§ç‰ˆ Appï¼šè¿”å› JSON è€Œä¸æ˜¯ HTML
  if (isOldAppVersion(appVersion)) {
    return res.json({
      code: 401,
      message: 'Token expired',
      action: 'show_native_login'
    });
  }
  
  // æ–°ç‰ˆ App å’Œ Webï¼šæ­£å¸¸æµç¨‹
  // ...
});
```

**App ç«¯å¤„ç†**ï¼š

```java
// æ—§ç‰ˆ App ç‰¹æ®Šå¤„ç†
webView.setWebViewClient(new WebViewClient() {
    @Override
    public void onPageFinished(WebView view, String url) {
        if (url.contains("/sso")) {
            // è¯„ä¼° JS è·å–å“åº”
            view.evaluateJavascript(
                "(function() { return document.body.innerText; })()",
                value -> {
                    if (value.contains("show_native_login")) {
                        handleAuthByNative();
                    }
                }
            );
        }
    }
});
```

---

## ä¸ƒã€å®æ–½è®¡åˆ’

### 7.1 é˜¶æ®µåˆ’åˆ†

**é˜¶æ®µ 1ï¼šåŸºç¡€è®¾æ–½å‡†å¤‡**
- [ ] SSO è·¯ç”±å®ç°
- [ ] Token åˆ·æ–°é€»è¾‘
- [ ] é”™è¯¯é¡µé¢æ¨¡æ¿

**é˜¶æ®µ 2ï¼šSSR æœåŠ¡æ”¹é€ **
- [ ] é›†æˆé‰´æƒä¸­é—´ä»¶
- [ ] è¿”å› 401 å“åº”
- [ ] æ·»åŠ  Location å¤´

**é˜¶æ®µ 3ï¼šå®¢æˆ·ç«¯é€‚é…**
- [ ] ç™»å½• SDK æ›´æ–°
- [ ] Cookie ä¼˜å…ˆç­–ç•¥
- [ ] App WebView æ‹¦æˆªé€»è¾‘

**é˜¶æ®µ 4ï¼šç›‘æ§ä¸ä¼˜åŒ–**
- [ ] ç›‘æ§ 401 å“åº”ç‡
- [ ] ç›‘æ§ Token åˆ·æ–°æˆåŠŸç‡
- [ ] ä¼˜åŒ–æ€§èƒ½ç“¶é¢ˆ

### 7.2 é£é™©è¯„ä¼°

| é£é™© | å½±å“ | ç¼“è§£æªæ–½ |
|------|------|---------|
| **å¤§è§„æ¨¡401å“åº”** | é«˜ | ç°åº¦å‘å¸ƒã€ç›‘æ§å‘Šè­¦ |
| **Tokenåˆ·æ–°å¤±è´¥** | é«˜ | é™çº§æ–¹æ¡ˆã€é‡è¯•æœºåˆ¶ |
| **Appå…¼å®¹æ€§é—®é¢˜** | ä¸­ | ç‰ˆæœ¬æ£€æµ‹ã€æ¸è¿›å¼å‡çº§ |
| **æ€§èƒ½ä¸‹é™** | ä¸­ | ç¼“å­˜ä¼˜åŒ–ã€å¼‚æ­¥å¤„ç† |

---

## å…«ã€æ€»ç»“

### 8.1 æ ¸å¿ƒä»·å€¼

**æŠ€æœ¯ä»·å€¼**ï¼š
- âœ… ç¬¦åˆ HTTP æ ‡å‡†è¯­ä¹‰
- âœ… é¿å…ç¼“å­˜æ±¡æŸ“
- âœ… è§£å†³æ°´åˆå¤±è´¥é—®é¢˜
- âœ… è·¨ç«¯ç»Ÿä¸€çš„é‰´æƒæµç¨‹

**ä¸šåŠ¡ä»·å€¼**ï¼š
- âœ… æå‡ç”¨æˆ·ä½“éªŒï¼ˆè‡ªåŠ¨ç»­ç­¾ï¼‰
- âœ… æé«˜ç³»ç»Ÿç¨³å®šæ€§
- âœ… é™ä½ç»´æŠ¤æˆæœ¬
- âœ… å‡å°‘ç”Ÿäº§äº‹æ•…

### 8.2 å…³é”®è¦ç‚¹

**å¿…é¡»éµå®ˆçš„è§„åˆ™**ï¼š

1. **è®¤è¯å¤±è´¥è¿”å› 401**ï¼Œè€Œä¸æ˜¯ 200
2. **æœåŠ¡ç«¯å’Œå®¢æˆ·ç«¯çŠ¶æ€å¿…é¡»ä¸€è‡´**
3. **Token ä¼˜å…ˆå­˜å‚¨åœ¨ HttpOnly Cookie**
4. **App WebView è¦æ‹¦æˆª 401ï¼Œä½¿ç”¨åŸç”Ÿé‰´æƒ**

### 8.3 ä¸‹ä¸€æ­¥

**ç›¸å…³æ–‡æ¡£**ï¼š
- [OAuth å’Œ JWT æœ€ä½³å®è·µ](06-é‰´æƒ-SSRä¸­ä½¿ç”¨OAuthå’ŒJWTçš„æœ€ä½³å®è·µ.md)
- [Token åˆ·æ–°å¹¶å‘é—®é¢˜](07-é‰´æƒ-æœåŠ¡ç«¯åˆ·æ–°tokenså¹¶å‘é—®é¢˜ä¸è§£å†³æ–¹æ¡ˆ.md)
- [Token åˆ·æ–°ç­–ç•¥è®¨è®º](08-é‰´æƒ-Tokenåº”å½“ç”±æœåŠ¡ç«¯è¿˜æ˜¯å®¢æˆ·ç«¯åˆ·æ–°.md)

---

**æ–‡æ¡£ç»´æŠ¤**ï¼šå‰ç«¯åŸºå»ºå›¢é˜Ÿ  
**RFC ä½œè€…**ï¼šå‰ç«¯æ¶æ„ç»„  
**æ•´ç†æ—¥æœŸ**ï¼š2025-01-25  
**æ–‡æ¡£ç‰ˆæœ¬**ï¼šv1.0
