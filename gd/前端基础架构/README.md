# 前端基础架构文档

## 📖 文档概述

本文档介绍稿定前端可生长架构（微前端架构实现），涵盖基础设施、工具链、集成层和应用层的完整技术方案。这是一个**技术栈无关、易于扩展、持续演进**的前端生态系统设计。

---

## 🗂️ 文档结构

```
前端基础架构/
├── README.md                              # 本文件：文档导航
├── 前端可生长架构设计.md                   # RFC 0：完整架构设计
├── Widget系统设计.md                      # RFC 1：Widget 插件系统
└── attachments/                          # 图片附件
    ├── image2023-3-30_11-18-35.png      # 架构全景图
    ├── image2023-3-15_14-25-0.png       # Monorepo 结构
    ├── image2023-2-28_20-46-2.png       # Widget 编辑模式
    └── ...
```

---

## 📚 阅读指南

### 快速开始（5分钟）

1. **了解核心理念**
   - 尊重 Web 标准
   - 避免技术栈污染
   - 减少构建依赖

2. **理解架构分层**
   ```
   应用层 → 集成层 → 工具链层 → 基础设施层
   ```

3. **掌握关键技术**
   - Monorepo（单体仓库）
   - Importmap（模块集成）
   - 挂件系统（微前端）

### 深入学习（60-80分钟）

#### 第一阶段：理解整体架构（30-40分钟）

阅读 [前端可生长架构设计](前端可生长架构设计.md)（RFC 0），了解：

**第一部分：基础设施层（10分钟）**
- Monorepo 的优势和实施策略
- DevOps 集成方案

**第二部分：工具链层（10分钟）**
- Pnpm 包管理
- Turborepo 构建系统
- Wpm 和 ESM CDN

**第三部分：集成层（5分钟）**
- Importmap 使用
- 挂件容器
- Iliad 编辑器

**第四部分：应用层（10分钟）**
- 包的标准
- 代码资产定义
- 挂件规范

**第五部分：未来规划（5分钟）**
- 设计系统
- 元框架

#### 第二阶段：掌握 Widget 系统（30-40分钟）

阅读 [Widget系统设计](Widget系统设计.md)（RFC 1），了解：

**第一部分：概念与动机（5分钟）**
- Widget 定义和应用场景
- 设计动机和核心理念

**第二部分：基本模式（10分钟）**
- 编辑模式（有限编辑、可配置）
- 开发模式（技术栈无关）
- 格式模式（NPM 包结构）

**第三部分：技术实现（10分钟）**
- 生命周期管理
- ESM CDN 与 Importmap
- 依赖共享机制

**第四部分：安全策略（10分钟）**
- Iframe Sandbox 模式
- Web Worker + SSR 模式
- Web Sandbox 模式
- 方案对比

**第五部分：未来可能性（5分钟）**
- 服务器端批量生成
- 插槽组合

---

## 🎯 核心概念

### 架构分层

```
┌────────────────────────────────────────┐
│           应用层                        │
│   页面 / 挂件 / 组件 / SDK              │
└────────────────────────────────────────┘
                 ↓
┌────────────────────────────────────────┐
│           集成层                        │
│   Importmap / 挂件容器 / Iliad         │
└────────────────────────────────────────┘
                 ↓
┌────────────────────────────────────────┐
│          工具链层                       │
│   Pnpm / Turborepo / Wpm / ESM CDN    │
└────────────────────────────────────────┘
                 ↓
┌────────────────────────────────────────┐
│        基础设施层                       │
│       Monorepo / DevOps                │
└────────────────────────────────────────┘
```

### Monorepo

**定义：**  
一个仓库包含多个项目，以包颗粒度进行独立发布与部署

**核心优势：**
- ✅ 可见性：跨团队协作
- ✅ 依赖管理：唯一依赖源
- ✅ 一致性：统一代码规范
- ✅ 原子提交：大规模重构
- ✅ 统一 CI/CD：相同部署流程

### Importmap

**定义：**  
Web 标准，在浏览器中映射模块标识符到 URL

**核心优势：**
- ✅ 跨业务共享代码资产
- ✅ 无需打包，直接使用 CDN
- ✅ 依赖去重，只加载一次

**示例：**
```html
<script type="importmap">
{
  "imports": {
    "react": "https://esm.gaoding.com/react@18.0.0/index.js"
  }
}
</script>
```

### 挂件（Widget）

**定义：**  
前端中的微服务，通过容器运行在不同技术栈中。Widget 是为 Web 编辑器设计的插件类型，是一个由开发者代码实现的小区块。

**应用场景：**
- 📊 数据驱动的图表、排行榜
- 🎰 交互式小游戏
- 📝 表单和数据提交

**格式级别：**
- **Level 1**：基础组件（Vue/React）
- **Level 2**：跨技术栈挂件（技术栈无关）
- **Level 3**：NoCode 可视化组件（提供清单）

**生命周期：**
```typescript
{
  bootstrap(props) {},  // 初始化（首次挂载前）
  mount(container, props) {},  // 挂载
  update(props) {},  // 更新
  unmount() {},  // 卸载
  unload() {}  // 移除
}
```

**核心特性：**
- ✅ 基于 Web 标准（NPM、ESM、Importmap）
- ✅ 技术栈无关（支持 React、Vue 等）
- ✅ 依赖共享（peerDependencies）
- ✅ Shadow DOM 隔离
- ✅ 安全沙盒机制

---

## 🚀 技术栈

### 基础设施

| 技术 | 说明 |
|------|------|
| **Monorepo** | 单体仓库，统一代码管理 |
| **DevOps** | CI/CD、多环境、灰度发布 |

### 工具链

| 技术 | 说明 | 官网 |
|------|------|------|
| **Pnpm** | 包管理工具 | https://pnpm.io/ |
| **Turborepo** | 构建系统 | https://turbo.build/ |
| **Vite** | 推荐打包工具 | https://vitejs.dev/ |
| **Rollup** | ESM 打包器 | https://rollupjs.org/ |
| **Wpm** | Web 包管理工具（稿定自研） | - |
| **ESM CDN** | ESM Npm CDN（稿定自研） | - |

### 集成

| 技术 | 说明 |
|------|------|
| **Importmap** | Web 标准模块映射 |
| **Web Widget Container** | 挂件运行容器（稿定自研） |
| **Iliad** | 可视化编辑器（稿定自研） |

---

## 💡 设计原则

### 核心理念

1. **尊重 Web 标准**  
   最大程度避免造私有标准与平台

2. **避免技术栈污染**  
   上游技术栈不污染下游

3. **减少构建依赖**  
   提高开发效率

4. **技术栈无关**  
   适应不同技术栈

5. **持续提升抽象层次**  
   ProCode 与 NoCode 融合

### 包的标准

**必须满足：**
- ✅ 语义化版本号
- ✅ 使用 `exports` 字段
- ✅ 默认导出 ESM 格式
- ✅ 浏览器兼容语法
- ✅ 条件导出
- ✅ 使用 `imports` 字段
- ✅ peerDependencies 共享依赖
- ✅ workspaces 协议
- ✅ 优先使用公共 Npm 源

---

## 📋 代码资产

### 资产类型

| 类型 | 说明 | 共享 | 外部耦合 | 技术栈中立 | 可视化 |
|------|------|:----:|:--------:|:----------:|:------:|
| **页面** | 与路由关联的模块 | ❌ | ❌ | ❌ | ❌ |
| **挂件** | 微前端入口 | ✅ | ✅ | ✅ | ✅ |
| **组件** | UI 组件 | ✅ | ❌ | ❌ | ⚠️ |
| **SDK** | 纯 API | ✅ | ✅ | ✅ | ❌ |

### 挂件规范

**Level 1：基础组件**
```vue
<template>
  <div>{{ content }}</div>
</template>
```

**Level 2：跨技术栈**
```typescript
export default {
  mount(el, props) { /* ... */ },
  unmount() { /* ... */ }
}
```

**Level 3：NoCode 可视化**
```json
{
  "name": "组件名",
  "props": { /* ... */ }
}
```

---

## 🔄 工作流程

### 开发流程

```
1. 创建包
   ↓
2. 遵循包标准
   ↓
3. 本地开发（Vite）
   ↓
4. 提交 PR
   ↓
5. CI 自动构建（Turborepo）
   ↓
6. 发布到 Npm
   ↓
7. 同步到 ESM CDN
   ↓
8. 通过 Importmap 集成
```

### 发布流程

```
本地构建 
  → Git 分支策略
  → DevOps CI/CD
  → 多环境部署
  → 灰度发布
  → 正式发布
```

---

## ❓ 常见问题

### Q1: 为什么选择 Monorepo？
**A:** Monorepo 提供：
- 更好的代码可见性和协作
- 简化的依赖管理（唯一依赖源）
- 统一的工具链和 CI/CD
- 原子提交支持大规模重构

### Q2: 为什么使用 Importmap？
**A:** Importmap 是 Web 标准，可以：
- 在浏览器中直接使用 CDN 模块
- 跨业务共享代码资产
- 依赖去重，提高性能

### Q3: 什么是挂件？
**A:** 挂件是稿定定义的微前端概念：
- 前端中的微服务
- 技术栈无关
- 可插拔、可复用
- 支持可视化集成

### Q4: Pnpm vs Npm？
**A:** Pnpm 优势：
- 极快的安装速度
- 节省磁盘空间（全局存储 + 硬链接）
- 更好的 Monorepo 支持
- 避免幽灵依赖

### Q5: Turborepo vs Lerna？
**A:** Turborepo 优势：
- 增量构建（只构建变更）
- 并行执行（多核 CPU）
- 远程缓存（团队共享）
- 更好的性能

### Q6: 如何开始新项目？
**A:** 步骤：
1. 加入现有 Monorepo
2. 创建新包
3. 遵循包标准
4. 集成 CI/CD
5. 灰度发布

---

## 📝 实施指南

### 新项目接入

**Step 1：创建包**
```bash
pnpm create @gaoding/package --name my-app
```

**Step 2：配置 package.json**
```json
{
  "name": "my-app",
  "type": "module",
  "exports": {
    ".": {
      "import": "./dist/index.js"
    }
  }
}
```

**Step 3：开发和构建**
```bash
pnpm dev      # 本地开发
pnpm build    # 构建
pnpm test     # 测试
```

### 现有项目迁移

**评估：**
- 分析依赖
- 评估成本
- 制定计划

**迁移：**
- 调整结构
- 适配工具
- 迁移到 Monorepo

**验证：**
- 功能测试
- 性能测试
- 灰度发布

---

## 🔗 参考资源

### 官方文档

- **Monorepo Tools**：https://monorepo.tools/
- **Turborepo**：https://turbo.build/
- **Pnpm**：https://pnpm.io/
- **Vite**：https://vitejs.dev/
- **Importmap**：https://github.com/WICG/import-maps

### 延伸阅读

- 5 分钟搞懂 Monorepo
- 微前端架构最佳实践
- ESM 模块系统详解
- 设计系统构建指南

---

## 📞 联系方式

- **架构问题**：联系前端架构团队
- **工具问题**：提交 Issue 或联系 DevOps
- **业务接入**：查看实施指南或联系对应团队

---

*最后更新：2025-01-26*  
*文档版本：v1.0 (RFC 0)*
