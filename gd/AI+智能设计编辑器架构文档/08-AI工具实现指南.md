# 08 - AIå·¥å…·å®ç°æŒ‡å—

> **å¯¼èˆª**ï¼š[ğŸ“š è¿”å›æ€»ç›®å½•](./README.md) | [â¬…ï¸ ä¸Šä¸€ç¯‡ï¼šAgentå·¥ä½œæµç¨‹](./07-Agentå·¥ä½œæµç¨‹.md) | [â¡ï¸ ä¸‹ä¸€ç¯‡ï¼šæ€§èƒ½ä¼˜åŒ–ä¸é”™è¯¯å¤„ç†](./08-æ€§èƒ½ä¼˜åŒ–ä¸é”™è¯¯å¤„ç†.md)
>
> **æ‰€å±**ï¼šAI+ æ™ºèƒ½è®¾è®¡ç¼–è¾‘å™¨æ¶æ„æ–‡æ¡£
>
> **æ ¸å¿ƒä»·å€¼**ï¼šå­¦ä¹ å„ç§AIå·¥å…·çš„å‰ç«¯å®ç°æµç¨‹å’Œå…³é”®æŠ€æœ¯

---

## ä¸€ã€AIå·¥å…·å…¨æ™¯

ç³»ç»Ÿæä¾›äº†**10+ç§AIå·¥å…·**ï¼ŒæŒ‰åŠŸèƒ½åˆ†ä¸ºä¸‰å¤§ç±»ï¼š

### 1.1 å·¥å…·åˆ†ç±»

| ç±»åˆ« | å·¥å…· | åŠŸèƒ½ | å…¸å‹åœºæ™¯ |
|------|------|------|---------|
| **ç”Ÿæˆç±»** | AIæŠ å›¾ | è‡ªåŠ¨åˆ†ç¦»å‰æ™¯ä¸èƒŒæ™¯ | å»é™¤äº§å“å›¾èƒŒæ™¯ |
|  | AIæ»¤é•œ | å›¾ç‰‡é£æ ¼è½¬æ¢ | å°†ç…§ç‰‡è½¬æˆæ²¹ç”»é£æ ¼ |
|  | è½¬çŸ¢é‡ | ä½å›¾è½¬çŸ¢é‡ | Logoè½¬å¯ç¼©æ”¾çš„çŸ¢é‡å›¾ |
| **ç¼–è¾‘ç±»** | AIæ”¹å›¾ | å±€éƒ¨æ›¿æ¢å†…å®¹ | æŠŠçº¢è‰²æ±½è½¦æ”¹æˆè“è‰² |
|  | AIæ¶ˆé™¤ | æ™ºèƒ½å»é™¤ç‰©ä½“ | ç§»é™¤ç…§ç‰‡ä¸­çš„è·¯äºº |
|  | AIæ‰©å›¾ | æ™ºèƒ½æ‰©å±•è¾¹ç•Œ | å°†16:9çš„å›¾æ‰©å±•æˆ1:1 |
|  | AIå˜æ¸…æ™° | å›¾ç‰‡è¶…åˆ†è¾¨ç‡ | ä½æ¸…å›¾ç‰‡å˜é«˜æ¸… |
| **åˆ†æç±»** | å›¾æ–‡åˆ†å±‚ | è‡ªåŠ¨è¯†åˆ«æ–‡å­—å’Œå›¾å½¢ | å°†æµ·æŠ¥æ‹†åˆ†æˆå¯ç¼–è¾‘çš„æ¨¡æ¿ |
|  | æº¶å›¾ | å›¾ç‰‡èåˆ | å°†ä¸¤å¼ å›¾è‡ªç„¶èåˆ |
|  | AIæ¢è„¸ | äººè„¸æ›¿æ¢ | æ›¿æ¢ç…§ç‰‡ä¸­çš„äººè„¸ |
|  | AIé˜´å½± | è‡ªåŠ¨ç”Ÿæˆé˜´å½± | ä¸ºæŠ å›¾å…ƒç´ æ·»åŠ çœŸå®é˜´å½± |

### 1.2 å·¥å…·æ³¨å†Œ

```typescript
// domains/editor/extensions/ai/src/hooks/use-image-actions.ts

export function useImageActions() {
  const actions: IAction[] = [
    {
      name: 'openInMatting',          // æŠ å›¾
      title: 'AI æŠ å›¾',
      filter: () => true,             // æ€»æ˜¯å¯ç”¨
      valid,                          // å…ƒç´ éªŒè¯å‡½æ•°
    },
    {
      name: 'openInPaintReplace',     // æ”¹å›¾
      title: 'AI æ”¹å›¾',
      filter: createFilter('inPaintReplaceV2'),  // æƒé™æ§åˆ¶
      valid,
    },
    {
      name: 'openInPaintRemove',      // æ¶ˆé™¤
      title: 'AI æ¶ˆé™¤',
      filter: () => !!(createFilter('inPaintRemove') || createFilter('inPaintRemoveV2')),
      valid,
    },
    // ... å…¶ä»–å·¥å…·
  ];

  return { actions, handleClickAction };
}
```

**å…³é”®è®¾è®¡**ï¼š

- `filter`ï¼šæƒé™æ§åˆ¶ï¼ˆæ˜¯å¦å¯ç”¨è¯¥å·¥å…·ï¼‰
- `valid`ï¼šå…ƒç´ éªŒè¯ï¼ˆå½“å‰å…ƒç´ æ˜¯å¦å¯ä½¿ç”¨è¯¥å·¥å…·ï¼‰
- `cover`ï¼šå·¥å…·çš„é¢„è§ˆå°é¢ï¼ˆé™æ€å›¾å’Œè§†é¢‘ï¼‰

---

## äºŒã€AIæŠ å›¾ï¼šè‡ªåŠ¨åˆ†ç¦»å‰æ™¯ä¸èƒŒæ™¯

### 2.1 åŠŸèƒ½æè¿°

**è¾“å…¥**ï¼šå¸¦èƒŒæ™¯çš„å›¾ç‰‡  
**è¾“å‡º**ï¼šé€æ˜èƒŒæ™¯çš„å‰æ™¯å›¾ï¼ˆPNGï¼‰

**å…¸å‹åœºæ™¯**ï¼š
- äº§å“æ‹æ‘„å›¾å»é™¤èƒŒæ™¯
- äººç‰©ç…§ç‰‡æå–ä¸»ä½“
- Logoç´ æå¤„ç†

### 2.2 å®ç°æµç¨‹

```
ç”¨æˆ·æ“ä½œæµç¨‹ï¼š
1. é€‰ä¸­å›¾ç‰‡å…ƒç´ 
2. ç‚¹å‡»å³ä¾§é¢æ¿"AIæŠ å›¾"æŒ‰é’®
3. ç³»ç»Ÿè‡ªåŠ¨å‘èµ·æŠ å›¾è¯·æ±‚
4. æ˜¾ç¤ºåŠ è½½çŠ¶æ€
5. æŠ å›¾å®Œæˆï¼Œæ›¿æ¢ä¸ºé€æ˜èƒŒæ™¯å›¾
6. ç”¨æˆ·å¯ä»¥è°ƒæ•´å‚æ•°é‡æ–°æŠ å›¾
```

### 2.3 å…³é”®æŠ€æœ¯

**æ ¸å¿ƒAPIè°ƒç”¨**ï¼š

```typescript
// è°ƒç”¨æŠ å›¾æ¥å£
const result = await fetch('/api/ai/matting', {
  method: 'POST',
  body: JSON.stringify({
    image_url: element.imageUrl,  // åŸå›¾URL
    algorithm: 'u2net',            // æˆ– 'modnet'ï¼ˆäººåƒä¸“ç”¨ï¼‰
  }),
});

// è¿”å›ç»“æœ
{
  "matted_url": "https://cdn.com/matted-image.png",  // æŠ å›¾åçš„URL
  "mask": "https://cdn.com/mask.png",                // è’™ç‰ˆï¼ˆå¯é€‰ï¼‰
}
```

**å‰ç«¯å¤„ç†**ï¼š

```typescript
// 1. è§¦å‘æŠ å›¾
postMessage({ type: 'openInMatting' });

// 2. ç›‘å¬æŠ å›¾ç»“æœ
events.on('mattingCompleted', (result) => {
  // æ›´æ–°å…ƒç´ å›¾ç‰‡URL
  editor.updateElement(element, {
    imageUrl: result.matted_url,
    mask: result.mask,  // ä¿å­˜è’™ç‰ˆç”¨äºåç»­ç¼–è¾‘
  });

  // ä¿å­˜æ“ä½œè®°å½•
  aiRecordsService.addRecord({
    tool_type: 'matting',
    origin_url: element.imageUrl,
    result_url: result.matted_url,
    element_id: element.id,
  });
});
```

**ç®—æ³•é€‰æ‹©**ï¼š

- `u2net`ï¼šé€šç”¨ç®—æ³•ï¼Œé€‚åˆå„ç§ç‰©ä½“
- `modnet`ï¼šäººåƒä¸“ç”¨ï¼Œè¾¹ç¼˜æ›´ç²¾ç»†

---

## ä¸‰ã€AIæ”¹å›¾ï¼šå±€éƒ¨å†…å®¹æ›¿æ¢

### 3.1 åŠŸèƒ½æè¿°

**è¾“å…¥**ï¼šå›¾ç‰‡ + è’™ç‰ˆåŒºåŸŸ + æç¤ºè¯  
**è¾“å‡º**ï¼šå±€éƒ¨æ›¿æ¢åçš„å›¾ç‰‡

**å…¸å‹åœºæ™¯**ï¼š
- æ”¹å˜ç‰©ä½“é¢œè‰²ï¼š"æŠŠçº¢è‰²æ±½è½¦æ”¹æˆè“è‰²"
- æ›¿æ¢èƒŒæ™¯ï¼š"æŠŠå®¤å†…èƒŒæ™¯æ”¹æˆæµ·è¾¹"
- ä¿®æ”¹ç»†èŠ‚ï¼š"æŠŠçœ¼ç›å˜å¤§ä¸€ç‚¹"

### 3.2 å®ç°æµç¨‹

```
ç”¨æˆ·æ“ä½œæµç¨‹ï¼š
1. é€‰ä¸­å›¾ç‰‡å…ƒç´ 
2. ç‚¹å‡»"AIæ”¹å›¾"
3. ç”¨æˆ·æ¶‚æŠ¹è¦ä¿®æ”¹çš„åŒºåŸŸï¼ˆç”Ÿæˆè’™ç‰ˆï¼‰
4. è¾“å…¥ä¿®æ”¹æç¤ºè¯ï¼š"æ”¹æˆè“è‰²"
5. ç‚¹å‡»ç¡®è®¤
6. ç³»ç»Ÿå‘èµ·æ”¹å›¾è¯·æ±‚
7. æ˜¾ç¤ºåŠ è½½çŠ¶æ€
8. æ”¹å›¾å®Œæˆï¼ŒåŸåœ°æ›¿æ¢
```

### 3.3 å…³é”®æŠ€æœ¯

**è’™ç‰ˆç»˜åˆ¶**ï¼š

```typescript
// ç”¨æˆ·æ¶‚æŠ¹åŒºåŸŸï¼Œç”Ÿæˆè’™ç‰ˆ
async function getMaskFromUserSelection() {
  // 1. æ˜¾ç¤ºæ¶‚æŠ¹å·¥å…·
  const brushTool = editor.createBrushTool({
    size: 20,          // ç”»ç¬”å¤§å°
    color: '#ff0000',  // çº¢è‰²é«˜äº®
    opacity: 0.5,      // åŠé€æ˜
  });

  // 2. ç”¨æˆ·æ¶‚æŠ¹
  const brushStrokes = await brushTool.waitForUserInput();

  // 3. ç”Ÿæˆè’™ç‰ˆï¼ˆé»‘ç™½å›¾ï¼‰
  const mask = await generateMaskFromStrokes(brushStrokes);

  return {
    mask,              // Base64ç¼–ç çš„è’™ç‰ˆå›¾ç‰‡
    bounds: brushTool.getBounds(),  // æ¶‚æŠ¹åŒºåŸŸçš„è¾¹ç•Œ
  };
}
```

**æ ¸å¿ƒAPIè°ƒç”¨**ï¼š

```typescript
const result = await fetch('/api/ai/inpaint/replace', {
  method: 'POST',
  body: JSON.stringify({
    image_url: element.imageUrl,  // åŸå›¾
    mask: maskArea.mask,          // è’™ç‰ˆåŒºåŸŸ
    prompt: "æ”¹æˆè“è‰²",            // ä¿®æ”¹æç¤ºè¯
    strength: 0.8,                // æ”¹åŠ¨å¼ºåº¦ï¼ˆ0-1ï¼‰
  }),
});

// è¿”å›ç»“æœ
{
  "result_url": "https://cdn.com/modified-image.jpg"
}
```

**å‰ç«¯å¤„ç†**ï¼š

```typescript
// åŸåœ°æ›¿æ¢å›¾ç‰‡
function replaceImageInPlace(element, newImageUrl) {
  // ä¿å­˜åŸå›¾ä½ç½®å’Œå°ºå¯¸
  const { x, y, width, height, rotation } = element.transform;

  // æ›´æ–°å›¾ç‰‡URLï¼ˆä¿æŒå…¶ä»–å±æ€§ä¸å˜ï¼‰
  editor.updateElement(element, {
    imageUrl: newImageUrl,
  });

  // æ·¡å…¥åŠ¨ç”»
  animateFadeIn(element, 300);
}
```

---

## å››ã€AIæ¶ˆé™¤ï¼šæ™ºèƒ½å»é™¤ç‰©ä½“

### 4.1 åŠŸèƒ½æè¿°

**è¾“å…¥**ï¼šå›¾ç‰‡ + è¦æ¶ˆé™¤çš„åŒºåŸŸ  
**è¾“å‡º**ï¼šæ¶ˆé™¤åçš„å›¾ç‰‡ï¼ˆæ™ºèƒ½å¡«å……ï¼‰

**å…¸å‹åœºæ™¯**ï¼š
- ç§»é™¤ç…§ç‰‡ä¸­çš„è·¯äºº
- å»é™¤å›¾ç‰‡ä¸Šçš„æ°´å°
- åˆ é™¤å¤šä½™çš„ç‰©ä½“

### 4.2 å®ç°æµç¨‹

```
ç”¨æˆ·æ“ä½œæµç¨‹ï¼š
1. é€‰ä¸­å›¾ç‰‡å…ƒç´ 
2. ç‚¹å‡»"AIæ¶ˆé™¤"
3. ç”¨æˆ·æ¶‚æŠ¹è¦æ¶ˆé™¤çš„åŒºåŸŸ
4. ç‚¹å‡»ç¡®è®¤
5. ç³»ç»Ÿæ™ºèƒ½å¡«å……æ¶ˆé™¤åŒºåŸŸ
6. æ˜¾ç¤ºæ¶ˆé™¤ç»“æœ
```

### 4.3 å…³é”®æŠ€æœ¯

**æ ¸å¿ƒAPIè°ƒç”¨**ï¼š

```typescript
const result = await fetch('/api/ai/inpaint/remove', {
  method: 'POST',
  body: JSON.stringify({
    image_url: element.imageUrl,
    mask: removeArea.mask,    // è¦æ¶ˆé™¤çš„åŒºåŸŸ
    algorithm: 'lama',        // æˆ– 'telea'
  }),
});
```

**ç®—æ³•é€‰æ‹©**ï¼š

- `lama`ï¼šLaMaç®—æ³•ï¼Œæ•ˆæœæ›´å¥½ï¼Œé€‚åˆå¤æ‚åœºæ™¯
- `telea`ï¼šä¼ ç»Ÿç®—æ³•ï¼Œé€Ÿåº¦å¿«ï¼Œé€‚åˆç®€å•åœºæ™¯

---

## äº”ã€AIæ‰©å›¾ï¼šæ™ºèƒ½æ‰©å±•è¾¹ç•Œ

### 5.1 åŠŸèƒ½æè¿°

**è¾“å…¥**ï¼šå›¾ç‰‡ + æ‰©å±•æ–¹å‘ + æ‰©å±•å°ºå¯¸  
**è¾“å‡º**ï¼šæ‰©å±•åçš„å›¾ç‰‡

**å…¸å‹åœºæ™¯**ï¼š
- å°†16:9çš„å›¾æ‰©å±•æˆ1:1
- æ‰©å±•å›¾ç‰‡è¾¹ç¼˜ï¼Œå¢åŠ ç•™ç™½
- æ™ºèƒ½è¡¥å…¨è¢«è£åˆ‡çš„å†…å®¹

### 5.2 å®ç°æµç¨‹

```
ç”¨æˆ·æ“ä½œæµç¨‹ï¼š
1. é€‰ä¸­å›¾ç‰‡å…ƒç´ 
2. ç‚¹å‡»"AIæ‰©å›¾"
3. é€‰æ‹©æ‰©å±•æ–¹å‘ï¼ˆä¸Š/ä¸‹/å·¦/å³/å…¨éƒ¨ï¼‰
4. é€‰æ‹©æ‰©å±•æ¯”ä¾‹ï¼ˆå¦‚20%ï¼‰
5. ç‚¹å‡»ç¡®è®¤
6. ç³»ç»Ÿæ™ºèƒ½ç”Ÿæˆæ‰©å±•å†…å®¹
7. æ˜¾ç¤ºæ‰©å±•ç»“æœ
```

### 5.3 å…³é”®æŠ€æœ¯

**æ ¸å¿ƒAPIè°ƒç”¨**ï¼š

```typescript
const result = await fetch('/api/ai/outpaint/expand', {
  method: 'POST',
  body: JSON.stringify({
    image_url: element.imageUrl,
    direction: 'all',             // 'left'|'right'|'top'|'bottom'|'all'
    expand_pixels: 200,           // æ‰©å±•åƒç´ æ•°
    prompt: element.context,      // ä¸Šä¸‹æ–‡æç¤ºï¼ˆå¯é€‰ï¼‰
  }),
});

// è¿”å›ç»“æœ
{
  "result_url": "https://cdn.com/expanded-image.jpg",
  "new_width": 2120,    // æ‰©å±•åçš„å®½åº¦
  "new_height": 1080,   // æ‰©å±•åçš„é«˜åº¦
}
```

**å‰ç«¯å¤„ç†**ï¼š

```typescript
// æ›´æ–°å…ƒç´ å°ºå¯¸å’ŒURL
editor.updateElement(element, {
  imageUrl: result.result_url,
  width: result.new_width,
  height: result.new_height,
  // ä¿æŒä¸­å¿ƒä½ç½®ä¸å˜
  transform: {
    ...element.transform,
    x: element.transform.x - (result.new_width - element.width) / 2,
    y: element.transform.y - (result.new_height - element.height) / 2,
  },
});
```

---

## å…­ã€AIå˜æ¸…æ™°ï¼šå›¾ç‰‡è¶…åˆ†è¾¨ç‡

### 6.1 åŠŸèƒ½æè¿°

**è¾“å…¥**ï¼šä½æ¸…å›¾ç‰‡  
**è¾“å‡º**ï¼šé«˜æ¸…å›¾ç‰‡

**å…¸å‹åœºæ™¯**ï¼š
- è€ç…§ç‰‡ä¿®å¤
- æ¨¡ç³Šå›¾ç‰‡å˜æ¸…æ™°
- å°å›¾æ”¾å¤§ä¸å¤±çœŸ

### 6.2 å®ç°æµç¨‹

```
ç”¨æˆ·æ“ä½œæµç¨‹ï¼š
1. é€‰ä¸­å›¾ç‰‡å…ƒç´ 
2. ç‚¹å‡»"AIå˜æ¸…æ™°"
3. é€‰æ‹©æ”¾å¤§å€æ•°ï¼ˆ2x/4xï¼‰
4. ç‚¹å‡»ç¡®è®¤
5. ç³»ç»Ÿè¿›è¡Œè¶…åˆ†è¾¨ç‡å¤„ç†
6. æ˜¾ç¤ºæ¸…æ™°åŒ–ç»“æœ
```

### 6.3 å…³é”®æŠ€æœ¯

**æ ¸å¿ƒAPIè°ƒç”¨**ï¼š

```typescript
// æ£€æŸ¥å›¾ç‰‡åˆ†è¾¨ç‡
const isLowResolution = element.width < 800 || element.height < 800;
if (!isLowResolution) {
  showToast('å›¾ç‰‡åˆ†è¾¨ç‡å·²ç»è¶³å¤Ÿï¼Œæ— éœ€å˜æ¸…æ™°');
  return;
}

const result = await fetch('/api/ai/enhance', {
  method: 'POST',
  body: JSON.stringify({
    image_url: element.imageUrl,
    scale_factor: 2,    // æ”¾å¤§å€æ•°ï¼ˆ2æˆ–4ï¼‰
    denoise: true,      // é™å™ª
    sharpen: true,      // é”åŒ–
  }),
});
```

**å‰ç«¯å¤„ç†**ï¼š

```typescript
// ä¿æŒåŸå°ºå¯¸æ›´æ–°ï¼ˆä¸æ”¹å˜ç”»å¸ƒä¸Šçš„å¤§å°ï¼‰
editor.updateElement(element, {
  imageUrl: result.url,
  // width å’Œ height ä¿æŒä¸å˜
});
```

---

## ä¸ƒã€å›¾æ–‡åˆ†å±‚ï¼šè‡ªåŠ¨è¯†åˆ«æ–‡å­—å’Œå›¾å½¢

### 7.1 åŠŸèƒ½æè¿°

**è¾“å…¥**ï¼šè®¾è®¡æµ·æŠ¥å›¾ç‰‡  
**è¾“å‡º**ï¼šå¯ç¼–è¾‘çš„æ¨¡æ¿ï¼ˆæ–‡å­—å±‚ + å›¾å½¢å±‚ + èƒŒæ™¯å±‚ï¼‰

**å…¸å‹åœºæ™¯**ï¼š
- å°†è®¾è®¡å¥½çš„æµ·æŠ¥è½¬æˆå¯ç¼–è¾‘æ¨¡æ¿
- æå–å›¾ç‰‡ä¸­çš„æ–‡å­—å†…å®¹
- åˆ†ç¦»å›¾ç‰‡ä¸­çš„å›¾å½¢å…ƒç´ 

### 7.2 å®ç°æµç¨‹

```
ç”¨æˆ·æ“ä½œæµç¨‹ï¼š
1. é€‰ä¸­æµ·æŠ¥å›¾ç‰‡
2. ç‚¹å‡»"å›¾æ–‡åˆ†å±‚"
3. ç³»ç»Ÿè‡ªåŠ¨è¯†åˆ«ï¼š
   - æ–‡å­—å†…å®¹ã€ä½ç½®ã€å­—ä½“ã€é¢œè‰²
   - å›¾å½¢å…ƒç´ ã€è·¯å¾„ã€å¡«å……
   - èƒŒæ™¯å›¾å±‚
4. ç”Ÿæˆå¯ç¼–è¾‘çš„æ¨¡æ¿
5. ç”¨æˆ·å¯ä»¥ä¿®æ”¹æ–‡å­—ã€æ›¿æ¢å›¾å½¢
```

### 7.3 å…³é”®æŠ€æœ¯

**æ ¸å¿ƒAPIè°ƒç”¨**ï¼š

```typescript
const result = await fetch('/api/ai/image-to-template', {
  method: 'POST',
  body: JSON.stringify({
    image_url: element.imageUrl,
    detect_text: true,       // è¯†åˆ«æ–‡å­—
    detect_graphics: true,   // è¯†åˆ«å›¾å½¢
  }),
});

// è¿”å›ç»“æœ
{
  "background_layer": "https://cdn.com/background.jpg",
  "text_layers": [
    {
      "content": "æ˜¥å­£æ–°å“",
      "font_family": "PingFang SC",
      "font_size": 48,
      "color": "#ff0000",
      "position": { "x": 100, "y": 200 },
    },
    // ... æ›´å¤šæ–‡å­—å±‚
  ],
  "graphic_layers": [
    {
      "type": "shape",
      "path_data": "M 0,0 L 100,0 L 100,100 Z",
      "fill_color": "#0000ff",
      "position": { "x": 50, "y": 50 },
    },
    // ... æ›´å¤šå›¾å½¢å±‚
  ],
}
```

**å‰ç«¯å¤„ç†**ï¼š

```typescript
// åˆ›å»ºæ¨¡æ¿ç»“æ„
function createTemplateFromLayers(result) {
  const template = {
    background: result.background_layer,
    elements: [],
  };

  // æ·»åŠ æ–‡å­—å±‚
  result.text_layers.forEach((textLayer) => {
    const textElement = editor.createElement({
      type: 'text',
      content: textLayer.content,
      fontFamily: textLayer.font_family,
      fontSize: textLayer.font_size,
      color: textLayer.color,
      transform: textLayer.position,
    });
    template.elements.push(textElement);
  });

  // æ·»åŠ å›¾å½¢å±‚
  result.graphic_layers.forEach((graphicLayer) => {
    const shapeElement = editor.createElement({
      type: 'shape',
      pathData: graphicLayer.path_data,
      fill: graphicLayer.fill_color,
      transform: graphicLayer.position,
    });
    template.elements.push(shapeElement);
  });

  return template;
}

// æ›¿æ¢åŸå…ƒç´ ä¸ºæ¨¡æ¿ç»„
function replaceWithTemplate(element, template) {
  // åˆ é™¤åŸå›¾ç‰‡å…ƒç´ 
  editor.removeElement(element);

  // æ·»åŠ æ¨¡æ¿å…ƒç´ 
  template.elements.forEach((el) => {
    editor.addElement(el);
  });
}
```

---

## å…«ã€è½¬çŸ¢é‡ï¼šä½å›¾è½¬çŸ¢é‡

### 8.1 åŠŸèƒ½æè¿°

**è¾“å…¥**ï¼šä½å›¾ï¼ˆPNG/JPGï¼‰  
**è¾“å‡º**ï¼šçŸ¢é‡å›¾ï¼ˆSVGï¼‰

**å…¸å‹åœºæ™¯**ï¼š
- Logoè½¬çŸ¢é‡ï¼Œæ— æŸç¼©æ”¾
- å›¾æ ‡è½¬SVGæ ¼å¼
- ç®€ç¬”ç”»è½¬å¯ç¼–è¾‘çŸ¢é‡

### 8.2 å…³é”®æŠ€æœ¯

**æ ¸å¿ƒAPIè°ƒç”¨**ï¼š

```typescript
const result = await fetch('/api/ai/image-to-svg', {
  method: 'POST',
  body: JSON.stringify({
    image_url: element.imageUrl,
    simplify: true,      // ç®€åŒ–è·¯å¾„
    color_mode: 'auto',  // 'auto'|'mono'|'color'
  }),
});

// è¿”å›ç»“æœ
{
  "svg_data": "<svg>...</svg>",
  "svg_url": "https://cdn.com/vector.svg",
}
```

**å‰ç«¯å¤„ç†**ï¼š

```typescript
// åˆ›å»ºSVGå…ƒç´ æ›¿æ¢åŸå›¾ç‰‡
const svgElement = editor.createElement({
  type: 'svg',
  svgData: result.svg_data,
  svgUrl: result.svg_url,
  transform: element.transform,  // ç»§æ‰¿åŸä½ç½®
});

editor.replaceElement(element, svgElement);
```

---

## ä¹ã€AIæ»¤é•œï¼šå›¾ç‰‡é£æ ¼è½¬æ¢

### 9.1 åŠŸèƒ½æè¿°

**è¾“å…¥**ï¼šå›¾ç‰‡ + ç›®æ ‡é£æ ¼  
**è¾“å‡º**ï¼šé£æ ¼åŒ–åçš„å›¾ç‰‡

**å…¸å‹åœºæ™¯**ï¼š
- ç…§ç‰‡è½¬æ²¹ç”»
- ç…§ç‰‡è½¬ç´ æ
- ç…§ç‰‡è½¬åŠ¨æ¼«é£æ ¼

### 9.2 å…³é”®æŠ€æœ¯

**æ ¸å¿ƒAPIè°ƒç”¨**ï¼š

```typescript
const result = await fetch('/api/ai/style-transfer', {
  method: 'POST',
  body: JSON.stringify({
    image_url: element.imageUrl,
    style: 'oil_painting',  // é£æ ¼ï¼š'oil_painting'|'sketch'|'anime'
    strength: 0.8,          // é£æ ¼å¼ºåº¦ï¼ˆ0-1ï¼‰
  }),
});
```

---

## åã€å·¥å…·é€šç”¨å¤„ç†æµç¨‹

### 10.1 ç»Ÿä¸€çš„å‰ç«¯æ¶æ„

æ‰€æœ‰AIå·¥å…·éƒ½éµå¾ªç›¸åŒçš„å¤„ç†æµç¨‹ï¼š

```typescript
// ç»Ÿä¸€çš„å·¥å…·è°ƒç”¨æµç¨‹
async function executeAITool(toolType: string, params: any) {
  // 1. å‚æ•°éªŒè¯
  validateParams(params);

  // 2. æ˜¾ç¤ºåŠ è½½çŠ¶æ€
  showLoading();

  // 3. è°ƒç”¨API
  const result = await callAIToolAPI(toolType, params);

  // 4. ä¿å­˜è®°å½•
  await saveToolRecord({
    tool_type: toolType,
    params,
    result,
    element_id: params.element_id,
  });

  // 5. æ›´æ–°ç”»å¸ƒ
  updateCanvasElement(result);

  // 6. éšè—åŠ è½½çŠ¶æ€
  hideLoading();

  // 7. åŸ‹ç‚¹è¿½è¸ª
  tracker.trackToolCompleted({
    tool_name: toolType,
    elapsed_time: Date.now() - startTime,
  });
}
```

### 10.2 é”™è¯¯å¤„ç†

```typescript
try {
  await executeAITool(toolType, params);
} catch (error) {
  if (error.code === 'INSUFFICIENT_BALANCE') {
    showToast('ç¨¿è±†ä¸è¶³ï¼Œè¯·å……å€¼');
    openPaymentModal();
  } else if (error.code === 'IMAGE_TOO_LARGE') {
    showToast('å›¾ç‰‡å¤ªå¤§ï¼Œè¯·å…ˆå‹ç¼©');
  } else {
    showToast('å¤„ç†å¤±è´¥ï¼Œè¯·é‡è¯•');
  }

  // é”™è¯¯åŸ‹ç‚¹
  tracker.trackToolFailed({
    tool_name: toolType,
    error_code: error.code,
    error_message: error.message,
  });
}
```

### 10.3 ç¼“å­˜ç­–ç•¥

```typescript
// å·¥å…·ç»“æœç¼“å­˜
class ToolResultCache {
  private cache = new Map<string, Promise<any>>();

  async getOrFetch(key: string, fetcher: () => Promise<any>) {
    // æ£€æŸ¥ç¼“å­˜
    if (this.cache.has(key)) {
      return this.cache.get(key);
    }

    // å‘èµ·è¯·æ±‚
    const promise = fetcher();
    this.cache.set(key, promise);

    // è¯·æ±‚å¤±è´¥æ—¶åˆ é™¤ç¼“å­˜
    promise.catch(() => {
      this.cache.delete(key);
    });

    return promise;
  }

  clear() {
    this.cache.clear();
  }
}

// ä½¿ç”¨ç¤ºä¾‹
const cacheKey = `${toolType}_${imageUrl}`;
const result = await toolResultCache.getOrFetch(cacheKey, () => {
  return callAIToolAPI(toolType, params);
});
```

---

## åä¸€ã€æ€»ç»“ä¸æœ€ä½³å®è·µ

### 11.1 è®¾è®¡åŸåˆ™

1. **ç»Ÿä¸€çš„ç”¨æˆ·ä½“éªŒ**ï¼šæ‰€æœ‰å·¥å…·éƒ½éµå¾ªç›¸åŒçš„äº¤äº’æµç¨‹
2. **å³æ—¶åé¦ˆ**ï¼šåŠ è½½çŠ¶æ€ã€è¿›åº¦æç¤ºã€ç»“æœé¢„è§ˆ
3. **å®¹é”™æœºåˆ¶**ï¼šç½‘ç»œå¼‚å¸¸ã€APIå¤±è´¥ã€å‚æ•°é”™è¯¯éƒ½æœ‰å‹å¥½æç¤º
4. **è®°å½•å¯è¿½æº¯**ï¼šæ¯æ¬¡æ“ä½œéƒ½ä¿å­˜è®°å½•ï¼Œæ”¯æŒæ’¤é”€å’Œé‡åš

### 11.2 æ€§èƒ½ä¼˜åŒ–

1. **æ‡’åŠ è½½**ï¼šå·¥å…·é¢æ¿æŒ‰éœ€åŠ è½½
2. **ç»“æœç¼“å­˜**ï¼šç›¸åŒå‚æ•°çš„è¯·æ±‚å¤ç”¨ç»“æœ
3. **å¹¶è¡Œå¤„ç†**ï¼šæ‰¹é‡å·¥å…·å¯ä»¥å¹¶è¡Œæ‰§è¡Œ
4. **æ™ºèƒ½é¢„åŠ è½½**ï¼šé¢„æµ‹ç”¨æˆ·å¯èƒ½ä½¿ç”¨çš„å·¥å…·ï¼Œæå‰åŠ è½½èµ„æº

### 11.3 ä¸‹ä¸€æ­¥

- **ä¸Šä¸€ç¯‡**ï¼š[07-Agentå·¥ä½œæµç¨‹](./07-Agentå·¥ä½œæµç¨‹.md) - äº†è§£Agentç¼–æ’
- **ä¸‹ä¸€ç¯‡**ï¼š[08-æ€§èƒ½ä¼˜åŒ–ä¸é”™è¯¯å¤„ç†](./08-æ€§èƒ½ä¼˜åŒ–ä¸é”™è¯¯å¤„ç†.md) - å­¦ä¹ ç³»ç»Ÿä¼˜åŒ–

---

> **æœ¬ç« å®Œæˆï¼** æ‚¨å·²ç»æŒæ¡äº†æ‰€æœ‰AIå·¥å…·çš„å‰ç«¯å®ç°åŸç†ã€‚
