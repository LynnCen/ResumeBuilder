# 09 - 性能优化与错误处理

> **导航**：[📚 返回总目录](./README.md) | [⬅️ 上一篇：AI工具实现指南](./08-AI工具实现指南.md) | [➡️ 下一篇：核心代码实现](./09-核心代码实现.md)
>
> **所属**：AI+ 智能设计编辑器架构文档

---

## 7.1 性能优化策略汇总

### 前端渲染优化

| 优化项         | 具体措施                         | 效果提升         |
| -------------- | -------------------------------- | ---------------- |
| **虚拟滚动**   | 消息列表超过50条启用虚拟滚动     | 减少70% DOM节点  |
| **图片懒加载** | IntersectionObserver 监听可见性  | 节省80% 带宽     |
| **防抖节流**   | 输入框300ms防抖，画布16ms节流    | 减少90% 无效渲染 |
| **Web Worker** | 大图处理放到Worker，不阻塞主线程 | UI始终流畅       |

### 网络通信优化

| 优化项           | 具体措施                      | 效果提升      |
| ---------------- | ----------------------------- | ------------- |
| **SSE 连接复用** | 同会话复用连接，避免频繁建立  | 减少延迟50%   |
| **请求合并**     | 批量生成用一个请求，而非多个  | 减少请求数75% |
| **CDN 加速**     | 图片自动走 CDN，支持 WebP格式 | 加载快3倍     |
| **预加载**       | 预加载常用样式、下一批消息    | 首屏快40%     |

### 内存管理优化

| 优化项         | 具体措施                         | 效果提升     |
| -------------- | -------------------------------- | ------------ |
| **消息分页**   | 历史消息按需加载，旧消息自动回收 | 降低60% 内存 |
| **纹理卸载**   | 超出视口的纹理自动卸载           | 降低80% 显存 |
| **事件清理**   | 组件销毁时移除监听，使用 WeakMap | 避免内存泄漏 |
| **对象池复用** | 复用PixiJS对象，减少GC           | 减少GC卡顿   |

---

## 7.2 错误处理机制

### 错误分类与处理策略

```
┌─────────────────────────────────────────────────────┐
│  客户端错误（4xx）                                    │
│  ───────────────────────────────────────────────   │
│  400 参数错误 → 显示"参数有误，请检查后重试"          │
│  401 未登录 → 弹出登录框                             │
│  403 权限不足 → 显示"此功能需要会员"                 │
│  429 请求过快 → 显示"请稍后再试"                     │
└─────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────┐
│  服务端错误（5xx）                                    │
│  ───────────────────────────────────────────────   │
│  500 服务器错误 → "服务暂时不可用，请稍后重试"        │
│  503 服务过载 → "当前使用人数较多，排队中..."        │
│  超时 → "网络不稳定，已自动重试"                      │
└─────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────┐
│  业务错误（自定义code）                               │
│  ───────────────────────────────────────────────   │
│  -1002 稿豆不足 → 弹出充值弹窗                        │
│  -1006 内容违规 → "内容不符合规范，请修改后重试"      │
│  -1007 AI拒绝 → "AI 认为此请求不合适"                │
└─────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────┐
│  网络错误                                             │
│  ───────────────────────────────────────────────   │
│  断网 → 显示"网络已断开"，连接恢复后自动重连          │
│  SSE中断 → 自动重连（最多3次），失败后显示重试按钮   │
└─────────────────────────────────────────────────────┘
```

### 错误处理流程

```
错误发生
    ↓
MessageHandler 捕获
    ↓
┌─────────────────────┐
│ 判断错误类型          │
└─────────────────────┘
    ↓
┌─────────────────────────────────────┐
│ 是否可重试？                          │
│  ├─ YES → 显示重试按钮                │
│  └─ NO → 只显示错误信息               │
└─────────────────────────────────────┘
    ↓
┌─────────────────────────────────────┐
│ 清理现场                              │
│  ├─ 移除占位元素                      │
│  ├─ 标记消息状态为失败                 │
│  ├─ 上报错误日志                      │
│  └─ 释放资源（关闭SSE连接等）          │
└─────────────────────────────────────┘
    ↓
用户点击重试 → 重新走生成流程
```

### 优雅降级策略

```
核心思想：功能不可用，但不能让应用崩溃

示例：
  AI 服务挂了 → 显示提示，其他编辑功能继续可用
  图片加载失败 → 显示占位图，不影响其他元素
  SSE 不支持 → 降级为轮询方式
```

---

> **下一步**：查看 [核心代码实现](./09-核心代码实现.md) 的关键代码片段。
