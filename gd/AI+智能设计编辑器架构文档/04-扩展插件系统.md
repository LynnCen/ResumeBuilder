# 04 - 扩展插件系统

> **导航**：[📚 返回总目录](./README.md) | [⬅️ 上一篇：编辑器基座](./03-编辑器基座.md) | [➡️ 下一篇：无限画布渲染引擎](./05-无限画布渲染引擎.md)
>
> **所属**：AI+ 智能设计编辑器架构文档

---

## 4.1 为什么需要插件系统？

**场景痛点**：

```
产品需求不断变化：
  ├─ 今天要加 AI 绘图
  ├─ 明天要加视频生成
  ├─ 后天要加协同编辑
  └─ 每次都改核心代码？❌

如果没有插件系统：
  ├─ 核心代码越来越臃肿
  ├─ 功能耦合严重，改一处影响全局
  ├─ 无法按需加载，首屏体积爆炸
  └─ 团队协作困难，互相阻塞
```

**插件化解决方案**：

```
编辑器核心（稳定）
  ↓
通过插件系统扩展（灵活）
  ├─ AI 插件       ← 团队A开发
  ├─ 上传插件      ← 团队B开发
  ├─ 协同插件      ← 团队C开发
  └─ 自定义插件    ← 客户自己开发
```

---

## 4.2 插件生命周期管理

插件从加载到销毁经历 **5 个阶段**：

```
┌─────────────────────────────────────────────────────────┐
│  1️⃣ Load（加载）                                          │
│  ────────────────────────────────────────────────────   │
│  • 解析插件配置（manifest）                               │
│  • 检查依赖关系                                           │
│  • 动态 import 插件代码                                   │
│  • 创建插件实例                                           │
└─────────────────────────────────────────────────────────┘
                          ↓
┌─────────────────────────────────────────────────────────┐
│  2️⃣ Register（注册）                                      │
│  ────────────────────────────────────────────────────   │
│  • 注册 Vue 组件                                          │
│  • 注册路由                                               │
│  • 注册全局指令/过滤器                                     │
│  • 注册编辑器命令                                         │
└─────────────────────────────────────────────────────────┘
                          ↓
┌─────────────────────────────────────────────────────────┐
│  3️⃣ Bootstrap（启动）                                     │
│  ────────────────────────────────────────────────────   │
│  • 初始化插件服务                                         │
│  • 建立网络连接                                           │
│  • 加载初始数据                                           │
│  • 注册事件监听                                           │
└─────────────────────────────────────────────────────────┘
                          ↓
┌─────────────────────────────────────────────────────────┐
│  4️⃣ Run（运行）                                           │
│  ────────────────────────────────────────────────────   │
│  • 插件功能正常工作                                        │
│  • 响应用户操作                                           │
│  • 与其他插件协作                                         │
└─────────────────────────────────────────────────────────┘
                          ↓
┌─────────────────────────────────────────────────────────┐
│  5️⃣ Unmount（卸载）                                       │
│  ────────────────────────────────────────────────────   │
│  • 移除事件监听                                           │
│  • 清理定时器/连接                                        │
│  • 释放内存资源                                           │
│  • 注销组件和命令                                         │
└─────────────────────────────────────────────────────────┘
```

**关键设计**：ExtensionManager 统一管理所有插件的生命周期。

---

## 4.3 插件配置与加载机制

**插件配置的三种方式**：

```javascript
// 方式1：直接传入对象
defineExtensionConfig({
  manifest: { id: 'ai', version: '1.0.0' },
});

// 方式2：异步加载（推荐，支持代码分割）
defineExtensionConfig(() => import('@design/extension-ai'));

// 方式3：带参数配置
defineExtensionConfig([
  import('@design/extension-ai'),
  { apiKey: 'xxx', model: 'gpt-4' }, // 插件参数
]);
```

**按需加载策略**：

```
首屏必需插件（同步加载）：
  ├─ 基础编辑插件（选择、拖拽、缩放...）
  └─ AI 聊天插件（核心功能）

懒加载插件（用户触发时加载）：
  ├─ 图像编辑插件 ← 点击"AI改图"时加载
  ├─ 批量设计插件 ← 打开批量面板时加载
  └─ 协同插件 ← 进入协作模式时加载
```

---

## 4.4 典型插件分类与职责

| 类别         | 插件示例                    | 核心职责                   |
| ------------ | --------------------------- | -------------------------- |
| **AI能力**   | extension-ai                | AI 图片/视频生成、智能编辑 |
|              | extension-image-edit        | 改图、扩图、消除、抠图     |
| **素材管理** | extension-upload            | 文件上传、素材管理         |
|              | extension-material-importer | 批量导入外部素材           |
| **效率工具** | extension-batch-design      | 批量生成、数据填充         |
|              | extension-auto-layout       | 智能布局、自动对齐         |
| **协作**     | extension-team-panel        | 团队管理、权限控制         |
|              | extension-comment           | 评论、标注、审批           |
| **UI增强**   | extension-my-panel          | 我的作品、收藏、历史       |
|              | extension-template-market   | 模板市场、灵感广场         |

---

> **下一步**：了解 [无限画布渲染引擎](./05-无限画布渲染引擎.md) 如何支撑万级元素流畅操作。
