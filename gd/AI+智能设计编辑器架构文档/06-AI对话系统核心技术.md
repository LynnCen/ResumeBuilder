# 06 - AIå¯¹è¯ç³»ç»Ÿæ ¸å¿ƒæŠ€æœ¯ â­â­â­

> **å¯¼èˆª**ï¼š[ğŸ“š è¿”å›æ€»ç›®å½•](./README.md) | [â¬…ï¸ ä¸Šä¸€ç¯‡ï¼šæ— é™ç”»å¸ƒæ¸²æŸ“å¼•æ“](./05-æ— é™ç”»å¸ƒæ¸²æŸ“å¼•æ“.md) | [â¡ï¸ ä¸‹ä¸€ç¯‡ï¼šAgentå·¥ä½œæµç¨‹](./07-Agentå·¥ä½œæµç¨‹.md)
>
> **æ‰€å±**ï¼šAI+ æ™ºèƒ½è®¾è®¡ç¼–è¾‘å™¨æ¶æ„æ–‡æ¡£
>
> **æ ¸å¿ƒä»·å€¼**ï¼šæ·±å…¥ç†è§£AIå¯¹è¯ç³»ç»Ÿçš„æ¶ˆæ¯æ ¼å¼å’ŒSSEæµå¼å¤„ç†æœºåˆ¶

---

## æœ¬ç« é‡ç‚¹

**æ‚¨å°†å­¦åˆ°**ï¼š
1. AIå¯¹è¯ç³»ç»Ÿæ”¯æŒå“ªäº›åŠŸèƒ½ï¼ˆAgentã€å›¾åƒã€è§†é¢‘ï¼‰ï¼Œå®ƒä»¬çš„æµç¨‹æœ‰ä½•ä¸åŒ
2. æ¶ˆæ¯æ ¼å¼çš„å®Œæ•´å®šä¹‰ï¼ˆæœ‰å“ªäº›æ¶ˆæ¯ç±»å‹ï¼Œå¦‚ä½•å¤„ç†ï¼‰
3. SSEæµå¼é€šä¿¡çš„æŠ€æœ¯å®ç°ï¼ˆå¦‚ä½•ç®¡ç†è¿æ¥ã€è§£ææ•°æ®ï¼‰
4. å®Œæ•´çš„æŠ€æœ¯é“¾è·¯ï¼ˆä»ç”¨æˆ·è¾“å…¥åˆ°ç”»å¸ƒè¾“å‡ºï¼‰

**ä¸åŒ…å«å†…å®¹**ï¼š
- Difyåç«¯å®ç°ï¼ˆé»‘ç›’ï¼Œä¸æ¶‰åŠï¼‰
- AIå·¥å…·å…·ä½“å®ç°ï¼ˆè§ç¬¬08ç« ï¼‰

---

## ä¸€ã€åŠŸèƒ½å…¨æ™¯ï¼šæ”¯æŒå“ªäº›AIèƒ½åŠ›ï¼Ÿ

### 1.1 ä¸‰å¤§æ ¸å¿ƒåŠŸèƒ½

ç³»ç»Ÿæ”¯æŒä¸‰ç§AIå¯¹è¯åŠŸèƒ½ï¼Œ**åº•å±‚æ¶æ„å®Œå…¨ç›¸åŒ**ï¼Œåªæ˜¯**å‚æ•°å’Œå¤„ç†é€»è¾‘ä¸åŒ**ï¼š

| åŠŸèƒ½ | æŠ€èƒ½æ ‡è¯† | å…¸å‹åœºæ™¯ | æ ¸å¿ƒç‰¹ç‚¹ |
|------|---------|---------|---------|
| **Agentå¯¹è¯** | `agent` | "å¸®æˆ‘è®¾è®¡ä¸€å¼ ç§‘æŠ€æµ·æŠ¥" | å¤šè½®å¯¹è¯ã€å·¥å…·é“¾è°ƒç”¨ã€æ€è€ƒè¿‡ç¨‹å¯è§†åŒ– |
| **å›¾åƒç”Ÿæˆ** | `image` | "ç”Ÿæˆ4å¼ ä¸åŒé£æ ¼çš„logo" | å•è½®ç”Ÿæˆã€æ”¯æŒæ‰¹é‡ã€é£æ ¼åŒ–å‚æ•° |
| **è§†é¢‘ç”Ÿæˆ** | `video` | "ç”Ÿæˆ5ç§’äº§å“å®£ä¼ è§†é¢‘" | è§†é¢‘ä¸“ç”¨å‚æ•°ã€æ—¶é•¿é™åˆ¶ |

### 1.2 æµç¨‹å¯¹æ¯”

**é—®é¢˜ï¼šè¿™ä¸‰ç§åŠŸèƒ½çš„æµç¨‹æ˜¯å¦ä¸€æ ·ï¼Ÿ**

**ç­”æ¡ˆï¼šæ ¸å¿ƒæµç¨‹å®Œå…¨ç›¸åŒï¼Œåªåœ¨å‚æ•°å±‚é¢æœ‰å·®å¼‚ã€‚**

```
ç»Ÿä¸€æµç¨‹ï¼ˆæ‰€æœ‰åŠŸèƒ½å…±äº«ï¼‰
â”œâ”€ 1. ç”¨æˆ·è¾“å…¥ â†’ æ”¶é›†å‚æ•°
â”œâ”€ 2. SSEè¿æ¥ â†’ å»ºç«‹æµå¼é€šä¿¡
â”œâ”€ 3. æ¶ˆæ¯è§£æ â†’ MessageHandlerå¤„ç†
â”œâ”€ 4. å ä½ç®¡ç† â†’ PlaceholderManageråˆ›å»ºå ä½
â”œâ”€ 5. å·¥å…·å¤„ç† â†’ ToolProcessoræ‰§è¡Œ
â””â”€ 6. ç”»å¸ƒæ¸²æŸ“ â†’ ElementAddServiceæ·»åŠ å…ƒç´ 

å·®å¼‚ç‚¹ï¼š
â”œâ”€ Agent: å¤šè½®å¯¹è¯ä¸Šä¸‹æ–‡ã€tool_callsè¿ç»­è°ƒç”¨
â”œâ”€ å›¾åƒ: æ‰¹é‡ç”Ÿæˆè¿½è¸ªï¼ˆconsecutiveFunctionCallsï¼‰
â””â”€ è§†é¢‘: è§†é¢‘ç‰¹å®šå‚æ•°ï¼ˆdurationã€fpsï¼‰
```

**ä»£ç ç¤ºä¾‹ï¼šå‚æ•°å·®å¼‚**

```typescript
// æ„é€ è¯·æ±‚å‚æ•°æ—¶çš„å·®å¼‚
function buildRequestParams(skill: string, userInput: string) {
  const baseParams = {
    query: userInput,
    scene_code: 'ai-chat',
  };

  if (skill === 'agent') {
    return {
      ...baseParams,
      arguments: {
        think: 1,        // å¯ç”¨æ·±åº¦æ€è€ƒ
        history_text: formatHistory(messages), // å†å²å¯¹è¯
      },
    };
  } else if (skill === 'image') {
    return {
      ...baseParams,
      arguments: {
        style_code: styleCode,  // é£æ ¼å‚æ•°
        ratio: '16:9',          // æ¯”ä¾‹
        batch_size: 4,          // æ‰¹é‡æ•°é‡
      },
    };
  } else if (skill === 'video') {
    return {
      ...baseParams,
      arguments: {
        duration: 5,            // æ—¶é•¿
        fps: 30,                // å¸§ç‡
      },
    };
  }
}
```

---

## äºŒã€æ¶ˆæ¯æ ¼å¼ï¼šAIå¦‚ä½•ä¸å‰ç«¯é€šä¿¡ï¼Ÿ

### 2.1 æ ¸å¿ƒæ¦‚å¿µï¼šä»€ä¹ˆæ˜¯"æ¶ˆæ¯"ï¼Ÿ

AIå¯¹è¯ç³»ç»Ÿä¸­çš„"æ¶ˆæ¯"æ˜¯æŒ‡ **ç”¨æˆ·å’ŒAIä¹‹é—´äº¤äº’çš„æ•°æ®å•å…ƒ**ã€‚å®ƒä¸ä»…åŒ…å«æ–‡æœ¬ï¼Œè¿˜åŒ…å«**è§’è‰²ã€ç±»å‹ã€çŠ¶æ€ã€å…ƒæ•°æ®**ç­‰ä¿¡æ¯ã€‚

**æ¶ˆæ¯çš„ç”Ÿå‘½å‘¨æœŸ**ï¼š

```
åˆ›å»º â†’ å‘é€ â†’ æ¥æ”¶ â†’ è§£æ â†’ å¤„ç† â†’ å±•ç¤º
```

### 2.2 æ¶ˆæ¯çš„å®Œæ•´ç»“æ„

**åŸºç¡€æ¥å£å®šä¹‰**ï¼š

```typescript
// src/types/message.ts
export interface MessageType extends Partial<Message> {
  // æ ¸å¿ƒå­—æ®µ
  role: string;              // æ¶ˆæ¯è§’è‰²
  content: MessageContent;   // æ¶ˆæ¯å†…å®¹
  messageId: string;         // æ¶ˆæ¯å”¯ä¸€ID
  
  // çŠ¶æ€å­—æ®µ
  status: string;            // æ¶ˆæ¯çŠ¶æ€
  event?: string;            // äº‹ä»¶ç±»å‹
  
  // å…ƒæ•°æ®å­—æ®µ
  extra?: Record<string, any>; // æ‰©å±•ä¿¡æ¯ï¼ˆå·¥å…·ç»“æœã€ä»»åŠ¡IDç­‰ï¼‰
  $senderParams?: SenderParams; // å‘é€è€…å‚æ•°
  
  // æ‰¹é‡ç›¸å…³
  functionCalls?: MessageType[]; // æ‰¹é‡å·¥å…·è°ƒç”¨ï¼ˆèšåˆæ˜¾ç¤ºï¼‰
}

export interface MessageContent {
  type: string;    // å†…å®¹ç±»å‹
  text: string;    // æ–‡æœ¬å†…å®¹
}

export interface SenderParams {
  prompt: string;         // ç”¨æˆ·è¾“å…¥
  skill?: string;         // æŠ€èƒ½ç±»å‹
  styleCode?: string;     // é£æ ¼ä»£ç 
  ratio?: string;         // æ¯”ä¾‹
  attachments?: any[];    // é™„ä»¶ï¼ˆå›¾ç‰‡/è§†é¢‘ï¼‰
}
```

### 2.3 æ¶ˆæ¯è§’è‰²ï¼ˆroleï¼‰

**å®šä¹‰**ï¼šæ ‡è¯†æ¶ˆæ¯çš„å‘é€è€…èº«ä»½ã€‚

```typescript
// src/config/constants.ts
export const MESSAGE_ROLE = {
  USER: 'user',              // ç”¨æˆ·æ¶ˆæ¯
  ASSISTANT: 'assistant',    // AIåŠ©æ‰‹æ¶ˆæ¯
  FUNCTION: 'function',      // å·¥å…·å“åº”æ¶ˆæ¯
  STATUS: 'status',          // çŠ¶æ€æ¶ˆæ¯ï¼ˆé”™è¯¯ã€æ’¤é”€ç­‰ï¼‰
  HEARTBEAT: 'heartbeat',    // å¿ƒè·³æ¶ˆæ¯ï¼ˆä¿æŒè¿æ¥ï¼‰
} as const;
```

**å„è§’è‰²çš„ä½œç”¨**ï¼š

| è§’è‰² | è¯´æ˜ | å…¸å‹åœºæ™¯ | æ˜¯å¦å±•ç¤º |
|------|------|---------|---------|
| `user` | ç”¨æˆ·å‘é€çš„æ¶ˆæ¯ | ç”¨æˆ·è¾“å…¥æç¤ºè¯ | âœ… å±•ç¤º |
| `assistant` | AIåŠ©æ‰‹çš„å›å¤ | AIæ–‡æœ¬å›å¤ã€å·¥å…·è°ƒç”¨å£°æ˜ | âœ… å±•ç¤º |
| `function` | å·¥å…·æ‰§è¡Œåçš„å“åº” | å›¾ç‰‡ç”Ÿæˆç»“æœã€æ–‡æ¡ˆç”Ÿæˆç»“æœ | âŒ ä¸å±•ç¤ºï¼ˆå†…éƒ¨æ¶ˆæ¯ï¼‰ |
| `status` | ç³»ç»ŸçŠ¶æ€é€šçŸ¥ | é”™è¯¯æç¤ºã€ç¨¿è±†ä¸è¶³ | âœ… å±•ç¤ºï¼ˆé”™è¯¯æ—¶ï¼‰ |
| `heartbeat` | å¿ƒè·³ä¿æ´» | é•¿æ—¶é—´è¿æ¥ä¿æŒæ´»è·ƒ | âŒ ä¸å±•ç¤º |

### 2.4 æ¶ˆæ¯å†…å®¹ç±»å‹ï¼ˆcontent.typeï¼‰

**å®šä¹‰**ï¼šæ ‡è¯†æ¶ˆæ¯å†…å®¹çš„å…·ä½“ç±»å‹ã€‚

```typescript
// å¸¸è§çš„ content.type å€¼
type ContentType = 
  | 'text'              // çº¯æ–‡æœ¬ï¼ˆç”¨æˆ·è¾“å…¥ã€AIå›å¤ï¼‰
  | 'function_call'     // å·¥å…·è°ƒç”¨å£°æ˜ï¼ˆAIå†³å®šè°ƒç”¨å“ªä¸ªå·¥å…·ï¼‰
  | 'function_response' // å·¥å…·å“åº”ï¼ˆå·¥å…·æ‰§è¡Œç»“æœï¼‰
  | 'reasoning'         // æ¨ç†è¿‡ç¨‹ï¼ˆDeepSeek R1æ€è€ƒè¿‡ç¨‹ï¼‰
  | 'plain'             // æ™®é€šæ–‡æœ¬ï¼ˆç³»ç»Ÿæç¤ºï¼‰
  | 'system';           // ç³»ç»Ÿæ¶ˆæ¯ï¼ˆé”™è¯¯æç¤ºï¼‰
```

**å„ç±»å‹çš„ä½œç”¨**ï¼š

| ç±»å‹ | è¯´æ˜ | content.textæ ¼å¼ | ç¤ºä¾‹ |
|------|------|-----------------|------|
| `text` | æ™®é€šæ–‡æœ¬ | å­—ç¬¦ä¸² | "å¥½çš„ï¼Œæˆ‘æ¥å¸®æ‚¨ç”Ÿæˆ" |
| `function_call` | å·¥å…·è°ƒç”¨ | JSONå­—ç¬¦ä¸² | `{"name":"å›¾ç‰‡ç”Ÿæˆ","arguments":"..."}` |
| `function_response` | å·¥å…·ç»“æœ | JSONæ•°ç»„ | `[{"uri":"https://...","width":1920}]` |
| `reasoning` | R1æ€è€ƒ | å¸¦&lt;thinking&gt;æ ‡ç­¾çš„æ–‡æœ¬ | `&lt;thinking&gt;æˆ‘éœ€è¦...&lt;/thinking&gt;` |
| `plain` | çº¯æ–‡æœ¬ | å­—ç¬¦ä¸² | "ç³»ç»Ÿç¹å¿™ï¼Œè¯·ç¨åé‡è¯•" |
| `system` | ç³»ç»Ÿé”™è¯¯ | JSONå­—ç¬¦ä¸² | `{"code":-1001,"message":"..."}` |

### 2.5 æ¶ˆæ¯çŠ¶æ€ï¼ˆstatusï¼‰

**å®šä¹‰**ï¼šæ ‡è¯†æ¶ˆæ¯çš„å¤„ç†çŠ¶æ€ã€‚

```typescript
export const MESSAGE_STATUS = {
  WAITING: 'waiting',      // ç­‰å¾…å¤„ç†
  LOADING: 'loading',      // å¤„ç†ä¸­
  FINISHED: 'finished',    // å·²å®Œæˆ
  STOP: 'stop',            // å·²åœæ­¢
};
```

**çŠ¶æ€æµè½¬**ï¼š

```
waiting â†’ loading â†’ finished
   â†“          â†“
  stop  â†  stop
```

**å„çŠ¶æ€çš„å±•ç¤ºæ•ˆæœ**ï¼š

| çŠ¶æ€ | å±•ç¤ºæ•ˆæœ | å…¸å‹åœºæ™¯ |
|------|---------|---------|
| `waiting` | ç°è‰²ï¼Œæ— åŠ¨ç”» | åˆšåˆ›å»ºæ¶ˆæ¯ï¼Œè¿˜æœªå¼€å§‹å¤„ç† |
| `loading` | åŠ è½½åŠ¨ç”»ï¼ˆè½¬åœˆåœˆï¼‰ | SSEæµå¼è¿”å›ä¸­ï¼Œå†…å®¹é€æ­¥æ›´æ–° |
| `finished` | æ­£å¸¸æ˜¾ç¤º | æ¶ˆæ¯å¤„ç†å®Œæˆï¼Œå¯ä»¥å±•ç¤º |
| `stop` | æ˜¾ç¤º"å·²åœæ­¢"æ ‡è¯† | ç”¨æˆ·æ‰‹åŠ¨åœæ­¢ç”Ÿæˆ |

### 2.6 å…¸å‹æ¶ˆæ¯ç¤ºä¾‹

**ç¤ºä¾‹1ï¼šç”¨æˆ·æ¶ˆæ¯**

```text
{
  "role": "user",
  "content": {
    "type": "text",
    "text": "å¸®æˆ‘ç”Ÿæˆä¸€å¼ æ˜¥å¤©çš„é£æ™¯ç…§ï¼Œ16:9"
  },
  "messageId": "msg_user_001",
  "status": "finished",
  "$senderParams": {
    "prompt": "å¸®æˆ‘ç”Ÿæˆä¸€å¼ æ˜¥å¤©çš„é£æ™¯ç…§ï¼Œ16:9",
    "skill": "image",
    "ratio": "16:9",
    "styleCode": "realistic"
  }
}
```

**ç¤ºä¾‹2ï¼šAIå·¥å…·è°ƒç”¨æ¶ˆæ¯**

```typescript
{
  role: 'assistant',
  content: {
    type: 'function_call',
    text: '{"name":"å›¾ç‰‡ç”Ÿæˆ","arguments":"{\\"prompt\\":\\"æ˜¥å¤©çš„é£æ™¯ç…§\\",\\"ratio\\":\\"16:9\\"}"}'
  },
  messageId: 'msg_ai_001',
  status: 'loading',
  extra: {},
  functionCalls: []  // ç”¨äºèšåˆæ‰¹é‡è°ƒç”¨
}
```

**ç¤ºä¾‹3ï¼šå·¥å…·å“åº”æ¶ˆæ¯**

```typescript
{
  role: 'function',
  content: {
    type: 'function_response',
    text: '[{"uri":"https://cdn.com/img.jpg","width":1920,"height":1080}]'
  },
  name: 'å›¾ç‰‡ç”Ÿæˆ',  // å·¥å…·åç§°
  messageId: 'msg_tool_001',
  status: 'finished',
  extra: {
    taskId: 'task_xxx',          // AIä»»åŠ¡ID
    lastToolMessageId: 'msg_ai_001',  // å…³è”çš„function_call ID
    deduct_points: 10            // æ‰£é™¤çš„ç¨¿è±†
  }
}
```

**ç¤ºä¾‹4ï¼šR1æ€è€ƒæ¶ˆæ¯**

```typescript
{
  role: 'assistant',
  content: {
    type: 'reasoning',
    text: '<thinking>\næˆ‘éœ€è¦åˆ†æç”¨æˆ·çš„éœ€æ±‚...\nç”¨æˆ·æƒ³è¦æ˜¥å¤©çš„é£æ™¯ç…§ï¼Œ16:9æ¯”ä¾‹...\n</thinking>'
  },
  messageId: 'msg_reasoning_001',
  status: 'loading',
  thinkingElapsedMs: 3500  // æ€è€ƒè€—æ—¶3.5ç§’
}
```

---

## ä¸‰ã€SSEæµå¼é€šä¿¡ï¼šå¦‚ä½•å®ç°å®æ—¶å“åº”ï¼Ÿ

### 3.1 ä¸ºä»€ä¹ˆé€‰æ‹©SSEï¼Ÿ

**é—®é¢˜ï¼šAIç”Ÿæˆéœ€è¦10-30ç§’ï¼Œå¦‚ä½•è®©ç”¨æˆ·æ„Ÿè§‰ä¸ç­‰å¾…ï¼Ÿ**

**å¯¹æ¯”æ–¹æ¡ˆ**ï¼š

| æ–¹æ¡ˆ | ä¼˜ç‚¹ | ç¼ºç‚¹ | ç»“è®º |
|------|------|------|------|
| **è½®è¯¢** | ç®€å•ï¼Œå…¼å®¹æ€§å¥½ | æµªè´¹å¸¦å®½ï¼Œå»¶è¿Ÿé«˜ï¼ˆ1-2ç§’ï¼‰ | âŒ ä¸é‡‡ç”¨ |
| **é•¿è½®è¯¢** | å‡å°‘è¯·æ±‚æ¬¡æ•° | ä»æœ‰å»¶è¿Ÿï¼ŒæœåŠ¡å™¨å‹åŠ›å¤§ | âŒ ä¸é‡‡ç”¨ |
| **WebSocket** | åŒå‘é€šä¿¡ï¼Œå®æ—¶æ€§é«˜ | å¤æ‚åº¦é«˜ï¼Œéœ€è¦ç»´æŠ¤è¿æ¥çŠ¶æ€ | âš ï¸ å¤‡é€‰ |
| **SSE** | æœåŠ¡ç«¯æ¨é€ï¼Œç®€å•é«˜æ•ˆ | ä»…å•å‘ï¼ˆå¤Ÿç”¨ï¼‰ | âœ… é‡‡ç”¨ |

**SSEçš„ä¼˜åŠ¿**ï¼š

```
âœ… åŸºäºHTTPï¼Œæ— éœ€ç‰¹æ®Šåè®®
âœ… è‡ªåŠ¨é‡è¿ï¼ˆæµè§ˆå™¨åŸç”Ÿæ”¯æŒï¼‰
âœ… è½»é‡çº§ï¼Œæ˜“äºå®ç°
âœ… æ”¯æŒæµå¼ä¼ è¾“ï¼ˆé€å­—æ˜¾ç¤ºï¼‰
âœ… æœåŠ¡ç«¯æ¨é€ï¼ˆæ— éœ€å‰ç«¯è½®è¯¢ï¼‰
```

### 3.2 SSEè¿æ¥ç®¡ç†

**æ ¸å¿ƒç±»ï¼šSSEManager**

```typescript
// src/services/sse-manager.ts
export class SSEManager {
  private connection: any;
  private options: SSEManagerOptions;

  constructor(options: SSEManagerOptions) {
    this.options = options;
  }

  // å»ºç«‹SSEè¿æ¥
  public async connect(
    messages: MessageType[],
    isOnline: boolean,
    events: ChatOptions['events']
  ) {
    try {
      // 1. åˆ›å»ºSSEè¿æ¥ï¼ˆfetch + ReadableStreamï¼‰
      this.connection = await createSSEConnection({
        onError: async (data) => {
          // å¤„ç†é”™è¯¯ï¼ˆå¦‚401éœ€è¦é‡æ–°ç™»å½•ï¼‰
          if (data.code === 401) {
            const loginResult = await chatConfigInstance.login?.();
            if (!loginResult) {
              this.close();
              this.options.onError(data);
            }
            return;
          }
          this.options.onError(data);
        },
        messageList: messages,  // å†å²æ¶ˆæ¯
        isOnline,
        events,
      });

      // 2. ç›‘å¬SSEæµ
      if (this.connection?.listen) {
        this.connection.listen(this.options.onMessage);
      }
    } catch (error) {
      this.options.onError(error);
    }
  }

  // å…³é—­è¿æ¥
  public close(needStop = false) {
    try {
      this.connection?.close(needStop);
      this.options.onClose?.();
    } catch (error) {
      console.error('Failed to close SSE connection:', error);
    }
  }
}
```

**ä½¿ç”¨ç¤ºä¾‹**ï¼š

```typescript
// åœ¨ChatWrapä¸­ä½¿ç”¨
const sseManager = new SSEManager({
  onMessage: (data) => {
    // æ”¶åˆ°SSEæ•°æ®åï¼Œäº¤ç»™MessageHandlerå¤„ç†
    messageHandler.handleSSEMessage(data.data, data.done);
  },
  onError: (error) => {
    // é”™è¯¯å¤„ç†
    showErrorToast('ç”Ÿæˆå¤±è´¥ï¼Œè¯·é‡è¯•');
  },
  onClose: () => {
    // è¿æ¥å…³é—­
    console.log('SSEè¿æ¥å·²å…³é—­');
  },
});

// å»ºç«‹è¿æ¥
await sseManager.connect(messages, isOnline, events);

// ç”¨æˆ·å–æ¶ˆæ—¶å…³é—­è¿æ¥
sseManager.close(true);
```

### 3.3 SSEè¿æ¥çš„åº•å±‚å®ç°

**æ ¸å¿ƒå‡½æ•°ï¼šcreateSSEConnection**

```typescript
// src/services/sse.ts
export async function createSSEConnection(options: {
  messageList?: MessageType[];
  onError: (data: any) => void;
  isOnline: boolean;
  events: ChatOptions['events'];
}) {
  const { onError, messageList, isOnline } = options;

  // 1. æ£€æŸ¥ç½‘ç»œçŠ¶æ€
  if (!isOnline) {
    onError({ event: 'system_error', content: { text: 'ç½‘ç»œé”™è¯¯' } });
    return;
  }

  // 2. è·å–æˆæƒä¿¡æ¯
  const authorization = await getAuthorization();

  // 3. å‘é€POSTè¯·æ±‚
  const response = await fetch(sseBaseUrl, {
    signal: controller.signal,
    method: 'post',
    credentials: 'include',
    body: JSON.stringify({
      content: messageList[0].content,
      role: messageList[0].role,
      local_thread_id: threadId ? '' : uuidv4(),
      local_message_id: uuidv4(),
      thread_id: threadId,
      attachments: messageList[0]?.attachments || [],
      extra: messageList[0]?.extra || {},
    }),
    headers: {
      'Content-Type': 'application/json',
      'Authorization': authorization,
      'x-content-id': contentId,
      'x-user-id': userId,
    },
  });

  // 4. æ£€æŸ¥å“åº”çŠ¶æ€
  if (!response.ok || !response.body) {
    onError({ event: 'system_error', content: { text: 'ç³»ç»Ÿé”™è¯¯' } });
    return;
  }

  // 5. è¿”å›æµå¼è¯»å–æ¥å£
  return {
    async listen(callBack: (data: any) => void) {
      try {
        // ä½¿ç”¨XStreamå¤„ç†æµå¼æ•°æ®
        for await (const chunk of XStream({
          readableStream: response.body,
          transformStream: createCustomTransformStream(),
        })) {
          callBack(chunk);
          if (chunk.done) break;
        }
      } catch (error) {
        onError({ event: 'system_error', content: { text: 'è¿æ¥å¼‚å¸¸' } });
      }
    },
    close(needStop = false) {
      if (needStop) {
        // å‘é€åœæ­¢è¯·æ±‚
        fetch(`${sseBaseUrl}/stop`, {
          method: 'post',
          body: JSON.stringify({ thread_id: threadId }),
        });
      }
      controller.abort();  // ä¸­æ­¢fetchè¯·æ±‚
    },
  };
}
```

### 3.4 æµå¼æ•°æ®è§£æ

**æ ¸å¿ƒæŠ€æœ¯ï¼šTransform Stream**

```typescript
// è‡ªå®šä¹‰TransformStreamï¼Œç”¨äºå¤„ç†JSONåºåˆ—
const createCustomTransformStream = (): TransformStream<
  string,
  { done: boolean; data: MessageType[] }
> => {
  let buffer = '';  // ç¼“å­˜ä¸å®Œæ•´çš„JSON

  return new TransformStream({
    transform(chunk: string, controller) {
      try {
        let text = chunk;
        if (buffer) {
          text = buffer + text;  // æ‹¼æ¥ä¸Šæ¬¡çš„ä¸å®Œæ•´æ•°æ®
        }

        try {
          // å°è¯•ç›´æ¥è§£æå®Œæ•´JSON
          const data = JSON.parse(text);
          controller.enqueue({ done: false, data });
          buffer = '';
        } catch {
          // è§£æå¤±è´¥ï¼Œå°è¯•å¤„ç†JSONåºåˆ—
          const jsonList = parseJsonSequence<MessageType[]>(text);
          if (jsonList.length === 0) {
            buffer = text;  // ä¸å®Œæ•´ï¼Œç¼“å­˜èµ·æ¥
          } else {
            const lastItem = jsonList.flat();
            controller.enqueue({ done: false, data: lastItem });
            buffer = '';
          }
        }
      } catch (error) {
        console.error('Transform error:', error);
      }
    },
    flush(controller) {
      // æµç»“æŸæ—¶å‘é€å®Œæˆä¿¡å·
      controller.enqueue({ done: true, data: [] });
    },
  });
};
```

**ä¸ºä»€ä¹ˆéœ€è¦bufferï¼Ÿ**

```
SSEæµå¼è¿”å›çš„æ•°æ®å¯èƒ½è¢«åˆ†å‰²ï¼š

ç¬¬1æ¬¡read: '{"role":"assist'
ç¬¬2æ¬¡read: 'ant","content":"hello"}'

å¦‚æœç›´æ¥JSON.parseï¼Œç¬¬1æ¬¡ä¼šå¤±è´¥ã€‚
è§£å†³æ–¹æ¡ˆï¼š
  - ç¬¬1æ¬¡ï¼šç¼“å­˜åˆ°buffer
  - ç¬¬2æ¬¡ï¼šbuffer + æ–°æ•°æ® â†’ å®Œæ•´JSON â†’ è§£ææˆåŠŸ
```

**JSONåºåˆ—è§£æ**ï¼š

```typescript
// å¤„ç†å¤šä¸ªJSONå¯¹è±¡è¿ç»­å‡ºç°çš„æƒ…å†µ
// è¾“å…¥: '{"a":1}{"b":2}{"c":3}'
// è¾“å‡º: [{a:1}, {b:2}, {c:3}]
function parseJsonSequence<T>(text: string): T[] {
  const result: T[] = [];
  let depth = 0;
  let start = 0;

  for (let i = 0; i < text.length; i++) {
    if (text[i] === '{') {
      if (depth === 0) start = i;
      depth++;
    } else if (text[i] === '}') {
      depth--;
      if (depth === 0) {
        try {
          const json = JSON.parse(text.slice(start, i + 1));
          result.push(json);
        } catch (e) {
          // å¿½ç•¥è§£æå¤±è´¥çš„ç‰‡æ®µ
        }
      }
    }
  }

  return result;
}
```

### 3.5 SSEæ•°æ®æ ¼å¼

**å…¸å‹çš„SSEäº‹ä»¶æµ**ï¼š

```text
data: {"event":"workflow_started","task_id":"task_xxx"}

data: {"event":"message","role":"assistant","content":{"type":"text","text":"å¥½çš„"}}

data: {"event":"message","role":"assistant","content":{"type":"function_call","text":"{\"name\":\"å›¾ç‰‡ç”Ÿæˆ\",\"arguments\":\"...\"}"}}

data: {"event":"message","role":"function","content":{"type":"function_response","text":"[{\"uri\":\"...\"}]"},"extra":{"taskId":"task_xxx"}}

data: {"event":"workflow_finished","task_id":"task_xxx"}
```

**äº‹ä»¶ç±»å‹**ï¼š

| äº‹ä»¶ | è¯´æ˜ | ä½•æ—¶è§¦å‘ |
|------|------|---------|
| `workflow_started` | å·¥ä½œæµå¼€å§‹ | åç«¯å¼€å§‹å¤„ç†è¯·æ±‚ |
| `message` | æ¶ˆæ¯æ¨é€ | AIé€æ­¥è¾“å‡ºå†…å®¹ |
| `system_error` | ç³»ç»Ÿé”™è¯¯ | ç”Ÿæˆå¤±è´¥ã€ç½‘ç»œå¼‚å¸¸ |
| `workflow_finished` | å·¥ä½œæµç»“æŸ | æ•´ä¸ªæµç¨‹å®Œæˆ |

---

## å››ã€æ¶ˆæ¯å¤„ç†ï¼šMessageHandleræ ¸å¿ƒé€»è¾‘

### 4.1 MessageHandlerçš„èŒè´£

```
SSEè¿”å›çš„æ˜¯åŸå§‹æ•°æ®æµï¼Œéœ€è¦MessageHandlerè¿›è¡Œï¼š
1. æ¶ˆæ¯è¯†åˆ«ï¼ˆåŒºåˆ†æ–‡æœ¬ã€å·¥å…·è°ƒç”¨ã€å·¥å…·å“åº”ç­‰ï¼‰
2. çŠ¶æ€ç®¡ç†ï¼ˆè¿½è¸ªæ¶ˆæ¯çš„å¤„ç†çŠ¶æ€ï¼‰
3. æ‰¹é‡è¿½è¸ªï¼ˆä¸€æ¬¡ç”Ÿæˆå¤šå¼ å›¾æ—¶çš„è®¡æ•°ï¼‰
4. æ¶ˆæ¯è¿‡æ»¤ï¼ˆå“ªäº›éœ€è¦å±•ç¤ºï¼Œå“ªäº›æ˜¯å†…éƒ¨æ¶ˆæ¯ï¼‰
5. äº‹ä»¶è§¦å‘ï¼ˆé€šçŸ¥ç”»å¸ƒæ·»åŠ å…ƒç´ ã€æ›´æ–°UIç­‰ï¼‰
```

### 4.2 å¤„ç†æµç¨‹

```typescript
// src/services/message-handler.ts
export class MessageHandler {
  private messages: MessageType[] = [];  // æ‰€æœ‰æ¶ˆæ¯
  private filteredMessages: MessageType[] = [];  // è¿‡æ»¤åå±•ç¤ºçš„æ¶ˆæ¯
  private consecutiveFunctionCalls: Map<string, ConsecutiveFunctionCallTracking[]> = new Map();  // æ‰¹é‡è¿½è¸ª

  // æ ¸å¿ƒæ–¹æ³•ï¼šå¤„ç†SSEæ¶ˆæ¯æµ
  public handleSSEMessage(data: MessageType[], done: boolean) {
    if (done) {
      this.finishMessages();  // æµç»“æŸï¼Œå®Œæˆæ‰€æœ‰æ¶ˆæ¯
      return;
    }

    // é€ä¸ªå¤„ç†æ¶ˆæ¯
    data.forEach((item) => this.processMessage(item));
    
    // é€šçŸ¥å¤–éƒ¨æ›´æ–°UI
    this.onUpdateMessages();
  }

  // å¤„ç†å•æ¡æ¶ˆæ¯
  private processMessage(item: MessageType) {
    // 1. å¿½ç•¥å¿ƒè·³æ¶ˆæ¯
    if (item.role === MESSAGE_ROLE.HEARTBEAT) {
      return;
    }

    // 2. å¤„ç†ç³»ç»Ÿé”™è¯¯
    if (item.event === 'system_error') {
      this.handleSystemMessage(item);
      return;
    }

    // 3. å¤„ç†çŠ¶æ€æ¶ˆæ¯ï¼ˆé”™è¯¯ã€æ’¤é”€ç­‰ï¼‰
    if (item.role === MESSAGE_ROLE.STATUS) {
      this.handleStatusMessage(item);
      return;
    }

    // 4. æŸ¥æ‰¾æ¶ˆæ¯æ˜¯å¦å·²å­˜åœ¨
    const existMessage = this.findExistMessage(item.messageId);
    
    if (existMessage) {
      // æ›´æ–°å·²å­˜åœ¨çš„æ¶ˆæ¯
      this.updateExistingMessage(existMessage, item);
    } else {
      // åˆ›å»ºæ–°æ¶ˆæ¯
      this.createNewMessage(item);
    }

    // 5. è·Ÿè¸ªæ‰¹é‡ç”Ÿæˆ
    this.trackConsecutiveFunctionCall(item);
  }
}
```

### 4.3 æ‰¹é‡ç”Ÿæˆè¿½è¸ªæœºåˆ¶ï¼ˆæ ¸å¿ƒäº®ç‚¹ï¼‰

**åœºæ™¯**ï¼šç”¨æˆ·è¯´"ç”Ÿæˆ4å¼ ä¸åŒé£æ ¼çš„logo"

**é—®é¢˜**ï¼š
```
AIä¼šè¿”å›4ä¸ªfunction_callå’Œ4ä¸ªfunction_response
å¦‚ä½•çŸ¥é“ä»€ä¹ˆæ—¶å€™å…¨éƒ¨å®Œæˆï¼Ÿ
å¦‚ä½•åœ¨UIä¸Šç»Ÿä¸€æ˜¾ç¤ºè¿™4å¼ å›¾ï¼Ÿ
```

**è§£å†³æ–¹æ¡ˆï¼šconsecutiveFunctionCalls**

```typescript
// æ•°æ®ç»“æ„
interface ConsecutiveFunctionCallTracking {
  startTime: number;              // å¼€å§‹æ—¶é—´æˆ³
  expectedResponses: number;      // æœŸæœ›å“åº”æ•°é‡ï¼ˆå¦‚4ï¼‰
  receivedResponses: number;      // å·²æ”¶åˆ°å“åº”æ•°é‡ï¼ˆå¦‚2ï¼‰
  messageIds: Set<string>;        // å…³è”çš„function_call IDé›†åˆ
  isCompleted: boolean;           // æ˜¯å¦å·²å®Œæˆ
  parentMessageId: string;        // çˆ¶æ¶ˆæ¯IDï¼ˆç¬¬ä¸€ä¸ªfunction_callï¼‰
}

// è¿½è¸ªé€»è¾‘
private trackConsecutiveFunctionCall(item: MessageType) {
  // åªå¤„ç†function_callæ¶ˆæ¯
  if (item.role === MESSAGE_ROLE.ASSISTANT && item.content.type === 'function_call') {
    const content = JSON.parse(item.content.text);
    const functionName = content.name;  // å¦‚"å›¾ç‰‡ç”Ÿæˆ"

    if (!this.consecutiveFunctionCalls.has(functionName)) {
      // ç¬¬1ä¸ªfunction_callï¼šåˆ›å»ºè¿½è¸ªè®°å½•
      this.consecutiveFunctionCalls.set(functionName, [{
        startTime: Date.now(),
        expectedResponses: 1,
        receivedResponses: 0,
        messageIds: new Set([item.messageId]),
        parentMessageId: item.messageId,
        isCompleted: false,
      }]);
    } else {
      // åç»­function_callï¼šæ›´æ–°è¿½è¸ªè®°å½•
      const trackings = this.consecutiveFunctionCalls.get(functionName)!;
      const tracking = trackings.find(it => it.messageIds.size < 6 && !it.isCompleted);
      
      if (tracking) {
        tracking.messageIds.add(item.messageId);
        tracking.expectedResponses = tracking.messageIds.size;  // æ›´æ–°æœŸæœ›æ•°é‡
        
        // å¦‚æœè¾¾åˆ°6ä¸ªï¼Œæ ‡è®°ä¸ºå·²å®Œæˆï¼ˆæœ€å¤š6ä¸ªä¸€æ‰¹ï¼‰
        if (tracking.messageIds.size === 6) {
          tracking.isCompleted = true;
        }
      }
    }

    // æ›´æ–°UIæ¸²æŸ“ç”¨çš„functionCallsæ•°ç»„
    this.updateFunctionCallsForRendering(tracking);
  }
}

// æ£€æŸ¥å“åº”å®Œæˆ
private checkConsecutiveFunctionResponse(item: MessageType) {
  if (item.role === MESSAGE_ROLE.FUNCTION && item.content.type === 'function_response') {
    const trackings = this.consecutiveFunctionCalls.get(item.name);
    const tracking = trackings.find(it => it.messageIds.has(item.extra?.lastToolMessageId));
    
    if (tracking) {
      tracking.receivedResponses += 1;
      
      // æ£€æŸ¥æ˜¯å¦å…¨éƒ¨å®Œæˆ
      if (tracking.receivedResponses >= tracking.expectedResponses) {
        // è§¦å‘æ‰¹é‡å®Œæˆäº‹ä»¶
        events.emit('generateCompleted', {
          total_elapsed_time: Date.now() - tracking.startTime,
          count: tracking.receivedResponses,
        });
      }
    }
  }
}
```

**UIå±•ç¤ºæ•ˆæœ**ï¼š

```
ç¬¬1ä¸ªfunction_callåˆ°è¾¾ï¼š
  [å›¾ç‰‡1-åŠ è½½ä¸­]

ç¬¬2ä¸ªfunction_callåˆ°è¾¾ï¼ˆè¿ç»­ï¼‰ï¼š
  [å›¾ç‰‡1-åŠ è½½ä¸­] [å›¾ç‰‡2-åŠ è½½ä¸­]

ç¬¬3ã€4ä¸ªfunction_callåˆ°è¾¾ï¼š
  [å›¾ç‰‡1-åŠ è½½ä¸­] [å›¾ç‰‡2-åŠ è½½ä¸­] [å›¾ç‰‡3-åŠ è½½ä¸­] [å›¾ç‰‡4-åŠ è½½ä¸­]

ç¬¬1ä¸ªfunction_responseåˆ°è¾¾ï¼š
  [å›¾ç‰‡1-å®Œæˆâœ…] [å›¾ç‰‡2-åŠ è½½ä¸­] [å›¾ç‰‡3-åŠ è½½ä¸­] [å›¾ç‰‡4-åŠ è½½ä¸­]

å…¨éƒ¨å®Œæˆï¼š
  [å›¾ç‰‡1-å®Œæˆâœ…] [å›¾ç‰‡2-å®Œæˆâœ…] [å›¾ç‰‡3-å®Œæˆâœ…] [å›¾ç‰‡4-å®Œæˆâœ…]
  â†’ è§¦å‘ generateCompleted äº‹ä»¶
  â†’ æ˜¾ç¤ºï¼š"å·²ä¸ºæ‚¨ç”Ÿæˆ4å¼ å›¾ç‰‡"
```

### 4.4 æ¶ˆæ¯è¿‡æ»¤é€»è¾‘

**é—®é¢˜ï¼šå“ªäº›æ¶ˆæ¯éœ€è¦å±•ç¤ºç»™ç”¨æˆ·ï¼Ÿ**

```typescript
private filterMessages() {
  this.filteredMessages = this.messages.filter((message, idx) => {
    const isLastMessage = idx === this.messages.length - 1;

    // âŒ å·²å®Œæˆçš„æ¨ç†æ¶ˆæ¯ï¼ˆä¸å±•ç¤ºï¼‰
    const isFinishedReasoningMessage =
      message.content.type === 'reasoning' && message.status === MESSAGE_STATUS.FINISHED;

    // âŒ function_responseæ¶ˆæ¯ï¼ˆå†…éƒ¨æ¶ˆæ¯ï¼Œä¸å±•ç¤ºï¼‰
    const isFunctionCallMessage = message.role === MESSAGE_ROLE.FUNCTION;

    // âŒ å¿ƒè·³æ¶ˆæ¯ï¼ˆä¸å±•ç¤ºï¼‰
    const isHeartbeatMessage = message.role === MESSAGE_ROLE.HEARTBEAT;

    // âŒ ç©ºè¡Œæ¶ˆæ¯ï¼ˆä¸å±•ç¤ºï¼‰
    const isDoubleBreakLine = message.content.text === '\n\n';

    // âŒ çŠ¶æ€æ¶ˆæ¯ï¼ˆä¸å±•ç¤ºï¼Œé™¤éæ˜¯æœ€åä¸€æ¡ä¸”æ˜¯ä»˜è´¹æç¤ºï¼‰
    const isStatusMessage = message.role === MESSAGE_ROLE.STATUS;

    // âŒ æ²¡æœ‰functionCallsçš„function_callæ¶ˆæ¯ï¼ˆä¸å±•ç¤ºï¼‰
    const noFunctionCalls =
      message.content.type === 'function_call' && message.functionCalls?.length === 0;

    // è¿”å›éœ€è¦å±•ç¤ºçš„æ¶ˆæ¯
    return (
      !isFinishedReasoningMessage &&
      !isFunctionCallMessage &&
      !isHeartbeatMessage &&
      !isDoubleBreakLine &&
      !isStatusMessage &&
      !noFunctionCalls
    );
  });
}
```

**è¿‡æ»¤åŸåˆ™**ï¼š

```
âœ… å±•ç¤ºç»™ç”¨æˆ·ï¼š
  - ç”¨æˆ·å‘çš„æ¶ˆæ¯ï¼ˆuserï¼‰
  - AIçš„æ–‡æœ¬å›å¤ï¼ˆassistant + textï¼‰
  - å·¥å…·è°ƒç”¨ç»“æœï¼ˆfunction_call + functionCallsæ•°ç»„ï¼‰
  - é”™è¯¯æç¤ºï¼ˆstatusï¼‰

âŒ ä¸å±•ç¤ºï¼ˆå†…éƒ¨æ¶ˆæ¯ï¼‰ï¼š
  - function_responseï¼ˆåŸå§‹å·¥å…·å“åº”ï¼‰
  - å¿ƒè·³æ¶ˆæ¯ï¼ˆä¿æŒè¿æ¥ç”¨ï¼‰
  - å·²å®Œæˆçš„reasoningï¼ˆæ€è€ƒè¿‡ç¨‹ç»“æŸåéšè—ï¼‰
  - ç©ºè¡Œæ¶ˆæ¯ï¼ˆæ— æ„ä¹‰ï¼‰
```

---

## äº”ã€å®Œæ•´æŠ€æœ¯é“¾è·¯æ€»ç»“

### 5.1 ä»ç”¨æˆ·è¾“å…¥åˆ°ç”»å¸ƒè¾“å‡ºçš„å®Œæ•´æµç¨‹

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 1. ç”¨æˆ·è¾“å…¥é˜¶æ®µ                                            â”‚
â”‚    ChatSenderæ”¶é›†å‚æ•° â†’ emit('submit', params)           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 2. SSEè¿æ¥é˜¶æ®µ                                             â”‚
â”‚    SSEManager.connect() â†’ createSSEConnection()           â”‚
â”‚    â†’ fetch + ReadableStream â†’ XStream                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 3. æµå¼è§£æé˜¶æ®µ                                            â”‚
â”‚    TransformStream â†’ parseJsonSequence()                  â”‚
â”‚    â†’ é€ä¸ªJSONå¯¹è±¡æ¨é€ â†’ callback(data)                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 4. æ¶ˆæ¯å¤„ç†é˜¶æ®µ                                            â”‚
â”‚    MessageHandler.handleSSEMessage()                      â”‚
â”‚    â†’ processMessage() â†’ è¯†åˆ«æ¶ˆæ¯ç±»å‹                      â”‚
â”‚    â†’ handleFunctionResponse() â†’ åˆ›å»ºToolå¯¹è±¡              â”‚
â”‚    â†’ trackConsecutiveFunctionCall() â†’ æ‰¹é‡è¿½è¸ª            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 5. å·¥å…·å¤„ç†é˜¶æ®µ                                            â”‚
â”‚    ToolProcessor.processAiTool()                          â”‚
â”‚    â†’ getRecordId() â†’ æŸ¥è¯¢å†å²è®°å½•                         â”‚
â”‚    â†’ postRecord() â†’ ä¿å­˜ç”Ÿæˆè®°å½•                          â”‚
â”‚    â†’ emit('addImage', tool) â†’ è§¦å‘æ·»åŠ äº‹ä»¶                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 6. å ä½ç®¡ç†é˜¶æ®µ                                            â”‚
â”‚    PlaceholderManager.create() â†’ åˆ›å»ºå ä½å…ƒç´              â”‚
â”‚    â†’ æ˜¾ç¤ºåŠ è½½åŠ¨ç”» â†’ ç”¨æˆ·ç«‹å³çœ‹åˆ°åé¦ˆ                      â”‚
â”‚    â†’ æ›¿æ¢çœŸå®å…ƒç´  â†’ æ·¡å…¥åŠ¨ç”»                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 7. ç”»å¸ƒæ¸²æŸ“é˜¶æ®µ                                            â”‚
â”‚    ElementAddService.addImage()                           â”‚
â”‚    â†’ editor.createElement() â†’ åˆ›å»ºå›¾ç‰‡å…ƒç´                 â”‚
â”‚    â†’ editor.addElement() â†’ æ·»åŠ åˆ°ç”»å¸ƒ                     â”‚
â”‚    â†’ adjustViewport() â†’ è‡ªåŠ¨æ»šåŠ¨åˆ°æ–°å…ƒç´                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 5.2 å…³é”®æŠ€æœ¯æ€»ç»“

| æŠ€æœ¯ç‚¹ | å®ç°æ–¹æ¡ˆ | è§£å†³çš„é—®é¢˜ | æ–‡ä»¶ä½ç½® |
|--------|---------|-----------|---------|
| **SSEæµå¼é€šä¿¡** | fetch + ReadableStream + XStream | å®æ—¶å“åº”ï¼Œé¿å…ç­‰å¾… | `sse.ts` |
| **JSONåºåˆ—è§£æ** | TransformStream + parseJsonSequence | å¤„ç†åˆ†æ®µJSON | `sse.ts` |
| **æ¶ˆæ¯åˆ†ç±»å¤„ç†** | MessageHandler + role + content.type | è¯†åˆ«ä¸åŒç±»å‹çš„æ¶ˆæ¯ | `message-handler.ts` |
| **æ‰¹é‡ç”Ÿæˆè¿½è¸ª** | consecutiveFunctionCalls Map | ç»Ÿè®¡æ‰¹é‡ç”Ÿæˆè¿›åº¦ | `message-handler.ts` |
| **æ¶ˆæ¯è¿‡æ»¤** | filterMessages() | åªå±•ç¤ºç”¨æˆ·å…³å¿ƒçš„æ¶ˆæ¯ | `message-handler.ts` |
| **å ä½ç®¡ç†** | PlaceholderManager | ä¼˜åŒ–ç­‰å¾…ä½“éªŒ | `placeholder-manager.ts` |
| **å·¥å…·å¤„ç†** | ToolProcessor + createTools | ç»Ÿä¸€å¤„ç†AIå·¥å…·ç»“æœ | `tool-processor.ts` |

### 5.3 æ€§èƒ½ä¼˜åŒ–ç‚¹

| ä¼˜åŒ–é¡¹ | å®ç°æ–¹æ¡ˆ | æ•ˆæœ |
|--------|---------|------|
| **JSONå¢é‡è§£æ** | bufferç¼“å­˜ + åˆ†æ®µè§£æ | é¿å…ä¸å®Œæ•´JSONæŠ¥é”™ |
| **å ä½åŒæ­¥åˆ›å»º** | <50msåˆ›å»ºå ä½ | ç”¨æˆ·ç«‹å³çœ‹åˆ°åé¦ˆ |
| **å·¥å…·ç¼“å­˜** | Promiseç¼“å­˜ + å»é‡ | é¿å…é‡å¤è¯·æ±‚ |
| **æ¶ˆæ¯è¿‡æ»¤** | å®¢æˆ·ç«¯è¿‡æ»¤thinking/error | å‡å°‘æ— æ•ˆToken |
| **å†å²æ¶ˆæ¯é™åˆ¶** | åªå‘é€æœ€è¿‘30ç»„ | æ§åˆ¶Tokenæ¶ˆè€— |

---

## å…­ã€ä¸‹ä¸€æ­¥

é˜…è¯»å®Œæœ¬ç« åï¼Œæ‚¨åº”è¯¥ï¼š

1. âœ… ç†è§£äº†AIå¯¹è¯ç³»ç»Ÿæ”¯æŒçš„ä¸‰ç§åŠŸèƒ½åŠå…¶å·®å¼‚
2. âœ… æŒæ¡äº†æ¶ˆæ¯æ ¼å¼çš„å®Œæ•´å®šä¹‰ï¼ˆroleã€content.typeã€statusï¼‰
3. âœ… äº†è§£äº†SSEæµå¼é€šä¿¡çš„æŠ€æœ¯å®ç°
4. âœ… ç†è§£äº†MessageHandlerçš„æ ¸å¿ƒé€»è¾‘ï¼ˆå°¤å…¶æ˜¯æ‰¹é‡è¿½è¸ªï¼‰

**æ¨èé˜…è¯»é¡ºåº**ï¼š

- **ä¸‹ä¸€ç¯‡**ï¼š[07-Agentå·¥ä½œæµç¨‹](./07-Agentå·¥ä½œæµç¨‹.md) - äº†è§£Difyé›†æˆå’Œå¤§æ¨¡å‹è°ƒç”¨
- **AIå·¥å…·**ï¼š[08-AIå·¥å…·å®ç°æŒ‡å—](./08-AIå·¥å…·å®ç°æŒ‡å—.md) - å­¦ä¹ å…·ä½“AIå·¥å…·çš„å®ç°ç»†èŠ‚

**åŠ¨æ‰‹å®è·µ**ï¼š

1. è°ƒè¯•SSEè¿æ¥ï¼ŒæŸ¥çœ‹å®é™…çš„æ•°æ®æ ¼å¼
2. ä¿®æ”¹æ¶ˆæ¯è¿‡æ»¤é€»è¾‘ï¼Œæ·»åŠ è‡ªå®šä¹‰è¿‡æ»¤è§„åˆ™
3. å®ç°ä¸€ä¸ªç®€å•çš„æ‰¹é‡è¿½è¸ªDemo

---

> **æœ¬ç« å®Œæˆï¼** æ‚¨å·²ç»æŒæ¡äº†AIå¯¹è¯ç³»ç»Ÿçš„æ ¸å¿ƒæŠ€æœ¯ã€‚
