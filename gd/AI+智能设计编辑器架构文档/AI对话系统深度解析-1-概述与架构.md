# AIå¯¹è¯ç³»ç»Ÿæ·±åº¦è§£æï¼ˆä¸€ï¼‰ï¼šæ¦‚è¿°ä¸æ•´ä½“æ¶æ„

> **ç³»åˆ—æ–‡æ¡£**ï¼š
>
> - **å½“å‰ï¼šPart 1 - æ¦‚è¿°ä¸æ•´ä½“æ¶æ„** â­
> - [Part 2 - æ¶ˆæ¯æµè½¬ä¸å¤„ç†æœºåˆ¶](./AIå¯¹è¯ç³»ç»Ÿæ·±åº¦è§£æ-2-æ¶ˆæ¯æµè½¬.md)
> - [Part 3 - ä¸‰ç§æ¨¡å¼è¿è½¬é€»è¾‘](./AIå¯¹è¯ç³»ç»Ÿæ·±åº¦è§£æ-3-ä¸‰ç§æ¨¡å¼.md)
> - [Part 4 - ä¼šè¯ä¸çŠ¶æ€ç®¡ç†](./AIå¯¹è¯ç³»ç»Ÿæ·±åº¦è§£æ-4-ä¼šè¯ç®¡ç†.md)

---

## ğŸ“‹ æ–‡æ¡£å®šä½

ä½œä¸º**æ–‡æ¡£æŠ€æœ¯ä¸“å®¶ã€å‰ç«¯ä¸“å®¶ã€IMé¢†åŸŸä¸“å®¶**ï¼Œæœ¬ç³»åˆ—æ–‡æ¡£å°†ä»ä¸šåŠ¡å’ŒæŠ€æœ¯ä¸¤ä¸ªç»´åº¦ï¼Œ**æ·±åº¦å‰–æAIå¯¹è¯ç³»ç»Ÿ**çš„å®Œæ•´å®ç°ã€‚

### æ ¸å¿ƒç›®æ ‡

1. **ç›´å‡»æœ¬è´¨**ï¼šæ­ç¤ºAIå¯¹è¯ç³»ç»Ÿçš„æ ¸å¿ƒè¿ä½œæœºåˆ¶
2. **å›¾æ–‡å¹¶èŒ‚**ï¼šç”¨æµç¨‹å›¾ã€æ—¶åºå›¾ã€æ¶æ„å›¾é˜é‡Šå¤æ‚é€»è¾‘
3. **ç®€æ˜æ‰¼è¦**ï¼šåªä¿ç•™å…³é”®ä»£ç å’Œæ ¸å¿ƒæ–¹æ³•ï¼Œä¸åšå†—ä½™å±•å¼€

### é€‚åˆäººç¾¤

- éœ€è¦ç†è§£AIå¯¹è¯ç³»ç»Ÿå…¨è²Œçš„æ¶æ„å¸ˆ
- è´Ÿè´£èŠå¤©åŠŸèƒ½å¼€å‘çš„å‰ç«¯å·¥ç¨‹å¸ˆ
- å¯¹IMç³»ç»Ÿè®¾è®¡æ„Ÿå…´è¶£çš„æŠ€æœ¯åŒå­¦

---

## ä¸€ã€ç³»ç»Ÿå…¨æ™¯ï¼šä»30000è‹±å°ºä¿¯ç°

### 1.1 ç³»ç»Ÿå®šä½

```
AIå¯¹è¯ç³»ç»Ÿ = IMèŠå¤©ç³»ç»Ÿ + AIèƒ½åŠ› + ç”»å¸ƒé›†æˆ

æ ¸å¿ƒèƒ½åŠ›ï¼š
â”œâ”€ IMåŸºç¡€ï¼šæ¶ˆæ¯æ”¶å‘ã€ä¼šè¯ç®¡ç†ã€å†å²è®°å½•
â”œâ”€ AIå¢å¼ºï¼šAgentå¯¹è¯ã€å›¾ç‰‡ç”Ÿæˆã€è§†é¢‘ç”Ÿæˆ
â””â”€ ç”»å¸ƒé›†æˆï¼šç”Ÿæˆç»“æœç›´æ¥æ·»åŠ åˆ°ç¼–è¾‘å™¨ç”»å¸ƒ
```

### 1.2 ä¸‰å±‚æ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    å±•ç¤ºå±‚ (UI Layer)                     â”‚
â”‚  ChatWrap â†’ Message â†’ Bubble â†’ ChatSender                â”‚
â”‚  èŒè´£ï¼šUIæ¸²æŸ“ã€ç”¨æˆ·äº¤äº’ã€æ¶ˆæ¯å±•ç¤º                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â†•ï¸ äº‹ä»¶é©±åŠ¨
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                  ä¸šåŠ¡å±‚ (Business Layer)                 â”‚
â”‚  MessageHandler â†’ SSEManager â†’ ToolProcessor              â”‚
â”‚  èŒè´£ï¼šæ¶ˆæ¯å¤„ç†ã€çŠ¶æ€ç®¡ç†ã€å·¥å…·è°ƒç”¨ã€æ‰¹é‡è¿½è¸ª              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â†•ï¸ HTTP/SSE
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   æœåŠ¡å±‚ (Service Layer)                 â”‚
â”‚  Difyå·¥ä½œæµ â†’ DeepSeekæ¨¡å‹ â†’ AIå·¥å…·æœåŠ¡                   â”‚
â”‚  èŒè´£ï¼šAIæ¨ç†ã€å·¥å…·è°ƒç”¨ã€ç»“æœç”Ÿæˆ                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 1.3 æŠ€æœ¯æ ˆæ€»è§ˆ

| å±‚çº§         | æŠ€æœ¯é€‰å‹                  | æ ¸å¿ƒä½œç”¨                                 |
| ------------ | ------------------------- | ---------------------------------------- |
| **UIæ¡†æ¶**   | React + Vueæ··åˆ           | Reactè´Ÿè´£æ¶ˆæ¯å±•ç¤ºï¼ŒVueè´Ÿè´£è¾“å…¥å’Œç”»å¸ƒé›†æˆ |
| **ç»„ä»¶åº“**   | Ant Design X              | æä¾›èŠå¤©UIç»„ä»¶ï¼ˆBubbleã€useXAgentç­‰ï¼‰    |
| **çŠ¶æ€ç®¡ç†** | useXAgent + useXChat      | Agentè¯·æ±‚ç®¡ç† + æ¶ˆæ¯çŠ¶æ€ç®¡ç†             |
| **é€šä¿¡åè®®** | SSE (Server-Sent Events)  | æœåŠ¡ç«¯æ¨é€ï¼Œå®ç°æµå¼å“åº”                 |
| **æµå¼å¤„ç†** | TransformStream + XStream | å¤„ç†åˆ†æ®µJSONæ•°æ®                         |
| **æ¶ˆæ¯ç®¡ç†** | MessageHandler            | æ¶ˆæ¯è§£æã€çŠ¶æ€è¿½è¸ªã€æ‰¹é‡ç®¡ç†             |
| **å·¥å…·å¤„ç†** | ToolProcessor             | ç»Ÿä¸€å¤„ç†AIå·¥å…·è°ƒç”¨ç»“æœ                   |

---

## äºŒã€æ ¸å¿ƒæ¦‚å¿µï¼šå¿…é¡»ç†è§£çš„5ä¸ªå…³é”®ç‚¹

### 2.1 æ¶ˆæ¯ï¼ˆMessageï¼‰

**å®šä¹‰**ï¼šç”¨æˆ·ä¸AIäº¤äº’çš„åŸºæœ¬æ•°æ®å•å…ƒ

```typescript
interface MessageType {
  // èº«ä»½æ ‡è¯†
  role: 'user' | 'assistant' | 'function' | 'status' | 'heartbeat';

  // å†…å®¹
  content: {
    type: 'text' | 'function_call' | 'function_response' | 'reasoning';
    text: string; // å®é™…å†…å®¹
  };

  // çŠ¶æ€
  status: 'waiting' | 'loading' | 'finished' | 'stop';

  // å”¯ä¸€æ ‡è¯†
  messageId: string;

  // å…ƒæ•°æ®
  extra?: {
    taskId?: string; // AIä»»åŠ¡ID
    localAigc?: {
      // AIç”Ÿæˆå†…å®¹
      tools: Tool[]; // å·¥å…·ç»“æœæ•°ç»„
    };
  };

  // æ‰¹é‡ç›¸å…³ï¼ˆæ ¸å¿ƒï¼‰
  functionCalls?: MessageType[]; // èšåˆçš„æ‰¹é‡è°ƒç”¨
}
```

**æ¶ˆæ¯çš„5ç§è§’è‰²**ï¼š

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   è§’è‰²      â”‚   è¯´æ˜         â”‚  æ˜¯å¦å±•ç¤º     â”‚ å…¸å‹åœºæ™¯  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ user        â”‚ ç”¨æˆ·æ¶ˆæ¯       â”‚ âœ… å±•ç¤º      â”‚ ç”¨æˆ·è¾“å…¥  â”‚
â”‚ assistant   â”‚ AIå›å¤         â”‚ âœ… å±•ç¤º      â”‚ AIå“åº”    â”‚
â”‚ function    â”‚ å·¥å…·å“åº”       â”‚ âŒ å†…éƒ¨æ¶ˆæ¯  â”‚ ç”Ÿæˆç»“æœ  â”‚
â”‚ status      â”‚ çŠ¶æ€é€šçŸ¥       â”‚ âš ï¸ é”™è¯¯æ—¶   â”‚ ç³»ç»Ÿæç¤º  â”‚
â”‚ heartbeat   â”‚ å¿ƒè·³ä¿æ´»       â”‚ âŒ å†…éƒ¨æ¶ˆæ¯  â”‚ è¿æ¥ä¿æŒ  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 2.2 ä¼šè¯ï¼ˆSessionï¼‰

**å®šä¹‰**ï¼šä¸€ç»„ç›¸å…³æ¶ˆæ¯çš„é›†åˆï¼Œä»£è¡¨ä¸€æ¬¡å®Œæ•´çš„å¯¹è¯ä¸Šä¸‹æ–‡

```typescript
interface ConversationSession {
  // ä¼šè¯æ ‡è¯†
  threadId: string; // ä¼šè¯å”¯ä¸€IDï¼ˆç”±åç«¯ç”Ÿæˆï¼‰
  localThreadId: string; // æœ¬åœ°ä¸´æ—¶IDï¼ˆé¦–æ¬¡åˆ›å»ºï¼‰

  // ä¼šè¯ä¿¡æ¯
  title: string; // ä¼šè¯æ ‡é¢˜ï¼ˆè‡ªåŠ¨ç”Ÿæˆæˆ–ç”¨æˆ·å‘½åï¼‰
  timestamp: number; // åˆ›å»ºæ—¶é—´

  // æ¶ˆæ¯åˆ—è¡¨
  messages: MessageType[]; // è¯¥ä¼šè¯çš„æ‰€æœ‰æ¶ˆæ¯

  // ä¼šè¯çŠ¶æ€
  isActive: boolean; // æ˜¯å¦ä¸ºå½“å‰æ¿€æ´»ä¼šè¯
}
```

**ä¼šè¯ç”Ÿå‘½å‘¨æœŸ**ï¼š

```
åˆ›å»º â†’ æ¿€æ´» â†’ è¿½åŠ æ¶ˆæ¯ â†’ å½’æ¡£/åˆ é™¤
  â†“
æœ¬åœ°ç”ŸæˆlocalThreadId
  â†“
é¦–æ¬¡è¯·æ±‚æ—¶è·å–threadIdï¼ˆåç«¯è¿”å›ï¼‰
  â†“
åç»­è¯·æ±‚æºå¸¦threadIdï¼ˆç»´æŒä¸Šä¸‹æ–‡ï¼‰
```

### 2.3 å·¥å…·ï¼ˆToolï¼‰

**å®šä¹‰**ï¼šAIå¯è°ƒç”¨çš„å¤–éƒ¨èƒ½åŠ›ï¼ˆå›¾ç‰‡ç”Ÿæˆã€è§†é¢‘ç”Ÿæˆç­‰ï¼‰

```typescript
interface Tool {
  // å·¥å…·ç±»å‹
  toolType: 'image' | 'video' | 'matting' | 'inPaintRemove' | ...;

  // ç»“æœ
  result: {
    uri: string;              // èµ„æºURL
    width: number;            // å®½åº¦
    height: number;           // é«˜åº¦
    mimeType: string;         // MIMEç±»å‹
  };

  // å…ƒæ•°æ®
  metadata: {
    taskId: string;           // AIä»»åŠ¡ID
    recordId?: string;        // ç”Ÿæˆè®°å½•ID
    query: string;            // ç”¨æˆ·æç¤ºè¯
    referenceImageUrls?: string[];  // å‚è€ƒå›¾
  };
}
```

**å·¥å…·è°ƒç”¨æµç¨‹**ï¼š

```
AIå†³ç­– â†’ function_call â†’ åç«¯æ‰§è¡Œ â†’ function_response â†’ å‰ç«¯å¤„ç†
```

### 2.4 å ä½ï¼ˆPlaceholderï¼‰

**å®šä¹‰**ï¼šåœ¨AIç”Ÿæˆè¿‡ç¨‹ä¸­ï¼Œé¢„å…ˆåœ¨ç”»å¸ƒä¸Šåˆ›å»ºçš„ä¸´æ—¶å…ƒç´ 

```
ç›®çš„ï¼šä¼˜åŒ–ç”¨æˆ·ä½“éªŒï¼Œè®©ç”¨æˆ·ç«‹å³çœ‹åˆ°åé¦ˆ
æ—¶æœºï¼šfunction_callæ¶ˆæ¯åˆ°è¾¾æ—¶ï¼ˆ< 50msï¼‰
çŠ¶æ€ï¼šåŠ è½½åŠ¨ç”» â†’ çœŸå®å…ƒç´ æ›¿æ¢
```

**å ä½ç®¡ç†å™¨**ï¼š

```typescript
class PlaceholderManager {
  create(toolType: string): PlaceholderId {
    // åˆ›å»ºå ä½å…ƒç´ ï¼ˆæ˜¾ç¤ºåŠ è½½åŠ¨ç”»ï¼‰
  }

  replace(placeholderId: string, realElement: Element): void {
    // æ›¿æ¢ä¸ºçœŸå®å…ƒç´ ï¼ˆæ·¡å…¥åŠ¨ç”»ï¼‰
  }

  remove(placeholderId: string): void {
    // åˆ é™¤å ä½ï¼ˆç”Ÿæˆå¤±è´¥æ—¶ï¼‰
  }
}
```

### 2.5 æ‰¹é‡ç”Ÿæˆè¿½è¸ªï¼ˆConsecutive Function Callsï¼‰

**å®šä¹‰**ï¼šè¿½è¸ªä¸€æ¬¡è¯·æ±‚ä¸­è¿ç»­çš„å¤šä¸ªå·¥å…·è°ƒç”¨ï¼ˆå¦‚ç”Ÿæˆ4å¼ å›¾ç‰‡ï¼‰

**æ ¸å¿ƒæ•°æ®ç»“æ„**ï¼š

```typescript
interface ConsecutiveFunctionCallTracking {
  startTime: number; // å¼€å§‹æ—¶é—´
  expectedResponses: number; // æœŸæœ›æ•°é‡ï¼ˆå¦‚4ï¼‰
  receivedResponses: number; // å·²æ”¶åˆ°æ•°é‡ï¼ˆå¦‚2ï¼‰
  messageIds: Set<string>; // function_call IDé›†åˆ
  parentMessageId: string; // çˆ¶æ¶ˆæ¯IDï¼ˆç¬¬ä¸€ä¸ªï¼‰
  isCompleted: boolean; // æ˜¯å¦å®Œæˆ
}
```

**ä¸ºä»€ä¹ˆéœ€è¦ï¼Ÿ**

```
é—®é¢˜ï¼šç”¨æˆ·è¯´"ç”Ÿæˆ4å¼ logo"
AIè¿”å›ï¼š4ä¸ªfunction_call + 4ä¸ªfunction_response

æŒ‘æˆ˜ï¼š
1. å¦‚ä½•çŸ¥é“æ€»å…±æœ‰å‡ ä¸ªï¼Ÿï¼ˆexpectedResponsesï¼‰
2. å¦‚ä½•çŸ¥é“å®Œæˆäº†å‡ ä¸ªï¼Ÿï¼ˆreceivedResponsesï¼‰
3. å¦‚ä½•åœ¨UIä¸Šç»Ÿä¸€å±•ç¤ºï¼Ÿï¼ˆfunctionCallsæ•°ç»„ï¼‰

è§£å†³ï¼šconsecutiveFunctionCallsè¿½è¸ªæœºåˆ¶
```

---

## ä¸‰ã€æ•´ä½“æ¶æ„ï¼š5å¤§æ ¸å¿ƒæ¨¡å—

### 3.1 æ¨¡å—èŒè´£åˆ’åˆ†

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                  1ï¸âƒ£ æ¶ˆæ¯ç®¡ç†æ¨¡å—                          â”‚
â”‚  MessageHandler + useMessage                              â”‚
â”‚  èŒè´£ï¼šæ¶ˆæ¯è§£æã€çŠ¶æ€è¿½è¸ªã€æ‰¹é‡ç®¡ç†ã€è¿‡æ»¤å±•ç¤º              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                  2ï¸âƒ£ é€šä¿¡ç®¡ç†æ¨¡å—                          â”‚
â”‚  SSEManager + createSSEConnection + XStream               â”‚
â”‚  èŒè´£ï¼šSSEè¿æ¥ã€æµå¼æ•°æ®å¤„ç†ã€JSONè§£æã€æ–­çº¿é‡è¿           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                  3ï¸âƒ£ å·¥å…·å¤„ç†æ¨¡å—                          â”‚
â”‚  ToolProcessor + createTools                              â”‚
â”‚  èŒè´£ï¼šå·¥å…·ç»“æœè½¬æ¢ã€è®°å½•ä¿å­˜ã€äº‹ä»¶è§¦å‘                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                  4ï¸âƒ£ å ä½ç®¡ç†æ¨¡å—                          â”‚
â”‚  PlaceholderManager + ElementAddService                   â”‚
â”‚  èŒè´£ï¼šå ä½åˆ›å»ºã€çœŸå®æ›¿æ¢ã€ç”»å¸ƒæ¸²æŸ“                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                  5ï¸âƒ£ ä¼šè¯ç®¡ç†æ¨¡å—                          â”‚
â”‚  ChatConfig + RecordConversation                          â”‚
â”‚  èŒè´£ï¼šä¼šè¯CRUDã€å†å²åŠ è½½ã€æ ‡é¢˜ç”Ÿæˆã€ä¸Šä¸‹æ–‡ç»´æŠ¤            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 3.2 æ•°æ®æµè½¬å›¾

```
ç”¨æˆ·è¾“å…¥ "ç”Ÿæˆ4å¼ æ˜¥å¤©çš„ç…§ç‰‡"
    â†“
ChatSender.submit()
    â†“
æ„é€ æ¶ˆæ¯ {role:'user', content:{type:'text', text:'...'}}
    â†“
useMessage.onRequest([userMessage])
    â†“
useXAgent.request()
    â†“
SSEManager.connect(messages)
    â†“
createSSEConnection() â†’ fetch(POST /chat)
    â†“
SSEæµå¼€å§‹ â†â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â†“               â”‚
XStreamè§£æ       â”‚ æŒç»­æ¨é€
    â†“               â”‚
MessageHandler    â”‚
.handleSSEMessage() â”‚
    â†“               â”‚
è§£ææ¶ˆæ¯ç±»å‹       â”‚
    â†“               â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ç±»å‹1: assistant + text           â”‚
â”‚ â†’ æ›´æ–°å¯¹è¯å†…å®¹                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ç±»å‹2: assistant + function_call  â”‚
â”‚ â†’ trackConsecutiveFunctionCall()  â”‚
â”‚ â†’ PlaceholderManager.create()     â”‚
â”‚ â†’ emit('addImage')                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ç±»å‹3: function + function_responseâ”‚
â”‚ â†’ checkConsecutiveFunctionResponse()â”‚
â”‚ â†’ createTools()                    â”‚
â”‚ â†’ ToolProcessor.process()          â”‚
â”‚ â†’ PlaceholderManager.replace()    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â†“
Observer.onUpdate(filteredMessages)
    â†“
useXChat.setMessages()
    â†“
Reacté‡æ¸²æŸ“
    â†“
Bubble.Listå±•ç¤ºæ¶ˆæ¯
```

---

## å››ã€æ ¸å¿ƒæµç¨‹ï¼šç”¨æˆ·è§†è§’ vs æŠ€æœ¯å®ç°

### 4.1 ç”¨æˆ·è§†è§’ï¼ˆç®€åŒ–ï¼‰

```
1. ç”¨æˆ·è¾“å…¥ "ç”Ÿæˆ4å¼ æ˜¥å¤©çš„ç…§ç‰‡"
   â†“
2. çœ‹åˆ°è¾“å…¥æ¡†ä¸‹æ–¹å‡ºç°"AIæ­£åœ¨æ€è€ƒ..."
   â†“
3. ç”»å¸ƒä¸Šç«‹å³å‡ºç°4ä¸ªå ä½ï¼ˆåŠ è½½åŠ¨ç”»ï¼‰
   â†“
4. å ä½é€ä¸ªè¢«çœŸå®å›¾ç‰‡æ›¿æ¢ï¼ˆ2-10ç§’ï¼‰
   â†“
5. èŠå¤©çª—å£æ˜¾ç¤º"å·²ä¸ºæ‚¨ç”Ÿæˆ4å¼ å›¾ç‰‡"
```

### 4.2 æŠ€æœ¯å®ç°ï¼ˆå®Œæ•´ï¼‰

#### é˜¶æ®µ1ï¼šè¾“å…¥ä¸æäº¤ï¼ˆ< 10msï¼‰

```typescript
// 1. ChatSenderæ”¶é›†å‚æ•°
const params = {
  prompt: 'ç”Ÿæˆ4å¼ æ˜¥å¤©çš„ç…§ç‰‡',
  skill: 'image',
  ratio: '16:9',
  styleCode: 'realistic',
};

// 2. æ„é€ ç”¨æˆ·æ¶ˆæ¯
const userMessage: MessageType = {
  role: 'user',
  content: { type: 'text', text: params.prompt },
  messageId: uuidv4(),
  status: 'finished',
  $senderParams: params,
};

// 3. è§¦å‘æäº¤
events.emit('submit', userMessage);
```

#### é˜¶æ®µ2ï¼šè¿æ¥å»ºç«‹ï¼ˆ50-200msï¼‰

```typescript
// 4. useMessage.onRequest()
const [agent] = useXAgent({
  request: async ({ message }, { onUpdate, onSuccess }) => {
    // 5. åˆå§‹åŒ–MessageHandler
    messageHandlerRef.current = new MessageHandler({
      observer: {
        onUpdate: (filteredMessages) => onUpdate(filteredMessages),
        onSuccess: (messages) => onSuccess(messages),
      },
    });

    // 6. å»ºç«‹SSEè¿æ¥
    sseManagerRef.current = new SSEManager({
      onMessage: ({ done, data }) => {
        messageHandlerRef.current.handleSSEMessage(data, done);
      },
    });

    await sseManagerRef.current.connect(message, isOnline, events);
  },
});
```

#### é˜¶æ®µ3ï¼šæµå¼å“åº”ï¼ˆæŒç»­10-30ç§’ï¼‰

```typescript
// 7. SSEæµå¼€å§‹æ¨é€
for await (const chunk of XStream({ readableStream: response.body })) {
  // 8. è§£æJSON
  const messages: MessageType[] = chunk.data;

  // 9. é€æ¡å¤„ç†
  messages.forEach((msg) => {
    messageHandler.handleSSEMessage([msg], false);
  });
}
```

**å…¸å‹çš„SSEäº‹ä»¶åºåˆ—**ï¼š

```json
// Event 1: AIæ–‡æœ¬å›å¤
{
  "role": "assistant",
  "content": {"type": "text", "text": "å¥½çš„ï¼Œæˆ‘æ¥ä¸ºæ‚¨ç”Ÿæˆ4å¼ æ˜¥å¤©çš„ç…§ç‰‡"},
  "messageId": "msg_001"
}

// Event 2-5: 4ä¸ªfunction_callï¼ˆè¿ç»­åˆ°è¾¾ï¼‰
{
  "role": "assistant",
  "content": {
    "type": "function_call",
    "text": "{\"name\":\"å›¾ç‰‡ç”Ÿæˆ\",\"arguments\":{\"prompt\":\"æ˜¥å¤©çš„æ¨±èŠ±\"}}"
  },
  "messageId": "msg_call_001"
}
// ... 3ä¸ªç±»ä¼¼çš„

// Event 6-9: 4ä¸ªfunction_responseï¼ˆé™†ç»­åˆ°è¾¾ï¼‰
{
  "role": "function",
  "content": {
    "type": "function_response",
    "text": "[{\"uri\":\"https://...\",\"width\":1920}]"
  },
  "name": "å›¾ç‰‡ç”Ÿæˆ",
  "messageId": "msg_resp_001",
  "extra": {
    "lastToolMessageId": "msg_call_001",
    "taskId": "task_xxx"
  }
}
// ... 3ä¸ªç±»ä¼¼çš„
```

#### é˜¶æ®µ4ï¼šæ‰¹é‡è¿½è¸ªï¼ˆå®æ—¶æ›´æ–°ï¼‰

```typescript
// 10. è¿½è¸ªfunction_call
private trackConsecutiveFunctionCall(item: MessageType) {
  if (item.content.type === 'function_call') {
    const functionName = JSON.parse(item.content.text).name;

    if (!this.consecutiveFunctionCalls.has(functionName)) {
      // ç¬¬1ä¸ªï¼šåˆ›å»ºè¿½è¸ª
      this.consecutiveFunctionCalls.set(functionName, [{
        expectedResponses: 1,
        receivedResponses: 0,
        messageIds: new Set([item.messageId]),
      }]);
    } else {
      // ç¬¬2-4ä¸ªï¼šç´¯åŠ 
      const tracking = this.consecutiveFunctionCalls.get(functionName)[0];
      tracking.messageIds.add(item.messageId);
      tracking.expectedResponses = tracking.messageIds.size;
    }
  }
}

// 11. æ£€æŸ¥function_response
private checkConsecutiveFunctionResponse(item: MessageType) {
  if (item.content.type === 'function_response') {
    const tracking = this.consecutiveFunctionCalls.get(item.name)[0];
    tracking.receivedResponses += 1;

    // æ£€æŸ¥æ˜¯å¦å…¨éƒ¨å®Œæˆ
    if (tracking.receivedResponses >= tracking.expectedResponses) {
      events.emit('generateCompleted', {
        count: tracking.receivedResponses,
      });
    }
  }
}
```

---

## äº”ã€å…³é”®æŠ€æœ¯ç‚¹

### 5.1 SSEæµå¼å¤„ç†

**ä¸ºä»€ä¹ˆç”¨SSEï¼Ÿ**

| æ–¹æ¡ˆ      | å®æ—¶æ€§      | å¤æ‚åº¦ | æµè§ˆå™¨æ”¯æŒ | ç»“è®º     |
| --------- | ----------- | ------ | ---------- | -------- |
| è½®è¯¢      | âŒ å»¶è¿Ÿé«˜   | ç®€å•   | âœ…         | ä¸é‡‡ç”¨   |
| WebSocket | âœ… åŒå‘å®æ—¶ | å¤æ‚   | âœ…         | å¤‡é€‰     |
| SSE       | âœ… å•å‘å®æ—¶ | ç®€å•   | âœ…         | **é‡‡ç”¨** |

**æ ¸å¿ƒå®ç°**ï¼š

```typescript
// createSSEConnection() æ ¸å¿ƒé€»è¾‘
const response = await fetch(sseUrl, {
  method: 'POST',
  body: JSON.stringify(message),
  signal: controller.signal,
});

// ä½¿ç”¨XStreamå¤„ç†æµå¼æ•°æ®
for await (const chunk of XStream({
  readableStream: response.body,
  transformStream: createCustomTransformStream(),
})) {
  callback(chunk);
}
```

### 5.2 TransformStreamï¼ˆæµå¼JSONè§£æï¼‰

**æŒ‘æˆ˜**ï¼šSSEæ¨é€çš„JSONå¯èƒ½è¢«åˆ†æ®µ

```
ç¬¬1æ¬¡: '{"role":"ass'
ç¬¬2æ¬¡: 'istant","content":"hello"}'
```

**è§£å†³**ï¼šä½¿ç”¨bufferç¼“å­˜ä¸å®Œæ•´æ•°æ®

```typescript
const createCustomTransformStream = () => {
  let buffer = '';

  return new TransformStream({
    transform(chunk, controller) {
      let text = buffer + chunk;

      try {
        const data = JSON.parse(text);
        controller.enqueue({ done: false, data });
        buffer = '';
      } catch {
        buffer = text; // ä¸å®Œæ•´ï¼Œç¼“å­˜èµ·æ¥
      }
    },
  });
};
```

### 5.3 æ¶ˆæ¯è¿‡æ»¤ï¼ˆå“ªäº›å±•ç¤ºï¼Ÿï¼‰

```typescript
filterMessages() {
  return this.messages.filter(msg => {
    // âŒ å†…éƒ¨æ¶ˆæ¯ï¼ˆä¸å±•ç¤ºï¼‰
    if (msg.role === 'function') return false;        // å·¥å…·å“åº”
    if (msg.role === 'heartbeat') return false;       // å¿ƒè·³
    if (msg.content.type === 'reasoning' &&
        msg.status === 'finished') return false;      // å·²å®Œæˆçš„æ€è€ƒ

    // âœ… ç”¨æˆ·æ¶ˆæ¯ï¼ˆå±•ç¤ºï¼‰
    return true;
  });
}
```

### 5.4 å ä½åŒæ­¥åˆ›å»º

```typescript
// function_callåˆ°è¾¾æ—¶ç«‹å³åˆ›å»ºå ä½
if (item.content.type === 'function_call') {
  const toolType = JSON.parse(item.content.text).name;

  // < 50msåˆ›å»ºå ä½
  const placeholderId = placeholderManager.create(toolType);

  // è®°å½•å…³è”
  this.placeholderMap.set(item.messageId, placeholderId);
}

// function_responseåˆ°è¾¾æ—¶æ›¿æ¢
if (item.content.type === 'function_response') {
  const placeholderId = this.placeholderMap.get(item.extra.lastToolMessageId);
  const tool = createTools(item)[0];

  // æ›¿æ¢ä¸ºçœŸå®å…ƒç´ 
  placeholderManager.replace(placeholderId, tool);
}
```

---

## å…­ã€ä¸‹ä¸€ç« é¢„å‘Š

æœ¬ç« å®Œæˆäº†**æ¦‚è¿°ä¸æ•´ä½“æ¶æ„**çš„è®²è§£ï¼Œä¸‹ä¸€ç« å°†æ·±å…¥**æ¶ˆæ¯æµè½¬ä¸å¤„ç†æœºåˆ¶**ï¼š

- æ¶ˆæ¯çš„å®Œæ•´ç”Ÿå‘½å‘¨æœŸ
- MessageHandlerçš„æ ¸å¿ƒç®—æ³•
- ä¸åŒè§’è‰²æ¶ˆæ¯çš„å¤„ç†é€»è¾‘
- æ‰¹é‡è¿½è¸ªçš„å®ç°ç»†èŠ‚

**ç»§ç»­é˜…è¯»**ï¼š[Part 2 - æ¶ˆæ¯æµè½¬ä¸å¤„ç†æœºåˆ¶](./AIå¯¹è¯ç³»ç»Ÿæ·±åº¦è§£æ-2-æ¶ˆæ¯æµè½¬.md)

---

> **Part 1 å®Œæˆï¼** æ‚¨å·²ç»æŒæ¡äº†AIå¯¹è¯ç³»ç»Ÿçš„æ•´ä½“æ¶æ„å’Œæ ¸å¿ƒæ¦‚å¿µã€‚
