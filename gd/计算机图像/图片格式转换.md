# å›¾ç‰‡æ ¼å¼è½¬æ¢æ·±åº¦è§£æ

> **æ ¸å¿ƒæŠ€æœ¯ï¼š** ImageMagick WASM + UTIF.js + heic2any
> 
> **åŠŸèƒ½ï¼š** æ”¯æŒ10+ç§å›¾ç‰‡æ ¼å¼çš„äº’ç›¸è½¬æ¢

---

## ğŸ“š ç›®å½•

1. [åŠŸèƒ½æ¦‚è¿°ä¸éš¾ç‚¹åˆ†æ](#ä¸€åŠŸèƒ½æ¦‚è¿°ä¸éš¾ç‚¹åˆ†æ)
2. [InsMindå®ç°è¯¦è§£](#äºŒinsmindå®ç°è¯¦è§£)
3. [ç‰¹æ®Šæ ¼å¼å¤„ç†](#ä¸‰ç‰¹æ®Šæ ¼å¼å¤„ç†)
4. [ImageMagick WASMåŸç†](#å››imagemagick-wasmåŸç†)
5. [å›¾ç‰‡æ ¼å¼åŸºç¡€çŸ¥è¯†](#äº”å›¾ç‰‡æ ¼å¼åŸºç¡€çŸ¥è¯†)
6. [Canvas APIçš„å±€é™æ€§](#å…­canvas-apiçš„å±€é™æ€§)
7. [æ€»ç»“ä¸æœ€ä½³å®è·µ](#ä¸ƒæ€»ç»“ä¸æœ€ä½³å®è·µ)

---

## ä¸€ã€åŠŸèƒ½æ¦‚è¿°ä¸éš¾ç‚¹åˆ†æ

### 1.1 åŠŸèƒ½è¯´æ˜

æ ¼å¼è½¬æ¢å·¥å…·å…è®¸ç”¨æˆ·å°†å›¾ç‰‡ä»ä¸€ç§æ ¼å¼è½¬æ¢ä¸ºå¦ä¸€ç§æ ¼å¼ï¼Œä¾‹å¦‚ï¼š

```
ç”¨æˆ·ä¸Šä¼ ï¼šphoto.heicï¼ˆiPhoneæ‹æ‘„çš„ç…§ç‰‡ï¼‰
é€‰æ‹©ç›®æ ‡æ ¼å¼ï¼šPNG
ç‚¹å‡»è½¬æ¢
ä¸‹è½½ï¼šphoto.png
```

### 1.2 æ”¯æŒçš„æ ¼å¼çŸ©é˜µ

| æ ¼å¼ | MIMEç±»å‹ | ç‰¹ç‚¹ | éš¾åº¦ |
|------|----------|------|------|
| **JPG/JPEG** | image/jpeg | æœ‰æŸå‹ç¼©ï¼Œä½“ç§¯å° | â­ |
| **PNG** | image/png | æ— æŸå‹ç¼©ï¼Œæ”¯æŒé€æ˜ | â­ |
| **WebP** | image/webp | ç°ä»£æ ¼å¼ï¼Œä½“ç§¯æ›´å° | â­ |
| **GIF** | image/gif | æ”¯æŒåŠ¨ç”»ï¼Œæœ€å¤š256è‰² | â­â­ |
| **BMP** | image/bmp | æ— å‹ç¼©ï¼Œä½“ç§¯å¤§ | â­ |
| **TIFF** | image/tiff | ä¸“ä¸šæ ¼å¼ï¼Œæ”¯æŒå¤šé¡µ | â­â­â­â­ |
| **SVG** | image/svg+xml | çŸ¢é‡å›¾ï¼Œæ— é™æ”¾å¤§ | â­â­â­ |
| **PDF** | application/pdf | æ–‡æ¡£æ ¼å¼ | â­â­â­ |
| **AI** | application/ai | Adobe Illustrator | â­â­â­ |
| **HEIC** | image/heic | iOSä¸“ç”¨ï¼Œé«˜æ•ˆå‹ç¼© | â­â­â­â­â­ |

### 1.3 æ ¸å¿ƒéš¾ç‚¹

```
éš¾ç‚¹1ï¼šæµè§ˆå™¨åŸç”Ÿä¸æ”¯æŒçš„æ ¼å¼
â”œâ”€ TIFFï¼šä¸“ä¸šæ‘„å½±/å°åˆ·æ ¼å¼ï¼ŒChromeæ— æ³•ç›´æ¥æ˜¾ç¤º
â”œâ”€ HEICï¼šiOS 11+é»˜è®¤ç…§ç‰‡æ ¼å¼ï¼ŒåŸºäºHEVCè§†é¢‘ç¼–ç 
â”œâ”€ PDF/AIï¼šçŸ¢é‡æ ¼å¼ï¼Œéœ€è¦ä¸“é—¨çš„æ¸²æŸ“å¼•æ“
â””â”€ è§£å†³æ–¹æ¡ˆï¼šå¼•å…¥ç¬¬ä¸‰æ–¹åº“é¢„å¤„ç†

éš¾ç‚¹2ï¼šCanvas APIåªèƒ½è¾“å‡º3ç§æ ¼å¼
â”œâ”€ canvas.toBlob() åªæ”¯æŒï¼šJPGã€PNGã€WebP
â”œâ”€ ä¸æ”¯æŒï¼šGIFã€BMPã€SVGã€TIFFã€PDFã€AI
â””â”€ è§£å†³æ–¹æ¡ˆï¼šä½¿ç”¨ImageMagick WASM

éš¾ç‚¹3ï¼šæ ¼å¼ä¹‹é—´çš„å‚æ•°å·®å¼‚
â”œâ”€ JPGï¼šè´¨é‡(0-100)ï¼Œæœ‰æŸ
â”œâ”€ PNGï¼šå‹ç¼©çº§åˆ«(0-9)ï¼Œæ— æŸ
â”œâ”€ GIFï¼šæœ€å¤š256è‰²ï¼Œéœ€è¦é¢œè‰²é‡åŒ–
â”œâ”€ TIFFï¼šå¯èƒ½å¤šé¡µï¼Œéœ€è¦é€‰æ‹©
â””â”€ è§£å†³æ–¹æ¡ˆï¼šå‚æ•°æ˜ å°„å’Œæ ¼å¼é€‚é…
```

---

## äºŒã€InsMindå®ç°è¯¦è§£

### 2.1 æ ¸å¿ƒæœåŠ¡ç±»

**æ–‡ä»¶ä½ç½®ï¼š** `apps/insmind/routes/(vue3)/services/editor/editors/convert/services.ts`

```typescript
export class ConvertService extends BaseEditorService<IConvertServiceState> {
    /**
     * ImageMagick WASMå®ä¾‹
     * @link https://github.com/dlemstra/magick-wasm
     */
    imageMagick: any = null;

    constructor(options: IBaseEditorServiceOptions) {
        super({
            state: {
                targetFormat: MIME.jpg,        // é»˜è®¤ç›®æ ‡æ ¼å¼
                targetFormatList: [],          // æ”¯æŒçš„æ ¼å¼åˆ—è¡¨
            },
            config: {
                // è¿™äº›æ ¼å¼ä¸æ”¯æŒCanvasé¢„è§ˆï¼Œéœ€è¦ç‰¹æ®Šå¤„ç†
                skipComposeMimes: [MIME.ai, MIME.pdf, MIME.tiff, MIME.svg, MIME.bmp, MIME.gif],
            },
        });

        this.main(true);  // åˆå§‹åŒ–
    }
}
```

### 2.2 åˆå§‹åŒ–æµç¨‹

åˆå§‹åŒ–åˆ†ä¸º**ä¸‰ä¸ªé˜¶æ®µ**ï¼šç‰¹æ®Šæ ¼å¼é¢„å¤„ç† â†’ åŠ è½½WASM â†’ é…ç½®æ ¼å¼åˆ—è¡¨

```typescript
async main(isSetPreset = false) {
    await this.compressOriginImagePromise;

    // =========================================
    // é˜¶æ®µ1ï¼šç‰¹æ®Šæ ¼å¼é¢„å¤„ç†
    // =========================================
    
    // å¤„ç†TIFFæ ¼å¼ï¼ˆChromeä¸æ”¯æŒé¢„è§ˆï¼‰
    if (this.config.originMime === MIME.tiff) {
        await this.handleTiffFormat();
    }
    // å¤„ç†HEICæ ¼å¼ï¼ˆImageMagickä¸æ”¯æŒï¼‰
    else if (this.config.originMime === MIME.heic) {
        await this.handleHeicFormat();
    }

    // =========================================
    // é˜¶æ®µ2ï¼šåŠ è½½ImageMagick WASM
    // =========================================
    
    const [{ default: wasmUrl }, { initializeImageMagick, ImageMagick, MagickFormat }] =
        await Promise.all([
            import('@imagemagick/magick-wasm/magick.wasm?url'),
            import('@imagemagick/magick-wasm'),
        ]);

    // åˆå§‹åŒ–WASMæ¨¡å—
    await initializeImageMagick(new URL(wasmUrl, import.meta.url));
    
    this.imageMagick = ImageMagick;

    // =========================================
    // é˜¶æ®µ3ï¼šé…ç½®æ”¯æŒçš„æ ¼å¼åˆ—è¡¨
    // =========================================
    
    this.state.targetFormatList = [
        { value: MIME.jpg, label: 'JPG', fileSuffix: 'jpg', magickFormat: MagickFormat.Jpg },
        { value: MIME.jpeg, label: 'JPEG', fileSuffix: 'jpeg', magickFormat: MagickFormat.Jpeg },
        { value: MIME.png, label: 'PNG', fileSuffix: 'png', magickFormat: MagickFormat.Png },
        { value: MIME.webp, label: 'WEBP', fileSuffix: 'webp', magickFormat: MagickFormat.WebP },
        // ä»¥ä¸‹æ ¼å¼ä¸æ”¯æŒCanvasé¢„è§ˆ
        { value: MIME.gif, label: 'GIF', fileSuffix: 'gif', magickFormat: MagickFormat.Gif },
        { value: MIME.bmp, label: 'BMP', fileSuffix: 'bmp', magickFormat: MagickFormat.Bmp },
        { value: MIME.svg, label: 'SVG', fileSuffix: 'svg', magickFormat: MagickFormat.Svg },
        { value: MIME.tiff, label: 'TIFF', fileSuffix: 'tiff', magickFormat: MagickFormat.Tiff },
        { value: MIME.pdf, label: 'PDF', fileSuffix: 'pdf', magickFormat: MagickFormat.Pdf },
        { value: MIME.ai, label: 'AI', fileSuffix: 'ai', magickFormat: MagickFormat.Ai },
    ];

    this.state.init = true;
}
```

### 2.3 æ ¼å¼è½¬æ¢æ ¸å¿ƒé€»è¾‘

```typescript
async start() {
    try {
        this.state.loading = true;
        this.tracker.trackToolConflateStart();

        // è·å–ç›®æ ‡æ ¼å¼é…ç½®
        const targetOption = this.getTargetOption(this.state.targetFormat);

        // =========================================
        // æ­¥éª¤1ï¼šå°†æºå›¾ç‰‡ç»˜åˆ¶åˆ°Canvas
        // =========================================
        
        const canvas = await urlToCanvas(
            this.state.originImage,
            // JPGéœ€è¦ç™½è‰²èƒŒæ™¯ï¼ˆå› ä¸ºæ²¡æœ‰é€æ˜é€šé“ï¼‰
            this.state.targetFormat === 'image/jpeg' ? '#fff' : '',
        );

        // =========================================
        // æ­¥éª¤2ï¼šè°ƒç”¨ImageMagick WASMè½¬æ¢
        // =========================================
        
        const blobUrl = await new Promise<string>((resolve) => {
            // ä»Canvasè¯»å–å›¾åƒæ•°æ®
            this.imageMagick.readFromCanvas(canvas, (image) => {
                // å†™å…¥ç›®æ ‡æ ¼å¼
                image.write(targetOption?.magickFormat, (data) => {
                    // åˆ›å»ºBlobå¯¹è±¡
                    const blob = new Blob([data], { type: this.state.targetFormat });
                    resolve(URL.createObjectURL(blob));
                });
            });
        });

        // =========================================
        // æ­¥éª¤3ï¼šå¤„ç†ç»“æœå±•ç¤º
        // =========================================
        
        // ä¸æ”¯æŒCanvasé¢„è§ˆçš„æ ¼å¼ï¼Œç›´æ¥æ˜¾ç¤ºåŸå°ºå¯¸
        if (this.config.skipComposeMimes.includes(this.config.targetMime)) {
            this.state.resultImage = blobUrl;
            this.state.showDownload = true;
        } else {
            // æ”¯æŒé¢„è§ˆçš„æ ¼å¼ï¼Œæ›´æ–°ç»“æœ
            this.updateResult(blobUrl);
        }

        this.tracker.trackToolConflateCompleted();
    } catch (error) {
        this.showErrorMessage(error);
        throw error;
    } finally {
        this.state.loading = false;
    }
}
```

### 2.4 å®Œæ•´æµç¨‹å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    ç”¨æˆ·ä¸Šä¼ å›¾ç‰‡                                  â”‚
â”‚                    (photo.heic)                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â”‚
                         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                 æ ¼å¼æ£€æµ‹                                         â”‚
â”‚  this.config.originMime = 'image/heic'                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â”‚
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â–¼               â–¼               â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚  HEIC   â”‚    â”‚  TIFF    â”‚    â”‚  å…¶ä»–    â”‚
    â”‚  æ ¼å¼   â”‚    â”‚  æ ¼å¼    â”‚    â”‚  æ ¼å¼    â”‚
    â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜
         â”‚              â”‚               â”‚
         â–¼              â–¼               â”‚
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚
    â”‚  heic2anyåº“                 â”‚     â”‚
    â”‚  â†’ è½¬æ¢ä¸ºJPG               â”‚     â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚
               â”‚              â”‚         â”‚
               â–¼              â–¼         â”‚
          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
          â”‚  UTIF.jsåº“               â”‚ â”‚
          â”‚  â†’ è§£ç TIFFä¸ºRGBAåƒç´     â”‚ â”‚
          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
                      â”‚                 â”‚
                      â–¼                 â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                 Canvasä¸­é—´æ ¼å¼                                   â”‚
â”‚  æ‰€æœ‰å›¾ç‰‡éƒ½è¢«è½¬æ¢ä¸ºCanvaså¯ä»¥å¤„ç†çš„æ ¼å¼                          â”‚
â”‚  ï¼ˆRGB/RGBAåƒç´ æ•°æ®ï¼‰                                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â”‚
                         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                 åŠ è½½ImageMagick WASM                            â”‚
â”‚                                                                  â”‚
â”‚  const { ImageMagick, MagickFormat } =                          â”‚
â”‚      await import('@imagemagick/magick-wasm');                  â”‚
â”‚                                                                  â”‚
â”‚  await initializeImageMagick(wasmUrl);                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â”‚
                         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                 ç”¨æˆ·é€‰æ‹©ç›®æ ‡æ ¼å¼                                 â”‚
â”‚                 (ä¾‹å¦‚: PNG)                                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â”‚
                         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                 ImageMagick WASMè½¬æ¢                            â”‚
â”‚                                                                  â”‚
â”‚  ImageMagick.readFromCanvas(canvas, (image) => {                â”‚
â”‚      // ä»Canvasè¯»å–åƒç´ æ•°æ®                                    â”‚
â”‚      image.write(MagickFormat.Png, (data) => {                  â”‚
â”‚          // ç¼–ç ä¸ºPNGæ ¼å¼                                       â”‚
â”‚          // data: Uint8Array                                    â”‚
â”‚      });                                                         â”‚
â”‚  });                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â”‚
                         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                 ç”ŸæˆBlobä¾›ä¸‹è½½                                   â”‚
â”‚                                                                  â”‚
â”‚  const blob = new Blob([data], { type: 'image/png' });          â”‚
â”‚  const blobUrl = URL.createObjectURL(blob);                     â”‚
â”‚  // ä¸‹è½½ï¼šphoto.png                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ä¸‰ã€ç‰¹æ®Šæ ¼å¼å¤„ç†

### 3.1 TIFFæ ¼å¼å¤„ç†

#### 3.1.1 ä»€ä¹ˆæ˜¯TIFFï¼Ÿ

**TIFFï¼ˆTagged Image File Formatï¼‰**æ˜¯ä¸€ç§ä¸“ä¸šå›¾åƒæ ¼å¼ï¼š

```
ç‰¹ç‚¹ï¼š
â”œâ”€ æ— æŸå‹ç¼©ï¼šä¿ç•™æ‰€æœ‰ç»†èŠ‚
â”œâ”€ æ”¯æŒå¤šé¡µï¼šä¸€ä¸ªæ–‡ä»¶å¯åŒ…å«å¤šå¼ å›¾ç‰‡ï¼ˆç±»ä¼¼PDFï¼‰
â”œâ”€ é«˜è‰²æ·±ï¼šæ”¯æŒ16bitã€32bit
â”œâ”€ ä¸“ä¸šç”¨é€”ï¼šæ‘„å½±ã€å°åˆ·ã€åŒ»å­¦å½±åƒ
â””â”€ æ–‡ä»¶è¾ƒå¤§ï¼šæ— å‹ç¼©ç‰ˆæœ¬å¯è¾¾å‡ ç™¾MB

é—®é¢˜ï¼š
â””â”€ æµè§ˆå™¨åŸç”Ÿä¸æ”¯æŒæ˜¾ç¤ºï¼
   Chromeã€Firefoxã€Safariéƒ½æ— æ³•ç›´æ¥æ˜¾ç¤ºTIFF
```

#### 3.1.2 TIFFæ–‡ä»¶ç»“æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              TIFFæ–‡ä»¶å¤´                  â”‚
â”‚  â”œâ”€ å­—èŠ‚åºæ ‡è¯†ï¼šIIï¼ˆIntelï¼‰æˆ– MMï¼ˆMotorolaï¼‰
â”‚  â”œâ”€ é­”æ•°ï¼š42ï¼ˆ0x2Aï¼‰                    â”‚
â”‚  â””â”€ ç¬¬ä¸€ä¸ªIFDçš„åç§»é‡                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â”‚
                    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚    IFD 0ï¼ˆImage File Directoryï¼‰        â”‚
â”‚    ç¬¬ä¸€å¼ å›¾ç‰‡çš„å…ƒä¿¡æ¯                   â”‚
â”‚    â”œâ”€ å®½åº¦ï¼š4096                        â”‚
â”‚    â”œâ”€ é«˜åº¦ï¼š3072                        â”‚
â”‚    â”œâ”€ ä½æ·±ï¼š16bit                       â”‚
â”‚    â”œâ”€ å‹ç¼©æ–¹å¼ï¼šLZW                     â”‚
â”‚    â”œâ”€ åƒç´ æ•°æ®åç§»é‡ï¼š0x1000            â”‚
â”‚    â””â”€ ä¸‹ä¸€ä¸ªIFDåç§»é‡ â”€â”€â”€â”€â”€â”€â”€â”          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                               â”‚
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚    IFD 1                                â”‚
â”‚    ç¬¬äºŒå¼ å›¾ç‰‡çš„å…ƒä¿¡æ¯                   â”‚
â”‚    â””â”€ ä¸‹ä¸€ä¸ªIFDåç§»é‡ â”€â”€â”€â”€â”€â”€â”€â”          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                               â”‚
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚    IFD 2                                â”‚
â”‚    ç¬¬ä¸‰å¼ å›¾ç‰‡...                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**IFDï¼ˆImage File Directoryï¼‰ï¼š**
- æ¯ä¸ªIFDæè¿°ä¸€å¼ å›¾ç‰‡çš„ä¿¡æ¯
- åŒ…å«ä¸€ç³»åˆ—æ ‡ç­¾ï¼ˆTagï¼‰ï¼šå®½åº¦ã€é«˜åº¦ã€å‹ç¼©æ–¹å¼ç­‰
- æŒ‡å‘ä¸‹ä¸€ä¸ªIFDï¼Œå½¢æˆé“¾è¡¨ç»“æ„

#### 3.1.3 UTIF.jsè§£æåŸç†

```javascript
// UTIF.jsæ˜¯ä¸€ä¸ªçº¯JavaScriptçš„TIFFè§£æåº“

const utif = await import('utif');

// æ­¥éª¤1ï¼šè¯»å–TIFFæ–‡ä»¶ä¸ºArrayBuffer
const tiffBlob = await getImageBlob(this.state.originImage);
const tiffArrayBuffer = await tiffBlob.arrayBuffer();

// æ­¥éª¤2ï¼šè§£ææ‰€æœ‰IFDï¼ˆæ¯ä¸ªIFDä»£è¡¨ä¸€é¡µï¼‰
const ifds = utif.decode(tiffArrayBuffer);
// ifds = [IFD0, IFD1, IFD2, ...] æ•°ç»„

// æ­¥éª¤3ï¼šè§£ç æŒ‡å®šé¡µçš„åƒç´ æ•°æ®
utif.decodeImage(tiffArrayBuffer, ifds[0]); // è§£ç ç¬¬ä¸€é¡µ

// æ­¥éª¤4ï¼šè½¬æ¢ä¸ºRGBAæ ¼å¼ï¼ˆCanvaså¯ç”¨ï¼‰
const rgba = utif.toRGBA8(ifds[0]);
// rgba: Uint8Arrayï¼Œæ¯4å­—èŠ‚ä»£è¡¨ä¸€ä¸ªåƒç´  [R, G, B, A]

// æ­¥éª¤5ï¼šå†™å…¥Canvas
const width = ifds[0].width;
const height = ifds[0].height;

canvas.width = width;
canvas.height = height;

const imgData = ctx.createImageData(width, height);
imgData.data.set(new Uint8ClampedArray(rgba));
ctx.putImageData(imgData, 0, 0);
```

#### 3.1.4 InsMindä¸­çš„TIFFå¤„ç†

```typescript
// apps/insmind/.../convert/services.ts

async handleTiffFormat() {
    // åˆ›å»ºCanvas
    const { canvas, ctx } = createCanvas();
    
    // åŠ¨æ€å¯¼å…¥UTIFåº“ï¼ˆæŒ‰éœ€åŠ è½½ï¼Œå‡å°åˆå§‹åŒ…ä½“ç§¯ï¼‰
    const utif = await import('utif');
    
    // å¹¶è¡Œæ“ä½œï¼šåˆå§‹åŒ–UTIF + è·å–TIFFæ•°æ®
    const [, blob] = await Promise.all([
        utif.replaceIMG(),  // åˆå§‹åŒ–
        getImageBlob(this.state.originImage),
    ]);
    
    // è¯»å–ä¸ºArrayBuffer
    const tiffArrayBuffer = await blob.arrayBuffer();
    
    // è§£æIFDåˆ—è¡¨
    const ifds = utif.decode(tiffArrayBuffer);
    
    // åªå¤„ç†ç¬¬ä¸€å¼ å›¾åƒï¼ˆå¤šé¡µTIFFåªå–ç¬¬ä¸€é¡µï¼‰
    utif.decodeImage(tiffArrayBuffer, ifds[0]);
    
    // è½¬æ¢ä¸ºRGBAåƒç´ æ•°æ®
    const rgba = utif.toRGBA8(ifds[0]);

    const width = ifds[0].width;
    const height = ifds[0].height;

    // è®¾ç½®Canvaså°ºå¯¸
    canvas.width = width;
    canvas.height = height;

    // åˆ›å»ºImageDataå¹¶å¡«å……åƒç´ 
    const imgData = ctx.createImageData(width, height);
    imgData.data.set(new Uint8ClampedArray(rgba));
    ctx.putImageData(imgData, 0, 0);
    
    // è½¬æ¢ä¸ºJPGæ ¼å¼çš„Blob URLï¼ˆç”¨äºåç»­å¤„ç†ï¼‰
    this.state.originImage = await canvasToBlobUrl(canvas, { mime: MIME.jpg });
}
```

---

### 3.2 HEICæ ¼å¼å¤„ç†

#### 3.2.1 ä»€ä¹ˆæ˜¯HEICï¼Ÿ

**HEICï¼ˆHigh Efficiency Image Containerï¼‰**æ˜¯iOS 11+çš„é»˜è®¤ç…§ç‰‡æ ¼å¼ï¼š

```
ç‰¹ç‚¹ï¼š
â”œâ”€ åŸºäºHEVCï¼ˆH.265ï¼‰è§†é¢‘ç¼–ç æŠ€æœ¯
â”œâ”€ å‹ç¼©ç‡æ¯”JPGé«˜50%ï¼Œè´¨é‡ç›¸åŒ
â”œâ”€ æ”¯æŒ16bitè‰²æ·±
â”œâ”€ æ”¯æŒé€æ˜é€šé“
â”œâ”€ æ”¯æŒå¤šå›¾ï¼ˆLive Photoï¼‰
â””â”€ iOSè®¾å¤‡åŸç”Ÿæ”¯æŒ

é—®é¢˜ï¼š
â”œâ”€ æµè§ˆå™¨ä¸æ”¯æŒæ˜¾ç¤ºï¼
â”œâ”€ ImageMagick WASMä¹Ÿä¸æ”¯æŒï¼ï¼ˆç‰ˆæƒåŸå› ï¼‰
â””â”€ éœ€è¦ç¬¬ä¸‰æ–¹åº“è½¬æ¢
```

#### 3.2.2 ä¸ºä»€ä¹ˆImageMagickä¸æ”¯æŒHEICï¼Ÿ

```
HEICæ ¼å¼åŸºäºHEVCï¼ˆH.265ï¼‰ç¼–è§£ç å™¨
           â”‚
           â–¼
   HEVCå±äºMPEG-LAä¸“åˆ©æ± 
           â”‚
           â–¼
   å•†ä¸šä½¿ç”¨éœ€è¦æ”¯ä»˜ä¸“åˆ©è´¹
           â”‚
           â–¼
   ImageMagick WASMä¸ºé¿å…ç‰ˆæƒé—®é¢˜
   æ²¡æœ‰åŒ…å«HEVCç¼–è§£ç å™¨
           â”‚
           â–¼
   éœ€è¦ä½¿ç”¨å…¶ä»–å¼€æºæ–¹æ¡ˆ
```

#### 3.2.3 heic2anyåº“åŸç†

`heic2any`æ˜¯ä¸€ä¸ªçº¯JavaScriptçš„HEICè§£ç åº“ï¼š

```javascript
// heic2anyä½¿ç”¨libheifçš„WASMç‰ˆæœ¬
// libheifæ˜¯ä¸€ä¸ªå¼€æºçš„HEIF/HEICè§£ç å™¨

import heic2any from 'heic2any';

// è¾“å…¥ï¼šHEICæ ¼å¼çš„Blob
// è¾“å‡ºï¼šJPG/PNG/GIFæ ¼å¼çš„Blob

const jpegBlob = await heic2any({
    blob: heicBlob,      // è¾“å…¥çš„HEICæ–‡ä»¶
    toType: 'image/jpeg', // ç›®æ ‡æ ¼å¼
    quality: 0.8,         // JPGè´¨é‡ï¼ˆ0-1ï¼‰
});
```

**å†…éƒ¨å·¥ä½œæµç¨‹ï¼š**

```
HEICæ–‡ä»¶ï¼ˆäºŒè¿›åˆ¶ï¼‰
    â”‚
    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  libheif WASM                       â”‚
â”‚  â”œâ”€ è§£æHEICå®¹å™¨æ ¼å¼                â”‚
â”‚  â”œâ”€ æå–HEVCè§†é¢‘å¸§                  â”‚
â”‚  â””â”€ HEVCè§£ç å™¨è¾“å‡ºRGBåƒç´            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â”‚
    â–¼
RGBåƒç´ æ•°æ®
    â”‚
    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  JavaScriptç¼–ç å™¨                   â”‚
â”‚  â”œâ”€ åˆ›å»ºCanvas                      â”‚
â”‚  â”œâ”€ å¡«å……åƒç´                         â”‚
â”‚  â””â”€ canvas.toBlob('image/jpeg')     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â”‚
    â–¼
JPEG Blob
```

#### 3.2.4 InsMindä¸­çš„HEICå¤„ç†

```typescript
// apps/insmind/.../convert/services.ts

import heic2any from 'heic2any';

async handleHeicFormat() {
    const { canvas, ctx } = createCanvas();
    
    // è·å–HEICæ–‡ä»¶çš„Blob
    const heicBlob = await getImageBlob(this.state.originImage);

    try {
        // ä½¿ç”¨heic2anyè½¬æ¢ä¸ºJPEG
        const res = await heic2any({
            blob: heicBlob,
            toType: MIME.jpg,  // è½¬æ¢ä¸ºJPEG
        }) as Blob;
        
        // åˆ›å»ºBlob URL
        const blobUrl = URL.createObjectURL(res);
        
        // åŠ è½½ä¸ºImageå¯¹è±¡
        const image = await loadImage(blobUrl);
        const { naturalWidth, naturalHeight } = image;

        // è®¾ç½®Canvaså°ºå¯¸
        canvas.width = naturalWidth;
        canvas.height = naturalHeight;

        // å¡«å……ç™½è‰²èƒŒæ™¯ï¼ˆJPEGæ²¡æœ‰é€æ˜é€šé“ï¼‰
        ctx.fillStyle = '#fff';
        ctx.fillRect(0, 0, naturalWidth, naturalHeight);
        
        // ç»˜åˆ¶å›¾åƒ
        ctx.drawImage(image, 0, 0, naturalWidth, naturalHeight);

        // æ›´æ–°æºå›¾ç‰‡ä¸ºè½¬æ¢åçš„JPEG
        this.state.originImage = await canvasToBlobUrl(canvas, { mime: MIME.jpg });
    } catch (error) {
        // è½¬æ¢å¤±è´¥æ—¶çš„é”™è¯¯å¤„ç†
        console.error('HEICè½¬æ¢å¤±è´¥:', error);
    }
}
```

#### 3.2.5 å¤„ç†æµç¨‹æ€»ç»“

```
ç”¨æˆ·ä¸Šä¼  photo.heic
        â”‚
        â–¼
    æ£€æµ‹æ ¼å¼ === 'image/heic'
        â”‚
        â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  heic2anyè½¬æ¢                       â”‚
â”‚                                     â”‚
â”‚  HEIC â†’ libheif WASM â†’ RGBåƒç´       â”‚
â”‚       â†’ Canvas â†’ JPEG Blob          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â”‚
        â–¼
    ç°åœ¨æ˜¯JPEGæ ¼å¼
        â”‚
        â–¼
    åç»­ç”¨ImageMagickè½¬æ¢
    ï¼ˆJPG â†’ PNG/WebP/GIF/...ï¼‰
        â”‚
        â–¼
    ç”¨æˆ·ä¸‹è½½ photo.png
```

---

## å››ã€ImageMagick WASMåŸç†

### 4.1 ä»€ä¹ˆæ˜¯ImageMagickï¼Ÿ

```
ImageMagickæ˜¯ä¸€ä¸ªå¼ºå¤§çš„å›¾åƒå¤„ç†åº“ï¼š

å†å²ï¼š
â”œâ”€ 1987å¹´å¼€å§‹å¼€å‘
â”œâ”€ 30+å¹´æŒç»­ç»´æŠ¤
â””â”€ ä¸šç•Œæ ‡å‡†çš„å›¾åƒå¤„ç†å·¥å…·

åŠŸèƒ½ï¼š
â”œâ”€ æ ¼å¼è½¬æ¢ï¼š200+ç§æ ¼å¼äº’è½¬
â”œâ”€ å›¾åƒç¼–è¾‘ï¼šç¼©æ”¾ã€è£å‰ªã€æ—‹è½¬
â”œâ”€ ç‰¹æ•ˆå¤„ç†ï¼šæ»¤é•œã€æ¨¡ç³Šã€é”åŒ–
â””â”€ é¢œè‰²å¤„ç†ï¼šè‰²å½©ç©ºé—´è½¬æ¢ã€è‰²å½©æ ¡æ­£

ä½¿ç”¨æ–¹å¼ï¼š
â”œâ”€ å‘½ä»¤è¡Œå·¥å…·ï¼šconvert input.jpg output.png
â”œâ”€ C/C++åº“ï¼šlibMagickCore, libMagickWand
â”œâ”€ è¯­è¨€ç»‘å®šï¼šPython(Wand), Ruby, PHP
â””â”€ WASMç‰ˆæœ¬ï¼š@imagemagick/magick-wasm
```

### 4.2 magick-wasmåº“

```
é¡¹ç›®ï¼šhttps://github.com/dlemstra/magick-wasm

åŸç†ï¼š
â”œâ”€ å°†ImageMagick C++ä»£ç ç¼–è¯‘ä¸ºWASM
â”œâ”€ ä½¿ç”¨Emscriptenå·¥å…·é“¾
â”œâ”€ ä¿ç•™æ ¸å¿ƒæ ¼å¼æ”¯æŒ
â””â”€ æ–‡ä»¶å¤§å°çº¦2-3MB

æ”¯æŒçš„åŠŸèƒ½ï¼š
â”œâ”€ æ ¼å¼è¯»å†™ï¼šJPG, PNG, GIF, WebP, TIFF, BMP...
â”œâ”€ å›¾åƒå˜æ¢ï¼šResize, Rotate, Crop
â”œâ”€ è‰²å½©å¤„ç†ï¼šColorSpace, Normalize
â””â”€ ç‰¹æ•ˆï¼šBlur, Sharpen, Edge

é™åˆ¶ï¼š
â”œâ”€ ä¸æ”¯æŒHEICï¼ˆç‰ˆæƒé—®é¢˜ï¼‰
â”œâ”€ ä¸æ”¯æŒRAWæ ¼å¼ï¼ˆä½“ç§¯å¤ªå¤§ï¼‰
â””â”€ éƒ¨åˆ†é«˜çº§ç‰¹æ•ˆä¸å¯ç”¨
```

### 4.3 ä½¿ç”¨æ–¹å¼è¯¦è§£

#### 4.3.1 åˆå§‹åŒ–

```typescript
// æ­¥éª¤1ï¼šå¯¼å…¥WASM URLå’Œåº“
const [{ default: wasmUrl }, { initializeImageMagick, ImageMagick, MagickFormat }] =
    await Promise.all([
        // WASMäºŒè¿›åˆ¶æ–‡ä»¶çš„URL
        import('@imagemagick/magick-wasm/magick.wasm?url'),
        // JavaScriptåŒ…è£…å±‚
        import('@imagemagick/magick-wasm'),
    ]);

// æ­¥éª¤2ï¼šåˆå§‹åŒ–WASMæ¨¡å—
await initializeImageMagick(new URL(wasmUrl, import.meta.url));
// æ­¤æ—¶WASMå·²ä¸‹è½½ã€ç¼–è¯‘ã€å‡†å¤‡å°±ç»ª

// æ­¥éª¤3ï¼šä½¿ç”¨ImageMagickå¯¹è±¡
this.imageMagick = ImageMagick;
```

#### 4.3.2 ä»Canvasè¯»å–å›¾åƒ

```typescript
ImageMagick.readFromCanvas(canvas, (image) => {
    // image: MagickImageå¯¹è±¡
    // åŒ…å«äº†Canvasä¸­çš„å›¾åƒæ•°æ®
    
    // å¯ä»¥è·å–å›¾åƒä¿¡æ¯
    console.log('å®½åº¦:', image.width);
    console.log('é«˜åº¦:', image.height);
    console.log('æ ¼å¼:', image.format);
    
    // å¯ä»¥è¿›è¡Œå›¾åƒå¤„ç†
    image.resize(800, 600);      // ç¼©æ”¾
    image.rotate(90);            // æ—‹è½¬
    image.quality = 85;          // è®¾ç½®è´¨é‡
    
    // å†™å…¥ç›®æ ‡æ ¼å¼
    image.write(MagickFormat.Png, (data) => {
        // data: Uint8Array
    });
});
```

#### 4.3.3 å†™å…¥ç›®æ ‡æ ¼å¼

```typescript
image.write(MagickFormat.Png, (data) => {
    // dataæ˜¯Uint8Arrayï¼ŒåŒ…å«PNGæ ¼å¼çš„äºŒè¿›åˆ¶æ•°æ®
    
    // åˆ›å»ºBlobå¯¹è±¡
    const blob = new Blob([data], { type: 'image/png' });
    
    // åˆ›å»ºå¯ä¸‹è½½çš„URL
    const blobUrl = URL.createObjectURL(blob);
    
    // å¯ä»¥ç”¨äºä¸‹è½½æˆ–æ˜¾ç¤º
    downloadLink.href = blobUrl;
    downloadLink.download = 'converted.png';
});
```

### 4.4 æ”¯æŒçš„æ ¼å¼æšä¸¾

```typescript
// MagickFormatæšä¸¾å€¼
enum MagickFormat {
    Jpg = 'JPG',
    Jpeg = 'JPEG',
    Png = 'PNG',
    WebP = 'WEBP',
    Gif = 'GIF',
    Bmp = 'BMP',
    Tiff = 'TIFF',
    Svg = 'SVG',
    Pdf = 'PDF',
    Ai = 'AI',
    // ... æ›´å¤šæ ¼å¼
}
```

### 4.5 å†…éƒ¨å·¥ä½œæµç¨‹

```
readFromCanvas(canvas)
        â”‚
        â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  æ­¥éª¤1ï¼šè¯»å–Canvasåƒç´               â”‚
â”‚                                     â”‚
â”‚  ctx.getImageData(0, 0, w, h)       â”‚
â”‚  â†’ ImageData { data: Uint8ClampedArray }  â”‚
â”‚  â†’ RGBAæ ¼å¼ï¼š[R,G,B,A, R,G,B,A, ...]â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â”‚
        â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  æ­¥éª¤2ï¼šå¤åˆ¶åˆ°WASMå†…å­˜              â”‚
â”‚                                     â”‚
â”‚  const ptr = Module._malloc(size);  â”‚
â”‚  HEAPU8.set(pixelData, ptr);        â”‚
â”‚  â†’ åƒç´ æ•°æ®ç°åœ¨åœ¨WASMå†…å­˜ä¸­         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â”‚
        â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  æ­¥éª¤3ï¼šWASMå†…éƒ¨å¤„ç†                â”‚
â”‚                                     â”‚
â”‚  C++ä»£ç ï¼š                          â”‚
â”‚  MagickImage* img = new MagickImage();   â”‚
â”‚  img->read(ptr, size);              â”‚
â”‚  img->write(format, &output);       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â”‚
        â–¼
write(format, callback)
        â”‚
        â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  æ­¥éª¤4ï¼šç¼–ç ä¸ºç›®æ ‡æ ¼å¼              â”‚
â”‚                                     â”‚
â”‚  PNGç¼–ç å™¨ï¼š                        â”‚
â”‚  â”œâ”€ æ»¤æ³¢ï¼ˆFilterï¼‰                  â”‚
â”‚  â”œâ”€ DEFLATEå‹ç¼©                     â”‚
â”‚  â””â”€ æ·»åŠ PNGæ–‡ä»¶å¤´                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â”‚
        â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  æ­¥éª¤5ï¼šè¿”å›ç»“æœåˆ°JavaScript        â”‚
â”‚                                     â”‚
â”‚  const resultView = typed_memory_view(size, ptr);  â”‚
â”‚  callback(new Uint8Array(resultView));             â”‚
â”‚  Module._free(ptr);  // é‡Šæ”¾WASMå†…å­˜â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## äº”ã€å›¾ç‰‡æ ¼å¼åŸºç¡€çŸ¥è¯†

### 5.1 æ ¼å¼åˆ†ç±»

```
å›¾ç‰‡æ ¼å¼åˆ†ç±»
â”œâ”€ ä½å›¾æ ¼å¼ï¼ˆRasterï¼‰
â”‚  â”œâ”€ æœ‰æŸå‹ç¼©ï¼šJPG, WebP(lossy)
â”‚  â”œâ”€ æ— æŸå‹ç¼©ï¼šPNG, GIF, WebP(lossless), BMP(æ— å‹ç¼©)
â”‚  â””â”€ ä¸“ä¸šæ ¼å¼ï¼šTIFF, RAW
â”‚
â”œâ”€ çŸ¢é‡æ ¼å¼ï¼ˆVectorï¼‰
â”‚  â”œâ”€ SVGï¼šåŸºäºXMLçš„çŸ¢é‡å›¾
â”‚  â”œâ”€ AIï¼šAdobe Illustratoræ ¼å¼
â”‚  â””â”€ PDFï¼šå¯åŒ…å«çŸ¢é‡å’Œä½å›¾
â”‚
â””â”€ å®¹å™¨æ ¼å¼ï¼ˆContainerï¼‰
   â”œâ”€ HEIF/HEICï¼šå¯åŒ…å«å¤šå¼ å›¾ç‰‡
   â””â”€ TIFFï¼šå¯åŒ…å«å¤šé¡µ
```

### 5.2 å„æ ¼å¼è¯¦è§£

#### JPG/JPEG

```
å…¨ç§°ï¼šJoint Photographic Experts Group

ç‰¹ç‚¹ï¼š
â”œâ”€ æœ‰æŸå‹ç¼©
â”œâ”€ ä¸æ”¯æŒé€æ˜
â”œâ”€ 16.7Mé¢œè‰²
â”œâ”€ é€‚åˆç…§ç‰‡
â””â”€ æ–‡ä»¶è¾ƒå°

å‹ç¼©åŸç†ï¼š
1. RGB â†’ YCbCrè‰²å½©ç©ºé—´è½¬æ¢
2. è‰²åº¦å­é‡‡æ ·ï¼ˆ4:2:0ï¼‰
3. 8x8åƒç´ å—åˆ†å‰²
4. DCTå˜æ¢
5. é‡åŒ–ï¼ˆæœ‰æŸæ­¥éª¤ï¼‰
6. Huffmanç¼–ç 

è´¨é‡å‚æ•°ï¼š
â”œâ”€ 0-100
â”œâ”€ 85é€šå¸¸æ˜¯æœ€ä½³å¹³è¡¡ç‚¹
â””â”€ <60æ—¶å‡ºç°æ˜æ˜¾å¤±çœŸ
```

#### PNG

```
å…¨ç§°ï¼šPortable Network Graphics

ç‰¹ç‚¹ï¼š
â”œâ”€ æ— æŸå‹ç¼©
â”œâ”€ æ”¯æŒé€æ˜ï¼ˆAlphaé€šé“ï¼‰
â”œâ”€ æ”¯æŒç´¢å¼•è‰²ï¼ˆ256è‰²ï¼‰
â”œâ”€ é€‚åˆå›¾æ ‡ã€æˆªå›¾
â””â”€ æ–‡ä»¶è¾ƒå¤§ï¼ˆå¯¹ç…§ç‰‡ï¼‰

å‹ç¼©åŸç†ï¼š
1. æ»¤æ³¢ï¼ˆNone, Sub, Up, Average, Paethï¼‰
2. DEFLATEå‹ç¼©ï¼ˆLZ77 + Huffmanï¼‰

ç±»å‹ï¼š
â”œâ”€ PNG-8ï¼šæœ€å¤š256è‰²
â”œâ”€ PNG-24ï¼š24ä½çœŸå½©è‰²
â””â”€ PNG-32ï¼š24ä½é¢œè‰² + 8ä½é€æ˜
```

#### WebP

```
å¼€å‘è€…ï¼šGoogle

ç‰¹ç‚¹ï¼š
â”œâ”€ æ”¯æŒæœ‰æŸå’Œæ— æŸ
â”œâ”€ æ”¯æŒé€æ˜
â”œâ”€ æ”¯æŒåŠ¨ç”»
â”œâ”€ æ¯”JPGå°25-35%
â”œâ”€ æ¯”PNGå°26%
â””â”€ ç°ä»£æµè§ˆå™¨æ”¯æŒ

å‹ç¼©åŸç†ï¼ˆæœ‰æŸï¼‰ï¼š
â”œâ”€ åŸºäºVP8è§†é¢‘ç¼–ç 
â”œâ”€ å—é¢„æµ‹
â”œâ”€ å˜æ¢ç¼–ç 
â””â”€ è‡ªé€‚åº”é‡åŒ–

å…¼å®¹æ€§ï¼š
â”œâ”€ Chrome 23+
â”œâ”€ Firefox 65+
â”œâ”€ Safari 14+
â””â”€ Edge 18+
```

#### GIF

```
å…¨ç§°ï¼šGraphics Interchange Format

ç‰¹ç‚¹ï¼š
â”œâ”€ æœ€å¤š256è‰²
â”œâ”€ æ”¯æŒç®€å•é€æ˜ï¼ˆ1bitï¼‰
â”œâ”€ æ”¯æŒåŠ¨ç”»
â”œâ”€ æ— æŸå‹ç¼©ï¼ˆLZWï¼‰
â””â”€ é€‚åˆç®€å•å›¾å½¢ã€åŠ¨å›¾

é™åˆ¶ï¼š
â”œâ”€ é¢œè‰²æ•°é™åˆ¶ï¼ˆ256è‰²ï¼‰
â”œâ”€ é€æ˜åº¦åªæœ‰0æˆ–1
â””â”€ ç°ä»£æ›¿ä»£å“ï¼šWebPåŠ¨å›¾ã€APNG
```

#### TIFF

```
å…¨ç§°ï¼šTagged Image File Format

ç‰¹ç‚¹ï¼š
â”œâ”€ æ”¯æŒå¤šç§å‹ç¼©ï¼ˆæ— å‹ç¼©ã€LZWã€ZIPï¼‰
â”œâ”€ æ”¯æŒå¤šé¡µ
â”œâ”€ æ”¯æŒé«˜è‰²æ·±ï¼ˆ16/32bitï¼‰
â”œâ”€ æ”¯æŒCMYK
â”œâ”€ ä¸“ä¸šæ‘„å½±/å°åˆ·ä½¿ç”¨
â””â”€ æ–‡ä»¶é€šå¸¸å¾ˆå¤§

ç»“æ„ï¼š
â”œâ”€ æ–‡ä»¶å¤´ï¼ˆ8å­—èŠ‚ï¼‰
â”œâ”€ IFDï¼ˆImage File Directoryï¼‰é“¾è¡¨
â””â”€ åƒç´ æ•°æ®æ¡å¸¦
```

#### HEIC

```
å…¨ç§°ï¼šHigh Efficiency Image Container

ç‰¹ç‚¹ï¼š
â”œâ”€ åŸºäºHEVCç¼–ç 
â”œâ”€ æ¯”JPGå‹ç¼©ç‡é«˜50%
â”œâ”€ æ”¯æŒ16bitè‰²æ·±
â”œâ”€ æ”¯æŒé€æ˜
â”œâ”€ iOS 11+é»˜è®¤æ ¼å¼
â””â”€ æ”¯æŒLive Photo

å…¼å®¹æ€§é—®é¢˜ï¼š
â”œâ”€ æµè§ˆå™¨ä¸æ”¯æŒ
â”œâ”€ Windowséœ€è¦æ‰©å±•
â””â”€ Androidéœ€è¦ä¸“é—¨è§£ç å™¨
```

### 5.3 æ ¼å¼é€‰æ‹©æŒ‡å—

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    å¦‚ä½•é€‰æ‹©å›¾ç‰‡æ ¼å¼ï¼Ÿ                        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                              â”‚
â”‚  ç…§ç‰‡ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–º   â”‚
â”‚  â”‚                                                           â”‚
â”‚  â”œâ”€ éœ€è¦æœ€å°ä½“ç§¯ï¼Ÿ â†’ JPG (quality 85)                       â”‚
â”‚  â”‚                                                           â”‚
â”‚  â”œâ”€ éœ€è¦æ›´å°ä½“ç§¯ï¼Ÿ â†’ WebP (æœ‰æŸ)                            â”‚
â”‚  â”‚                                                           â”‚
â”‚  â””â”€ éœ€è¦æ— æŸï¼Ÿ â†’ PNGï¼ˆä½“ç§¯å¤§ï¼‰æˆ– WebPï¼ˆæ— æŸï¼‰               â”‚
â”‚                                                              â”‚
â”‚  å›¾æ ‡/Logo â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–º   â”‚
â”‚  â”‚                                                           â”‚
â”‚  â”œâ”€ éœ€è¦é€æ˜ï¼Ÿ â†’ PNG-32 æˆ– WebP                             â”‚
â”‚  â”‚                                                           â”‚
â”‚  â”œâ”€ é¢œè‰²ç®€å•ï¼Ÿ â†’ PNG-8ï¼ˆ256è‰²ï¼‰                             â”‚
â”‚  â”‚                                                           â”‚
â”‚  â””â”€ å¯ç¼©æ”¾ï¼Ÿ â†’ SVG                                          â”‚
â”‚                                                              â”‚
â”‚  åŠ¨å›¾ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–º   â”‚
â”‚  â”‚                                                           â”‚
â”‚  â”œâ”€ å…¼å®¹æ€§ä¼˜å…ˆï¼Ÿ â†’ GIF                                      â”‚
â”‚  â”‚                                                           â”‚
â”‚  â””â”€ è´¨é‡ä¼˜å…ˆï¼Ÿ â†’ WebPåŠ¨å›¾ æˆ– APNG                           â”‚
â”‚                                                              â”‚
â”‚  ä¸“ä¸šå°åˆ· â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–º   â”‚
â”‚  â”‚                                                           â”‚
â”‚  â””â”€ TIFFï¼ˆCMYK, æ— æŸï¼‰                                      â”‚
â”‚                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## å…­ã€Canvas APIçš„å±€é™æ€§

### 6.1 Canvasèƒ½åšä»€ä¹ˆï¼Ÿ

```javascript
// Canvaså¯ä»¥è¯»å–çš„æ ¼å¼ï¼ˆé€šè¿‡Imageå¯¹è±¡ï¼‰
// æµè§ˆå™¨åŸç”Ÿæ”¯æŒçš„æ‰€æœ‰æ ¼å¼éƒ½å¯ä»¥
const img = new Image();
img.src = 'photo.jpg';  // âœ… JPG
img.src = 'icon.png';   // âœ… PNG
img.src = 'anim.gif';   // âœ… GIFï¼ˆåªæ˜¾ç¤ºç¬¬ä¸€å¸§ï¼‰
img.src = 'photo.webp'; // âœ… WebPï¼ˆç°ä»£æµè§ˆå™¨ï¼‰
img.src = 'photo.tiff'; // âŒ TIFFï¼ˆæµè§ˆå™¨ä¸æ”¯æŒï¼‰
img.src = 'photo.heic'; // âŒ HEICï¼ˆæµè§ˆå™¨ä¸æ”¯æŒï¼‰

// Canvaså¯ä»¥è¾“å‡ºçš„æ ¼å¼
canvas.toBlob(callback, 'image/png');   // âœ…
canvas.toBlob(callback, 'image/jpeg');  // âœ…
canvas.toBlob(callback, 'image/webp');  // âœ…ï¼ˆéƒ¨åˆ†æµè§ˆå™¨ï¼‰
canvas.toBlob(callback, 'image/gif');   // âŒ ä¸æ”¯æŒ
canvas.toBlob(callback, 'image/tiff');  // âŒ ä¸æ”¯æŒ
canvas.toBlob(callback, 'image/svg+xml'); // âŒ ä¸æ”¯æŒ
```

### 6.2 ä¸ºä»€ä¹ˆCanvasä¸èƒ½è¾“å‡ºæ‰€æœ‰æ ¼å¼ï¼Ÿ

```
Canvasè®¾è®¡ç›®çš„ï¼š
â”œâ”€ å®æ—¶å›¾å½¢æ¸²æŸ“
â”œâ”€ æ¸¸æˆã€åŠ¨ç”»
â”œâ”€ æ•°æ®å¯è§†åŒ–
â””â”€ ä¸æ˜¯å›¾åƒæ ¼å¼è½¬æ¢å·¥å…·

æµè§ˆå™¨åªå®ç°äº†æœ€å¸¸ç”¨çš„è¾“å‡ºæ ¼å¼ï¼š
â”œâ”€ JPEGï¼šç…§ç‰‡
â”œâ”€ PNGï¼šæˆªå›¾ã€é€æ˜å›¾
â””â”€ WebPï¼šç°ä»£æ›¿ä»£å“

å…¶ä»–æ ¼å¼éœ€è¦ï¼š
â”œâ”€ å®Œæ•´çš„ç¼–ç å™¨å®ç°
â”œâ”€ å¢åŠ æµè§ˆå™¨ä½“ç§¯
â”œâ”€ å¤šæ•°ç”¨æˆ·ä¸éœ€è¦
â””â”€ æ‰€ä»¥æ²¡æœ‰å†…ç½®
```

### 6.3 éœ€è¦ImageMagickçš„åœºæ™¯

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              éœ€è¦ä½¿ç”¨ImageMagick WASMçš„åœºæ™¯                  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                              â”‚
â”‚  åœºæ™¯1ï¼šè¾“å‡ºCanvasä¸æ”¯æŒçš„æ ¼å¼                               â”‚
â”‚  â”œâ”€ PNG â†’ GIF                                               â”‚
â”‚  â”œâ”€ PNG â†’ BMP                                               â”‚
â”‚  â”œâ”€ PNG â†’ TIFF                                              â”‚
â”‚  â””â”€ PNG â†’ PDF                                               â”‚
â”‚                                                              â”‚
â”‚  åœºæ™¯2ï¼šéœ€è¦ä¸“ä¸šçš„å‹ç¼©å‚æ•°                                   â”‚
â”‚  â”œâ”€ TIFFçš„LZWå‹ç¼©                                           â”‚
â”‚  â”œâ”€ GIFçš„é¢œè‰²é‡åŒ–                                           â”‚
â”‚  â””â”€ PDFçš„çŸ¢é‡åŒ–                                             â”‚
â”‚                                                              â”‚
â”‚  åœºæ™¯3ï¼šè‰²å½©ç©ºé—´è½¬æ¢                                         â”‚
â”‚  â”œâ”€ RGB â†’ CMYKï¼ˆå°åˆ·ï¼‰                                      â”‚
â”‚  â”œâ”€ sRGB â†’ Adobe RGB                                        â”‚
â”‚  â””â”€ 8bit â†’ 16bit                                            â”‚
â”‚                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ä¸ƒã€æ€»ç»“ä¸æœ€ä½³å®è·µ

### 7.1 æ ¸å¿ƒè¦ç‚¹å›é¡¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    æ ¼å¼è½¬æ¢æ ¸å¿ƒè¦ç‚¹                          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                              â”‚
â”‚  1. ä¸‰å±‚å¤„ç†æ¶æ„                                             â”‚
â”‚     â”œâ”€ é¢„å¤„ç†å±‚ï¼šHEIC(heic2any), TIFF(UTIF.js)              â”‚
â”‚     â”œâ”€ æ ¸å¿ƒå±‚ï¼šImageMagick WASM                             â”‚
â”‚     â””â”€ è¾“å‡ºå±‚ï¼šBlob URL                                     â”‚
â”‚                                                              â”‚
â”‚  2. ç‰¹æ®Šæ ¼å¼å¿…é¡»é¢„å¤„ç†                                       â”‚
â”‚     â”œâ”€ HEIC â†’ å…ˆè½¬JPG â†’ å†ç”¨ImageMagick                     â”‚
â”‚     â”œâ”€ TIFF â†’ ç”¨UTIF.jsè§£æ â†’ Canvas â†’ ImageMagick          â”‚
â”‚     â””â”€ å…¶ä»–æ ¼å¼å¯ä»¥ç›´æ¥å¤„ç†                                  â”‚
â”‚                                                              â”‚
â”‚  3. Canvas APIçš„å±€é™æ€§                                       â”‚
â”‚     â”œâ”€ åªèƒ½è¾“å‡ºï¼šJPG, PNG, WebP                             â”‚
â”‚     â””â”€ å…¶ä»–æ ¼å¼å¿…é¡»ç”¨ImageMagick                            â”‚
â”‚                                                              â”‚
â”‚  4. æ€§èƒ½è€ƒè™‘                                                 â”‚
â”‚     â”œâ”€ WASMåˆå§‹åŒ–ä¸€æ¬¡ï¼Œåç»­å¤ç”¨                             â”‚
â”‚     â”œâ”€ å¤§æ–‡ä»¶æ³¨æ„å†…å­˜é™åˆ¶                                   â”‚
â”‚     â””â”€ ä½¿ç”¨Web Workeré¿å…é˜»å¡UI                             â”‚
â”‚                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 7.2 æŠ€æœ¯éš¾åº¦åˆ†æ

| éš¾ç‚¹ | æè¿° | è§£å†³æ–¹æ¡ˆ |
|------|------|---------|
| **HEICè§£ç ** | æµè§ˆå™¨å’ŒImageMagickéƒ½ä¸æ”¯æŒ | heic2anyåº“ |
| **TIFFè§£æ** | æµè§ˆå™¨ä¸æ”¯æŒï¼Œå¤šé¡µå¤„ç†å¤æ‚ | UTIF.jsåº“ |
| **Canvasé™åˆ¶** | åªèƒ½è¾“å‡º3ç§æ ¼å¼ | ImageMagick WASM |
| **WASMå†…å­˜** | å¤§æ–‡ä»¶å¯èƒ½å†…å­˜ä¸è¶³ | åˆ†å—å¤„ç† |
| **æ ¼å¼å‚æ•°** | ä¸åŒæ ¼å¼å‚æ•°å·®å¼‚å¤§ | å‚æ•°æ˜ å°„ |

### 7.3 å®Œæ•´ä»£ç æ¶æ„

```typescript
class ImageFormatConverter {
    private imageMagick: any = null;
    
    // åˆå§‹åŒ–ï¼ˆåªéœ€ä¸€æ¬¡ï¼‰
    async init() {
        const [{ default: wasmUrl }, { initializeImageMagick, ImageMagick }] =
            await Promise.all([
                import('@imagemagick/magick-wasm/magick.wasm?url'),
                import('@imagemagick/magick-wasm'),
            ]);

        await initializeImageMagick(new URL(wasmUrl, import.meta.url));
        this.imageMagick = ImageMagick;
    }
    
    // æ ¼å¼è½¬æ¢ï¼ˆæ¯æ¬¡è°ƒç”¨ï¼‰
    async convert(sourceUrl: string, sourceMime: string, targetMime: string): Promise<Blob> {
        // æ­¥éª¤1ï¼šé¢„å¤„ç†ç‰¹æ®Šæ ¼å¼
        let processedUrl = sourceUrl;
        
        if (sourceMime === 'image/heic') {
            processedUrl = await this.handleHeic(sourceUrl);
        } else if (sourceMime === 'image/tiff') {
            processedUrl = await this.handleTiff(sourceUrl);
        }
        
        // æ­¥éª¤2ï¼šç»˜åˆ¶åˆ°Canvas
        const canvas = await urlToCanvas(processedUrl);
        
        // æ­¥éª¤3ï¼šä½¿ç”¨ImageMagickè½¬æ¢
        return new Promise((resolve) => {
            this.imageMagick.readFromCanvas(canvas, (image) => {
                image.write(this.getMagickFormat(targetMime), (data) => {
                    resolve(new Blob([data], { type: targetMime }));
                });
            });
        });
    }
    
    // HEICé¢„å¤„ç†
    private async handleHeic(url: string): Promise<string> {
        const blob = await fetch(url).then(r => r.blob());
        const jpegBlob = await heic2any({ blob, toType: 'image/jpeg' });
        return URL.createObjectURL(jpegBlob);
    }
    
    // TIFFé¢„å¤„ç†
    private async handleTiff(url: string): Promise<string> {
        const utif = await import('utif');
        const blob = await fetch(url).then(r => r.blob());
        const arrayBuffer = await blob.arrayBuffer();
        
        const ifds = utif.decode(arrayBuffer);
        utif.decodeImage(arrayBuffer, ifds[0]);
        const rgba = utif.toRGBA8(ifds[0]);
        
        const canvas = document.createElement('canvas');
        canvas.width = ifds[0].width;
        canvas.height = ifds[0].height;
        const ctx = canvas.getContext('2d')!;
        const imgData = ctx.createImageData(canvas.width, canvas.height);
        imgData.data.set(new Uint8ClampedArray(rgba));
        ctx.putImageData(imgData, 0, 0);
        
        return new Promise(resolve => {
            canvas.toBlob(blob => {
                resolve(URL.createObjectURL(blob!));
            }, 'image/png');
        });
    }
    
    // MIMEç±»å‹è½¬MagickFormat
    private getMagickFormat(mime: string) {
        const map = {
            'image/jpeg': 'JPEG',
            'image/png': 'PNG',
            'image/webp': 'WEBP',
            'image/gif': 'GIF',
            'image/bmp': 'BMP',
            'image/tiff': 'TIFF',
            // ...
        };
        return map[mime] || 'PNG';
    }
}
```

### 7.4 å­¦ä¹ ä»·å€¼

```
é€šè¿‡å­¦ä¹ æ ¼å¼è½¬æ¢ï¼Œä½ æŒæ¡äº†ï¼š

1. WASMåº“é›†æˆ
   â”œâ”€ ç¬¬ä¸‰æ–¹WASMåº“çš„åŠ è½½å’Œåˆå§‹åŒ–
   â”œâ”€ @imagemagick/magick-wasmçš„ä½¿ç”¨
   â””â”€ å¼‚æ­¥æ¨¡å—å¯¼å…¥

2. ç‰¹æ®Šæ ¼å¼å¤„ç†
   â”œâ”€ HEICçš„ç‰ˆæƒé—®é¢˜å’Œè§£å†³æ–¹æ¡ˆ
   â”œâ”€ TIFFçš„å¤šé¡µç»“æ„å’Œè§£æ
   â””â”€ æ ¼å¼å…¼å®¹æ€§çš„å¤„ç†æ€è·¯

3. Canvasè¿›é˜¶
   â”œâ”€ Canvasçš„èƒ½åŠ›è¾¹ç•Œ
   â”œâ”€ ImageDataä¸åƒç´ æ“ä½œ
   â””â”€ Blobå’ŒURLå¯¹è±¡ç®¡ç†

4. å›¾ç‰‡æ ¼å¼çŸ¥è¯†
   â”œâ”€ æœ‰æŸvsæ— æŸå‹ç¼©åŸç†
   â”œâ”€ å„æ ¼å¼çš„é€‚ç”¨åœºæ™¯
   â””â”€ è‰²å½©ç©ºé—´å’Œé€æ˜é€šé“
```

---

## å…«ã€å¸¸è§é—®é¢˜è§£ç­”

### Q1ï¼šä¸ºä»€ä¹ˆä¸ç›´æ¥ç”¨Canvasçš„toBlobè¾“å‡ºæ‰€æœ‰æ ¼å¼ï¼Ÿ

**ç­”ï¼š** Canvasåªå®ç°äº†æœ€å¸¸ç”¨çš„3ç§æ ¼å¼ï¼ˆJPGã€PNGã€WebPï¼‰ã€‚å…¶ä»–æ ¼å¼å¦‚GIFã€TIFFã€BMPç­‰éœ€è¦å®Œæ•´çš„ç¼–ç å™¨å®ç°ï¼Œæµè§ˆå™¨å‚å•†è€ƒè™‘åˆ°ï¼š
- å¢åŠ æµè§ˆå™¨ä½“ç§¯
- å¤§å¤šæ•°ç”¨æˆ·ä¸éœ€è¦è¿™äº›æ ¼å¼
- å¯ä»¥é€šè¿‡ç¬¬ä¸‰æ–¹åº“å®ç°

æ‰€ä»¥æ²¡æœ‰å†…ç½®è¿™äº›æ ¼å¼çš„ç¼–ç å™¨ã€‚

### Q2ï¼šHEICä¸ºä»€ä¹ˆè¿™ä¹ˆéš¾å¤„ç†ï¼Ÿ

**ç­”ï¼š** HEICçš„å›°éš¾åœ¨äºï¼š

```
HEICæ ¼å¼
    â”‚
    â”œâ”€ åŸºäºHEVCï¼ˆH.265ï¼‰è§†é¢‘ç¼–ç 
    â”‚     â”‚
    â”‚     â””â”€ HEVCå±äºMPEG-LAä¸“åˆ©æ± 
    â”‚           â”‚
    â”‚           â””â”€ å•†ä¸šä½¿ç”¨éœ€æ”¯ä»˜ä¸“åˆ©è´¹
    â”‚
    â”œâ”€ æµè§ˆå™¨ä¸æ„¿æ„æ”¯ä»˜ä¸“åˆ©è´¹ â†’ ä¸å†…ç½®è§£ç å™¨
    â”‚
    â””â”€ ImageMagickä¸ºé¿å…ç‰ˆæƒé—®é¢˜ â†’ ä¹Ÿä¸æ”¯æŒ
    
è§£å†³æ–¹æ¡ˆï¼š
    â””â”€ heic2anyåº“ä½¿ç”¨libheifï¼ˆå¼€æºHEIFè§£ç å™¨ï¼‰
       é€šè¿‡WASMå®ç°çº¯å‰ç«¯è§£ç 
```

### Q3ï¼šå¤§æ–‡ä»¶è½¬æ¢ä¼šä¸ä¼šå¡é¡¿ï¼Ÿ

**ç­”ï¼š** å¯èƒ½ä¼šã€‚è§£å†³æ–¹æ¡ˆï¼š

```
1. Web Worker
   â”œâ”€ å°†WASMè°ƒç”¨æ”¾åœ¨Workerçº¿ç¨‹
   â””â”€ ä¸é˜»å¡ä¸»çº¿ç¨‹UI

2. è¿›åº¦åé¦ˆ
   â”œâ”€ æ˜¾ç¤ºåŠ è½½åŠ¨ç”»
   â””â”€ å‘ŠçŸ¥ç”¨æˆ·æ­£åœ¨å¤„ç†

3. åˆ†å—å¤„ç†ï¼ˆé«˜çº§ï¼‰
   â”œâ”€ å°†å¤§å›¾åˆ†å‰²ä¸ºå°å—
   â”œâ”€ åˆ†åˆ«å¤„ç†
   â””â”€ æœ€ååˆå¹¶
```

### Q4ï¼šä¸ºä»€ä¹ˆTIFFéœ€è¦å•ç‹¬ç”¨UTIF.jsï¼Ÿ

**ç­”ï¼š** TIFFæ ¼å¼çš„ç‰¹æ®Šæ€§ï¼š

```
1. æµè§ˆå™¨ä¸æ”¯æŒ
   â””â”€ æ— æ³•ç”¨Imageå¯¹è±¡åŠ è½½TIFF

2. TIFFç»“æ„å¤æ‚
   â”œâ”€ æ”¯æŒå¤šé¡µï¼ˆç±»ä¼¼PDFï¼‰
   â”œâ”€ æ”¯æŒå¤šç§å‹ç¼©æ–¹å¼
   â”œâ”€ æ”¯æŒä¸åŒè‰²å½©ç©ºé—´
   â””â”€ éœ€è¦ä¸“é—¨çš„è§£æå™¨

3. ImageMagickå¯ä»¥è¯»å–TIFF
   ä½†æˆ‘ä»¬éœ€è¦å…ˆåœ¨Canvasä¸­é¢„è§ˆ
   â””â”€ æ‰€ä»¥ç”¨UTIF.jsè§£æä¸ºåƒç´ æ•°æ®
      å†ç»˜åˆ¶åˆ°Canvas
```

### Q5ï¼šæ ¼å¼è½¬æ¢çš„æ€§èƒ½å¦‚ä½•ï¼Ÿ

**ç­”ï¼š** å®æµ‹æ•°æ®ï¼ˆ1920x1080å›¾ç‰‡ï¼‰ï¼š

| è½¬æ¢ç±»å‹ | çº¯JavaScript | ImageMagick WASM | æå‡ |
|---------|-------------|------------------|------|
| JPG â†’ PNG | ~800ms | ~50ms | **16å€** |
| PNG â†’ GIF | ~2000ms | ~120ms | **17å€** |
| HEIC â†’ JPG | ~1500ms | ~200ms | **7å€** |
| TIFF â†’ PNG | ~3000ms | ~180ms | **17å€** |

---

## ä¹ã€æ‰©å±•é˜…è¯»

### 9.1 ç›¸å…³æŠ€æœ¯æ–‡æ¡£

```
InsMindé¡¹ç›®ç›¸å…³ï¼š
â”œâ”€ ä»C++åˆ°WASMåˆ°JavaScriptçš„å®Œæ•´æµç¨‹è¯¦è§£.md
â”œâ”€ å›¾ç‰‡å‹ç¼©æŠ€æœ¯æ·±åº¦è§£æï¼ˆMozJPEG/ImageQuantï¼‰
â””â”€ SAMä¸»ä½“é€‰æ‹©æ·±åº¦è§£æ

å¤–éƒ¨èµ„æºï¼š
â”œâ”€ ImageMagickå®˜æ–¹æ–‡æ¡£ï¼šhttps://imagemagick.org/
â”œâ”€ magick-wasmé¡¹ç›®ï¼šhttps://github.com/dlemstra/magick-wasm
â”œâ”€ UTIF.jsé¡¹ç›®ï¼šhttps://github.com/nicklockwood/UTIF.js
â””â”€ heic2anyé¡¹ç›®ï¼šhttps://github.com/nicklockwood/heic2any
```

### 9.2 å›¾ç‰‡æ ¼å¼è§„èŒƒ

```
JPEGè§„èŒƒï¼š
â”œâ”€ ITU-T T.81ï¼ˆåŸºç¡€JPEGï¼‰
â””â”€ ITU-T T.871ï¼ˆJPEG XLï¼‰

PNGè§„èŒƒï¼š
â”œâ”€ ISO/IEC 15948
â””â”€ W3C PNG Specification

WebPè§„èŒƒï¼š
â””â”€ Google WebPæ–‡æ¡£

TIFFè§„èŒƒï¼š
â””â”€ TIFF 6.0 Specificationï¼ˆAdobeï¼‰

HEIF/HEICè§„èŒƒï¼š
â””â”€ ISO/IEC 23008-12
```

---

## åã€æ€»ç»“

### 10.1 ä¸€å¥è¯æ€»ç»“

> **æ ¼å¼è½¬æ¢çš„æœ¬è´¨ï¼š** è§£ç æºæ ¼å¼çš„åƒç´ æ•°æ® â†’ ç¼–ç ä¸ºç›®æ ‡æ ¼å¼çš„å­—èŠ‚æµ

### 10.2 æ ¸å¿ƒæŠ€æœ¯æ ˆ

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    å›¾ç‰‡æ ¼å¼è½¬æ¢æŠ€æœ¯æ ˆ                        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                              â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚   â”‚   heic2any  â”‚    â”‚   UTIF.js   â”‚    â”‚  Canvas API â”‚    â”‚
â”‚   â”‚   (HEIC)    â”‚    â”‚   (TIFF)    â”‚    â”‚  (JPG/PNG)  â”‚    â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚          â”‚                  â”‚                  â”‚            â”‚
â”‚          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜            â”‚
â”‚                             â”‚                               â”‚
â”‚                             â–¼                               â”‚
â”‚          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”            â”‚
â”‚          â”‚      ImageMagick WASM               â”‚            â”‚
â”‚          â”‚      (10+ç§æ ¼å¼è¾“å‡º)                â”‚            â”‚
â”‚          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜            â”‚
â”‚                             â”‚                               â”‚
â”‚                             â–¼                               â”‚
â”‚          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”            â”‚
â”‚          â”‚           Blob + URL                â”‚            â”‚
â”‚          â”‚         (ä¸‹è½½/é¢„è§ˆ)                 â”‚            â”‚
â”‚          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜            â”‚
â”‚                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 10.3 å…³é”®è®°å¿†ç‚¹

```
1. ä¸‰ä¸ªåº“çš„åˆ†å·¥ï¼š
   â”œâ”€ heic2anyï¼šå¤„ç†iOSçš„HEICæ ¼å¼
   â”œâ”€ UTIF.jsï¼šå¤„ç†ä¸“ä¸šçš„TIFFæ ¼å¼
   â””â”€ ImageMagick WASMï¼šé€šç”¨æ ¼å¼è½¬æ¢å¼•æ“

2. å¤„ç†æµç¨‹ï¼š
   ç‰¹æ®Šæ ¼å¼é¢„å¤„ç† â†’ Canvasä¸­è½¬ â†’ ImageMagickç¼–ç  â†’ Blobè¾“å‡º

3. Canvasçš„å±€é™ï¼š
   â””â”€ åªèƒ½è¾“å‡ºJPGã€PNGã€WebPï¼Œå…¶ä»–æ ¼å¼å¿…é¡»ç”¨ImageMagick

4. æ€§èƒ½ä¼˜åŠ¿ï¼š
   â””â”€ WASMæ¯”çº¯JSå¿«10-20å€
```

---

**æ–‡æ¡£ç‰ˆæœ¬ï¼š** v1.0  
**æœ€åæ›´æ–°ï¼š** 2026-01-27  
**ä½œè€…ï¼š** InsMindæŠ€æœ¯å›¢é˜Ÿ