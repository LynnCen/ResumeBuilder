# Monorepo 工作流体系文档

## 📖 文档概述

本目录包含稿定平台 Monorepo 的完整工作流体系文档，涵盖核心概念、工作流设计、最佳实践。这些文档基于主干开发、特性开关、基础设施即代码（IaC）等现代 DevOps 最佳实践，是一次**模式级别的改变**。

---

## 🗂️ 文档结构

```
monorepo/
├── README.md                              # 本文件：文档导航
├── 01-核心概念/                           # 核心概念层
│   └── 主干开发与最佳实践.md              # 主干开发、特性开关、IaC
├── 02-工作流设计/                         # 工作流设计层
│   └── CI-CD工作流设计.md                # CI/CD 完整工作流
├── 03-实践指南/                          # 实践指南层
│   └── Docker镜像构建指南.md             # Docker + pnpm + Turbo
└── attachments/                          # 图片附件
    ├── image2025-2-13_23-15-49.png
    ├── image2025-2-17_23-26-51.png
    └── ...
```

---

## 📚 阅读指南

### 方式一：按角色阅读

#### 技术负责人 / 架构师
1. **必读**：[主干开发与最佳实践](01-核心概念/主干开发与最佳实践.md)
   - 理解主干开发模式
   - 理解特性开关的价值
   - 理解基础设施即代码
   
2. **必读**：[CI/CD 工作流设计](02-工作流设计/CI-CD工作流设计.md)
   - 了解完整的工作流设计
   - 理解角色和职责划分
   - 理解自动化流程

3. **推荐**：[Docker 镜像构建指南](03-实践指南/Docker镜像构建指南.md)
   - 了解 Monorepo 中的 Docker 构建策略
   - 理解预构建和容器化流程

#### 开发者
1. **必读**：[主干开发与最佳实践](01-核心概念/主干开发与最佳实践.md)
   - 理解新的开发模式
   - 学习特性开关的使用
   
2. **必读**：[CI/CD 工作流设计](02-工作流设计/CI-CD工作流设计.md)
   - 学习如何创建变更集
   - 学习 PR 工作流程
   - 学习发布流程

3. **推荐**：[Docker 镜像构建指南](03-实践指南/Docker镜像构建指南.md)
   - 学习如何在 Monorepo 中构建 Docker 镜像
   - 理解预构建策略

#### DevOps / 运维
1. **必读**：[CI/CD 工作流设计](02-工作流设计/CI-CD工作流设计.md)
   - 了解 CI/CD 流水线设计
   - 理解环境管理策略
   - 理解部署流程
   
2. **必读**：[Docker 镜像构建指南](03-实践指南/Docker镜像构建指南.md)
   - 掌握 Monorepo 中的 Docker 构建流程
   - 学习构建优化策略
   - 了解 CI/CD 集成方案

3. **推荐**：[主干开发与最佳实践](01-核心概念/主干开发与最佳实践.md)
   - 理解 IaC 理念
   - 理解主干开发模式

#### 测试工程师
1. **推荐**：[主干开发与最佳实践](01-核心概念/主干开发与最佳实践.md)
   - 理解新的测试模式
   - 理解特性开关与测试
   
2. **推荐**：[CI/CD 工作流设计](02-工作流设计/CI-CD工作流设计.md)
   - 了解预览环境测试流程
   - 了解发布流程

### 方式二：按顺序阅读

#### 第一阶段：理解概念（30-40分钟）
1. [主干开发与最佳实践](01-核心概念/主干开发与最佳实践.md)
   - 什么是主干开发
   - 为什么采用主干开发
   - 特性开关的作用
   - 基础设施即代码

#### 第二阶段：掌握流程（40-50分钟）
2. [CI/CD 工作流设计](02-工作流设计/CI-CD工作流设计.md)
   - 完整的工作流设计
   - 角色和职责
   - 变更集管理
   - CI/CD 流水线

#### 第三阶段：实践应用（30-40分钟）
3. [Docker 镜像构建指南](03-实践指南/Docker镜像构建指南.md)
   - pnpm + Turbo + Docker 配合
   - 预构建策略与多阶段构建
   - CI/CD 集成方案
   - 最佳实践和优化技巧

---

## 🎯 核心概念速览

### 主干开发（Trunk-Based Development）
- **定义**：开发人员围绕着主干分支上协作和编写代码，而没有其它共享的长期分支
- **目标**：持续集成、持续发布
- **模式**：小型团队直接提交，成规模团队使用短期特性分支

### 特性开关（Feature Flags）
- **定义**：通过特性标志在不部署新版本的情况下切换特性
- **目标**：解耦部署和发布，实现灰度发布和 A/B 测试
- **应用**：结合 AB 实验、灰度发布、版本管理

### 基础设施即代码（IaC）
- **定义**：将基础架构资源编码为文本文件并提交到版本控制系统
- **目标**：版本控制、一致性、可复现性、团队协作
- **实践**：构建流水线、环境配置、阿波罗配置

### 变更集（Changeset）
- **定义**：描述代码变更的 Markdown 文件
- **作用**：驱动版本发布，生成 CHANGELOG
- **格式**：包含包名、变更类型、变更描述

---

## 🚀 快速开始

### 开发者快速开始

**1. 创建特性分支**
```bash
git checkout -b feature/add-button-component
```

**2. 完成开发**
```bash
# 开发代码...
```

**3. 创建变更集**
```bash
pnpm changeset

# 选择变更的包和类型
# 填写变更描述
```

**4. 提交并创建 PR**
```bash
git add .
git commit -m "feat: 添加按钮组件"
git push origin feature/add-button-component

# 在 GitHub/GitLab 创建 PR
```

**5. 等待审查和合并**
- PR 会自动部署到预览环境
- 评审者审查代码
- 合并后自动触发版本管理流程

### DevOps 快速开始

**1. 配置 CI/CD 流水线**
- 复制工作流配置文件到 `.github/workflows/`
- 配置 Secrets（NPM_TOKEN、DEPLOY_WEBHOOK_URL 等）
- 配置环境（preview、stage、production）

**2. 验证流水线**
- 创建测试 PR，验证预览发布
- 合并 PR，验证版本管理
- 合并版本 PR，验证正式发布

---

## 📋 分支模型

### 分支类型

| 分支类型 | 命名规范 | 生命周期 | 用途 |
|---------|---------|---------|------|
| **主干分支** | `main` | 永久 | 唯一的长期分支 |
| **特性分支** | `feature/*` | 短期（几天） | 开发新特性 |
| **修复分支** | `bugfix/*` | 短期（几天） | 修复问题 |
| **发布分支** | `release/*` | 短期（自动创建） | 版本发布（只读） |
| **版本管理分支** | `changeset-release/main` | 短期（自动创建） | 版本 PR |

### 分支约束

**允许：**
- ✅ 从 main 创建短期特性分支
- ✅ 特性分支允许"结对编程"
- ✅ 自动化工具创建发布分支

**禁止：**
- ❌ 除了"结对编程"之外的共享分支
- ❌ 主干之外的长期分支
- ❌ 开发者在发布分支上提交代码

---

## 🔄 工作流程

### 开发流程

```
1. 创建特性分支
   ↓
2. 完成代码开发
   ↓
3. 运行 pnpm changeset
   ↓
4. 提交代码并创建 PR
   ↓
5. 自动发布预览版
   ↓
6. 代码评审
   ↓
7. 合并到 main
```

### 发布流程

```
1. 合并特性 PR 到 main
   ↓
2. Action 收集变更集
   ↓
3. Action 生成版本 PR
   ↓
4. 评审版本 PR
   ↓
5. 合并版本 PR
   ↓
6. Action 发布到 npm
   ↓
7. Action 创建 Git Tags
   ↓
8. Action 构建 Docker 镜像
   ↓
9. Action 通知部署系统
   ↓
10. DeploySystem 部署生产环境
```

---

## 👥 角色和职责

### 人类角色

| 角色 | 职责 | 关键动作 |
|------|------|---------|
| **PR Author** | 创建和维护 PR | 创建变更集、提交 PR、响应评审 |
| **PR Reviewer** | 代码评审 | 审查代码、提出意见、批准 PR |
| **PR Assignee** | PR 合并决策 | 合并特性 PR、合并版本 PR |

### 自动化角色

| 角色 | 职责 | 关键动作 |
|------|------|---------|
| **Action** | 自动化构建和发布 | 运行测试、发布预览、生成版本、发布正式版 |
| **DeploySystem** | 应用部署 | 部署预览环境、部署生产环境、服务监控 |

---

## 🔗 相关资源

### 内部资源
- **MVP 验证仓库**：https://gitlab.gaoding.com/gdesign/monorepo-workflows-example
- **PingCode 任务管理**：关联任务使用 `#PINGCODE-ID` 格式

### 外部资源

**主干开发：**
- Paul Hammant: 基于主干开发
- Google Cloud: 基于主干开发

**基础设施即代码：**
- Amazon: 什么是基础设施即代码
- Atlassian: 基础设施即代码
- Google Cloud 上的基础架构即代码

**特性开关：**
- Martin Fowler: Feature Toggles
- LaunchDarkly: 特性开关管理平台
- Unleash: 开源特性开关平台

**Changesets：**
- Changesets 官方文档
- Changesets GitHub 仓库

---

## ❓ 常见问题

### Q1: 为什么要采用主干开发模式？
**A:** 主干开发是持续集成、持续发布的最佳实践：
- 减少集成冲突
- 提高部署频率
- 加快问题发现
- 适用于各种规模的团队

### Q2: 什么是变更集？为什么需要它？
**A:** 变更集是描述代码变更的文件：
- 驱动版本发布
- 自动生成 CHANGELOG
- 明确变更影响范围
- 遵循语义化版本规范

### Q3: 如何处理紧急修复？
**A:** 紧急修复也遵循同样的流程：
1. 创建 bugfix 分支
2. 快速修复并测试
3. 创建变更集（patch 类型）
4. 提交 PR 进行快速评审
5. 合并后自动发布

### Q4: 预览环境什么时候创建和销毁？
**A:** 预览环境生命周期：
- **创建**：PR 创建或更新时自动创建
- **销毁**：PR 关闭或合并后自动销毁
- **注意**：stage 环境是共享的，需要协调使用

### Q5: 如何回滚版本？
**A:** 回滚策略：
- **应用回滚**：通过 DeploySystem 回滚到上一个版本
- **代码回滚**：创建 revert PR，走正常发布流程
- **快速回滚**：可以使用 DeploySystem 的快速回滚功能

### Q6: 特性开关会不会增加技术债务？
**A:** 需要注意管理：
- 定期清理已稳定的特性标志
- 保持特性标志的可搜索性
- 使用工具自动检测过期标志
- 文档记录特性标志的生命周期

---

## 📝 最佳实践

### 开发最佳实践

**变更集：**
- ✅ 每个 PR 都包含变更集
- ✅ 变更描述清晰明了
- ✅ 关联 PingCode 任务
- ✅ 选择正确的变更类型

**PR：**
- ✅ PR 保持小而专注（200-400 行）
- ✅ PR 标题和描述清晰
- ✅ 及时响应评审意见
- ✅ 合并后删除特性分支

**分支：**
- ✅ 特性分支生命周期不超过几天
- ✅ 及时同步 main 分支的变更
- ✅ 分支命名规范清晰

### 发布最佳实践

**发布频率：**
- ✅ 定期发布，避免积累
- ✅ 小批量频繁发布
- ✅ 发布前充分测试

**发布流程：**
- ✅ 准备好回滚方案
- ✅ 使用灰度发布策略
- ✅ 发布后监控服务状态
- ✅ 及时响应问题

**版本管理：**
- ✅ 遵循语义化版本规范
- ✅ 维护清晰的 CHANGELOG
- ✅ 创建有意义的 Git Tags

---

## 🎓 学习路径

### 新人入门（1-2 天）
1. 阅读 [主干开发与最佳实践](01-核心概念/主干开发与最佳实践.md)
2. 理解基本概念和术语
3. 观看现有 PR 的流程

### 实践操作（3-5 天）
1. 创建第一个 PR
2. 学习创建变更集
3. 体验预览环境
4. 参与代码评审

### 深入理解（1-2 周）
1. 阅读 [CI/CD 工作流设计](02-工作流设计/CI-CD工作流设计.md)
2. 理解 CI/CD 流水线
3. 学习环境管理
4. 参与版本发布

### 实践应用（持续）
1. 阅读 [Docker 镜像构建指南](03-实践指南/Docker镜像构建指南.md)
2. 配置项目的 Docker 构建
3. 优化构建性能
4. 集成到 CI/CD 流程

---

## 📅 更新记录

| 版本 | 日期 | 更新内容 | 更新人 |
|------|------|---------|--------|
| v1.0 | 2025-01-25 | 初始版本，整合 RFC 17 和主干开发文档 | AI |

---

## 📞 联系方式

- **技术问题**：联系 DevOps 团队
- **流程问题**：联系技术负责人
- **工具问题**：查看 MVP 验证仓库或提交 Issue

---

*最后更新：2025-01-25*
