# Agent æ¶ˆæ¯ç»“æ„è®¾è®¡

## ä¸€ã€è®¾è®¡èƒŒæ™¯

### 1.1 ä¸ºä»€ä¹ˆéœ€è¦è‡ªå®šä¹‰æ¶ˆæ¯æ ¼å¼ï¼Ÿ

åœ¨ AI Agent ç³»ç»Ÿä¸­ï¼Œç›´æ¥ä½¿ç”¨ LLM çš„æ¶ˆæ¯æ ¼å¼å­˜åœ¨ä»¥ä¸‹é—®é¢˜ï¼š

**ChatGPT é“¾è¡¨ç»“æ„ï¼š**

![](../attachments/image2025-7-1_1-8-34.png)

**è±†åŒ…åˆ—è¡¨ç»“æ„ï¼š**

![](../attachments/image2025-7-1_1-9-19.png)

**ç—›ç‚¹ï¼š**
- âŒ LLM æ¶ˆæ¯æ ¼å¼ä¸ç»Ÿä¸€
- âŒ ç¼ºå°‘çŠ¶æ€ç®¡ç†
- âŒ ä¸æ”¯æŒä¸šåŠ¡æ‰©å±•å­—æ®µ
- âŒ æ— æ³•å›æº¯å®Œæ•´çŠ¶æ€

> ğŸ’¡ **æ ¸å¿ƒæ´å¯Ÿ**  
> æ„ˆå‘è§‰å¾—å‰æœŸä¸åº”è¯¥æŠŠ LLM çš„æ¶ˆæ¯æ ¼å¼å½“ä½œä¸šåŠ¡æ ¼å¼æ¥ä½¿ç”¨ã€‚é¢å‘ä¸šåŠ¡é¢†åŸŸçš„æ¶ˆæ¯æ ¼å¼ï¼ŒåŠ¿å¿…è¦è€ƒè™‘çŠ¶æ€å’Œäº¤äº’çš„é—®é¢˜ï¼Œå¦åˆ™æ— æ³•é€šè¿‡ä¸€ä¸ªæºæ¥å›æº¯æ‰€æœ‰çš„çŠ¶æ€ã€‚

---

## äºŒã€Qwen-Agent åŸå§‹æ¶ˆæ¯æ ¼å¼

### 2.1 æ¶ˆæ¯è½¬æ¢é€»è¾‘

Qwen-Agent ç»™å‰ç«¯çš„åŸå§‹æ¶ˆæ¯éœ€è¦ç»è¿‡è½¬æ¢ï¼Œæ ¸å¿ƒå‡½æ•° `convert_fncall_to_text`:

**æ¶ˆæ¯è§’è‰²ï¼š**
- `system`ï¼šç³»ç»ŸæŒ‡ä»¤
- `user`ï¼šç”¨æˆ·è¾“å…¥
- `assistant`ï¼šAI åŠ©æ‰‹å›å¤
- `function`ï¼šå·¥å…·è°ƒç”¨ç»“æœ

**è½¬æ¢é€»è¾‘ï¼š**

```python
def convert_fncall_to_text(messages: List[Dict]) -> List[Dict]:
    new_messages = []
    for msg in messages:
        role, content, reasoning_content, name = (
            msg[ROLE], msg[CONTENT], 
            msg.get(REASONING_CONTENT, ''), 
            msg.get(NAME, None)
        )
        content = (content or '').lstrip('\n').rstrip().replace('```', '')
        
        # system or user: ç›´æ¥è¿½åŠ 
        if role in (SYSTEM, USER):
            new_messages.append({
                ROLE: role, 
                CONTENT: content, 
                NAME: name
            })
        
        # assistant: æ·»åŠ  thinking å†…å®¹
        elif role == ASSISTANT:
            if reasoning_content:
                thought = reasoning_content
                content = THINK.format(thought=thought) + content
            
            # åˆå¹¶è¿ç»­çš„ assistant æ¶ˆæ¯
            if (len(new_messages) > 0 and 
                new_messages[-1][ROLE] == ASSISTANT and 
                new_messages[-1][NAME] == name):
                new_messages[-1][CONTENT] += content
            else:
                new_messages.append({
                    ROLE: role, 
                    CONTENT: content, 
                    NAME: name
                })
        
        # function: æ·»åŠ å·¥å…·è¾“å‡º
        elif role == FUNCTION:
            assert new_messages[-1][ROLE] == ASSISTANT
            new_messages[-1][CONTENT] += TOOL_OUTPUT.format(
                tool_output=content
            )
        
        else:
            raise TypeError
    
    return new_messages
```

### 2.2 å·¥å…·è°ƒç”¨æ¨¡æ¿

**å·¥å…·è°ƒç”¨å¼€å§‹ï¼š**
```python
TOOL_CALL = '''
âœ±âœ±âœ± Start calling tool "{tool_name}" ...

{tool_input}
âœ±âœ±âœ±
'''
```

**å·¥å…·è¾“å‡ºï¼š**
```python
TOOL_OUTPUT = '''
âœ±âœ±âœ± Finished tool calling.

{tool_output}
âœ±âœ±âœ±
'''
```

---

## ä¸‰ã€ç¨¿å®šæ¶ˆæ¯æ ¼å¼

### 3.1 æ¶ˆæ¯ç»´åº¦

è€ƒè™‘åˆ°æ¶ˆæ¯å…¥åº“ã€å‰ç«¯çŠ¶æ€å±•ç¤ºï¼Œæˆ‘ä»¬å¯¹æ¶ˆæ¯æ ¼å¼è¿›è¡Œæ‰©å±•ï¼Œåˆ†ä¸ºä¸¤å¤§ç±»ï¼š
- **æ¶ˆæ¯ç»´åº¦**ï¼šæ¶ˆæ¯å­—æ®µçš„å¯è§æ€§
- **ä¼šè¯ç»´åº¦**ï¼šæ¶ˆæ¯çš„å¯è§æ€§

### 3.2 å­—æ®µå®šä¹‰

#### ä¸€çº§å­—æ®µ

| å­—æ®µ | ç±»å‹ | è¯´æ˜ |
|------|------|------|
| `thread_id` | varchar(100) | ä¼šè¯ IDï¼Œç”± Agent åç«¯ç”Ÿæˆï¼›é¦–æ¬¡å¯¹è¯æ—¶å‰ç«¯ä¼ ç©º |
| `message_id` | varchar(100) | æ¶ˆæ¯å”¯ä¸€æ ‡è¯†ï¼Œç”± Agent åç«¯ç”Ÿæˆï¼Œthread å†…å”¯ä¸€ |
| `local_thread_id` | varchar(100) | å‰ç«¯æœ¬åœ°çš„ä¼šè¯ IDï¼ŒAgent ä¼šè®°å½• |
| `local_message_id` | varchar(100) | å‰ç«¯æœ¬åœ°çš„æ¶ˆæ¯ IDï¼ŒAgent ä¼šè®°å½• |
| `role` | string | æ¶ˆæ¯è§’è‰²/ç±»å‹ï¼ˆè§ä¸‹è¡¨ï¼‰ |
| `content` | JSON | æ¶ˆæ¯å†…å®¹ï¼ˆè§ 3.3ï¼‰ |
| `input_skill_id` | int | ç”¨æˆ·é€‰æ‹©çš„æŠ€èƒ½ ID |
| `attachments` | JSON Array | é™„ä»¶åˆ—è¡¨ |
| `extra` | JSON | é¢å¤–ä¿¡æ¯ |

#### Role ç±»å‹

| Role | è¯´æ˜ |
|------|------|
| `system` | ç³»ç»ŸæŒ‡ä»¤ |
| `user` | ç”¨æˆ·è¾“å…¥ |
| `assistant` | AI åŠ©æ‰‹å›å¤ |
| `function` | å·¥å…·è°ƒç”¨ |
| `status` | çŠ¶æ€æ¶ˆæ¯ï¼ˆè§ç¬¬å››èŠ‚ï¼‰ |
| `heartbeat` | å¿ƒè·³åŒ…ï¼Œä»…ä¿æ´»ä½¿ç”¨ |

### 3.3 Content ç»“æ„

Content æ˜¯ JSON ç»“æ„ï¼ŒåŒ…å«ä»¥ä¸‹å­—æ®µï¼š

| å­—æ®µ | è¯´æ˜ |
|------|------|
| `type` | å†…å®¹ç±»å‹ï¼Œå½±å“å¯¹ content çš„è§£æ |
| `text` | æ–‡æœ¬å†…å®¹ï¼ŒJSON ç»“æ„ï¼Œæ ¹æ® type è§£æ |

#### Content Type ç±»å‹

| Type | è¯´æ˜ |
|------|------|
| `plain` | çº¯æ–‡æœ¬å†…å®¹ |
| `function_call` | å·¥å…·è°ƒç”¨æŒ‡ä»¤ |
| `function_response` | å·¥å…·è°ƒç”¨ç»“æœ |
| `reasoning` | Reasoning æ¨¡å‹çš„æ€è€ƒå†…å®¹ |

### 3.4 æŠ€èƒ½ ID (input_skill_id)

| ID | æŠ€èƒ½åç§° |
|----|----------|
| 1 | æœç´¢ |
| 2 | å›¾åƒç”Ÿæˆ |
| 3 | è§†é¢‘ç”Ÿæˆ |
| ... | å…¶ä»–æŠ€èƒ½ |

### 3.5 å®Œæ•´ç¤ºä¾‹

**ç”¨æˆ·æ¶ˆæ¯ï¼š**
```json
{
  "thread_id": "thread_abc123",
  "message_id": "msg_001",
  "local_thread_id": "local_thread_001",
  "local_message_id": "local_msg_001",
  "role": "user",
  "content": {
    "type": "plain",
    "text": "å¸®æˆ‘ç”Ÿæˆä¸€å¼ ç‰™è†äº§å“å›¾"
  },
  "input_skill_id": 2,
  "attachments": [],
  "extra": {}
}
```

**Assistant æ¶ˆæ¯ï¼ˆå·¥å…·è°ƒç”¨ï¼‰ï¼š**
```json
{
  "thread_id": "thread_abc123",
  "message_id": "msg_002",
  "role": "assistant",
  "content": {
    "type": "function_call",
    "text": {
      "tool_name": "é€šç”¨å›¾åƒç”Ÿæˆ",
      "parameters": {
        "user_prompt": "ä¸€æ”¯é«˜ç«¯ç‰™è†äº§å“...",
        "width": "512",
        "height": "512"
      }
    }
  },
  "extra": {}
}
```

**Function æ¶ˆæ¯ï¼ˆå·¥å…·ç»“æœï¼‰ï¼š**
```json
{
  "thread_id": "thread_abc123",
  "message_id": "msg_003",
  "role": "function",
  "content": {
    "type": "function_response",
    "text": {
      "tool_name": "é€šç”¨å›¾åƒç”Ÿæˆ",
      "result": "success",
      "image_url": "https://example.com/image.png",
      "task_id": "task_123"
    }
  },
  "extra": {
    "deduct_points": 10
  }
}
```

---

## å››ã€çŠ¶æ€æ¶ˆæ¯

### 4.1 å®šä¹‰

çŠ¶æ€æ¶ˆæ¯æ˜¯ `role = status` çš„ç‰¹æ®Šæ¶ˆæ¯ï¼Œç”¨äºä¼ é€’ç³»ç»ŸçŠ¶æ€å’Œæ§åˆ¶æŒ‡ä»¤ã€‚

### 4.2 Content ç»“æ„

```json
{
  "code": -1001,
  "message": "åœæ­¢ç”Ÿæˆçš„åŸå› ",
  "extra": {
    "message_id": "msg_xxx"
  }
}
```

### 4.3 çŠ¶æ€ç å®šä¹‰

#### åç«¯ç”Ÿæˆçš„çŠ¶æ€æ¶ˆæ¯

| Code | Message | è¯´æ˜ | Extra å®šä¹‰ |
|------|---------|------|------------|
| -1001 | åœæ­¢ç”Ÿæˆçš„åŸå›  | ç”¨äºåœæ­¢ç”Ÿæˆ | `message_id`ï¼šè¢«åœæ­¢çš„æ¶ˆæ¯ ID |
| -1002 | ç¨¿è±†ä¸è¶³ | ç¨¿è±†æ‰£é™¤å¤±è´¥<br/>å‰ç«¯éœ€å¼•å¯¼ç”¨æˆ·å……å€¼ | `last_tool_message_id`ï¼šæœ€åä¸€æ¬¡å·¥å…·è°ƒç”¨çš„æ¶ˆæ¯ ID |
| -1003 | LLMã€å·¥å…·è°ƒç”¨è¶…å‡ºé™åˆ¶ | å•è½®å¯¹è¯ä¸­ï¼ŒLLM æˆ–å·¥å…·è°ƒç”¨æ•°è¶…é˜ˆå€¼ | - |
| -1004 | Token è¿‡æœŸ | ç”¨æˆ· token è¿‡æœŸ<br/>å‰ç«¯éœ€é™é»˜åˆ·æ–°æˆ–å¼•å¯¼é‡æ–°ç™»å½• | - |
| -1005 | å¿ƒè·³æ¶ˆæ¯ | ä¿æŒè¿æ¥æ´»è·ƒ | - |
| -1006 | ä¸­æ–­å¹¶æ’¤å› | Guardrails æ£€æµ‹åˆ° jailbreak ç­‰å¼‚å¸¸<br/>ä¸­æ–­å¹¶æ’¤å›å·²è¾“å‡ºå†…å®¹ | `revoked_message_id`ï¼šè¢«æ’¤å›çš„æ¶ˆæ¯ ID |
| -1007 | å®‰å…¨é¢„è­¦ | Guardrails æ£€æµ‹åˆ°é£é™©è¯æ±‡<br/>ä¸ä¸­æ–­è¾“å‡ºï¼Œä»…æç¤ºé£é™© | - |

#### å‰ç«¯ç”Ÿæˆçš„çŠ¶æ€æ¶ˆæ¯

| Code | Message | è¯´æ˜ | Extra å®šä¹‰ |
|------|---------|------|------------|
| -2001 | æ¢å¤æ‰§è¡Œ | ç”¨æˆ·å®Œæˆå……å€¼æˆ–ç™»å½•åæ¢å¤æ‰§è¡Œ<br/>åç«¯æ£€æµ‹åˆ°æ­¤æ¶ˆæ¯æ—¶æ‰§è¡Œæ¢å¤æµç¨‹ | `message_id`ï¼šä¸­æ–­æ—¶çš„æ¶ˆæ¯ ID |

### 4.4 çŠ¶æ€æ¶ˆæ¯ç¤ºä¾‹

**ç¨¿è±†ä¸è¶³ï¼ˆåç«¯ â†’ å‰ç«¯ï¼‰ï¼š**
```json
{
  "thread_id": "thread_abc123",
  "message_id": "status_001",
  "role": "status",
  "content": {
    "code": -1002,
    "message": "ç¨¿è±†ä¸è¶³",
    "extra": {
      "last_tool_message_id": "msg_003"
    }
  }
}
```

**æ¢å¤æ‰§è¡Œï¼ˆå‰ç«¯ â†’ åç«¯ï¼‰ï¼š**
```json
{
  "thread_id": "thread_abc123",
  "message_id": "status_002",
  "role": "status",
  "content": {
    "code": -2001,
    "message": "æ¢å¤æ‰§è¡Œï¼šç”¨æˆ·å®Œæˆå……å€¼",
    "extra": {
      "message_id": "status_001"
    }
  }
}
```

**å®‰å…¨é¢„è­¦ï¼ˆåç«¯ â†’ å‰ç«¯ï¼‰ï¼š**
```json
{
  "thread_id": "thread_abc123",
  "message_id": "status_003",
  "role": "status",
  "content": {
    "code": -1007,
    "message": "å®‰å…¨é¢„è­¦",
    "extra": {
      "warning": "è¾“å‡ºå†…å®¹å¯èƒ½åŒ…å«é£é™©è¯æ±‡"
    }
  }
}
```

---

## äº”ã€ä¸­æ–­ä¸æ¢å¤æœºåˆ¶

### 5.1 ä¸­æ–­åœºæ™¯

| åœºæ™¯ | è§¦å‘æ¡ä»¶ | çŠ¶æ€ç  | æ¢å¤æ–¹å¼ |
|------|----------|--------|----------|
| ç¨¿è±†ä¸è¶³ | å·¥å…·è°ƒç”¨æ‰£è´¹å¤±è´¥ | -1002 | ç”¨æˆ·å……å€¼åå‘é€ -2001 |
| Token è¿‡æœŸ | ç”¨æˆ·è®¤è¯å¤±æ•ˆ | -1004 | å‰ç«¯åˆ·æ–° token åé‡æ–°è¯·æ±‚ |
| å†…å®¹å®‰å…¨ | Guardrails æ£€æµ‹åˆ°é£é™© | -1006 | æ’¤å›æ¶ˆæ¯ï¼Œç”¨æˆ·ä¿®æ”¹è¾“å…¥ |
| è¶…é™ | LLM/å·¥å…·è°ƒç”¨æ¬¡æ•°è¶…é˜ˆå€¼ | -1003 | ä¸å¯æ¢å¤ï¼Œéœ€æ–°å»ºä¼šè¯ |

### 5.2 æ¢å¤æµç¨‹

```mermaid
sequenceDiagram
    participant User
    participant Frontend
    participant Agent
    participant Tool

    User->>Frontend: å‘é€æ¶ˆæ¯
    Frontend->>Agent: è¯·æ±‚å¤„ç†
    Agent->>Tool: è°ƒç”¨å·¥å…·
    Tool-->>Agent: ç¨¿è±†ä¸è¶³
    Agent->>Frontend: çŠ¶æ€æ¶ˆæ¯ -1002
    Frontend->>User: æç¤ºå……å€¼
    
    User->>Frontend: å®Œæˆå……å€¼
    Frontend->>Agent: å‘é€ -2001 æ¢å¤æ‰§è¡Œ
    Agent->>Agent: æ£€æµ‹æ¢å¤çŠ¶æ€
    Agent->>Tool: é‡è¯•å·¥å…·è°ƒç”¨
    Tool-->>Agent: è°ƒç”¨æˆåŠŸ
    Agent->>Frontend: è¿”å›ç»“æœ
```

### 5.3 æ¢å¤é€»è¾‘

**åç«¯æ£€æµ‹é€»è¾‘ï¼š**
```python
def should_resume(thread_messages):
    """æ£€æŸ¥ä¼šè¯æ˜¯å¦éœ€è¦æ¢å¤æ‰§è¡Œ"""
    if not thread_messages:
        return False
    
    last_message = thread_messages[-1]
    
    # æ£€æŸ¥æœ€åä¸€æ¡æ¶ˆæ¯æ˜¯å¦ä¸ºæ¢å¤çŠ¶æ€
    if (last_message.role == 'status' and 
        last_message.content.get('code') == -2001):
        return True
    
    return False

def resume_execution(thread_id, status_message):
    """æ¢å¤ä¼šè¯æ‰§è¡Œ"""
    # è·å–ä¸­æ–­æ—¶çš„æ¶ˆæ¯ ID
    interrupted_message_id = status_message.content['extra']['message_id']
    
    # ä»ä¸­æ–­ç‚¹æ¢å¤
    # ...
```

---

## å…­ã€æœ€ä½³å®è·µ

### 6.1 æ¶ˆæ¯è®¾è®¡åŸåˆ™

**DOï¼š**
- âœ… ä½¿ç”¨ç»Ÿä¸€çš„æ¶ˆæ¯æ ¼å¼
- âœ… è®°å½•å®Œæ•´çš„çŠ¶æ€ä¿¡æ¯
- âœ… ä¿æŒæ¶ˆæ¯ä¸å¯å˜æ€§ï¼ˆä¸€æ—¦åˆ›å»ºä¸ä¿®æ”¹ï¼‰
- âœ… ä½¿ç”¨çŠ¶æ€æ¶ˆæ¯ä¼ é€’æ§åˆ¶æŒ‡ä»¤
- âœ… è®°å½•æœ¬åœ° ID ä¾¿äºå‰ç«¯å…³è”

**DON'Tï¼š**
- âŒ ç›´æ¥ä½¿ç”¨ LLM çš„æ¶ˆæ¯æ ¼å¼
- âŒ åœ¨æ¶ˆæ¯ä¸­å­˜å‚¨å¤§æ–‡ä»¶ï¼ˆä½¿ç”¨ attachmentsï¼‰
- âŒ ä¿®æ”¹å·²åˆ›å»ºçš„æ¶ˆæ¯
- âŒ åœ¨ content ä¸­åµŒå¥—è¿‡æ·±çš„ JSON

### 6.2 å‰ç«¯å¤„ç†å»ºè®®

**çŠ¶æ€å¤„ç†ï¼š**
```typescript
function handleStatusMessage(statusMessage) {
  const { code, message, extra } = statusMessage.content;
  
  switch (code) {
    case -1002: // ç¨¿è±†ä¸è¶³
      showRechargeDialog(extra.last_tool_message_id);
      break;
    
    case -1004: // Token è¿‡æœŸ
      refreshToken().then(() => {
        // é‡æ–°å‘é€è¯·æ±‚
      });
      break;
    
    case -1006: // ä¸­æ–­å¹¶æ’¤å›
      revokeMessage(extra.revoked_message_id);
      break;
    
    case -1007: // å®‰å…¨é¢„è­¦
      showWarningBanner(message);
      break;
    
    default:
      console.warn('Unknown status code:', code);
  }
}
```

**æ¢å¤æ‰§è¡Œï¼š**
```typescript
function resumeAfterRecharge(threadId, interruptedMessageId) {
  const resumeMessage = {
    thread_id: threadId,
    role: 'status',
    content: {
      code: -2001,
      message: 'æ¢å¤æ‰§è¡Œï¼šç”¨æˆ·å®Œæˆå……å€¼',
      extra: {
        message_id: interruptedMessageId
      }
    }
  };
  
  sendMessage(resumeMessage);
}
```

---

## ä¸ƒã€æ€»ç»“

### 7.1 æ ¸å¿ƒè®¾è®¡

1. **ç»Ÿä¸€æ ¼å¼**ï¼šä¸ä¾èµ–ç‰¹å®š LLM çš„æ¶ˆæ¯æ ¼å¼
2. **çŠ¶æ€ç®¡ç†**ï¼šé€šè¿‡çŠ¶æ€æ¶ˆæ¯å®ç°ä¸­æ–­ä¸æ¢å¤
3. **æ‰©å±•æ€§**ï¼šæ”¯æŒä¸šåŠ¡å­—æ®µæ‰©å±•
4. **å¯è¿½æº¯**ï¼šå®Œæ•´è®°å½•æ¶ˆæ¯å†å²

### 7.2 å…³é”®ç‰¹æ€§

- âœ… æ”¯æŒå¤šç§æ¶ˆæ¯ç±»å‹ï¼ˆuserã€assistantã€functionã€statusï¼‰
- âœ… å®Œæ•´çš„çŠ¶æ€ç ä½“ç³»
- âœ… ä¸­æ–­ä¸æ¢å¤æœºåˆ¶
- âœ… æœ¬åœ° ID å…³è”
- âœ… æŠ€èƒ½é€‰æ‹©
- âœ… é™„ä»¶æ”¯æŒ

---

*æ–‡æ¡£ç‰ˆæœ¬ï¼šv1.0*  
*æœ€åæ›´æ–°ï¼š2025-01-26*
