# æ¶ˆæ¯ç³»ç»Ÿæ·±å…¥åŸç†

> **ç†è§£ AI Agent çš„é€šä¿¡è¯­è¨€**

---

## ä¸€ã€ä¸ºä»€ä¹ˆéœ€è¦è‡ªå®šä¹‰æ¶ˆæ¯æ ¼å¼ï¼Ÿï¼ˆæ·±å…¥åˆ†æï¼‰

### 1.1 LLM åŸç”Ÿæ ¼å¼çš„æ·±å±‚é—®é¢˜

#### ChatGPT çš„é“¾è¡¨ç»“æ„å‰–æ

ä» `image2025-7-1_1-8-34.png` å¯ä»¥çœ‹åˆ° ChatGPT çš„æ¶ˆæ¯ç»“æ„ï¼š

```json
{
  "mapping": {
    "7e5528af-c94d-47a9-9d97-a940f601d491": {
      "id": "7e5528af-c94d-47a99d97-a940f601d491",
      "message": {
        "id": "7e5528af-c94d-47a9-9d97-a940f601d491",
        "author": {
          "role": "system",
          "name": null,
          "metadata": {}
        },
        "content": {
          "content_type": "text",
          "parts": ["..."]
        },
        "status": "finished_successfully",
        "end_turn": true,
        "metadata": {
          "is_visually_hidden_from_conversation": true
        }
      },
      "parent": "aaa14f48-f585-462a-a22a-cb6be5550bf6",
      "children": ["aaa22956-f5e7-4e1e-ab3b-19719f2cecc1"]
    }
  }
}
```

**æ·±å±‚é—®é¢˜åˆ†æ**ï¼š

1. **æ ‘å½¢ç»“æ„çš„å¤æ‚æ€§**
   - ä½¿ç”¨ `parent` å’Œ `children` æ„æˆæ ‘
   - éœ€è¦é€’å½’éå†æ‰èƒ½è·å–å¯¹è¯å†å²
   - éš¾ä»¥åšèŒƒå›´æŸ¥è¯¢ï¼ˆå¦‚"è·å–æœ€è¿‘10æ¡æ¶ˆæ¯"ï¼‰

2. **å…ƒæ•°æ®å†—ä½™**
   - `id` å­—æ®µé‡å¤å‡ºç°
   - `metadata` åµŒå¥—è¿‡æ·±
   - `is_visually_hidden_from_conversation` è¿™ç±»å­—æ®µä¸šåŠ¡è€¦åˆ

3. **å­˜å‚¨æ•ˆç‡ä½**
   - JSON åµŒå¥—å±‚æ¬¡æ·±
   - å…³ç³»å‹æ•°æ®åº“å­˜å‚¨å›°éš¾
   - æŸ¥è¯¢æ€§èƒ½å·®

#### Doubao çš„åˆ—è¡¨ç»“æ„å‰–æ

ä» `image2025-7-1_1-9-19.png` å¯ä»¥çœ‹åˆ°è±†åŒ…çš„æ¶ˆæ¯ç»“æ„ï¼š

```json
{
  "data": {
    "message_list": [
      {
        "conversation_id": "9807447576487938",
        "section_id": "9807447576488194",
        "message_id": "10646269206109442",
        "local_message_id": "",
        "index": 26,
        "content": "{\"text\":\"ä»¥ä¸‹æ˜¯ä¸€äº›å¸¸è§è¯­è¨€ä¸­"ä½ å¥½"çš„è¡¨è¾¾...",
        "ext": {
          "bot_id": "7338286299411103781",
          "inner_app_id": "582478",
          "inner_platform": "web",
          ...
        }
      }
    ]
  }
}
```

**æ·±å±‚é—®é¢˜åˆ†æ**ï¼š

1. **å­—æ®µå‘½åä¸ä¸€è‡´**
   - `conversation_id` vs OpenAI çš„ `thread_id`
   - `content` æ˜¯å­—ç¬¦ä¸²ï¼Œéœ€è¦äºŒæ¬¡è§£æ
   - `ext` å­—æ®µé‡Œå¡äº†å¤§é‡å†…éƒ¨å­—æ®µ

2. **ä¸šåŠ¡è€¦åˆä¸¥é‡**
   - `inner_app_id`, `inner_platform` ç­‰å†…éƒ¨å­—æ®µæš´éœ²
   - `bot_id` æ˜¯è±†åŒ…ç‰¹æœ‰æ¦‚å¿µ
   - éš¾ä»¥é€‚é…å…¶ä»– LLM

3. **æ‰©å±•æ€§å·®**
   - Content æ˜¯çº¯å­—ç¬¦ä¸²ï¼Œéš¾ä»¥è¡¨è¾¾å¤æ‚ç±»å‹
   - æ²¡æœ‰é¢„ç•™çš„æ‰©å±•å­—æ®µ
   - ç¼ºå°‘ç‰ˆæœ¬ç®¡ç†

### 1.2 ç»Ÿä¸€æ ¼å¼çš„è®¾è®¡å“²å­¦

> ğŸ’¡ **æ ¸å¿ƒæ´å¯Ÿ**  
> "æ„ˆå‘è§‰å¾—å‰æœŸä¸åº”è¯¥æŠŠ LLM çš„æ¶ˆæ¯æ ¼å¼å½“ä½œä¸šåŠ¡æ ¼å¼æ¥ä½¿ç”¨ã€‚é¢å‘ä¸šåŠ¡é¢†åŸŸçš„æ¶ˆæ¯æ ¼å¼ï¼ŒåŠ¿å¿…è¦è€ƒè™‘çŠ¶æ€å’Œäº¤äº’çš„é—®é¢˜ï¼Œå¦åˆ™æ— æ³•é€šè¿‡ä¸€ä¸ªæºæ¥å›æº¯æ‰€æœ‰çš„çŠ¶æ€ã€‚"

**è®¾è®¡å“²å­¦**ï¼š

1. **åˆ†ç¦»å…³æ³¨ç‚¹**
   ```
   LLM æ¶ˆæ¯æ ¼å¼ â† é€‚é…å±‚ â†’ ä¸šåŠ¡æ¶ˆæ¯æ ¼å¼
   ```
   - LLM æ ¼å¼ï¼šä¸“æ³¨äº LLM çš„è¾“å…¥è¾“å‡º
   - ä¸šåŠ¡æ ¼å¼ï¼šä¸“æ³¨äºä¸šåŠ¡é€»è¾‘å’ŒçŠ¶æ€ç®¡ç†
   - é€‚é…å±‚ï¼šè´Ÿè´£æ ¼å¼è½¬æ¢

2. **é¢†åŸŸé©±åŠ¨è®¾è®¡**
   - æ¶ˆæ¯æ ¼å¼åº”è¯¥åæ˜ ä¸šåŠ¡é¢†åŸŸæ¨¡å‹
   - è€Œä¸æ˜¯åæ˜  LLM çš„æŠ€æœ¯å®ç°

3. **é¢å‘æœªæ¥çš„å¯æ‰©å±•æ€§**
   - æ”¯æŒæ–°çš„æ¶ˆæ¯ç±»å‹
   - æ”¯æŒæ–°çš„ä¸šåŠ¡å­—æ®µ
   - æ”¯æŒç‰ˆæœ¬æ¼”è¿›

---

## äºŒã€æ¶ˆæ¯æ ¼å¼è¯¦ç»†è®¾è®¡

### 2.1 ä¸€çº§å­—æ®µè®¾è®¡

| å­—æ®µ | ç±»å‹ | å¿…éœ€ | è¯´æ˜ | è®¾è®¡ç†ç”± |
|------|------|------|------|----------|
| `thread_id` | varchar(100) | âœ… | ä¼šè¯ ID | å…³è”ä¼šè¯ |
| `message_id` | varchar(100) | âœ… | æ¶ˆæ¯ ID | å…¨å±€å”¯ä¸€æ ‡è¯† |
| `local_thread_id` | varchar(100) | - | å‰ç«¯æœ¬åœ°ä¼šè¯ ID | æ”¯æŒç¦»çº¿å’Œä¹è§‚æ›´æ–° |
| `local_message_id` | varchar(100) | - | å‰ç«¯æœ¬åœ°æ¶ˆæ¯ ID | å‰ç«¯å…³è”ç”¨ |
| `role` | string | âœ… | æ¶ˆæ¯è§’è‰² | åŒºåˆ†æ¶ˆæ¯ç±»å‹ |
| `content` | JSON | âœ… | æ¶ˆæ¯å†…å®¹ | ç»“æ„åŒ–å†…å®¹ |
| `input_skill_id` | int | - | ç”¨æˆ·é€‰æ‹©çš„æŠ€èƒ½ | ä¸šåŠ¡æ‰©å±• |
| `attachments` | JSON Array | - | é™„ä»¶åˆ—è¡¨ | æ”¯æŒå¤šæ¨¡æ€ |
| `extra` | JSON | - | é¢å¤–ä¿¡æ¯ | é¢„ç•™æ‰©å±•å­—æ®µ |

#### å­—æ®µè®¾è®¡æ·±åº¦åˆ†æ

**1. ä¸ºä»€ä¹ˆæœ‰ä¸¤å¥— IDï¼Ÿ**

```typescript
{
  "local_thread_id": "local_001",   // å‰ç«¯ç”Ÿæˆ
  "thread_id": "thread_abc123",     // åç«¯ç”Ÿæˆ
  "local_message_id": "local_msg_001",
  "message_id": "msg_123"
}
```

**åŸå› **ï¼š

- **ç¦»çº¿æ”¯æŒ**ï¼šå‰ç«¯å¯ä»¥åœ¨ç¦»çº¿æ—¶åˆ›å»ºæœ¬åœ°ä¼šè¯
- **ä¹è§‚æ›´æ–°**ï¼šå‰ç«¯ä¸éœ€è¦ç­‰å¾…åç«¯å“åº”
- **å…³è”æ˜ å°„**ï¼šå‰ç«¯å¯ä»¥é€šè¿‡æœ¬åœ° ID æ‰¾åˆ°å¯¹åº”çš„æœåŠ¡ç«¯ ID
- **é”™è¯¯æ¢å¤**ï¼šå¦‚æœåˆ›å»ºå¤±è´¥ï¼Œå‰ç«¯å¯ä»¥é€šè¿‡æœ¬åœ° ID é‡è¯•

**æµç¨‹**ï¼š

```
å‰ç«¯åˆ›å»ºæ¶ˆæ¯
  â†“
ç”Ÿæˆ local_message_id = "local_msg_001"
  â†“
ä¹è§‚æ˜¾ç¤ºï¼ˆä½¿ç”¨æœ¬åœ° IDï¼‰
  â†“
å‘é€åˆ°åç«¯
  â†“
åç«¯ç”Ÿæˆ message_id = "msg_abc123"
  â†“
å‰ç«¯è®°å½•æ˜ å°„ï¼šlocal_msg_001 â†’ msg_abc123
  â†“
æ›´æ–°æ˜¾ç¤ºï¼ˆä½¿ç”¨æœåŠ¡ç«¯ IDï¼‰
```

**2. ä¸ºä»€ä¹ˆ Content æ˜¯ JSON è€Œä¸æ˜¯å­—ç¬¦ä¸²ï¼Ÿ**

âŒ **å­—ç¬¦ä¸²æ–¹æ¡ˆ**ï¼š
```json
{
  "content": "å¸®æˆ‘ç”Ÿæˆä¸€å¼ å›¾"
}
```

é—®é¢˜ï¼š
- æ— æ³•åŒºåˆ†ç±»å‹ï¼ˆçº¯æ–‡æœ¬ vs å·¥å…·è°ƒç”¨ï¼‰
- æ— æ³•æºå¸¦ç»“æ„åŒ–ä¿¡æ¯
- å‰ç«¯éœ€è¦è§£æå­—ç¬¦ä¸²

âœ… **JSON æ–¹æ¡ˆ**ï¼š
```json
{
  "content": {
    "type": "plain",
    "text": "å¸®æˆ‘ç”Ÿæˆä¸€å¼ å›¾"
  }
}
```

ä¼˜åŠ¿ï¼š
- ç±»å‹æ˜ç¡®
- ç»“æ„æ¸…æ™°
- æ˜“äºæ‰©å±•

**3. ä¸ºä»€ä¹ˆéœ€è¦ extra å­—æ®µï¼Ÿ**

**è®¾è®¡åŸåˆ™**ï¼š**å¼€æ”¾å°é—­åŸåˆ™**
- å¯¹æ‰©å±•å¼€æ”¾
- å¯¹ä¿®æ”¹å°é—­

**ç¤ºä¾‹**ï¼š

```json
{
  "extra": {
    "deduct_points": 10,        // æ‰£é™¤ç¨¿è±†
    "execution_time_ms": 5000,  // æ‰§è¡Œè€—æ—¶
    "model_version": "v1.2",    // æ¨¡å‹ç‰ˆæœ¬
    "debug_info": {...}         // è°ƒè¯•ä¿¡æ¯ï¼ˆä»…éç”Ÿäº§ç¯å¢ƒï¼‰
  }
}
```

ä¸éœ€è¦ä¿®æ”¹è¡¨ç»“æ„ï¼Œå°±å¯ä»¥æ·»åŠ æ–°å­—æ®µã€‚

### 2.2 Role ç±»å‹æ·±åº¦è§£æ

| Role | ç”Ÿæˆè€… | ä½œç”¨ | ç‰¹ç‚¹ |
|------|--------|------|------|
| `system` | ç³»ç»Ÿ | è®¾å®š LLM è¡Œä¸º | é€šå¸¸æ˜¯ç¬¬ä¸€æ¡æ¶ˆæ¯ |
| `user` | ç”¨æˆ· | ç”¨æˆ·è¾“å…¥ | å¯ä»¥æºå¸¦é™„ä»¶å’ŒæŠ€èƒ½ ID |
| `assistant` | LLM | AI å›å¤æˆ–å·¥å…·è°ƒç”¨ | å¯ä»¥åŒ…å« reasoning |
| `function` | å·¥å…· | å·¥å…·æ‰§è¡Œç»“æœ | æ€»æ˜¯è·Ÿåœ¨ function_call å |
| `status` | ç³»ç»Ÿ | çŠ¶æ€æ¶ˆæ¯ | ç”¨äºæ§åˆ¶æµç¨‹ |
| `heartbeat` | ç³»ç»Ÿ | å¿ƒè·³åŒ… | ä»…ä¿æŒè¿æ¥æ´»è·ƒ |

#### Heartbeat çš„è®¾è®¡ç†ç”±

**é—®é¢˜**ï¼šSSE é•¿è¿æ¥å¯èƒ½è¢«ç½‘å…³æˆ–ä»£ç†æ–­å¼€

**è§£å†³æ–¹æ¡ˆ**ï¼šå®šæœŸå‘é€å¿ƒè·³

```javascript
// åç«¯æ¯ 30 ç§’å‘é€ä¸€æ¬¡å¿ƒè·³
setInterval(() => {
  send_sse({
    role: "heartbeat",
    content: { code: -1005, message: "heartbeat" }
  })
}, 30000)

// å‰ç«¯æ£€æµ‹å¿ƒè·³
let lastHeartbeat = Date.now()
setInterval(() => {
  if (Date.now() - lastHeartbeat > 60000) {
    // 60ç§’æ²¡æ”¶åˆ°å¿ƒè·³ï¼Œè®¤ä¸ºè¿æ¥æ–­å¼€
    reconnect()
  }
}, 10000)
```

### 2.3 Content ç±»å‹æ·±åº¦è§£æ

#### Type æšä¸¾

| Type | è¯´æ˜ | ä½¿ç”¨åœºæ™¯ | Content.text ç±»å‹ |
|------|------|----------|-------------------|
| `plain` | çº¯æ–‡æœ¬ | ç”¨æˆ·è¾“å…¥ã€LLM å›å¤ | string |
| `function_call` | å·¥å…·è°ƒç”¨æŒ‡ä»¤ | LLM å†³å®šè°ƒç”¨å·¥å…· | FunctionCall |
| `function_response` | å·¥å…·æ‰§è¡Œç»“æœ | å·¥å…·è¿”å›ç»“æœ | FunctionResponse |
| `reasoning` | æ€è€ƒå†…å®¹ | Reasoning æ¨¡å‹çš„æ€è€ƒè¿‡ç¨‹ | string |

#### FunctionCall ç»“æ„

```typescript
interface FunctionCall {
  tool_name: string
  parameters: Record<string, any>
}

// ç¤ºä¾‹
{
  "type": "function_call",
  "text": {
    "tool_name": "generate_image",
    "parameters": {
      "user_prompt": "ä¸€å¼ ç‰™è†äº§å“å›¾",
      "width": "512",
      "height": "512",
      "style": "ç®€çº¦"
    }
  }
}
```

**ä¸ºä»€ä¹ˆå‚æ•°æ˜¯ Record<string, any>ï¼Ÿ**

- **çµæ´»æ€§**ï¼šä¸åŒå·¥å…·çš„å‚æ•°ä¸åŒ
- **å¯æ‰©å±•**ï¼šå·¥å…·å¯ä»¥éšæ—¶æ·»åŠ æ–°å‚æ•°
- **JSON å…¼å®¹**ï¼šå¯ä»¥ç›´æ¥åºåˆ—åŒ–

**å‚æ•°éªŒè¯**ï¼š

```python
def validate_function_call(tool_name, parameters):
    tool = get_tool(tool_name)
    
    # æ£€æŸ¥å¿…éœ€å‚æ•°
    for param_name, param_def in tool.required_params.items():
        if param_name not in parameters:
            raise ValueError(f"Missing required parameter: {param_name}")
    
    # æ£€æŸ¥å‚æ•°ç±»å‹
    for param_name, param_value in parameters.items():
        param_def = tool.params[param_name]
        if not isinstance(param_value, param_def['type']):
            raise TypeError(f"Parameter {param_name} must be {param_def['type']}")
    
    return True
```

#### FunctionResponse ç»“æ„

```typescript
interface FunctionResponse {
  tool_name: string
  result: "success" | "failed"
  [key: string]: any  // å·¥å…·ç‰¹å®šçš„è¿”å›å­—æ®µ
}

// å›¾åƒç”Ÿæˆå·¥å…·è¿”å›
{
  "type": "function_response",
  "text": {
    "tool_name": "generate_image",
    "result": "success",
    "image_url": "https://cdn.gaoding.com/xxx.png",
    "task_id": "task_123",
    "width": 512,
    "height": 512
  }
}

// æœç´¢å·¥å…·è¿”å›
{
  "type": "function_response",
  "text": {
    "tool_name": "search_templates",
    "result": "success",
    "results": [
      {"id": "1", "title": "...", "thumbnail": "..."},
      {"id": "2", "title": "...", "thumbnail": "..."}
    ],
    "total": 100,
    "page": 1
  }
}
```

**ä¸ºä»€ä¹ˆå…è®¸åŠ¨æ€å­—æ®µï¼Ÿ**

- ä¸åŒå·¥å…·è¿”å›çš„å­—æ®µä¸åŒ
- é¿å…å®šä¹‰å¤§é‡çš„æ¥å£ç±»å‹
- ä¿æŒçµæ´»æ€§

---

## ä¸‰ã€çŠ¶æ€æ¶ˆæ¯çš„æ·±å±‚è®¾è®¡

### 3.1 çŠ¶æ€æ¶ˆæ¯çš„æœ¬è´¨

**çŠ¶æ€æ¶ˆæ¯æ˜¯ä¸€ç§ç‰¹æ®Šçš„æ§åˆ¶æµæ¶ˆæ¯ï¼Œå®ƒä¸æºå¸¦ä¸šåŠ¡æ•°æ®ï¼Œè€Œæ˜¯æºå¸¦æ§åˆ¶æŒ‡ä»¤ã€‚**

**ç±»æ¯”**ï¼š
- æ™®é€šæ¶ˆæ¯ = HTTP çš„ 200 å“åº”ï¼ˆæ­£å¸¸æ•°æ®ï¼‰
- çŠ¶æ€æ¶ˆæ¯ = HTTP çš„ 4xx/5xx çŠ¶æ€ç ï¼ˆé”™è¯¯æ§åˆ¶ï¼‰

**åŒºåˆ«**ï¼š
| ç»´åº¦ | æ™®é€šæ¶ˆæ¯ | çŠ¶æ€æ¶ˆæ¯ |
|------|----------|----------|
| **æ¥æº** | ç”¨æˆ·æˆ– LLM | ç³»ç»Ÿ |
| **å†…å®¹** | ä¸šåŠ¡æ•°æ® | æ§åˆ¶æŒ‡ä»¤ |
| **ä½œç”¨** | æ¨è¿›å¯¹è¯ | æ§åˆ¶æµç¨‹ |
| **æŒä¹…åŒ–** | éœ€è¦ | å¯é€‰ |

### 3.2 çŠ¶æ€ç è®¾è®¡å“²å­¦

#### åˆ†æ®µè®¾è®¡

```
-1xxxï¼šåç«¯ â†’ å‰ç«¯çš„çŠ¶æ€æ¶ˆæ¯
-2xxxï¼šå‰ç«¯ â†’ åç«¯çš„çŠ¶æ€æ¶ˆæ¯
-3xxxï¼šé¢„ç•™ï¼ˆå¦‚ç³»ç»Ÿé—´é€šä¿¡ï¼‰
```

**ä¸ºä»€ä¹ˆåˆ†æ®µï¼Ÿ**

1. **èŒè´£æ˜ç¡®**ï¼šä¸€çœ‹å°±çŸ¥é“æ˜¯è°å‘çš„
2. **é˜²æ­¢å†²çª**ï¼šä¸ä¼šæœ‰ç›¸åŒçš„çŠ¶æ€ç 
3. **æ˜“äºæ‰©å±•**ï¼šæ¯æ®µå†…å¯ä»¥ç‹¬ç«‹æ·»åŠ æ–°çŠ¶æ€ç 

#### åç«¯çŠ¶æ€ç è¯¦è§£

| Code | Message | è§¦å‘æ¡ä»¶ | å‰ç«¯å¤„ç† | Extra å­—æ®µ |
|------|---------|---------|----------|-----------|
| `-1001` | åœæ­¢ç”Ÿæˆ | ç”¨æˆ·ç‚¹å‡»åœæ­¢æŒ‰é’® | åœæ­¢æ˜¾ç¤ºæµå¼è¾“å‡º | `message_id`: è¢«åœæ­¢çš„æ¶ˆæ¯ ID |
| `-1002` | ç¨¿è±†ä¸è¶³ | å·¥å…·è°ƒç”¨æ—¶ç¨¿è±†ä½™é¢ä¸è¶³ | æ˜¾ç¤ºå……å€¼å¼¹çª— | `last_tool_message_id`: æœ€åä¸€æ¬¡å·¥å…·è°ƒç”¨çš„æ¶ˆæ¯ ID |
| `-1003` | LLM/å·¥å…·è°ƒç”¨è¶…é™ | å•è½®å¯¹è¯è°ƒç”¨æ¬¡æ•°è¶…è¿‡é˜ˆå€¼ | æç¤ºç”¨æˆ·ï¼Œç»“æŸå¯¹è¯ | - |
| `-1004` | Token è¿‡æœŸ | ç”¨æˆ· Token å¤±æ•ˆ | é™é»˜åˆ·æ–°æˆ–å¼•å¯¼ç™»å½• | - |
| `-1005` | å¿ƒè·³ | å®šæ—¶å‘é€ | æ›´æ–°æœ€åå¿ƒè·³æ—¶é—´ | - |
| `-1006` | ä¸­æ–­å¹¶æ’¤å› | Guardrails æ£€æµ‹åˆ°é£é™© | æ’¤å›å·²è¾“å‡ºçš„æ¶ˆæ¯ï¼Œæ˜¾ç¤ºè­¦å‘Š | `revoked_message_id`: è¢«æ’¤å›çš„æ¶ˆæ¯ ID |
| `-1007` | å®‰å…¨é¢„è­¦ | Guardrails æ£€æµ‹åˆ°è½»å¾®é£é™© | æ˜¾ç¤ºè­¦å‘Šæç¤ºï¼Œä½†ä¸ä¸­æ–­ | `warning`: è­¦å‘Šä¿¡æ¯ |

#### å‰ç«¯çŠ¶æ€ç è¯¦è§£

| Code | Message | è§¦å‘æ¡ä»¶ | åç«¯å¤„ç† | Extra å­—æ®µ |
|------|---------|---------|----------|-----------|
| `-2001` | æ¢å¤æ‰§è¡Œ | ç”¨æˆ·å……å€¼åç‚¹å‡»"ç»§ç»­" | æ£€æµ‹åˆ°æ­¤æ¶ˆæ¯ï¼Œä»ä¸­æ–­ç‚¹æ¢å¤ | `message_id`: ä¸­æ–­æ—¶çš„çŠ¶æ€æ¶ˆæ¯ ID |

### 3.3 çŠ¶æ€æ¶ˆæ¯çš„ç”Ÿå‘½å‘¨æœŸ

#### -1002ï¼ˆç¨¿è±†ä¸è¶³ï¼‰çš„å®Œæ•´æµç¨‹

```mermaid
sequenceDiagram
    participant User
    participant Frontend
    participant Agent
    participant Tool
    participant Payment

    User->>Frontend: ç”Ÿæˆå›¾ç‰‡
    Frontend->>Agent: POST /chat (input_skill_id=2)
    Agent->>Agent: æ£€æŸ¥ LLM è°ƒç”¨æ¬¡æ•°
    Agent->>Tool: è°ƒç”¨å›¾åƒç”Ÿæˆå·¥å…·
    Tool->>Tool: æ£€æŸ¥ç¨¿è±†ä½™é¢
    Tool-->>Agent: ç¨¿è±†ä¸è¶³
    
    Note over Agent: ç”ŸæˆçŠ¶æ€æ¶ˆæ¯ -1002
    
    Agent->>Frontend: SSE: status message (-1002)
    Frontend->>User: æ˜¾ç¤ºå……å€¼å¼¹çª—
    
    User->>Payment: å®Œæˆå……å€¼
    Payment-->>Frontend: å……å€¼æˆåŠŸå›è°ƒ
    
    Frontend->>Agent: POST /chat (resume=true, status message -2001)
    
    Note over Agent: æ£€æµ‹åˆ°æ¢å¤æ¶ˆæ¯
    
    Agent->>Agent: ä» messages ä¸­æ‰¾åˆ°ä¸­æ–­ç‚¹
    Agent->>Tool: é‡è¯•å·¥å…·è°ƒç”¨
    Tool->>Tool: æ£€æŸ¥ç¨¿è±†ä½™é¢ï¼ˆå……å€¼åä½™é¢å……è¶³ï¼‰
    Tool-->>Agent: è°ƒç”¨æˆåŠŸï¼Œè¿”å›å›¾ç‰‡
    Agent->>Frontend: SSE: function response
    Frontend->>User: æ˜¾ç¤ºç”Ÿæˆç»“æœ
```

#### -1006ï¼ˆä¸­æ–­å¹¶æ’¤å›ï¼‰çš„å®Œæ•´æµç¨‹

```mermaid
sequenceDiagram
    participant User
    participant Frontend
    participant Agent
    participant LLM
    participant Guardrails

    User->>Frontend: ç”Ÿæˆæ•æ„Ÿå†…å®¹
    Frontend->>Agent: POST /chat
    Agent->>LLM: è°ƒç”¨ LLM
    
    Note over LLM: å¼€å§‹æµå¼è¾“å‡º
    
    LLM-->>Agent: chunk 1: "è¿™æ˜¯..."
    Agent->>Frontend: SSE: chunk 1
    Frontend->>User: æ˜¾ç¤º "è¿™æ˜¯..."
    
    LLM-->>Agent: chunk 2: "ä¸€ä¸ªå…³äº..."
    Agent->>Guardrails: æ£€æµ‹å†…å®¹
    Guardrails-->>Agent: æ£€æµ‹åˆ°é«˜é£é™©è¯æ±‡
    
    Note over Agent: ç”ŸæˆçŠ¶æ€æ¶ˆæ¯ -1006
    
    Agent->>Frontend: SSE: status message (-1006)
    Frontend->>Frontend: æ’¤å›å·²æ˜¾ç¤ºçš„å†…å®¹
    Frontend->>User: æ˜¾ç¤ºè­¦å‘Šï¼š"å†…å®¹åŒ…å«æ•æ„Ÿä¿¡æ¯"
    
    Note over Agent: ç»ˆæ­¢ LLM æµå¼è¾“å‡º
```

### 3.4 çŠ¶æ€æ¶ˆæ¯çš„å­˜å‚¨ç­–ç•¥

**é—®é¢˜**ï¼šçŠ¶æ€æ¶ˆæ¯éœ€è¦æŒä¹…åŒ–å—ï¼Ÿ

**ç­”æ¡ˆ**ï¼šåˆ†æƒ…å†µ

| çŠ¶æ€ç  | æ˜¯å¦æŒä¹…åŒ– | ç†ç”± |
|--------|-----------|------|
| `-1001` (åœæ­¢) | âœ… æ˜¯ | éœ€è¦è®°å½•ç”¨æˆ·ä¸»åŠ¨åœæ­¢çš„å†å² |
| `-1002` (ç¨¿è±†ä¸è¶³) | âœ… æ˜¯ | éœ€è¦æ¢å¤ï¼Œå¿…é¡»æŒä¹…åŒ– |
| `-1003` (è¶…é™) | âœ… æ˜¯ | éœ€è¦è®°å½•è¶…é™åŸå›  |
| `-1004` (Tokenè¿‡æœŸ) | âŒ å¦ | ä¸´æ—¶çŠ¶æ€ï¼Œä¸éœ€è¦æŒä¹…åŒ– |
| `-1005` (å¿ƒè·³) | âŒ å¦ | ä»…ä¿æŒè¿æ¥ï¼Œä¸éœ€è¦æŒä¹…åŒ– |
| `-1006` (æ’¤å›) | âœ… æ˜¯ | éœ€è¦å®¡è®¡è¿½è¸ª |
| `-1007` (é¢„è­¦) | âœ… æ˜¯ | éœ€è¦åˆ†æé¢„è­¦è®°å½• |
| `-2001` (æ¢å¤) | âœ… æ˜¯ | éœ€è¦è®°å½•æ¢å¤æ“ä½œ |

**å®ç°**ï¼š

```python
PERSISTENT_STATUS_CODES = {
    -1001, -1002, -1003, -1006, -1007, -2001
}

def should_persist_status_message(code):
    return code in PERSISTENT_STATUS_CODES

def send_status_message(thread_id, code, message, extra=None):
    status_msg = {
        "thread_id": thread_id,
        "role": "status",
        "content": {
            "code": code,
            "message": message,
            "extra": extra or {}
        }
    }
    
    # å‘é€ç»™å‰ç«¯
    send_sse(status_msg)
    
    # æ ¹æ®çŠ¶æ€ç å†³å®šæ˜¯å¦æŒä¹…åŒ–
    if should_persist_status_message(code):
        message_id = generate_message_id()
        status_msg["message_id"] = message_id
        save_message(status_msg)
    
    return status_msg
```

---

## å››ã€Qwen-Agent çš„æ¶ˆæ¯è½¬æ¢æœºåˆ¶

### 4.1 convert_fncall_to_text å‡½æ•°è§£æ

ä»ç°æœ‰æ–‡æ¡£å¯ä»¥çœ‹åˆ°ï¼ŒQwen-Agent éœ€è¦è½¬æ¢æ¶ˆæ¯æ ¼å¼ï¼š

```python
def convert_fncall_to_text(messages: List[Dict]) -> List[Dict]:
    """
    å°† function æ¶ˆæ¯è½¬æ¢ä¸º assistant æ¶ˆæ¯
    
    åŸå› ï¼š
    1. ä¾¿äºå‰ç«¯å±•ç¤º
    2. LLM æ›´å®¹æ˜“ç†è§£
    3. ä¿æŒå¯¹è¯çš„è¿ç»­æ€§
    """
    new_messages = []
    
    for msg in messages:
        role, content, reasoning_content, name = (
            msg[ROLE], msg[CONTENT], 
            msg.get(REASONING_CONTENT, ''), 
            msg.get(NAME, None)
        )
        
        # å»é™¤å¤šä½™çš„ç©ºç™½å’Œä»£ç å—æ ‡è®°
        content = (content or '').lstrip('\n').rstrip().replace('```', '')
        
        # system æˆ– user æ¶ˆæ¯ç›´æ¥è¿½åŠ 
        if role in (SYSTEM, USER):
            new_messages.append({
                ROLE: role, 
                CONTENT: content, 
                NAME: name
            })
        
        # assistant æ¶ˆæ¯ï¼šæ·»åŠ  thinking å†…å®¹
        elif role == ASSISTANT:
            if reasoning_content:
                thought = reasoning_content
                content = THINK.format(thought=thought) + content
            
            # åˆå¹¶è¿ç»­çš„ assistant æ¶ˆæ¯
            if (len(new_messages) > 0 and 
                new_messages[-1][ROLE] == ASSISTANT and 
                new_messages[-1][NAME] == name):
                new_messages[-1][CONTENT] += content
            else:
                new_messages.append({
                    ROLE: role, 
                    CONTENT: content, 
                    NAME: name
                })
        
        # function æ¶ˆæ¯ï¼šåˆå¹¶åˆ°æœ€åä¸€æ¡ assistant æ¶ˆæ¯ä¸­
        elif role == FUNCTION:
            assert new_messages[-1][ROLE] == ASSISTANT
            new_messages[-1][CONTENT] += TOOL_OUTPUT.format(
                tool_output=content
            )
        
        else:
            raise TypeError(f"Unknown role: {role}")
    
    return new_messages
```

### 4.2 ä¸ºä»€ä¹ˆéœ€è¦è½¬æ¢ï¼Ÿ

**åœºæ™¯ 1ï¼šå±•ç¤ºå·¥å…·è°ƒç”¨ç»“æœ**

**è½¬æ¢å‰**ï¼š

```json
[
  {"role": "assistant", "content": "<tool_call>{...}</tool_call>"},
  {"role": "function", "content": "{'result': 'success', 'image_url': '...'}"}
]
```

å‰ç«¯éœ€è¦ï¼š
1. è§£æ assistant æ¶ˆæ¯æ‰¾åˆ°å·¥å…·è°ƒç”¨
2. å…³è” function æ¶ˆæ¯
3. åˆ†åˆ«æ¸²æŸ“

**è½¬æ¢å**ï¼š

```json
[
  {
    "role": "assistant",
    "content": "âœ±âœ±âœ± Start calling tool \"generate_image\" ...\n{...}\nâœ±âœ±âœ±\nâœ±âœ±âœ± Finished tool calling.\n{'result': 'success', 'image_url': '...'}\nâœ±âœ±âœ±"
  }
]
```

å‰ç«¯åªéœ€è¦ï¼š
1. æ¸²æŸ“ assistant æ¶ˆæ¯
2. è§£æç‰¹æ®Šæ ‡è®° `âœ±âœ±âœ±`
3. åˆ†åŒºåŸŸæ˜¾ç¤º

**åœºæ™¯ 2ï¼šLLM ç†è§£ä¸Šä¸‹æ–‡**

LLM åœ¨ç†è§£å†å²å¯¹è¯æ—¶ï¼Œæ›´å®¹æ˜“ç†è§£ï¼š

```
Assistant: æˆ‘æ­£åœ¨è°ƒç”¨å·¥å…· generate_image ç”Ÿæˆå›¾ç‰‡...
[å·¥å…·æ‰§è¡Œç»“æœï¼šæˆåŠŸï¼Œå›¾ç‰‡URL: xxx]
```

è€Œä¸æ˜¯ï¼š

```
Message 1: <tool_call>{...}</tool_call>
Message 2: (role=function) {...}
```

### 4.3 å·¥å…·è°ƒç”¨æ¨¡æ¿

```python
# å·¥å…·è°ƒç”¨å¼€å§‹æ ‡è®°
TOOL_CALL = '''
âœ±âœ±âœ± Start calling tool "{tool_name}" ...

{tool_input}
âœ±âœ±âœ±
'''

# å·¥å…·æ‰§è¡Œç»“æœæ ‡è®°
TOOL_OUTPUT = '''
âœ±âœ±âœ± Finished tool calling.

{tool_output}
âœ±âœ±âœ±
'''

# Thinking å†…å®¹æ ‡è®°
THINK = '''
<think>
{thought}
</think>

'''
```

**ä¸ºä»€ä¹ˆä½¿ç”¨ç‰¹æ®Šæ ‡è®°ï¼Ÿ**

1. **æ˜“äºè§£æ**ï¼š`âœ±âœ±âœ±` ä¸ä¼šå‡ºç°åœ¨æ­£å¸¸æ–‡æœ¬ä¸­
2. **æ˜“äºè¯†åˆ«**ï¼šè§†è§‰ä¸Šæ˜æ˜¾
3. **æ˜“äºç§»é™¤**ï¼šå‰ç«¯å¯ä»¥é€‰æ‹©éšè—è¿™äº›æ ‡è®°

---

## äº”ã€æ¶ˆæ¯çš„ç”Ÿå‘½å‘¨æœŸç®¡ç†

### 5.1 æ¶ˆæ¯çš„åˆ›å»º

```python
def create_message(
    thread_id: str,
    role: str,
    content: dict,
    input_skill_id: int = None,
    attachments: list = None,
    extra: dict = None
) -> dict:
    """åˆ›å»ºæ¶ˆæ¯"""
    
    # 1. ç”Ÿæˆæ¶ˆæ¯ ID
    message_id = generate_message_id()
    
    # 2. éªŒè¯æ¶ˆæ¯æ ¼å¼
    validate_message(role, content)
    
    # 3. æ„é€ æ¶ˆæ¯å¯¹è±¡
    message = {
        "thread_id": thread_id,
        "message_id": message_id,
        "role": role,
        "content": content,
        "input_skill_id": input_skill_id,
        "attachments": attachments or [],
        "extra": extra or {},
        "created_at": datetime.utcnow().isoformat()
    }
    
    # 4. æŒä¹…åŒ–
    save_message(message)
    
    # 5. è¿”å›
    return message
```

### 5.2 æ¶ˆæ¯çš„æŸ¥è¯¢

```python
# è·å–ä¼šè¯çš„æ‰€æœ‰æ¶ˆæ¯
def get_messages(thread_id: str) -> List[dict]:
    return db.query(
        "SELECT * FROM messages WHERE thread_id = ? ORDER BY created_at",
        thread_id
    )

# è·å–ä¼šè¯çš„æœ€è¿‘Næ¡æ¶ˆæ¯
def get_recent_messages(thread_id: str, limit: int = 10) -> List[dict]:
    return db.query(
        "SELECT * FROM messages WHERE thread_id = ? "
        "ORDER BY created_at DESC LIMIT ?",
        thread_id, limit
    )

# è·å–ç‰¹å®šè§’è‰²çš„æ¶ˆæ¯
def get_messages_by_role(thread_id: str, role: str) -> List[dict]:
    return db.query(
        "SELECT * FROM messages WHERE thread_id = ? AND role = ? "
        "ORDER BY created_at",
        thread_id, role
    )
```

### 5.3 æ¶ˆæ¯çš„ç»Ÿè®¡

```python
# ç»Ÿè®¡ LLM è°ƒç”¨æ¬¡æ•°
def count_llm_calls(messages: List[dict]) -> int:
    return sum(
        1 for msg in messages 
        if msg['role'] == 'assistant' and 
           msg['content']['type'] in ('plain', 'function_call')
    )

# ç»Ÿè®¡å·¥å…·è°ƒç”¨æ¬¡æ•°
def count_tool_calls(messages: List[dict]) -> int:
    return sum(
        1 for msg in messages 
        if msg['role'] == 'function'
    )

# æ£€æŸ¥æ˜¯å¦éœ€è¦æ¢å¤
def needs_resume(messages: List[dict]) -> bool:
    if not messages:
        return False
    
    last_msg = messages[-1]
    
    # æœ€åä¸€æ¡æ¶ˆæ¯æ˜¯æ¢å¤çŠ¶æ€æ¶ˆæ¯
    if (last_msg['role'] == 'status' and 
        last_msg['content']['code'] == -2001):
        return True
    
    return False
```

---

## å…­ã€æœ€ä½³å®è·µ

### 6.1 æ¶ˆæ¯è®¾è®¡åŸåˆ™

**DOï¼š**
- âœ… ä½¿ç”¨ç±»å‹å®‰å…¨çš„ Content ç»“æ„
- âœ… è®°å½•å®Œæ•´çš„ä¸Šä¸‹æ–‡ä¿¡æ¯
- âœ… ä¿æŒæ¶ˆæ¯ä¸å¯å˜
- âœ… ä½¿ç”¨çŠ¶æ€æ¶ˆæ¯ä¼ é€’æ§åˆ¶æŒ‡ä»¤
- âœ… è®°å½•æœ¬åœ° ID ä¾¿äºå‰ç«¯å…³è”

**DON'Tï¼š**
- âŒ ç›´æ¥ä½¿ç”¨ LLM çš„æ¶ˆæ¯æ ¼å¼
- âŒ åœ¨æ¶ˆæ¯ä¸­å­˜å‚¨å¤§æ–‡ä»¶
- âŒ ä¿®æ”¹å·²åˆ›å»ºçš„æ¶ˆæ¯
- âŒ åœ¨ content ä¸­åµŒå¥—è¿‡æ·±

### 6.2 å‰ç«¯å¤„ç†å»ºè®®

```typescript
// æ¶ˆæ¯å¤„ç†å™¨
class MessageHandler {
  handle(message: Message) {
    switch (message.role) {
      case 'user':
        return this.handleUserMessage(message)
      case 'assistant':
        return this.handleAssistantMessage(message)
      case 'function':
        return this.handleFunctionMessage(message)
      case 'status':
        return this.handleStatusMessage(message)
      case 'heartbeat':
        return this.handleHeartbeat(message)
    }
  }
  
  handleStatusMessage(message: StatusMessage) {
    const { code, message: msg, extra } = message.content
    
    switch (code) {
      case -1002: // ç¨¿è±†ä¸è¶³
        this.showRechargeDialog(extra.last_tool_message_id)
        break
      
      case -1004: // Token è¿‡æœŸ
        this.refreshToken().then(() => {
          this.retryLastRequest()
        })
        break
      
      case -1006: // ä¸­æ–­å¹¶æ’¤å›
        this.revokeMessage(extra.revoked_message_id)
        this.showWarning(msg)
        break
      
      case -1007: // å®‰å…¨é¢„è­¦
        this.showWarningBanner(msg)
        break
    }
  }
}
```

---

## ä¸ƒã€æ€»ç»“

### 7.1 æ ¸å¿ƒè®¾è®¡

1. **ç»Ÿä¸€æ¶ˆæ¯æ ¼å¼**ï¼šä¸ä¾èµ–ç‰¹å®š LLM
2. **çŠ¶æ€æ¶ˆæ¯**ï¼šå®ç°ä¸­æ–­ä¸æ¢å¤
3. **ç±»å‹å®‰å…¨**ï¼šContent ç»“æ„åŒ–è®¾è®¡
4. **å¯æ‰©å±•**ï¼šExtra å­—æ®µé¢„ç•™æ‰©å±•

### 7.2 å…³é”®ç‰¹æ€§

- âœ… æ”¯æŒå¤šç§æ¶ˆæ¯ç±»å‹
- âœ… å®Œæ•´çš„çŠ¶æ€ç ä½“ç³»
- âœ… ä¸­æ–­ä¸æ¢å¤æœºåˆ¶
- âœ… æœ¬åœ° ID å…³è”
- âœ… æŠ€èƒ½é€‰æ‹©
- âœ… é™„ä»¶æ”¯æŒ

---

*æ–‡æ¡£ç‰ˆæœ¬ï¼šv1.0*  
*æœ€åæ›´æ–°ï¼š2026-01-26*

**ä¸Šä¸€ç¯‡**ï¼š[â† åŸºç¡€æ¦‚å¿µ](01-åŸºç¡€æ¦‚å¿µ.md) | **ä¸‹ä¸€ç¯‡**ï¼š[å·¥å…·è°ƒç”¨ â†’](03-å·¥å…·è°ƒç”¨.md)
