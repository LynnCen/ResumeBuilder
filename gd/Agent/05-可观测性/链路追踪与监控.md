# Agent é“¾è·¯è¿½è¸ªä¸ç›‘æ§

## ä¸€ã€æ¦‚è¿°

æœ¬æ–‡æ¡£ä»‹ç» Agent ç³»ç»Ÿçš„å¯è§‚æµ‹æ€§æ–¹æ¡ˆï¼ŒåŒ…æ‹¬é“¾è·¯è¿½è¸ªã€æ—¥å¿—é‡‡é›†ã€ç›‘æ§æŒ‡æ ‡å’Œå‘Šè­¦è§„åˆ™ï¼Œæ”¯æ’‘ç³»ç»Ÿçš„ç¨³å®šè¿è¡Œå’Œæˆæœ¬ç®¡æ§ã€‚

> ğŸ“‹ **éœ€æ±‚èƒŒæ™¯**  
> éœ€æ±‚ç¨¿ï¼šAgent2.0 å»ºç«‹é“¾è·¯è¿½è¸ªã€å¯è§‚æµ‹ä»¥åŠæˆæœ¬ç®¡æ§ç­‰éåŠŸèƒ½ç‰¹æ€§

---

## äºŒã€ä¸€æ¡ Message çš„ç”Ÿå‘½å‘¨æœŸ

### 2.1 ç”Ÿå‘½å‘¨æœŸ Checkpoints

| Checkpoint | å®šä¹‰ | æ”¯æ’‘åˆ¤æ–­ | æ‰€å±æ¨¡å— |
|-----------|------|---------|----------|
| **è¯·æ±‚æ¥æ”¶** | `request_execute_begin` | ä¼šè¯æ•°ã€æ–°ä¼šè¯æ•°ã€è¯·æ±‚æ•°ã€é¦–æ¬¡ä»»åŠ¡å®Œæˆç‡ã€æŠ€èƒ½ä½¿ç”¨ç‡ã€æ¨¡å¼ä½¿ç”¨ç‡ | Gaoding-AI-Agent |
| **èŠ‚ç‚¹æ‰§è¡Œ** | `node_execute_begin` / `node_execute_end` | èŠ‚ç‚¹æ‰§è¡ŒæˆåŠŸç‡ã€èŠ‚ç‚¹æ‰§è¡Œè€—æ—¶ | Gaoding-AI-Agent |
| **LLM è°ƒç”¨** | `llm_execute_begin` / `llm_execute_end` | æ¨¡å‹ token æ¶ˆè€—ã€æ¨¡å‹å“åº”è€—æ—¶ | Gaoding-AI-Agent |
| **å·¥å…·è°ƒç”¨** | `tool_execute_begin` / `tool_execute_end` | å·¥å…·è°ƒç”¨æˆåŠŸç‡ã€å·¥å…·è°ƒç”¨è€—æ—¶ | Gaoding-AI-Agent, gdesign-tool |
| **è¯·æ±‚å®Œæˆ** | `request_execute_end` | è¯·æ±‚å¤„ç†æ—¶é•¿ | Gaoding-AI-Agent |
| **ç”¨æˆ·ä¸‹è½½/å¯¼å‡º** | *å¤ç”¨æ•°æ®é€šè·¯ä¸ŠæŠ¥* | é‡‡çº³ç‡ / è½¬åŒ–æ¼æ–— | å‰ç«¯ |
| **ç”¨æˆ·ä¸­æ–­** | `user_stop_streaming` | ä»»åŠ¡æœªå®Œæˆç‡ï¼ˆç”Ÿæˆä¸­ä¸»åŠ¨é€€å‡ºï¼‰ | å‰ç«¯ |

### 2.2 ç”Ÿå‘½å‘¨æœŸæµç¨‹å›¾

```mermaid
sequenceDiagram
    participant User
    participant Frontend
    participant Agent
    participant LLM
    participant Tool

    User->>Frontend: å‘é€æ¶ˆæ¯
    Frontend->>Agent: request_execute_begin
    
    Agent->>Agent: node_execute_begin
    Agent->>LLM: llm_execute_begin
    LLM-->>Agent: llm_execute_end
    Agent->>Agent: node_execute_end
    
    Agent->>Agent: node_execute_begin (toolèŠ‚ç‚¹)
    Agent->>Tool: tool_execute_begin
    Tool-->>Agent: tool_execute_end
    Agent->>Agent: node_execute_end
    
    Agent->>Frontend: request_execute_end
    Frontend->>User: æ˜¾ç¤ºç»“æœ
    
    alt ç”¨æˆ·ä¸‹è½½
        User->>Frontend: ä¸‹è½½/å¯¼å‡º
        Frontend->>æ•°æ®é€šè·¯: ä¸ŠæŠ¥è½¬åŒ–
    end
    
    alt ç”¨æˆ·ä¸­æ–­
        User->>Frontend: åœæ­¢ç”Ÿæˆ
        Frontend->>Agent: user_stop_streaming
    end
```

---

## ä¸‰ã€Checkpoint è¯¦ç»†å®šä¹‰

### 3.1 è¯·æ±‚å¼€å§‹ (request_execute_begin)

**æ—¶æœº**ï¼šAgent æ”¶åˆ°ç”¨æˆ·è¯·æ±‚ï¼Œå¼€å§‹å¤„ç†

**å­—æ®µï¼š**
| å­—æ®µ | ç±»å‹ | è¯´æ˜ |
|------|------|------|
| `text` | string | ç”¨æˆ·æŒ‡ä»¤ |
| `is_new` | boolean | æ˜¯å¦æ˜¯æ–°ä¼šè¯ |
| `input_skill_id` | int | ç”¨æˆ·é€‰æ‹©çš„æŠ€èƒ½ ID |
| `mode` | string | æ¨¡å¼ï¼šæ™®é€š / é«˜çº§ |
| `attachments` | array | é™„ä»¶åˆ—è¡¨ |

**ç¤ºä¾‹ï¼š**
```json
{
  "event": "request_execute_begin",
  "trace_id": "trace_123",
  "thread_id": "thread_abc",
  "user_id": "user_456",
  "data": {
    "text": "å¸®æˆ‘ç”Ÿæˆä¸€å¼ ç‰™è†äº§å“å›¾",
    "is_new": true,
    "input_skill_id": 2,
    "mode": "normal",
    "attachments": []
  },
  "timestamp": "2025-07-08T12:00:00Z"
}
```

### 3.2 èŠ‚ç‚¹æ‰§è¡Œ (node_execute_begin / node_execute_end)

**æ—¶æœº**ï¼šAgent å·¥ä½œæµèŠ‚ç‚¹æ‰§è¡Œå‰å

**å¼€å§‹å­—æ®µï¼š**
| å­—æ®µ | ç±»å‹ | è¯´æ˜ |
|------|------|------|
| `graph_name` | string | å·¥ä½œæµåç§° |
| `node_name` | string | èŠ‚ç‚¹åç§° |

**ç»“æŸå­—æ®µï¼š**
| å­—æ®µ | ç±»å‹ | è¯´æ˜ |
|------|------|------|
| `graph_name` | string | å·¥ä½œæµåç§° |
| `node_name` | string | èŠ‚ç‚¹åç§° |
| `duration_ms` | int | æ‰§è¡Œè€—æ—¶ï¼ˆæ¯«ç§’ï¼‰ |
| `status` | string | æˆåŠŸ / å¤±è´¥ |
| `error` | string | é”™è¯¯ä¿¡æ¯ï¼ˆå¦‚æœå¤±è´¥ï¼‰ |

**ç¤ºä¾‹ï¼š**
```json
{
  "event": "node_execute_begin",
  "trace_id": "trace_123",
  "data": {
    "graph_name": "image_generation_workflow",
    "node_name": "generate_prompt"
  },
  "timestamp": "2025-07-08T12:00:01Z"
}
```

### 3.3 LLM è°ƒç”¨ (llm_execute_begin / llm_execute_end)

**æ—¶æœº**ï¼šAgent è°ƒç”¨æ¨¡å‹å‰å

**å¼€å§‹å­—æ®µï¼š**
| å­—æ®µ | ç±»å‹ | è¯´æ˜ |
|------|------|------|
| `model_name` | string | ä½¿ç”¨çš„æ¨¡å‹å |
| `original_messages` | array | åŸå§‹çš„ messagesï¼ˆä»…é prod ç¯å¢ƒï¼‰ |
| `llm_messages` | array | é¢å‘ LLM çš„æ¶ˆæ¯ï¼ˆä»…é prod ç¯å¢ƒï¼‰ |

**ç»“æŸå­—æ®µï¼š**
| å­—æ®µ | ç±»å‹ | è¯´æ˜ |
|------|------|------|
| `llm_calls_num` | int | è¿­ä»£æ¬¡æ•° |
| `prompt_tokens` | int | è¾“å…¥ tokens |
| `completion_tokens` | int | è¾“å‡º tokens |
| `reasoning_tokens` | int | æ€è€ƒ tokensï¼ˆreasoning æ¨¡å‹ï¼‰ |
| `cached_tokens` | int | å‘½ä¸­ç¼“å­˜çš„ tokens æ•°é‡ |
| `text_tokens` | int | å‘½ä¸­ç¼“å­˜çš„ text tokens æ•°é‡ |
| `messages` | array | å“åº”çš„ messagesï¼ˆä»…é prod ç¯å¢ƒï¼‰ |

**ç¤ºä¾‹ï¼š**
```json
{
  "event": "llm_execute_end",
  "trace_id": "trace_123",
  "data": {
    "llm_calls_num": 1,
    "prompt_tokens": 150,
    "completion_tokens": 80,
    "reasoning_tokens": 0,
    "cached_tokens": 50,
    "text_tokens": 45
  },
  "timestamp": "2025-07-08T12:00:03Z"
}
```

### 3.4 å·¥å…·è°ƒç”¨ (tool_execute_begin / tool_execute_end)

**æ—¶æœº**ï¼šAgent æˆ– gdesign-tool æ‰§è¡Œå·¥å…·å‰å

**å¼€å§‹å­—æ®µï¼ˆAgentï¼‰ï¼š**
| å­—æ®µ | ç±»å‹ | è¯´æ˜ |
|------|------|------|
| `tool_call_id` | string | å·¥å…·è°ƒç”¨ IDï¼ˆAgent æœ¬åœ°è¯†åˆ«ï¼‰ |
| `func_name` | string | å·¥å…·åç§° |
| `params` | object | è°ƒç”¨å‚æ•° |

**ç»“æŸå­—æ®µï¼ˆAgentï¼‰ï¼š**
| å­—æ®µ | ç±»å‹ | è¯´æ˜ |
|------|------|------|
| `tool_call_id` | string | å·¥å…·è°ƒç”¨ ID |
| `result` | string | è°ƒç”¨ç»“æœï¼š"success" / "failed" |
| `task_id` | string | gdesign-tool ç”Ÿæˆçš„ä»»åŠ¡ ID |
| `deduct_points` | int | æ‰£é™¤çš„ç¨¿è±†æ•° |
| `exception_message` | string | å¼‚å¸¸ä¿¡æ¯ |

**ç»“æŸå­—æ®µï¼ˆgdesign-toolï¼‰ï¼š**
| å­—æ®µ | ç±»å‹ | è¯´æ˜ |
|------|------|------|
| `trace_id` | string | è¯·æ±‚ ID |
| `result` | string | "success" / "failed" |
| `task_id` | string | ä»»åŠ¡ ID |
| `scene_code` | string | å¯¹åº”è½»èˆŸçš„åœºæ™¯ code |
| `deduct_points` | int | æ‰£é™¤çš„ç¨¿è±†æ•° |
| `exception_message` | string | å¼‚å¸¸ä¿¡æ¯ |

**ç¤ºä¾‹ï¼š**
```json
{
  "event": "tool_execute_end",
  "trace_id": "trace_123",
  "data": {
    "tool_call_id": "tool_call_001",
    "result": "success",
    "task_id": "task_abc123",
    "deduct_points": 10,
    "exception_message": null
  },
  "timestamp": "2025-07-08T12:00:05Z"
}
```

### 3.5 è¯·æ±‚ç»“æŸ (request_execute_end)

**æ—¶æœº**ï¼šAgent å®Œæˆç”¨æˆ·è¯·æ±‚

**å­—æ®µï¼š**
| å­—æ®µ | ç±»å‹ | è¯´æ˜ |
|------|------|------|
| `reason` | string | ç»“æŸåŸå› ï¼šcompleted / interrupted / error |

**ç¤ºä¾‹ï¼š**
```json
{
  "event": "request_execute_end",
  "trace_id": "trace_123",
  "data": {
    "reason": "completed"
  },
  "timestamp": "2025-07-08T12:00:10Z"
}
```

### 3.6 ç”¨æˆ·ä¸­æ–­ (user_stop_streaming)

**æ—¶æœº**ï¼šç”¨æˆ·ä¸»åŠ¨ä¸­æ–­è¾“å‡º

**å­—æ®µï¼š**
| å­—æ®µ | ç±»å‹ | è¯´æ˜ |
|------|------|------|
| `thread_id` | string | ä¼šè¯ ID |
| `user_id` | string | ç”¨æˆ· ID |
| `message_id` | string | æ¶ˆæ¯ ID |

**ç¤ºä¾‹ï¼š**
```json
{
  "event": "user_stop_streaming",
  "data": {
    "thread_id": "thread_abc",
    "user_id": "user_456",
    "message_id": "msg_789"
  },
  "timestamp": "2025-07-08T12:00:08Z"
}
```

---

## å››ã€ID å…³ç³»ä¸é€ä¼ 

### 4.1 ID ä½“ç³»

![](../attachments/image2025-8-8_17-5-16.png)

| ID ç±»å‹ | ç”Ÿæˆè€… | ä½œç”¨åŸŸ | è¯´æ˜ |
|---------|--------|--------|------|
| `trace_id` | Agent / Frontend | å•æ¬¡è¯·æ±‚ | è¿½è¸ªå®Œæ•´è¯·æ±‚é“¾è·¯ |
| `thread_id` | Agent | ä¼šè¯ | æ ‡è¯†ä¸€ä¸ªå¯¹è¯ä¼šè¯ |
| `message_id` | Agent | ä¼šè¯å†… | æ ‡è¯†å•æ¡æ¶ˆæ¯ |
| `tool_call_id` | Agent | å•æ¬¡å·¥å…·è°ƒç”¨ | æ ‡è¯†å·¥å…·è°ƒç”¨ |
| `task_id` | gdesign-tool | å·¥å…·æ‰§è¡Œ | æ ‡è¯†å…·ä½“ä»»åŠ¡ |

### 4.2 å…¬å…±ä¸ŠæŠ¥å­—æ®µ

**Gaoding-AI-Agentï¼š**
- `trace_id`ï¼šè¯·æ±‚ ID
- `thread_id`ï¼šä¼šè¯ ID
- `user_id`ï¼šç”¨æˆ· ID

**gdesign-toolï¼š**
- `trace_id`ï¼šè¯·æ±‚ ID
- `func_name`ï¼šå·¥å…·åç§°ï¼ˆå¤ç”¨ç´¢å¼•ï¼‰

### 4.3 task_id å’Œ deduct_points é€ä¼ 

ç”±äº response body ä¸º json-rpc æ ¼å¼ï¼Œä¸æ–¹ä¾¿é€ä¼ ï¼Œ**æ”¾åˆ° response header é‡Œ**ï¼š

```python
# gdesign-tool å“åº”
response.headers['X-Task-ID'] = task_id
response.headers['X-Deduct-Points'] = str(deduct_points)

# Agent è§£æ
task_id = response.headers.get('X-Task-ID')
deduct_points = int(response.headers.get('X-Deduct-Points', 0))
```

---

## äº”ã€ç›‘æ§æŒ‡æ ‡

### 5.1 æ ¸å¿ƒæŒ‡æ ‡

| æŒ‡æ ‡ç±»å‹ | æŒ‡æ ‡å | è®¡ç®—æ–¹å¼ | ä½œç”¨ |
|---------|--------|---------|------|
| **è¯·æ±‚** | ä¼šè¯æ•° | COUNT(DISTINCT thread_id) | æ€»ä¼šè¯é‡ |
| **è¯·æ±‚** | æ–°ä¼šè¯æ•° | COUNT WHERE is_new=true | æ–°ç”¨æˆ·æ´»è·ƒåº¦ |
| **è¯·æ±‚** | è¯·æ±‚æ•° | COUNT(trace_id) | æ€»è¯·æ±‚é‡ |
| **æˆåŠŸç‡** | é¦–æ¬¡ä»»åŠ¡å®Œæˆç‡ | (å®Œæˆæ•° / æ€»è¯·æ±‚æ•°) * 100% | ä»»åŠ¡å®Œç»“æƒ…å†µ |
| **æˆåŠŸç‡** | å·¥å…·è°ƒç”¨æ€»æˆåŠŸç‡ | (æˆåŠŸæ•° / æ€»è°ƒç”¨æ•°) * 100% | å·¥å…·æ•´ä½“å¯ç”¨æ€§ |
| **æˆåŠŸç‡** | å•å·¥å…·è°ƒç”¨æˆåŠŸç‡ | (è¯¥å·¥å…·æˆåŠŸæ•° / è¯¥å·¥å…·è°ƒç”¨æ•°) * 100% | å•ä¸ªå·¥å…·å¯ç”¨æ€§ |
| **å»¶è¿Ÿ** | é¦–å“åº”å»¶è¿Ÿ P99 | P99(é¦–æ¡ Response æ—¶é—´) | ç”¨æˆ·ä½“éªŒ |
| **å»¶è¿Ÿ** | è¯·æ±‚å¤„ç†æ—¶é•¿ P99 | P99(request_execute_end - request_execute_begin) | æ•´ä½“æ€§èƒ½ |
| **å»¶è¿Ÿ** | LLM å“åº”æ—¶é•¿ P99 | P99(llm_execute_end - llm_execute_begin) | LLM æ€§èƒ½ |
| **å»¶è¿Ÿ** | å·¥å…·è°ƒç”¨æ—¶é•¿ P99 | P99(tool_execute_end - tool_execute_begin) | å·¥å…·æ€§èƒ½ |
| **æˆæœ¬** | Token æ¶ˆè€— | SUM(prompt_tokens + completion_tokens) | LLM æˆæœ¬ |
| **æˆæœ¬** | ç¨¿è±†æ¶ˆè€— | SUM(deduct_points) | å·¥å…·æˆæœ¬ |
| **ä¸šåŠ¡** | æŠ€èƒ½ä½¿ç”¨ç‡ | COUNT BY input_skill_id | æŠ€èƒ½çƒ­åº¦ |
| **ä¸šåŠ¡** | æ¨¡å¼ä½¿ç”¨ç‡ | COUNT BY mode | æ¨¡å¼åå¥½ |
| **ä¸šåŠ¡** | é‡‡çº³ç‡ | (ä¸‹è½½æ•° / å®Œæˆæ•°) * 100% | ç”¨æˆ·æ»¡æ„åº¦ |
| **ä¸šåŠ¡** | ä»»åŠ¡æœªå®Œæˆç‡ | (ä¸­æ–­æ•° / æ€»è¯·æ±‚æ•°) * 100% | ç”¨æˆ·æµå¤± |

---

## å…­ã€å‘Šè­¦è§„åˆ™

### 6.1 å‘Šè­¦é…ç½®

| æŒ‡æ ‡å | å‘Šè­¦è§„åˆ™ | å‘Šè­¦çº§åˆ« | ä¸‹ä¸€æ­¥ |
|--------|---------|----------|--------|
| **å¯¹è¯è¯·æ±‚æˆåŠŸç‡** | è¿‘ 5 åˆ†é’Ÿ < 50% | P0 | ä¼šè¯å¼‚å¸¸ç»“æŸåŸå› åˆ†æ |
| **å·¥å…·è°ƒç”¨æ€»æˆåŠŸç‡** | è¿‘ 5 åˆ†é’Ÿ < 50% | P1 | å·¥å…·è°ƒç”¨å¤±è´¥åŸå› åˆ†æã€å·¥å…· QPS æ£€æŸ¥ |
| **å•å·¥å…·è°ƒç”¨æˆåŠŸç‡** | è¿‘ 5 åˆ†é’Ÿ < 50% | P1 | å•å·¥å…·æ•…éšœåˆ†æ |
| **é¦–å“åº”å»¶è¿Ÿ** | è¿‘ 5 åˆ†é’Ÿ P99 > 10s ä¸”å æ¯” > 20% | P1 | ç³»ç»Ÿæ‰©å®¹ / Graph ä¼˜åŒ– / é€‰æ‹©æ›´å¿«çš„ LLM |
| **æ ‡é¢˜ç”ŸæˆæˆåŠŸç‡** | è¿‘ 5 åˆ†é’Ÿ < 50% | P2 | gdesign-tool è°ƒç”¨ Dify é“¾è·¯åˆ†æã€Dify workflow é”™è¯¯åˆ†æ |
| **Auth Key åˆ·æ–°æˆåŠŸç‡** | è¿‘ 10 åˆ†é’Ÿå‡å¤±è´¥ | P0 | FileMS æ˜¯å¦æ­£å¸¸ã€Redis æ˜¯å¦æ­£å¸¸ |

### 6.2 å‘Šè­¦åˆ†çº§

| çº§åˆ« | å“åº”æ—¶é—´ | å½±å“èŒƒå›´ |
|------|---------|----------|
| **P0** | 5 åˆ†é’Ÿ | æ ¸å¿ƒåŠŸèƒ½ä¸å¯ç”¨ |
| **P1** | 15 åˆ†é’Ÿ | é‡è¦åŠŸèƒ½å—å½±å“ |
| **P2** | 30 åˆ†é’Ÿ | æ¬¡è¦åŠŸèƒ½å¼‚å¸¸ |

---

## ä¸ƒã€æ—¥å¿—é‡‡é›†

### 7.1 æ—¥å¿—æ ¼å¼

```json
{
  "timestamp": "2025-07-08T12:00:00Z",
  "level": "INFO",
  "event": "request_execute_begin",
  "trace_id": "trace_123",
  "thread_id": "thread_abc",
  "user_id": "user_456",
  "module": "Gaoding-AI-Agent",
  "data": {
    "text": "å¸®æˆ‘ç”Ÿæˆä¸€å¼ ç‰™è†äº§å“å›¾",
    "is_new": true
  }
}
```

### 7.2 æ—¥å¿—çº§åˆ«

| çº§åˆ« | ç”¨é€” |
|------|------|
| **DEBUG** | è°ƒè¯•ä¿¡æ¯ï¼ˆä»…å¼€å‘ç¯å¢ƒï¼‰ |
| **INFO** | æ­£å¸¸æµç¨‹æ—¥å¿— |
| **WARNING** | è­¦å‘Šä¿¡æ¯ï¼ˆé™çº§ã€é‡è¯•ï¼‰ |
| **ERROR** | é”™è¯¯ä¿¡æ¯ |
| **CRITICAL** | ä¸¥é‡é”™è¯¯ |

### 7.3 æ•æ„Ÿä¿¡æ¯å¤„ç†

**è„±æ•è§„åˆ™ï¼š**
- `original_messages` / `llm_messages`ï¼šä»…åœ¨é prod ç¯å¢ƒä¸ŠæŠ¥
- ç”¨æˆ·è¾“å…¥ï¼šä¸è®°å½•æ•æ„Ÿè¯
- API Keyï¼šæ°¸ä¸è®°å½•

---

## å…«ã€å®ç°ç¤ºä¾‹

### 8.1 æ—¥å¿—è®°å½•

```python
import logging
import json
from datetime import datetime

def log_checkpoint(event, trace_id, thread_id, user_id, data):
    """è®°å½• checkpoint æ—¥å¿—"""
    log_entry = {
        "timestamp": datetime.utcnow().isoformat() + "Z",
        "level": "INFO",
        "event": event,
        "trace_id": trace_id,
        "thread_id": thread_id,
        "user_id": user_id,
        "module": "Gaoding-AI-Agent",
        "data": data
    }
    logging.info(json.dumps(log_entry))

# ä½¿ç”¨ç¤ºä¾‹
log_checkpoint(
    event="request_execute_begin",
    trace_id="trace_123",
    thread_id="thread_abc",
    user_id="user_456",
    data={
        "text": "å¸®æˆ‘ç”Ÿæˆä¸€å¼ ç‰™è†äº§å“å›¾",
        "is_new": True,
        "input_skill_id": 2
    }
)
```

### 8.2 æŒ‡æ ‡ä¸ŠæŠ¥

```python
from prometheus_client import Counter, Histogram, Gauge

# å®šä¹‰æŒ‡æ ‡
request_total = Counter(
    'agent_request_total', 
    'Total number of requests',
    ['status', 'skill_id']
)

request_duration = Histogram(
    'agent_request_duration_seconds',
    'Request duration in seconds'
)

llm_tokens = Counter(
    'agent_llm_tokens_total',
    'Total LLM tokens consumed',
    ['token_type', 'model']
)

# ä½¿ç”¨ç¤ºä¾‹
request_total.labels(status='success', skill_id='2').inc()
request_duration.observe(5.2)
llm_tokens.labels(token_type='prompt', model='doubao').inc(150)
```

---

## ä¹ã€æ•°æ®åˆ†æ

### 9.1 å…³é”®æŸ¥è¯¢

**ä¼šè¯ç»Ÿè®¡ï¼š**
```sql
SELECT 
    DATE(timestamp) as date,
    COUNT(DISTINCT thread_id) as total_threads,
    COUNT(DISTINCT CASE WHEN is_new THEN thread_id END) as new_threads
FROM agent_logs
WHERE event = 'request_execute_begin'
GROUP BY date
ORDER BY date DESC;
```

**æˆåŠŸç‡åˆ†æï¼š**
```sql
SELECT 
    func_name,
    COUNT(*) as total_calls,
    SUM(CASE WHEN result = 'success' THEN 1 ELSE 0 END) as success_calls,
    ROUND(100.0 * SUM(CASE WHEN result = 'success' THEN 1 ELSE 0 END) / COUNT(*), 2) as success_rate
FROM agent_logs
WHERE event = 'tool_execute_end'
GROUP BY func_name
ORDER BY total_calls DESC;
```

**æˆæœ¬åˆ†æï¼š**
```sql
SELECT 
    DATE(timestamp) as date,
    SUM(prompt_tokens + completion_tokens) as total_tokens,
    SUM(deduct_points) as total_points
FROM agent_logs
WHERE event IN ('llm_execute_end', 'tool_execute_end')
GROUP BY date
ORDER BY date DESC;
```

---

## åã€æ€»ç»“

### 10.1 æ ¸å¿ƒè®¾è®¡

1. **å®Œæ•´é“¾è·¯è¿½è¸ª**ï¼šè¦†ç›–è¯·æ±‚å…¨ç”Ÿå‘½å‘¨æœŸ
2. **ç²¾ç»†åŒ–æŒ‡æ ‡**ï¼šæ”¯æŒæˆæœ¬ç®¡æ§å’Œæ€§èƒ½ä¼˜åŒ–
3. **åˆ†çº§å‘Šè­¦**ï¼šå¿«é€Ÿå‘ç°å’Œå“åº”é—®é¢˜
4. **æ•°æ®é©±åŠ¨**ï¼šæ”¯æ’‘ä¸šåŠ¡å†³ç­–

### 10.2 å…³é”®èƒ½åŠ›

- âœ… é“¾è·¯è¿½è¸ªï¼štrace_id è´¯ç©¿å…¨é“¾è·¯
- âœ… æ€§èƒ½ç›‘æ§ï¼šå»¶è¿Ÿã€æˆåŠŸç‡ã€ååé‡
- âœ… æˆæœ¬ç®¡æ§ï¼šToken å’Œç¨¿è±†æ¶ˆè€—
- âœ… ä¸šåŠ¡æ´å¯Ÿï¼šæŠ€èƒ½ä½¿ç”¨ã€ç”¨æˆ·è¡Œä¸º

---

*æ–‡æ¡£ç‰ˆæœ¬ï¼šv1.0*  
*æœ€åæ›´æ–°ï¼š2025-01-26*
