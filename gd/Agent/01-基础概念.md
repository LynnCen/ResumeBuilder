# AI Agent åŸºç¡€æ¦‚å¿µ

> **ä»ç¬¬ä¸€æ€§åŸç†ç†è§£ AI Agent**

---

## ä¸€ã€ä»€ä¹ˆæ˜¯ AI Agentï¼Ÿ

### 1.1 ä¼ ç»Ÿè½¯ä»¶ vs AI Agent

è®©æˆ‘ä»¬ä»æœ€åŸºæœ¬çš„é—®é¢˜å¼€å§‹ï¼š**AI Agent å’Œä¼ ç»Ÿè½¯ä»¶æœ‰ä»€ä¹ˆæœ¬è´¨åŒºåˆ«ï¼Ÿ**

**ä¼ ç»Ÿè½¯ä»¶ï¼ˆè§„åˆ™é©±åŠ¨ï¼‰**ï¼š
```python
def process_request(user_input):
    if user_input == "å¤©æ°”":
        return get_weather()
    elif user_input == "æ—¶é—´":
        return get_time()
    else:
        return "ä¸ç†è§£"
```

**ç‰¹ç‚¹**ï¼š
- âŒ åªèƒ½å¤„ç†é¢„å®šä¹‰çš„æƒ…å†µ
- âŒ æ— æ³•ç†è§£è‡ªç„¶è¯­è¨€
- âŒ æ— æ³•å¤„ç†å¤æ‚ä»»åŠ¡

**AI Agentï¼ˆæ™ºèƒ½é©±åŠ¨ï¼‰**ï¼š
```python
def ai_agent(user_input):
    # 1. LLM ç†è§£ç”¨æˆ·æ„å›¾
    intent = llm.understand(user_input)
    
    # 2. è§„åˆ’éœ€è¦è°ƒç”¨çš„å·¥å…·
    tools = llm.plan_tools(intent)
    
    # 3. æ‰§è¡Œå·¥å…·è°ƒç”¨
    results = execute_tools(tools)
    
    # 4. LLM æ•´åˆç»“æœå¹¶å›å¤
    return llm.generate_response(intent, results)
```

**ç‰¹ç‚¹**ï¼š
- âœ… ç†è§£è‡ªç„¶è¯­è¨€
- âœ… åŠ¨æ€è§„åˆ’æ‰§è¡Œè·¯å¾„
- âœ… å¯ä»¥è°ƒç”¨å¤–éƒ¨å·¥å…·
- âœ… èƒ½å¤„ç†å¤æ‚å¤šæ­¥ä»»åŠ¡

### 1.2 æ ¸å¿ƒèƒ½åŠ›æ‹†è§£

AI Agent çš„æ ¸å¿ƒèƒ½åŠ›å¯ä»¥æ‹†è§£ä¸º **4 ä¸ªå±‚æ¬¡**ï¼š

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Layer 4: ä»»åŠ¡ç¼–æ’ (Orchestration)  â”‚  â† æœ€é«˜å±‚
â”‚  - å¤æ‚ä»»åŠ¡æ‹†è§£                      â”‚
â”‚  - å¤šæ­¥éª¤è§„åˆ’                        â”‚
â”‚  - çŠ¶æ€ç®¡ç†                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Layer 3: å·¥å…·è°ƒç”¨ (Tool Calling)   â”‚
â”‚  - Function Calling                  â”‚
â”‚  - å‚æ•°æå–                          â”‚
â”‚  - ç»“æœè§£æ                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Layer 2: å¯¹è¯ç®¡ç† (Dialogue Mgmt)  â”‚
â”‚  - ä¸Šä¸‹æ–‡è®°å¿†                        â”‚
â”‚  - å¤šè½®å¯¹è¯                          â”‚
â”‚  - çŠ¶æ€è·Ÿè¸ª                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Layer 1: è¯­è¨€ç†è§£ (NLU)            â”‚  â† åŸºç¡€å±‚
â”‚  - æ„å›¾è¯†åˆ«                          â”‚
â”‚  - å®ä½“æå–                          â”‚
â”‚  - è¯­ä¹‰ç†è§£                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**å±‚æ¬¡è¯´æ˜**ï¼š
- **Layer 1**ï¼šç”± LLM æä¾›ï¼ˆå¦‚ GPTã€Claudeã€Doubaoï¼‰
- **Layer 2**ï¼šéœ€è¦ç³»ç»Ÿè®¾è®¡ï¼ˆæ¶ˆæ¯å­˜å‚¨ã€ä¸Šä¸‹æ–‡ç®¡ç†ï¼‰
- **Layer 3**ï¼šéœ€è¦æ¡†æ¶æ”¯æŒï¼ˆFunction Calling æœºåˆ¶ï¼‰
- **Layer 4**ï¼šéœ€è¦ç¼–æ’å¼•æ“ï¼ˆå¦‚ LangGraphï¼‰

---

## äºŒã€ä¸ºä»€ä¹ˆéœ€è¦è‡ªå®šä¹‰æ¶ˆæ¯æ ¼å¼ï¼Ÿ

### 2.1 LLM åŸç”Ÿæ¶ˆæ¯æ ¼å¼çš„é—®é¢˜

#### ChatGPT çš„é“¾è¡¨ç»“æ„

ä»å›¾ç‰‡å¯ä»¥çœ‹åˆ°ï¼ŒChatGPT ä½¿ç”¨é“¾è¡¨ç»“æ„ï¼š

```json
{
  "mapping": {
    "node_id_1": {
      "message": {...},
      "parent": "node_id_0",
      "children": ["node_id_2"]
    },
    "node_id_2": {
      "message": {...},
      "parent": "node_id_1",
      "children": []
    }
  }
}
```

**é—®é¢˜**ï¼š
1. **å¤æ‚åº¦é«˜**ï¼šéœ€è¦éå†é“¾è¡¨æ‰èƒ½è·å–å®Œæ•´å¯¹è¯å†å²
2. **æ‰©å±•æ€§å·®**ï¼šéš¾ä»¥æ·»åŠ ä¸šåŠ¡å­—æ®µï¼ˆå¦‚æŠ€èƒ½ IDã€ç¨¿è±†æ‰£é™¤ï¼‰
3. **ä¸åˆ©äºå­˜å‚¨**ï¼šé“¾è¡¨ç»“æ„ä¸é€‚åˆå…³ç³»å‹æ•°æ®åº“

#### Doubaoï¼ˆè±†åŒ…ï¼‰çš„åˆ—è¡¨ç»“æ„

ä»å›¾ç‰‡å¯ä»¥çœ‹åˆ°ï¼Œè±†åŒ…ä½¿ç”¨ç®€å•åˆ—è¡¨ï¼š

```json
{
  "data": {
    "message_list": [
      {
        "conversation_id": "...",
        "message_id": "...",
        "content": "...",
        "role": "user"
      },
      {
        "conversation_id": "...",
        "message_id": "...",
        "content": "...",
        "role": "assistant"
      }
    ]
  }
}
```

**é—®é¢˜**ï¼š
1. **å­—æ®µä¸ç»Ÿä¸€**ï¼šæ¯ä¸ª LLM çš„å­—æ®µåéƒ½ä¸åŒ
2. **ç¼ºå°‘æ‰©å±•**ï¼šæ²¡æœ‰ä¸šåŠ¡ç›¸å…³å­—æ®µ
3. **æ— çŠ¶æ€ç®¡ç†**ï¼šæ— æ³•è¡¨è¾¾ä¸­æ–­ã€æ¢å¤ç­‰çŠ¶æ€

### 2.2 ç»Ÿä¸€æ¶ˆæ¯æ ¼å¼çš„å¿…è¦æ€§

> ğŸ’¡ **æ ¸å¿ƒæ´å¯Ÿ**ï¼ˆæ¥è‡ªå®è·µï¼‰  
> "æ„ˆå‘è§‰å¾—å‰æœŸä¸åº”è¯¥æŠŠ LLM çš„æ¶ˆæ¯æ ¼å¼å½“ä½œä¸šåŠ¡æ ¼å¼æ¥ä½¿ç”¨ã€‚é¢å‘ä¸šåŠ¡é¢†åŸŸçš„æ¶ˆæ¯æ ¼å¼ï¼ŒåŠ¿å¿…è¦è€ƒè™‘çŠ¶æ€å’Œäº¤äº’çš„é—®é¢˜ï¼Œå¦åˆ™æ— æ³•é€šè¿‡ä¸€ä¸ªæºæ¥å›æº¯æ‰€æœ‰çš„çŠ¶æ€ã€‚"

**ä¸ºä»€ä¹ˆéœ€è¦ç»Ÿä¸€ï¼Ÿ**

1. **å¤šæ¨¡å‹æ”¯æŒ**  
   æˆ‘ä»¬éœ€è¦æ”¯æŒå¤šç§ LLMï¼ˆGPTã€Claudeã€Doubaoã€Qwenï¼‰ï¼Œæ¯ä¸ªæ¨¡å‹çš„æ¶ˆæ¯æ ¼å¼éƒ½ä¸åŒ

2. **ä¸šåŠ¡æ‰©å±•**  
   éœ€è¦è®°å½•ä¸šåŠ¡ä¿¡æ¯ï¼š
   - ç”¨æˆ·é€‰æ‹©çš„æŠ€èƒ½ ID
   - ç¨¿è±†æ‰£é™¤ä¿¡æ¯
   - æœ¬åœ°æ¶ˆæ¯ IDï¼ˆå‰ç«¯å…³è”ï¼‰
   - é™„ä»¶ä¿¡æ¯

3. **çŠ¶æ€ç®¡ç†**  
   éœ€è¦æ”¯æŒï¼š
   - ä¸­æ–­ï¼ˆç¨¿è±†ä¸è¶³ã€Token è¿‡æœŸï¼‰
   - æ¢å¤ï¼ˆç”¨æˆ·å……å€¼åç»§ç»­ï¼‰
   - åœæ­¢ï¼ˆç”¨æˆ·ä¸»åŠ¨åœæ­¢ï¼‰

4. **å¯è¿½æº¯æ€§**  
   éœ€è¦å®Œæ•´è®°å½•ï¼š
   - æ¯æ¡æ¶ˆæ¯çš„åˆ›å»ºæ—¶é—´
   - æ¶ˆæ¯ä¹‹é—´çš„å…³è”å…³ç³»
   - å·¥å…·è°ƒç”¨çš„å®Œæ•´é“¾è·¯

---

## ä¸‰ã€æ¶ˆæ¯æ ¼å¼æ·±å…¥åŸç†

### 3.1 æ¶ˆæ¯çš„æœ¬è´¨

ä»è®¡ç®—æœºç§‘å­¦çš„è§’åº¦çœ‹ï¼Œ**æ¶ˆæ¯å°±æ˜¯çŠ¶æ€æœºçš„çŠ¶æ€è½¬ç§»**ï¼š

```
State_0 (åˆå§‹çŠ¶æ€)
   â†“ [user message]
State_1 (ç­‰å¾… LLM å“åº”)
   â†“ [assistant message]
State_2 (LLM å›å¤å®Œæˆ)
   â†“ [function call]
State_3 (ç­‰å¾…å·¥å…·æ‰§è¡Œ)
   â†“ [function response]
State_4 (å·¥å…·æ‰§è¡Œå®Œæˆ)
   â†“ [assistant message]
State_5 (æœ€ç»ˆå›å¤)
```

**å…³é”®ç†è§£**ï¼š
- æ¯æ¡æ¶ˆæ¯éƒ½æ˜¯ä¸€æ¬¡çŠ¶æ€è½¬ç§»
- æ¶ˆæ¯åºåˆ—æ„æˆäº†å®Œæ•´çš„çŠ¶æ€æœº
- çŠ¶æ€æœºå¿…é¡»æ˜¯**å¯æ¢å¤çš„**ï¼ˆå› æ­¤éœ€è¦æŒä¹…åŒ–ï¼‰

### 3.2 æ¶ˆæ¯çš„ 5 ç§è§’è‰²

#### 1. `system` - ç³»ç»ŸæŒ‡ä»¤

**ä½œç”¨**ï¼šä¸º LLM è®¾å®šè¡Œä¸ºè§„åˆ™

```json
{
  "role": "system",
  "content": {
    "type": "plain",
    "text": "ä½ æ˜¯ç¨¿å®š AI Agentï¼Œæ“…é•¿å›¾åƒç”Ÿæˆå’Œè®¾è®¡"
  }
}
```

**ç‰¹ç‚¹**ï¼š
- é€šå¸¸æ˜¯ç¬¬ä¸€æ¡æ¶ˆæ¯
- ä¸ç”±ç”¨æˆ·è§¦å‘
- å½±å“ LLM çš„è¡Œä¸º

#### 2. `user` - ç”¨æˆ·è¾“å…¥

**ä½œç”¨**ï¼šç”¨æˆ·çš„è¯·æ±‚æˆ–æŒ‡ä»¤

```json
{
  "role": "user",
  "content": {
    "type": "plain",
    "text": "å¸®æˆ‘ç”Ÿæˆä¸€å¼ ç‰™è†äº§å“å›¾"
  },
  "input_skill_id": 2,  // ä¸šåŠ¡æ‰©å±•å­—æ®µ
  "attachments": []      // é™„ä»¶
}
```

**ç‰¹ç‚¹**ï¼š
- ç”±ç”¨æˆ·è§¦å‘
- å¯ä»¥åŒ…å«é™„ä»¶
- å¯ä»¥æŒ‡å®šæŠ€èƒ½

#### 3. `assistant` - AI å›å¤

**ä½œç”¨**ï¼šLLM çš„å›å¤æˆ–å·¥å…·è°ƒç”¨

```json
{
  "role": "assistant",
  "content": {
    "type": "function_call",
    "text": {
      "tool_name": "generate_image",
      "parameters": {...}
    }
  }
}
```

**ç‰¹ç‚¹**ï¼š
- å¯ä»¥æ˜¯çº¯æ–‡æœ¬å›å¤
- å¯ä»¥æ˜¯å·¥å…·è°ƒç”¨æŒ‡ä»¤
- å¯ä»¥åŒ…å« Reasoning å†…å®¹ï¼ˆæ€è€ƒè¿‡ç¨‹ï¼‰

#### 4. `function` - å·¥å…·ç»“æœ

**ä½œç”¨**ï¼šå·¥å…·æ‰§è¡Œçš„ç»“æœ

```json
{
  "role": "function",
  "content": {
    "type": "function_response",
    "text": {
      "tool_name": "generate_image",
      "result": "success",
      "image_url": "https://...",
      "task_id": "task_123"
    }
  },
  "extra": {
    "deduct_points": 10  // æ‰£é™¤çš„ç¨¿è±†
  }
}
```

**ç‰¹ç‚¹**ï¼š
- æ€»æ˜¯è·Ÿåœ¨ `assistant` (function_call) ä¹‹å
- åŒ…å«å·¥å…·æ‰§è¡Œç»“æœ
- å¯ä»¥è®°å½•ç¨¿è±†æ‰£é™¤

#### 5. `status` - çŠ¶æ€æ¶ˆæ¯

**ä½œç”¨**ï¼šä¼ é€’ç³»ç»ŸçŠ¶æ€å’Œæ§åˆ¶æŒ‡ä»¤

```json
{
  "role": "status",
  "content": {
    "code": -1002,
    "message": "ç¨¿è±†ä¸è¶³",
    "extra": {
      "last_tool_message_id": "msg_003"
    }
  }
}
```

**ç‰¹ç‚¹**ï¼š
- ä¸æ˜¯ LLM ç”Ÿæˆçš„
- ç”¨äºæ§åˆ¶æµç¨‹
- æ”¯æŒä¸­æ–­ä¸æ¢å¤

### 3.3 Content ç±»å‹çš„æ·±å±‚è®¾è®¡

**ä¸ºä»€ä¹ˆ Content æ˜¯åµŒå¥—ç»“æ„ï¼Ÿ**

```json
{
  "content": {
    "type": "plain",      // ç±»å‹æ ‡è¯†
    "text": "..."         // å®é™…å†…å®¹
  }
}
```

è€Œä¸æ˜¯ç®€å•çš„å­—ç¬¦ä¸²ï¼š

```json
{
  "content": "..."  // âŒ å¤ªç®€å•
}
```

**åŸå›  1ï¼šç±»å‹å¤šæ€**

Content éœ€è¦æ”¯æŒå¤šç§ç±»å‹ï¼š

```typescript
type Content = 
  | { type: "plain", text: string }
  | { type: "function_call", text: FunctionCall }
  | { type: "function_response", text: FunctionResponse }
  | { type: "reasoning", text: string }
  | { type: "image", text: ImageData }  // æœªæ¥æ‰©å±•
  | { type: "video", text: VideoData }  // æœªæ¥æ‰©å±•
```

**åŸå›  2ï¼šç»“æ„åŒ–è§£æ**

å‰ç«¯å¯ä»¥æ ¹æ® `type` è¿›è¡Œä¸åŒçš„æ¸²æŸ“ï¼š

```typescript
function renderContent(content) {
  switch (content.type) {
    case "plain":
      return <Text>{content.text}</Text>
    case "function_call":
      return <FunctionCallCard call={content.text} />
    case "function_response":
      return <FunctionResultCard result={content.text} />
    case "reasoning":
      return <ThinkingBubble>{content.text}</ThinkingBubble>
  }
}
```

**åŸå›  3ï¼šæœªæ¥æ‰©å±•**

å¯ä»¥è½»æ¾æ·»åŠ æ–°çš„ content ç±»å‹ï¼Œè€Œä¸å½±å“ç°æœ‰ä»£ç ã€‚

---

## å››ã€çŠ¶æ€æ¶ˆæ¯çš„æœ¬è´¨

### 4.1 ä¸ºä»€ä¹ˆéœ€è¦çŠ¶æ€æ¶ˆæ¯ï¼Ÿ

**é—®é¢˜åœºæ™¯**ï¼š

```
ç”¨æˆ·ï¼šç”Ÿæˆå›¾ç‰‡
  â†“
Agentï¼šè°ƒç”¨å·¥å…·
  â†“
å·¥å…·ï¼šç¨¿è±†ä¸è¶³ï¼ˆå¦‚ä½•é€šçŸ¥å‰ç«¯ï¼Ÿï¼‰
```

**æ–¹æ¡ˆ 1ï¼šåœ¨ assistant æ¶ˆæ¯ä¸­è¿”å›**

```json
{
  "role": "assistant",
  "content": {
    "type": "plain",
    "text": "æŠ±æ­‰ï¼Œæ‚¨çš„ç¨¿è±†ä¸è¶³ï¼Œè¯·å……å€¼"
  }
}
```

âŒ **é—®é¢˜**ï¼š
- LLM å·²ç»æ¶ˆè€—äº† Tokenï¼ˆæˆæœ¬æµªè´¹ï¼‰
- æ— æ³•ä»ä¸­æ–­ç‚¹æ¢å¤ï¼ˆä¸çŸ¥é“ä¸­æ–­åœ¨å“ªï¼‰
- å‰ç«¯æ— æ³•åŒºåˆ†æ˜¯æ™®é€šå›å¤è¿˜æ˜¯é”™è¯¯

**æ–¹æ¡ˆ 2ï¼šä½¿ç”¨çŠ¶æ€æ¶ˆæ¯**

```json
{
  "role": "status",
  "content": {
    "code": -1002,
    "message": "ç¨¿è±†ä¸è¶³",
    "extra": {
      "last_tool_message_id": "msg_003"  // è®°å½•ä¸­æ–­ä½ç½®
    }
  }
}
```

âœ… **ä¼˜åŠ¿**ï¼š
- ä¸æ¶ˆè€— LLM Token
- æ˜ç¡®æ ‡è®°ä¸­æ–­ä½ç½®
- å‰ç«¯å¯ä»¥ç‰¹æ®Šå¤„ç†ï¼ˆæ˜¾ç¤ºå……å€¼æŒ‰é’®ï¼‰
- æ”¯æŒæ¢å¤æ‰§è¡Œ

### 4.2 çŠ¶æ€æ¶ˆæ¯çš„çŠ¶æ€æœº

çŠ¶æ€æ¶ˆæ¯æ„æˆäº†ä¸€ä¸ª**æ§åˆ¶æµçŠ¶æ€æœº**ï¼š

```
æ­£å¸¸æ‰§è¡Œ
  â†“
æ£€æµ‹åˆ°ä¸­æ–­æ¡ä»¶
  â†“
å‘é€çŠ¶æ€æ¶ˆæ¯ (-1002: ç¨¿è±†ä¸è¶³)
  â†“
ç­‰å¾…ç”¨æˆ·æ“ä½œ
  â†“
ç”¨æˆ·å……å€¼å®Œæˆ
  â†“
å‰ç«¯å‘é€æ¢å¤æ¶ˆæ¯ (-2001: æ¢å¤æ‰§è¡Œ)
  â†“
ä»ä¸­æ–­ç‚¹ç»§ç»­æ‰§è¡Œ
```

### 4.3 çŠ¶æ€ç è®¾è®¡åŸåˆ™

**ä¸ºä»€ä¹ˆçŠ¶æ€ç æ˜¯è´Ÿæ•°ï¼Ÿ**

```
æ­£æ•°ï¼šä¸šåŠ¡æ­£å¸¸æµç¨‹
0ï¼šæˆåŠŸ
è´Ÿæ•°ï¼šå¼‚å¸¸/æ§åˆ¶æµç¨‹
```

**ä¸ºä»€ä¹ˆåˆ†æ®µè®¾è®¡ï¼Ÿ**

```
-1xxxï¼šåç«¯ç”Ÿæˆçš„çŠ¶æ€æ¶ˆæ¯
  -1001: åœæ­¢ç”Ÿæˆ
  -1002: ç¨¿è±†ä¸è¶³
  -1003: è°ƒç”¨è¶…é™
  -1004: Token è¿‡æœŸ
  -1005: å¿ƒè·³
  -1006: å†…å®¹é£é™©
  -1007: å®‰å…¨é¢„è­¦

-2xxxï¼šå‰ç«¯ç”Ÿæˆçš„çŠ¶æ€æ¶ˆæ¯
  -2001: æ¢å¤æ‰§è¡Œ
```

**è®¾è®¡ç†ç”±**ï¼š
1. **èŒè´£æ˜ç¡®**ï¼šä¸€çœ‹çŠ¶æ€ç å°±çŸ¥é“æ˜¯è°å‘çš„
2. **æ˜“äºæ‰©å±•**ï¼šå¯ä»¥åœ¨æ¯ä¸ªæ®µå†…æ·»åŠ æ–°çŠ¶æ€ç 
3. **é˜²æ­¢å†²çª**ï¼šåç«¯å’Œå‰ç«¯ä¸ä¼šæœ‰ç›¸åŒçš„çŠ¶æ€ç 

---

## äº”ã€å·¥å…·è°ƒç”¨çš„æœ¬è´¨

### 5.1 ä»€ä¹ˆæ˜¯ Function Callingï¼Ÿ

**æœ¬è´¨**ï¼šè®© LLM è¾“å‡º**ç»“æ„åŒ–çš„å‡½æ•°è°ƒç”¨æŒ‡ä»¤**ï¼Œè€Œä¸æ˜¯è‡ªç„¶è¯­è¨€ã€‚

**æ²¡æœ‰ Function Calling æ—¶**ï¼š

```
User: åŒ—äº¬æ˜å¤©å¤©æ°”æ€ä¹ˆæ ·ï¼Ÿ
LLM: åŒ—äº¬æ˜å¤©æ™´ï¼Œæ¸©åº¦ 20-25â„ƒ

ï¼ˆé—®é¢˜ï¼šLLM çš„çŸ¥è¯†æ˜¯è¿‡æ—¶çš„ï¼‰
```

**æœ‰ Function Calling æ—¶**ï¼š

```
User: åŒ—äº¬æ˜å¤©å¤©æ°”æ€ä¹ˆæ ·ï¼Ÿ
LLM: <tool_call>
     {
       "name": "get_weather",
       "parameters": {"city": "åŒ—äº¬", "date": "æ˜å¤©"}
     }
     </tool_call>
Agent: [è°ƒç”¨ get_weather API]
Tool: {"city": "åŒ—äº¬", "date": "2026-01-27", "weather": "æ™´", "temp": "20-25â„ƒ"}
LLM: æ ¹æ®æŸ¥è¯¢ç»“æœï¼ŒåŒ—äº¬æ˜å¤©æ™´ï¼Œæ¸©åº¦ 20-25â„ƒ
```

### 5.2 Function Calling çš„å®ç°åŸç†

**Step 1ï¼šåœ¨ System Prompt ä¸­æ³¨å…¥å·¥å…·æè¿°**

ä»å›¾ç‰‡ `image2025-7-4_14-16-44.png` å¯ä»¥çœ‹åˆ°ï¼š

```python
FN_CALL_TEMPLATE = """# Tools

You may call one or more functions to assist with the user query.

You are provided with function signatures within XML tags:

{tool_descs}

For each function call, return a json object with function name and arguments within XML tags:

<tool_call>
{{"name": <function_name>, "arguments": <args_dict>}}
</tool_call>
"""
```

**å…³é”®ç‚¹**ï¼š
- ä½¿ç”¨ XML æ ‡ç­¾ `<tool_call>` åŒ…è£¹ï¼ˆä¾¿äºè§£æï¼‰
- å·¥å…·æè¿°ä½¿ç”¨ XML æ ¼å¼ï¼ˆæ¸…æ™°çš„å±‚æ¬¡ç»“æ„ï¼‰
- å‚æ•°ä½¿ç”¨ JSON æ ¼å¼ï¼ˆæ ‡å‡†åŒ–ï¼‰

**Step 2ï¼šLLM ç”Ÿæˆå·¥å…·è°ƒç”¨**

ä»å›¾ç‰‡ `image2025-7-4_14-19-15.png` å¯ä»¥çœ‹åˆ°ï¼ŒLLM ä¼šè¾“å‡ºï¼š

```xml
<tool_call>
{"name": "generate_image", "arguments": {"user_prompt": "...", "width": "512", "height": "512"}}
</tool_call>
```

**Step 3ï¼šæµå¼è§£æå·¥å…·è°ƒç”¨**

ä»å›¾ç‰‡ `image2025-7-4_14-41-48.png` å¯ä»¥çœ‹åˆ°ï¼Œéœ€è¦ç­‰å¾…å®Œæ•´çš„ `</tool_call>` æ ‡ç­¾ï¼š

```python
def parse_tool_call_streaming(response_stream):
    buffer = ""
    in_tool_call = False
    
    for chunk in response_stream:
        buffer += chunk
        
        if "<tool_call>" in buffer:
            in_tool_call = True
        
        if "</tool_call>" in buffer and in_tool_call:
            # æå–å®Œæ•´çš„å·¥å…·è°ƒç”¨
            tool_call_xml = extract_tool_call(buffer)
            tool_call = parse_json(tool_call_xml)
            yield {"type": "tool_call", "data": tool_call}
            
            buffer = ""
            in_tool_call = False
```

**Step 4ï¼šæ‰§è¡Œå·¥å…·å¹¶è¿”å›ç»“æœ**

ä»å›¾ç‰‡ `image2025-7-4_16-36-34.png` å¯ä»¥çœ‹åˆ°ï¼š

```python
# è§£æå·¥å…·è°ƒç”¨
fn_name, fn_args = extract_fn(tool_call)

# æ‰§è¡Œå·¥å…·
result = call_tool(fn_name, fn_args)

# æ„é€  function æ¶ˆæ¯
function_message = {
    "role": "function",
    "content": {
        "type": "function_response",
        "text": {
            "tool_name": fn_name,
            "result": result
        }
    }
}
```

### 5.3 ä¸ºä»€ä¹ˆç»Ÿä¸€å·¥å…·è°ƒç”¨æ ¼å¼ï¼Ÿ

**è¡Œä¸šæ ‡å‡†å¯¹æ¯”**ï¼š

| æ¨¡å‹ | å·¥å…·è°ƒç”¨æ ¼å¼ | æ˜¯å¦ç»Ÿä¸€ |
|------|-------------|---------|
| **OpenAI** | `function_call` å­—æ®µ | âœ… ç»Ÿä¸€ |
| **Anthropic** | `<tool_call>` æ ‡ç­¾ | âœ… ç»Ÿä¸€ |
| **Doubao** | `<FunctionCallBegin>` æ ‡ç­¾ | âŒ ä¸ç»Ÿä¸€ |

**Doubao çš„æ ¼å¼**ï¼š

```xml
<FunctionCallBegin>
[{"name":"é€šç”¨","parameters":{...}}]
</FunctionCallEnd>
```

**æ ‡å‡†æ ¼å¼**ï¼š

```xml
<tool_call>
{"name":"é€šç”¨","parameters":{...}}
</tool_call>
```

**ç»Ÿä¸€çš„å¿…è¦æ€§**ï¼š
1. **å¼€å‘è€…ä½“éªŒ**ï¼šä¸€å¥—ä»£ç é€‚é…æ‰€æœ‰æ¨¡å‹
2. **å·¥å…·ç”Ÿæ€**ï¼šå·¥å…·å®šä¹‰ä¸æ¨¡å‹æ— å…³
3. **å¯ç»´æŠ¤æ€§**ï¼šå‡å°‘é€‚é…å±‚çš„å¤æ‚åº¦

---

## å…­ã€ä¼šè¯ (Thread) çš„æœ¬è´¨

### 6.1 Thread æ˜¯ä»€ä¹ˆï¼Ÿ

**Thread**ï¼ˆçº¿ç¨‹/ä¼šè¯ï¼‰æ˜¯ä¸€ä¸ª**ç‹¬ç«‹çš„å¯¹è¯ä¸Šä¸‹æ–‡**ã€‚

**ç±»æ¯”**ï¼š
- **Thread** = å¾®ä¿¡çš„ä¸€ä¸ªèŠå¤©çª—å£
- **Message** = èŠå¤©çª—å£é‡Œçš„ä¸€æ¡æ¶ˆæ¯

**ç‰¹ç‚¹**ï¼š
- æ¯ä¸ª Thread æœ‰å”¯ä¸€ ID
- Thread å†…çš„æ¶ˆæ¯æŒ‰æ—¶é—´é¡ºåºæ’åˆ—
- Thread ä¹‹é—´ç›¸äº’ç‹¬ç«‹

### 6.2 Thread çš„ç”Ÿå‘½å‘¨æœŸ

```
åˆ›å»º
  â†“
[ç”¨æˆ·å‘é€ç¬¬ä¸€æ¡æ¶ˆæ¯]
  â†“
æ´»è·ƒ
  â†“
[æŒç»­å¯¹è¯]
  â†“
ä¼‘çœ 
  â†“
[ç”¨æˆ·ä¸€æ®µæ—¶é—´ä¸æ“ä½œ]
  â†“
å½’æ¡£/åˆ é™¤
```

### 6.3 Thread ID çš„è®¾è®¡

**ä¸ºä»€ä¹ˆéœ€è¦å‰ç«¯æœ¬åœ° ID å’Œåç«¯ IDï¼Ÿ**

```typescript
{
  "local_thread_id": "local_thread_001",  // å‰ç«¯ç”Ÿæˆ
  "thread_id": "thread_abc123",           // åç«¯ç”Ÿæˆ
}
```

**åŸå› **ï¼š

1. **ç¦»çº¿æ”¯æŒ**  
   å‰ç«¯å¯ä»¥åœ¨æ²¡æœ‰ç½‘ç»œæ—¶åˆ›å»ºæœ¬åœ°ä¼šè¯

2. **ä¹è§‚æ›´æ–°**  
   å‰ç«¯ä¸éœ€è¦ç­‰å¾…åç«¯å“åº”å°±å¯ä»¥æ˜¾ç¤ºæ¶ˆæ¯

3. **ID æ˜ å°„**  
   å‰ç«¯å¯ä»¥é€šè¿‡æœ¬åœ° ID å…³è”åˆ°åç«¯ ID

**æµç¨‹**ï¼š

```
å‰ç«¯åˆ›å»ºä¼šè¯
  â†“
ç”Ÿæˆ local_thread_id = "local_001"
  â†“
å‘é€ç¬¬ä¸€æ¡æ¶ˆæ¯ï¼ˆthread_id = nullï¼‰
  â†“
åç«¯ç”Ÿæˆ thread_id = "thread_abc123"
  â†“
å‰ç«¯è®°å½•æ˜ å°„ï¼šlocal_001 â†’ thread_abc123
  â†“
åç»­æ¶ˆæ¯ä½¿ç”¨ thread_abc123
```

---

## ä¸ƒã€æ ¸å¿ƒè®¾è®¡åŸåˆ™

### 7.1 ä¸å¯å˜æ€§ (Immutability)

**åŸåˆ™**ï¼šæ¶ˆæ¯ä¸€æ—¦åˆ›å»ºï¼Œä¸å¯ä¿®æ”¹ã€‚

**ä¸ºä»€ä¹ˆï¼Ÿ**

1. **å®¡è®¡è¿½è¸ª**  
   å¯ä»¥è¿½æº¯æ¯æ¡æ¶ˆæ¯çš„å®Œæ•´å†å²

2. **å¹¶å‘å®‰å…¨**  
   å¤šä¸ªè¯·æ±‚åŒæ—¶è¯»å–æ¶ˆæ¯æ—¶ä¸ä¼šå†²çª

3. **çŠ¶æ€å›æº¯**  
   å¯ä»¥å›åˆ°ä»»æ„å†å²çŠ¶æ€

**å®ç°**ï¼š

```python
# âœ… æ­£ç¡®ï¼šåˆ›å»ºæ–°æ¶ˆæ¯
def add_message(thread_id, content):
    message = create_message(thread_id, content)
    save_message(message)
    return message

# âŒ é”™è¯¯ï¼šä¿®æ”¹å·²æœ‰æ¶ˆæ¯
def update_message(message_id, new_content):
    message = get_message(message_id)
    message.content = new_content  # âŒ ä¸å…è®¸
    save_message(message)
```

### 7.2 å•ä¸€æ•°æ®æº (Single Source of Truth)

**åŸåˆ™**ï¼šæ‰€æœ‰çŠ¶æ€éƒ½é€šè¿‡æ¶ˆæ¯è®°å½•ã€‚

**ä¸ºä»€ä¹ˆï¼Ÿ**

1. **å®Œæ•´æ€§**  
   é€šè¿‡æ¶ˆæ¯åºåˆ—å¯ä»¥å®Œå…¨æ¢å¤çŠ¶æ€

2. **ä¸€è‡´æ€§**  
   ä¸ä¼šå‡ºç°çŠ¶æ€ä¸ä¸€è‡´çš„æƒ…å†µ

3. **å¯è¿½æº¯**  
   æ‰€æœ‰å˜åŒ–éƒ½æœ‰è®°å½•

**ç¤ºä¾‹**ï¼š

```python
# âœ… æ­£ç¡®ï¼šé€šè¿‡æ¶ˆæ¯è®°å½•çŠ¶æ€
def get_conversation_state(thread_id):
    messages = get_messages(thread_id)
    state = {
        "llm_calls": count_llm_calls(messages),
        "tool_calls": count_tool_calls(messages),
        "is_interrupted": has_status_message(messages, -1002),
    }
    return state

# âŒ é”™è¯¯ï¼šå•ç‹¬ç»´æŠ¤çŠ¶æ€
conversation_states = {
    "thread_123": {"llm_calls": 5, "tool_calls": 2}
}
```

### 7.3 å¹‚ç­‰æ€§ (Idempotency)

**åŸåˆ™**ï¼šç›¸åŒçš„è¾“å…¥å¤šæ¬¡æ‰§è¡Œäº§ç”Ÿç›¸åŒçš„ç»“æœã€‚

**ä¸ºä»€ä¹ˆï¼Ÿ**

1. **é‡è¯•å®‰å…¨**  
   ç½‘ç»œå¤±è´¥æ—¶å¯ä»¥å®‰å…¨é‡è¯•

2. **åˆ†å¸ƒå¼å‹å¥½**  
   å¤šä¸ªèŠ‚ç‚¹å¯ä»¥å¤„ç†ç›¸åŒè¯·æ±‚

**å®ç°**ï¼š

```python
# ä½¿ç”¨ message_id ä¿è¯å¹‚ç­‰
def create_message(message_id, content):
    # æ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨
    if exists(message_id):
        return get_message(message_id)
    
    # ä¸å­˜åœ¨åˆ™åˆ›å»º
    message = Message(id=message_id, content=content)
    save_message(message)
    return message
```

---

## å…«ã€æ€»ç»“

### 8.1 æ ¸å¿ƒæ¦‚å¿µå›é¡¾

1. **AI Agent = LLM + å·¥å…·è°ƒç”¨ + çŠ¶æ€ç®¡ç† + ä»»åŠ¡ç¼–æ’**

2. **æ¶ˆæ¯æ˜¯çŠ¶æ€æœºçš„çŠ¶æ€è½¬ç§»**

3. **ç»Ÿä¸€æ¶ˆæ¯æ ¼å¼çš„å¿…è¦æ€§**ï¼š
   - æ”¯æŒå¤šæ¨¡å‹
   - ä¸šåŠ¡æ‰©å±•
   - çŠ¶æ€ç®¡ç†
   - å¯è¿½æº¯æ€§

4. **5 ç§æ¶ˆæ¯è§’è‰²**ï¼š
   - `system`ï¼šç³»ç»ŸæŒ‡ä»¤
   - `user`ï¼šç”¨æˆ·è¾“å…¥
   - `assistant`ï¼šAI å›å¤
   - `function`ï¼šå·¥å…·ç»“æœ
   - `status`ï¼šçŠ¶æ€æ¶ˆæ¯

5. **å·¥å…·è°ƒç”¨çš„æœ¬è´¨**ï¼šè®© LLM è¾“å‡ºç»“æ„åŒ–æŒ‡ä»¤

6. **Thread æ˜¯ç‹¬ç«‹çš„å¯¹è¯ä¸Šä¸‹æ–‡**

### 8.2 è®¾è®¡åŸåˆ™

- âœ… **ä¸å¯å˜æ€§**ï¼šæ¶ˆæ¯ä¸å¯ä¿®æ”¹
- âœ… **å•ä¸€æ•°æ®æº**ï¼šçŠ¶æ€é€šè¿‡æ¶ˆæ¯è®°å½•
- âœ… **å¹‚ç­‰æ€§**ï¼šå¯ä»¥å®‰å…¨é‡è¯•

### 8.3 ä¸‹ä¸€æ­¥

ç°åœ¨ä½ å·²ç»ç†è§£äº† AI Agent çš„åŸºç¡€æ¦‚å¿µï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬å°†æ·±å…¥ï¼š

- **[æ¶ˆæ¯ç³»ç»Ÿ](02-æ¶ˆæ¯ç³»ç»Ÿ.md)**ï¼šæ¶ˆæ¯æ ¼å¼çš„å®Œæ•´è®¾è®¡
- **[å·¥å…·è°ƒç”¨](03-å·¥å…·è°ƒç”¨.md)**ï¼šFunction Calling çš„å®ç°ç»†èŠ‚
- **[å·¥ä½œæµç¼–æ’](04-å·¥ä½œæµç¼–æ’.md)**ï¼šLangGraph çš„é›†æˆåŸç†

---

*æ–‡æ¡£ç‰ˆæœ¬ï¼šv1.0*  
*æœ€åæ›´æ–°ï¼š2026-01-26*

**ä¸Šä¸€ç¯‡**ï¼š[â† å¿«é€Ÿå…¥é—¨](00-å¿«é€Ÿå…¥é—¨.md) | **ä¸‹ä¸€ç¯‡**ï¼š[æ¶ˆæ¯ç³»ç»Ÿ â†’](02-æ¶ˆæ¯ç³»ç»Ÿ.md)
