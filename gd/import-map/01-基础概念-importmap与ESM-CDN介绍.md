# Import Map ä¸ ESM CDN ä»‹ç»

> **æ–‡æ¡£æ¥æº**  
> Confluence: https://doc.huanleguang.com/pages/viewpage.action?pageId=270426831

---

## æ–‡æ¡£æ¦‚è¿°

æœ¬æ–‡æ¡£å…¨é¢ä»‹ç»äº† **Import Map**ï¼ˆå¯¼å…¥æ˜ å°„ï¼‰å’Œ **ESM CDN** çš„æ ¸å¿ƒæ¦‚å¿µã€å·¥ä½œåŸç†ã€ä¸šåŠ¡åº”ç”¨åŠæœ€ä½³å®è·µã€‚

**æ ¸å¿ƒå†…å®¹**ï¼š
- ğŸ“˜ Import Map åŸºç¡€æ¦‚å¿µ
- ğŸš€ ESM CDN æœåŠ¡ä»‹ç»
- ğŸ› ï¸ WPM å·¥å…·ä½¿ç”¨æŒ‡å—
- ğŸ“¦ åŒ…è§„èŒƒè¦æ±‚
- âœ¨ å®é™…åº”ç”¨æ”¶ç›Š

---

## ä¸€ã€Import Map åŸºç¡€æ¦‚å¿µ

### 1.1 ä»€ä¹ˆæ˜¯ Import Map

**Import Map**ï¼ˆå¯¼å…¥æ˜ å°„ï¼‰æ˜¯ WICG æå‡ºçš„ä¸€ä¸ªææ¡ˆï¼Œç”¨äº**æ§åˆ¶ JavaScript çš„æ¨¡å—åŠ è½½è¡Œä¸º**ã€‚

**æ ¸å¿ƒä»·å€¼**ï¼š
- âœ… æ”¯æŒè£¸æ¨¡å—å¯¼å…¥ï¼ˆBare Module Importsï¼‰
- âœ… æµè§ˆå™¨åŸç”Ÿæ”¯æŒ
- âœ… è¿è¡Œæ—¶é›†æˆ
- âœ… ç°ä»£å‰ç«¯å·¥ç¨‹çš„è¶‹åŠ¿

**æµè§ˆå™¨æ”¯æŒ**ï¼š
- Chrome 89+ ç¨³å®šç‰ˆå¼€å§‹é»˜è®¤æ”¯æŒ
- å…¶ä»–ç°ä»£æµè§ˆå™¨é€æ­¥æ”¯æŒ

### 1.2 åŸºæœ¬ä½¿ç”¨

#### é—®é¢˜ï¼šè£¸æ¨¡å—å¯¼å…¥å¤±è´¥

**ä¼ ç»Ÿæ–¹å¼ï¼ˆä¼šæŠ¥é”™ï¼‰**ï¼š

```javascript
import _ from 'lodash';
_.clone({})
```

**é”™è¯¯ä¿¡æ¯**ï¼š

![è£¸æ¨¡å—å¯¼å…¥é”™è¯¯](../importmap%20&%20ESM%20CDN%20ä»‹ç»/attachments/image2022-12-8_13-41-45.png)

**é”™è¯¯åŸå› **ï¼š
- æµè§ˆå™¨ä¸çŸ¥é“ `'lodash'` æŒ‡å‘å“ªä¸ªæ–‡ä»¶
- éœ€è¦å®Œæ•´çš„ URL æˆ–ç›¸å¯¹è·¯å¾„

#### è§£å†³æ–¹æ¡ˆï¼šä½¿ç”¨ Import Map

**æ·»åŠ  Import Map åå³å¯å·¥ä½œ**ï¼š

```html
<script type="importmap">
{
  "imports": {
    "lodash": "https://esm.dancf.com/npm:lodash-es@4.17.21/lodash.js"
  }
}
</script>

<script type="module">
import _ from 'lodash';
_.clone({})
</script>
```

**å·¥ä½œåŸç†**ï¼š

```
æµè§ˆå™¨é‡åˆ° import 'lodash'
   â†“
æŸ¥æ‰¾ Import Map
   â†“
æ‰¾åˆ°æ˜ å°„ï¼šlodash â†’ https://esm.dancf.com/...
   â†“
åŠ è½½å¯¹åº”çš„ URL
   â†“
æ‰§è¡Œæ¨¡å—
```

### 1.3 é«˜çº§ç‰¹æ€§

#### ç‰¹æ€§ 1ï¼šç‰ˆæœ¬éš”ç¦»ï¼ˆScopesï¼‰

**ä½¿ç”¨åœºæ™¯**ï¼šåœ¨åŒä¸€é¡µé¢ä½¿ç”¨åŒä¸€ä¸ªåŒ…çš„ä¸åŒç‰ˆæœ¬

**é…ç½®ç¤ºä¾‹**ï¼š

```html
<script type="importmap">
{
  "imports": {
    "vue": "https://esm.dancf.com/npm:vue@2.7.13/dist/vue.runtime.esm.js"
  },
  "scopes": {
    "/vue2-app/": {
      "vue": "https://esm.dancf.com/npm:vue@2.6.14/dist/vue.runtime.esm.js"
    }
  }
}
</script>
```

**å·¥ä½œåŸç†**ï¼š

| æ¨¡å—è·¯å¾„ | ä½¿ç”¨çš„ Vue ç‰ˆæœ¬ | è¯´æ˜ |
|---------|----------------|------|
| `/main.js` | 2.7.13 | ä½¿ç”¨å…¨å±€ imports |
| `/vue2-app/app.js` | 2.6.14 | ä½¿ç”¨ scopes ä¸­çš„é…ç½® |
| `/vue2-app/utils.js` | 2.6.14 | åŒä¸€ scope ä¸‹éƒ½ä½¿ç”¨ 2.6.14 |

**åº”ç”¨åœºæ™¯**ï¼š
- âœ… å¾®å‰ç«¯ï¼šä¸åŒå­åº”ç”¨ä½¿ç”¨ä¸åŒç‰ˆæœ¬
- âœ… æ¸è¿›å¼å‡çº§ï¼šéƒ¨åˆ†æ¨¡å—å…ˆå‡çº§
- âœ… å…¼å®¹æ€§ï¼šä¿æŒè€ä»£ç æ­£å¸¸è¿è¡Œ

#### ç‰¹æ€§ 2ï¼šé™çº§ç­–ç•¥ï¼ˆFallbackï¼‰

**ä½¿ç”¨åœºæ™¯**ï¼šCDN å®¹ç¾ï¼Œä¸» CDN ä¸å¯ç”¨æ—¶è‡ªåŠ¨é™çº§

**é…ç½®ç¤ºä¾‹**ï¼š

```html
<script type="importmap">
{
  "imports": {
    "vue": [
      "https://esm.dancf.com/npm:vue@2.7.13/dist/vue.runtime.esm.js",
      "https://ga.jspm.io/npm:vue@2.7.13/dist/vue.runtime.esm.js"
    ]
  }
}
</script>
```

**å·¥ä½œæµç¨‹**ï¼š

```
å°è¯•åŠ è½½ç¬¬ä¸€ä¸ª URL
   â†“
åŠ è½½å¤±è´¥ï¼Ÿ
   â”œâ”€ å¦ â†’ æˆåŠŸ
   â””â”€ æ˜¯ â†’ å°è¯•ç¬¬äºŒä¸ª URL
          â†“
       åŠ è½½å¤±è´¥ï¼Ÿ
          â”œâ”€ å¦ â†’ æˆåŠŸ
          â””â”€ æ˜¯ â†’ é”™è¯¯
```

**åº”ç”¨åœºæ™¯**ï¼š
- âœ… CDN å®¹ç¾
- âœ… æé«˜å¯ç”¨æ€§
- âœ… å¤šåœ°åŸŸä¼˜åŒ–

#### ç‰¹æ€§ 3ï¼šå…¶ä»–ç‰¹æ€§

Import Map è¿˜æ”¯æŒæ›´å¤šç‰¹æ€§ï¼š

| ç‰¹æ€§ | è¯´æ˜ | æ–‡æ¡£é“¾æ¥ |
|------|------|---------|
| **åˆ«åï¼ˆAliasesï¼‰** | æ¨¡å—åç§°åˆ«å | [WICG Spec](https://github.com/WICG/import-maps) |
| **è™šæ‹ŸåŒ–ï¼ˆVirtualizationï¼‰** | è™šæ‹Ÿæ¨¡å—è·¯å¾„ | [WICG Spec](https://github.com/WICG/import-maps) |
| **é€šé…ç¬¦ï¼ˆWildcardsï¼‰** | è·¯å¾„é€šé…ç¬¦åŒ¹é… | [WICG Spec](https://github.com/WICG/import-maps) |

---

## äºŒã€ä¸šåŠ¡ç°çŠ¶ä¸æŒ‘æˆ˜

### 2.1 ç¼“å­˜é—®é¢˜

#### ä¼ ç»Ÿæ–¹æ¡ˆçš„ç—›ç‚¹

**æœŸæœ›**ï¼š
- âœ… æ‰€æœ‰ URL å”¯ä¸€
- âœ… é•¿æ—¶é—´ç¼“å­˜ï¼ˆå¼ºç¼“å­˜ï¼‰
- âœ… æœ€å¿«çš„è¯·æ±‚æ˜¯æ— è¯·æ±‚

**ä¼ ç»Ÿåšæ³•**ï¼š
- ä½¿ç”¨æ–‡ä»¶å†…å®¹ Hashï¼ˆå¦‚ `app.abc123.js`ï¼‰
- ä¿è¯ URL å”¯ä¸€æ€§

**é—®é¢˜**ï¼š

```
ä¾èµ–å…³ç³»é“¾ï¼š
app.js
  â”œâ”€ utils.js
  â”‚   â””â”€ lodash.js â† æ›´æ–°
  â””â”€ components.js

lodash æ›´æ–°
   â†“
utils.js å†…å®¹å˜åŒ–ï¼ˆimport è¯­å¥ä¸­çš„ hash å˜äº†ï¼‰
   â†“
app.js å†…å®¹å˜åŒ–ï¼ˆimport è¯­å¥ä¸­çš„ hash å˜äº†ï¼‰
   â†“
æ‰€æœ‰æ–‡ä»¶ç¼“å­˜å¤±æ•ˆï¼
```

**å½±å“**ï¼š
- âŒ ä¸€ä¸ªå°æ”¹åŠ¨å¯¼è‡´æ‰€æœ‰æ–‡ä»¶ç¼“å­˜å¤±æ•ˆ
- âŒ ç”¨æˆ·éœ€è¦é‡æ–°ä¸‹è½½æ‰€æœ‰èµ„æº
- âŒ ç¼“å­˜å‘½ä¸­ç‡ä½

#### Import Map çš„è§£å†³æ–¹æ¡ˆ

**é…ç½®ç¤ºä¾‹**ï¼š

```html
<!-- index.html -->
<script type="importmap">
{
  "imports": {
    "vue": "https://esm.dancf.com/npm:vue@2.7.13/dist/vue.runtime.esm.js"
  }
}
</script>
```

```javascript
// vite.config.ts
{
  build: {
    rollupOptions: {
      external: ['vue'], // å¤–éƒ¨åŒ– vue
    }
  }
}
```

**ä¼˜åŠ¿**ï¼š

```
ä¾èµ–å…³ç³»é“¾ï¼š
app.js
  â”œâ”€ utils.js
  â”‚   â””â”€ vue (external)
  â””â”€ components.js

vue æ›´æ–°
   â†“
åªéœ€æ›´æ–° Import Map
   â†“
app.jsã€utils.js ç­‰æ–‡ä»¶ä¸éœ€è¦å˜åŒ–
   â†“
ç¼“å­˜ä¾ç„¶æœ‰æ•ˆï¼
```

**æ”¶ç›Š**ï¼š
- âœ… å‡å°‘ç¼“å­˜å¤±æ•ˆ
- âœ… æ›´æ–°æ›´å¿«
- âœ… å¸¦å®½èŠ‚çœ

### 2.2 å…¼å®¹æ€§å¤„ç†

#### æµè§ˆå™¨æ”¯æŒæƒ…å†µ

| æµè§ˆå™¨ | æ”¯æŒç‰ˆæœ¬ | å¸‚åœºå æœ‰ç‡ |
|--------|---------|-----------|
| Chrome | 89+ | âœ… é«˜ |
| Edge | 89+ | âœ… é«˜ |
| Safari | 16.4+ | âš ï¸ ä¸­ |
| Firefox | 108+ | âš ï¸ ä¸­ |

**é—®é¢˜**ï¼šéœ€è¦æ”¯æŒä½ç‰ˆæœ¬æµè§ˆå™¨

#### è§£å†³æ–¹æ¡ˆï¼šES Module Shims

**ES Module Shims** æ˜¯ä¸€ä¸ªåŸºäº WebAssembly çš„é«˜æ€§èƒ½å«ç‰‡ï¼ˆPolyfillï¼‰ã€‚

**ç‰¹ç‚¹**ï¼š
- âœ… ç”Ÿäº§ç¯å¢ƒå¯ç”¨
- âœ… åŸºäº WebAssembly è¯æ³•åˆ†æ
- âœ… æ€§èƒ½ä¼˜ç§€
- âœ… å®Œæ•´æ”¯æŒ Import Map è§„èŒƒ

**ä½¿ç”¨ç¤ºä¾‹**ï¼š

```javascript
if (!HTMLScriptElement.supports || !HTMLScriptElement.supports('importmap')) {
  // ä¸æ”¯æŒ Import Mapï¼ŒåŠ è½½å«ç‰‡
  document.head.appendChild(
    Object.assign(document.createElement('script'), {
      src: 'https://esm.dancf.com/npm:es-module-shims@1.6.2/dist/es-module-shims.js',
      crossorigin: 'anonymous',
      async: true,
      onload() {
        // ä½¿ç”¨ importShim åŠ è½½æ¨¡å—
        importShim('https://cdn.dancf.com/gdesign/view/static/js2/d7ca4e8b.js');
      },
    }),
  );
} else {
  // åŸç”Ÿæ”¯æŒï¼Œç›´æ¥ä½¿ç”¨
  import('https://cdn.dancf.com/gdesign/view/static/js2/d7ca4e8b.js');
}
```

**å·¥ä½œæµç¨‹**ï¼š

```
æ£€æµ‹æµè§ˆå™¨æ”¯æŒ
   â”œâ”€ æ”¯æŒ Import Map
   â”‚     â†“
   â”‚  ä½¿ç”¨åŸç”Ÿ import
   â”‚
   â””â”€ ä¸æ”¯æŒ
         â†“
      åŠ è½½ es-module-shims.js
         â†“
      ä½¿ç”¨ importShim
```

---

## ä¸‰ã€ESM CDN ä»‹ç»

### 3.1 ä»€ä¹ˆæ˜¯ ESM CDN

**esm.dancf.com** æ˜¯ Growing Web æ¨å‡ºçš„ CDN æœåŠ¡ã€‚

**å®šä½**ï¼š
- ğŸ“¦ ä»¥ npm ä½œä¸ºæ‰˜ç®¡ä¸­å¿ƒ
- ğŸ¯ åŸç”Ÿ ES Module æ ¼å¼
- ğŸš€ ä¸“ä¸º Import Map è®¾è®¡

### 3.2 ä¸ JSPM çš„å¯¹æ¯”

**ç›¸åŒç‚¹**ï¼š
- âœ… åŠŸèƒ½ç›¸åŒ
- âœ… éƒ½æ”¯æŒ npm åŒ…
- âœ… éƒ½è¾“å‡º ESM æ ¼å¼

**ä¼˜åŠ¿**ï¼š

| å¯¹æ¯”é¡¹ | esm.dancf.com | ga.jspm.io |
|--------|---------------|------------|
| **è®¿é—®é€Ÿåº¦ï¼ˆå›½å†…ï¼‰** | ğŸš€ å¿« | âš ï¸ æ…¢ |
| **ç¨³å®šæ€§ï¼ˆå›½å†…ï¼‰** | âœ… é«˜ | âš ï¸ ä½ |
| **æ—¶æ•ˆæ€§** | âœ… ç«‹å³å¯ç”¨ | âš ï¸ éœ€è¦æ„å»ºé˜Ÿåˆ— |
| **ç§æœ‰åŒ–éƒ¨ç½²** | âœ… æ”¯æŒ | âŒ ä¸æ”¯æŒ |

### 3.3 ä¸ºä»€ä¹ˆè¦è‡ªå»º CDN

**æ ¸å¿ƒåŸå› **ï¼š

| éœ€æ±‚ | ç°æœ‰æ–¹æ¡ˆé—®é¢˜ | è‡ªå»ºè§£å†³æ–¹æ¡ˆ |
|------|------------|-------------|
| **å›½å†…è®¿é—®é€Ÿåº¦** | jspm åœ¨å›½å¤–ï¼Œè®¿é—®æ…¢ | å›½å†…éƒ¨ç½²ï¼Œè®¿é—®å¿« |
| **å¯é æ€§** | ä¾èµ–ç¬¬ä¸‰æ–¹ | è‡ªä¸»å¯æ§ |
| **å®æ—¶æ€§** | éœ€è¦æ„å»ºé˜Ÿåˆ— | å³å‘å³ç”¨ |
| **æ‰©å±•æ€§** | æ— æ³•å®šåˆ¶ | å®Œå…¨å¯å®šåˆ¶ |
| **ç§æœ‰åŒ–** | ä¸æ”¯æŒ | æ”¯æŒä¼ä¸šç§æœ‰éƒ¨ç½² |

### 3.4 CDN æœåŠ¡å·¥ä½œæµç¨‹

**æ¶æ„å›¾**ï¼š

![CDN å·¥ä½œæµç¨‹](../importmap%20&%20ESM%20CDN%20ä»‹ç»/attachments/image2022-6-16_15-25-5.png)

**å·¥ä½œæµç¨‹**ï¼š

```
ç”¨æˆ·è¯·æ±‚åŒ…
   â†“
esm.dancf.com
   â†“
æ£€æŸ¥ç¼“å­˜
   â”œâ”€ å‘½ä¸­ â†’ ç›´æ¥è¿”å›
   â””â”€ æœªå‘½ä¸­ â†“
      ä» npm ä¸‹è½½
         â†“
      è½¬æ¢ä¸º ESM æ ¼å¼
         â†“
      å‹ç¼©ä¼˜åŒ–
         â†“
      ä¸Šä¼ åˆ° CDN
         â†“
      è¿”å›ç»™ç”¨æˆ·
```

**å…³é”®æ­¥éª¤**ï¼š
1. **ä¸‹è½½**ï¼šä» npm registry ä¸‹è½½åŒ…
2. **è½¬æ¢**ï¼šCommonJS â†’ ES Module
3. **ä¼˜åŒ–**ï¼šä»£ç å‹ç¼©ã€Tree Shaking
4. **ç¼“å­˜**ï¼šå¼ºç¼“å­˜ 1 å¹´ï¼ˆå›ºå®šç‰ˆæœ¬ï¼‰

### 3.5 CDN ä½¿ç”¨æ–¹æ³•

#### URL æ ¼å¼

```
https://esm.dancf.com/npm:package@version/file
```

**å‚æ•°è¯´æ˜**ï¼š

| éƒ¨åˆ† | è¯´æ˜ | ç¤ºä¾‹ |
|------|------|------|
| `package` | åŒ…å | `vue` æˆ– `@gaoding/utils` |
| `version` | ç‰ˆæœ¬å·ï¼ˆå¿…é¡»å›ºå®šï¼‰ | `2.7.13` |
| `file` | æ–‡ä»¶è·¯å¾„ | `dist/vue.runtime.esm.js` |

#### ä½¿ç”¨ç¤ºä¾‹

**ç¤ºä¾‹ 1ï¼šåŸºç¡€åŒ…**

```
https://esm.dancf.com/npm:vue@2.7.13/dist/vue.runtime.esm.js
```

**ç¤ºä¾‹ 2ï¼šScoped åŒ…**

```
https://esm.dancf.com/npm:@gaoding/user-device-id@0.5.1/dist/index.js
```

**ç¤ºä¾‹ 3ï¼šå­è·¯å¾„**

```
https://esm.dancf.com/npm:lodash-es@4.17.21/debounce.js
```

#### ç¼“å­˜ç­–ç•¥

**å›ºå®šç‰ˆæœ¬ï¼ˆæ¨èï¼‰**ï¼š

```
Cache-Control: public, max-age=31536000, immutable
```

**ç‰¹ç‚¹**ï¼š
- âœ… ç¼“å­˜ 1 å¹´
- âœ… æ°¸ä¸è¿‡æœŸ
- âœ… æ€§èƒ½æœ€ä¼˜

**æ³¨æ„**ï¼š
- âš ï¸ å¿…é¡»ä½¿ç”¨å›ºå®šç‰ˆæœ¬å·ï¼ˆä¸èƒ½ç”¨ `^` æˆ– `~`ï¼‰
- âš ï¸ ç‰ˆæœ¬æ›´æ–°éœ€è¦ä¿®æ”¹ Import Map

---

## å››ã€WPM å·¥å…·

### 4.1 ä»€ä¹ˆæ˜¯ WPM

**WPM**ï¼ˆWeb Package Managerï¼‰æ˜¯ Growing Web æ¨å‡ºçš„åŒ…ç®¡ç†å·¥å…·ã€‚

**å®šä½**ï¼š
- ğŸ“¦ åŸºäº Import Map æ ‡å‡†
- ğŸŒ ç®¡ç†è¿œç¨‹ CDN åŒ…
- ğŸ”— ä¹Ÿå¯ä»¥æ˜ å°„åˆ°æœ¬åœ°åŒ…

**ä¸ npm çš„å¯¹æ¯”**ï¼š

| ç‰¹æ€§ | npm | WPM |
|------|-----|-----|
| **åŒ…æ¥æº** | æœ¬åœ° node_modules | è¿œç¨‹ CDN |
| **é”æ–‡ä»¶** | package-lock.json | importmap.json |
| **å…³ç³»** | åŸºç¡€ | äº’è¡¥ |

**æ ¸å¿ƒä»·å€¼**ï¼š
- âœ… ç®€åŒ– SaaS éƒ¨ç½²
- âœ… ç®€åŒ–ç§æœ‰åŒ–éƒ¨ç½²
- âœ… æ— éœ€æ„å»ºå³å¯æ›´æ–°ä¾èµ–

### 4.2 å®‰è£… WPM

```bash
npm install -g @growing-web/wpm
```

### 4.3 é…ç½®æ–‡ä»¶

**æ–‡ä»¶å**ï¼š`web-module.json`

**åŸºç¡€é…ç½®**ï¼š

```json
{
  "defaultProvider": "dancf",
  "providers": {},
  "dependencies": {
    "react": "^17.0.2"
  }
}
```

**é…ç½®è¯´æ˜**ï¼š

| å­—æ®µ | è¯´æ˜ | ç¤ºä¾‹ |
|------|------|------|
| `defaultProvider` | é»˜è®¤ CDN ä¾›åº”å•† | `"dancf"` æˆ– `"jspm"` |
| `providers` | è‡ªå®šä¹‰ä¾›åº”å•†æ˜ å°„ | `{ "@company": "custom-cdn" }` |
| `dependencies` | ä¾èµ–åˆ—è¡¨ï¼ˆæ”¯æŒç‰ˆæœ¬èŒƒå›´ï¼‰ | `{ "react": "^17.0.2" }` |

### 4.4 å®‰è£…ä¾èµ–

```bash
wpm install
```

**æ‰§è¡Œå**ï¼š
- âœ… ç”Ÿæˆ `importmap.json` æ–‡ä»¶
- âœ… è§£æä¾èµ–å…³ç³»
- âœ… å¡«å…… scopesï¼ˆå­ä¾èµ–ï¼‰

**ç”Ÿæˆçš„ importmap.json ç¤ºä¾‹**ï¼š

```json
{
  "imports": {
    "react": "https://esm.dancf.com/npm:react@17.0.2/index.js"
  },
  "scopes": {
    "https://esm.dancf.com/": {
      "object-assign": "https://esm.dancf.com/npm:object-assign@4.1.1/index.js"
    }
  }
}
```

**å·¥ä½œåŸç†**ï¼š

```
WPM åˆ†æ react çš„ä¾èµ–
   â†“
å‘ç°ä¾èµ– object-assign
   â†“
æŸ¥çœ‹ react çš„ package.json
   â†“
ç¡®å®š object-assign çš„ç‰ˆæœ¬
   â†“
æ·»åŠ åˆ° scopes ä¸­
   â†“
å®ç°ä¾èµ–å…±äº«
```

### 4.5 ä½¿ç”¨ Import Map

**åœ¨ HTML ä¸­ä½¿ç”¨**ï¼š

```html
<!DOCTYPE html>
<html>
<head>
  <!-- åŠ è½½ Import Map -->
  <script type="importmap" src="/importmap.json"></script>
</head>
<body>
  <script type="module">
    // ç›´æ¥ä½¿ç”¨è£¸æ¨¡å—å¯¼å…¥
    import React from 'react';
    console.log(React.version);
  </script>
</body>
</html>
```

---

## äº”ã€å¯¹åŒ…çš„è¦æ±‚

### 5.1 æ ¸å¿ƒè¦æ±‚

Import Map å¯¹åŒ…æœ‰ä»¥ä¸‹è¦æ±‚ï¼š

| è¦æ±‚ | è¯´æ˜ | é‡è¦æ€§ |
|------|------|--------|
| **ESM æ ¼å¼** | å¿…é¡»æä¾› ES Module äº§ç‰© | ğŸ”´ å¿…é¡» |
| **å¯¹ç­‰ä¾èµ–** | æ˜ç¡®å£°æ˜ peerDependencies | ğŸ”´ å¿…é¡» |
| **å…¥å£é…ç½®** | ä½¿ç”¨ exports å­—æ®µ | ğŸŸ¡ æ¨è |

### 5.2 æ˜ç¡®å¯¹ç­‰ä¾èµ–

#### ä»€ä¹ˆæ˜¯å¯¹ç­‰ä¾èµ–

**å¯¹ç­‰ä¾èµ–ï¼ˆpeerDependenciesï¼‰**ï¼šæç¤ºå®¿ä¸»ç¯å¢ƒå®‰è£…æŒ‡å®šçš„ä¾èµ–ã€‚

**ç›®çš„**ï¼š
- âœ… é¿å…ç‰ˆæœ¬å†²çª
- âœ… å…±äº«ç›¸åŒçš„ä¾èµ–
- âœ… å‡å°‘åŒ…ä½“ç§¯

**é…ç½®ç¤ºä¾‹**ï¼š

```json
{
  "name": "@gaoding/vue-components",
  "peerDependencies": {
    "vue": "^2.7.0"
  }
}
```

**å·¥ä½œåŸç†**ï¼š

```
é¡¹ç›®ç»“æ„ï¼š
my-app/
  â”œâ”€ vue@2.7.13 (é¡¹ç›®å®‰è£…)
  â””â”€ @gaoding/vue-components
       â””â”€ å£°æ˜ peerDependencies: vue ^2.7.0

ç»“æœï¼š
@gaoding/vue-components ä½¿ç”¨é¡¹ç›®çš„ vue@2.7.13
ä¸ä¼šé‡å¤å®‰è£… vue
```

### 5.3 å…¥å£é…ç½®ï¼ˆExportsï¼‰

#### åŸºç¡€ç”¨æ³•

**package.json é…ç½®**ï¼š

```json
{
  "name": "pkg",
  "exports": {
    ".": "./main.js",
    "./sub/path": "./sub.js"
  }
}
```

**ä½¿ç”¨æ–¹å¼**ï¼š

```javascript
import "pkg"           // â†’ import "pkg/main.js"
import "pkg/sub/path"  // â†’ import "pkg/sub.js"
```

#### æ¡ä»¶å¯¼å‡º

**å¼ºå¤§ä¹‹å¤„**ï¼šé’ˆå¯¹ä¸åŒç¯å¢ƒæä¾›ä¸åŒç‰ˆæœ¬

**é…ç½®ç¤ºä¾‹**ï¼š

```json
{
  "exports": {
    "development": {
      "node": "./app-ssr.dev.js",
      "browser": "./app.dev.mjs"
    },
    "production": {
      "node": "./app-ssr.js",
      "browser": "./app.mjs"
    },
    "default": "./app.mjs"
  }
}
```

**æ¡ä»¶ç±»å‹**ï¼š

| æ¡ä»¶ | è¯´æ˜ | ä½¿ç”¨åœºæ™¯ |
|------|------|---------|
| `development` | å¼€å‘ç¯å¢ƒ | åŒ…å«è°ƒè¯•ä¿¡æ¯ |
| `production` | ç”Ÿäº§ç¯å¢ƒ | ä¼˜åŒ–åçš„ä»£ç  |
| `node` | Node.js ç¯å¢ƒ | SSRã€æ„å»ºå·¥å…· |
| `browser` | æµè§ˆå™¨ç¯å¢ƒ | å®¢æˆ·ç«¯ä»£ç  |
| `import` | ES Module | ç°ä»£ç¯å¢ƒ |
| `require` | CommonJS | å…¼å®¹ç¯å¢ƒ |
| `default` | é™çº§ | å…¶ä»–æƒ…å†µ |

**åŒ¹é…è§„åˆ™**ï¼š
- ä»ä¸Šåˆ°ä¸‹åŒ¹é…
- ç¬¬ä¸€ä¸ªåŒ¹é…çš„æ¡ä»¶ç”Ÿæ•ˆ
- `default` ä½œä¸ºå…œåº•

**æ”¶ç›Š**ï¼š
- âœ… WPM ç­‰å·¥å…·å¯ä»¥è‡ªåŠ¨é€‰æ‹©æ­£ç¡®çš„å…¥å£
- âœ… å¼€å‘å’Œç”Ÿäº§ä½¿ç”¨ä¸åŒçš„åŒ…
- âœ… SSR å’Œ CSR ä½¿ç”¨ä¸åŒçš„åŒ…

---

## å…­ã€Import Map çš„ä»·å€¼

### 6.1 ç¼“å­˜å…±äº«

#### è·¨åº”ç”¨å…±äº«

**åœºæ™¯**ï¼šå¤šä¸ªåº”ç”¨ä½¿ç”¨ç›¸åŒçš„åŸºç¡€åº“

**é…ç½®ç¤ºä¾‹**ï¼š

```json
{
  "imports": {
    "app1": "https://esm.dancf.com/npm:app1@17.0.2/app.js",
    "app2": "https://esm.dancf.com/npm:app2@17.0.2/app.js"
  },
  "scopes": {
    "https://esm.dancf.com/": {
      "auth": "https://esm.dancf.com/npm:auth@4.1.1/auth.js"
    }
  }
}
```

**æ”¶ç›Š**ï¼š

```
ç”¨æˆ·è®¿é—® app1
   â†“
ä¸‹è½½ app1.js å’Œ auth.js
   â†“
ç”¨æˆ·è®¿é—® app2
   â†“
åªéœ€ä¸‹è½½ app2.js
auth.js å·²ç¼“å­˜ï¼Œæ— éœ€é‡å¤ä¸‹è½½ï¼
```

**ä»·å€¼**ï¼š
- âœ… å‡å°‘å¸¦å®½æ¶ˆè€—
- âœ… æå‡åŠ è½½é€Ÿåº¦
- âœ… é™ä½æœåŠ¡å™¨å‹åŠ›

#### è·¨ç‰ˆæœ¬å…±äº«

**åœºæ™¯**ï¼šåº”ç”¨æ›´æ–°åï¼Œå…±äº«ä¾èµ–æ— éœ€é‡æ–°ä¸‹è½½

```
åº”ç”¨ v1.0.0
   â”œâ”€ react@17.0.2
   â””â”€ lodash@4.17.21

åº”ç”¨ v1.0.1
   â”œâ”€ react@17.0.2 (å·²ç¼“å­˜ï¼)
   â””â”€ lodash@4.17.21 (å·²ç¼“å­˜ï¼)
```

### 6.2 æ— æ„å»ºæ›´æ–°

**ä¼ ç»Ÿæ–¹å¼**ï¼š

```
æ›´æ–°ä¸€ä¸ªä¾èµ–
   â†“
é‡æ–°æ„å»ºæ•´ä¸ªé¡¹ç›®
   â†“
ç”Ÿæˆæ–°çš„ hash æ–‡ä»¶å
   â†“
æ‰€æœ‰æ–‡ä»¶ç¼“å­˜å¤±æ•ˆ
   â†“
ç”¨æˆ·é‡æ–°ä¸‹è½½æ‰€æœ‰æ–‡ä»¶
```

**Import Map æ–¹å¼**ï¼š

```
æ›´æ–°ä¸€ä¸ªä¾èµ–
   â†“
åªä¿®æ”¹ importmap.json
   â†“
å…¶ä»–æ–‡ä»¶ä¸å˜
   â†“
ç¼“å­˜ä¾ç„¶æœ‰æ•ˆ
   â†“
ç”¨æˆ·åªä¸‹è½½æ›´æ–°çš„ä¾èµ–
```

**é…ç½®å¯¹æ¯”**ï¼š

```json
// æ›´æ–°å‰
{
  "imports": {
    "app1": "https://esm.dancf.com/npm:app1@17.0.2/app.js"
  },
  "scopes": {
    "https://esm.dancf.com/": {
      "auth": "https://esm.dancf.com/npm:auth@4.1.1/auth.js"
    }
  }
}

// æ›´æ–°åï¼ˆåªæ”¹äº† auth ç‰ˆæœ¬ï¼‰
{
  "imports": {
    "app1": "https://esm.dancf.com/npm:app1@17.0.2/app.js"
  },
  "scopes": {
    "https://esm.dancf.com/": {
      "auth": "https://esm.dancf.com/npm:auth@4.1.2/auth.js"  // â† åªæ”¹è¿™é‡Œ
    }
  }
}
```

**æ”¶ç›Š**ï¼š
- âœ… æ›´æ–°é€Ÿåº¦å¿«
- âœ… å‡å°‘æ„å»ºæ—¶é—´
- âœ… æå‡éƒ¨ç½²æ•ˆç‡

### 6.3 åŒ…æ ‡å‡†åŒ–

**æ¨åŠ¨æ•ˆæœ**ï¼š
- âœ… åŒ…è§„èŒƒåŒ–ï¼ˆESMã€exportsã€peerDependenciesï¼‰
- âœ… æ„å»ºæ ‡å‡†åŒ–
- âœ… ç”Ÿæ€ç°ä»£åŒ–

**å¥—ç‰ˆé¡¹ç›®å®è·µæ”¶ç›Š**ï¼š

| æŒ‡æ ‡ | ä¼˜åŒ–å‰ | ä¼˜åŒ–å | æå‡ |
|------|-------|-------|------|
| **æ„å»ºé€Ÿåº¦** | 7 åˆ†é’Ÿ | 3 åˆ†é’Ÿ | â¬†ï¸ 150% |
| **äº§ç‰©ä½“ç§¯** | åŸºå‡† | -20% | â¬‡ï¸ 20% |

**æ”¹é€ å†…å®¹**ï¼š
- âœ… æ˜ç¡®å¯¹ç­‰ä¾èµ–
- âœ… ä½¿ç”¨ exports å­—æ®µ
- âœ… æä¾› ESM äº§ç‰©

---

## ä¸ƒã€å®è·µä¸­çš„é—®é¢˜

### 7.1 æµè§ˆå™¨æ’ä»¶å¹²æ‰°

#### é—®é¢˜æè¿°

**Import Map è¦æ±‚**ï¼š
- `<script type="importmap">` å¿…é¡»åœ¨ç¬¬ä¸€ä¸ª `<script type="module">` ä¹‹å‰

**é—®é¢˜åœºæ™¯**ï¼š
- æå°‘æ•°æµè§ˆå™¨æ’ä»¶ä¼šåœ¨ HTML é¡¶éƒ¨æ³¨å…¥ `<script type="module">`
- å¯¼è‡´ Import Map å¤±æ•ˆ

**ç¤ºä¾‹å›¾**ï¼š

![æ’ä»¶å¹²æ‰°ç¤ºä¾‹1](../importmap%20&%20ESM%20CDN%20ä»‹ç»/attachments/image2022-12-7_15-7-3.png)

![æ’ä»¶å¹²æ‰°ç¤ºä¾‹2](../importmap%20&%20ESM%20CDN%20ä»‹ç»/attachments/image2022-12-8_13-40-34.png)

#### è§£å†³æ–¹æ¡ˆ

**æ£€æµ‹ä»£ç **ï¼š

```javascript
(function () {
  try {
    var current = document.querySelector('script[type=importmap]');
    var selector = 'script[type=module]';
    
    while (
      (current =
        current.previousElementSibling ||
        (current.parentElement && current.parentElement.previousElementSibling))
    ) {
      if (current.matches(selector) || current.querySelector(selector)) {
        // æ£€æµ‹åˆ°æ’ä»¶å¹²æ‰°
        window.prompt(
          'æ‚¨çš„æŸä¸ªæµè§ˆå™¨æ’ä»¶é˜»æ­¢äº†' +
            document.domain +
            'çš„è¿è¡Œï¼Œè¯·æ‰¾åˆ°å¹¶å…³é—­å®ƒã€‚\nå¤åˆ¶é“¾æ¥å¹¶åœ¨æ–°çš„çª—å£æ‰“å¼€è®¾ç½®ç•Œé¢è¿›è¡Œå…³é—­ã€‚',
          'chrome://extensions/',
        );
        break;
      }
    }
  } catch (error) {
    // å¿½ç•¥é”™è¯¯
  }
})();
```

**æç¤ºç•Œé¢**ï¼š

![ç”¨æˆ·æç¤º](../importmap%20&%20ESM%20CDN%20ä»‹ç»/attachments/image2022-12-7_14-42-24.png)

**å®æ–½æ–¹å¼**ï¼š
- âœ… åœ¨ HTML çš„ `<head>` ä¸­å°½æ—©æ”¾ç½®æ£€æµ‹ä»£ç 
- âœ… æç¤ºç”¨æˆ·è®¿é—® `chrome://extensions/` å…³é—­æ’ä»¶
- âœ… æä¾›æ˜ç¡®çš„æ“ä½œæŒ‡å¼•

### 7.2 åœ¨ NoCode/LowCode ä¸­çš„åº”ç”¨

**ä¼˜åŠ¿**ï¼š

| ç‰¹æ€§ | ä»·å€¼ |
|------|------|
| **æ— éœ€æ„å»ºå·¥å…·** | ç›´æ¥åœ¨æµè§ˆå™¨è¿è¡Œ | âœ… |
| **ä¾èµ–ç®¡ç†ç®€å•** | Import Map è‡ªåŠ¨å¤„ç† | âœ… |
| **åŠ¨æ€åŠ è½½** | è¿è¡Œæ—¶åŠ è½½ä»»æ„æ¨¡å— | âœ… |
| **ç‰ˆæœ¬éš”ç¦»** | Scopes æ”¯æŒå¤šç‰ˆæœ¬ | âœ… |

**åº”ç”¨åœºæ™¯**ï¼š
- âœ… ä½ä»£ç é¡µé¢
- âœ… åŠ¨æ€ç»„ä»¶åŠ è½½
- âœ… æ’ä»¶ç³»ç»Ÿ
- âœ… å¾®å‰ç«¯

**å·¥å…·æ”¯æŒ**ï¼š
- [JSPM Generator](https://generator.jspm.io/)ï¼šç”Ÿæˆ Import Map
- WPMï¼šä¼ä¸šçº§ Import Map ç®¡ç†

---

## å…«ã€æ€»ç»“

### 8.1 æ ¸å¿ƒä»·å€¼

**Import Map**ï¼š
- ğŸ“˜ æµè§ˆå™¨åŸç”Ÿæ¨¡å—ç®¡ç†æ ‡å‡†
- ğŸš€ æ”¯æŒè£¸æ¨¡å—å¯¼å…¥
- ğŸ”„ ç‰ˆæœ¬éš”ç¦»å’Œé™çº§
- âœ… ç°ä»£å‰ç«¯å·¥ç¨‹åŸºçŸ³

**ESM CDN**ï¼š
- ğŸ“¦ npm åŒ…çš„ CDN åŠ é€Ÿ
- ğŸ¯ åŸç”Ÿ ESM æ ¼å¼
- ğŸš€ esm.dancf.com å›½å†…ä¼˜åŒ–
- âœ… æ”¯æŒç§æœ‰åŒ–éƒ¨ç½²

**WPM å·¥å…·**ï¼š
- ğŸ› ï¸ Import Map ç”Ÿæˆå·¥å…·
- ğŸ“¦ ç®¡ç†è¿œç¨‹å’Œæœ¬åœ°åŒ…
- ğŸ”— ç®€åŒ–éƒ¨ç½²æµç¨‹
- âœ… æå‡å¼€å‘ä½“éªŒ

### 8.2 å…³é”®æ”¶ç›Š

**æ€§èƒ½æå‡**ï¼š
- âœ… æ„å»ºé€Ÿåº¦æå‡ 150%
- âœ… äº§ç‰©ä½“ç§¯å‡å°‘ 20%
- âœ… ç¼“å­˜å‘½ä¸­ç‡æé«˜

**å¼€å‘ä½“éªŒ**ï¼š
- âœ… æ— éœ€å¤æ‚æ„å»ºå·¥å…·
- âœ… ä¾èµ–ç®¡ç†è‡ªåŠ¨åŒ–
- âœ… çƒ­æ›´æ–°æ›´å¿«

**éƒ¨ç½²ç®€åŒ–**ï¼š
- âœ… SaaS éƒ¨ç½²ç®€åŒ–
- âœ… ç§æœ‰åŒ–éƒ¨ç½²ç®€åŒ–
- âœ… è·¨åº”ç”¨å…±äº«ä¾èµ–

### 8.3 æœªæ¥å±•æœ›

**ç”Ÿæ€å‘å±•**ï¼š
- ğŸ“ˆ æµè§ˆå™¨æ”¯æŒåº¦æŒç»­æå‡
- ğŸ“ˆ æ›´å¤šå·¥å…·æ”¯æŒ Import Map
- ğŸ“ˆ npm åŒ…é€æ­¥æ ‡å‡†åŒ–

**æŠ€æœ¯æ¼”è¿›**ï¼š
- ğŸ”® ä¸ Web Components æ·±åº¦é›†æˆ
- ğŸ”® ä¸å¾®å‰ç«¯æ¶æ„ç»“åˆ
- ğŸ”® è¾¹ç¼˜è®¡ç®—åœºæ™¯åº”ç”¨

---

## ä¹ã€è‡´è°¢

æ„Ÿè°¢ä»¥ä¸‹åŒå­¦åœ¨å¥—ç‰ˆé¡¹ç›® Import Map è½åœ°è¿‡ç¨‹ä¸­çš„ååŠ©ï¼š

- @ç³–é¥¼
- @é’±è‘±
- @æœªçŸ¥ç”¨æˆ· (kayan)
- @ç‰›ä¸¸
- @æœªçŸ¥ç”¨æˆ· (haiyuan)
- @æœªçŸ¥ç”¨æˆ· (lingmao)

åœ¨åŒ…æ ‡å‡†åŒ–æ”¹é€ æ¨è¿›è¿‡ç¨‹ä¸­ï¼Œå¤§å®¶çš„åŠªåŠ›ä½¿å¾— Import Map å¾—ä»¥æˆåŠŸè½åœ°ã€‚

---

## åã€å‚è€ƒèµ„æº

### 10.1 è§„èŒƒæ–‡æ¡£

- [WICG Import Maps Spec](https://github.com/WICG/import-maps)
- [ES Module Specification](https://tc39.es/ecma262/#sec-modules)
- [Package Exports Field](https://nodejs.org/api/packages.html#exports)

### 10.2 å·¥å…·èµ„æº

- [JSPM Generator](https://generator.jspm.io/)
- [ES Module Shims](https://github.com/guybedford/es-module-shims)
- [WPM](https://github.com/growing-web/wpm)

### 10.3 CDN æœåŠ¡

- [esm.dancf.com](https://esm.dancf.com)
- [JSPM CDN](https://ga.jspm.io)
- [jsDelivr](https://www.jsdelivr.com/)

---

**æ–‡æ¡£ç»´æŠ¤**ï¼šå‰ç«¯åŸºå»ºå›¢é˜Ÿ  
**æ•´ç†æ—¥æœŸ**ï¼š2025-01-24  
**æ–‡æ¡£ç‰ˆæœ¬**ï¼šv1.0
