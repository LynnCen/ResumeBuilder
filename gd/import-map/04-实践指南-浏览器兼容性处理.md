# Import Map æµè§ˆå™¨å…¼å®¹æ€§å¤„ç†æœ€ä½³å®è·µ

> **æ–‡æ¡£æ¥æº**  
> Confluence: https://doc.huanleguang.com/pages/viewpage.action?pageId=321434711

---

## æ–‡æ¡£æ¦‚è¿°

æœ¬æ–‡æ¡£æä¾›äº† **Import Map æµè§ˆå™¨å…¼å®¹æ€§å¤„ç†**çš„æœ€ä½³å®è·µï¼Œç¡®ä¿åœ¨ä¸æ”¯æŒ Import Map çš„æµè§ˆå™¨ä¸­ä¹Ÿèƒ½æ­£å¸¸è¿è¡Œã€‚

**æ ¸å¿ƒå†…å®¹**ï¼š
- ğŸ”§ å¼•å…¥ ES Module Shims å«ç‰‡
- ğŸ“ æ ‡å‡†åŒ–çš„åŠ è½½å…¥å£æ–‡ä»¶æ–¹å¼
- âœ… å¼€å‘ç¯å¢ƒä¸ç”Ÿäº§ç¯å¢ƒå…¼å®¹

---

## ä¸€ã€èƒŒæ™¯ä¿¡æ¯

### 1.1 Import Map æµè§ˆå™¨æ”¯æŒæƒ…å†µ

**åŸç”Ÿæ”¯æŒæƒ…å†µ**ï¼š

| æµè§ˆå™¨ | æ”¯æŒç‰ˆæœ¬ | å‘å¸ƒæ—¶é—´ | å¸‚åœºå æœ‰ç‡ |
|--------|---------|---------|-----------|
| **Chrome** | 89+ | 2021-03 | âœ… é«˜ |
| **Edge** | 89+ | 2021-03 | âœ… é«˜ |
| **Safari** | 16.4+ | 2023-03 | âš ï¸ ä¸­ |
| **Firefox** | 108+ | 2022-12 | âš ï¸ ä¸­ |
| **Opera** | 75+ | 2021-04 | âš ï¸ ä½ |

**å…¼å®¹æ€§æ£€æŸ¥**ï¼š

```javascript
// æ£€æµ‹æµè§ˆå™¨æ˜¯å¦æ”¯æŒ Import Map
const supportsImportMap = HTMLScriptElement.supports && 
                          HTMLScriptElement.supports('importmap');

console.log('æ”¯æŒ Import Map:', supportsImportMap);
```

### 1.2 ä¸ºä»€ä¹ˆéœ€è¦å…¼å®¹æ€§å¤„ç†

**éœ€è¦å…¼å®¹çš„åŸå› **ï¼š

| åŸå›  | è¯´æ˜ | å½±å“ |
|------|------|------|
| **æ—§ç‰ˆæµè§ˆå™¨** | ä¼ä¸šç”¨æˆ·ã€ç‰¹å®šè®¾å¤‡ | ğŸ”´ æ— æ³•è¿è¡Œ |
| **Safari å»¶è¿Ÿ** | Safari æ”¯æŒè¾ƒæ™š | ğŸ”´ iOS ç”¨æˆ·å—å½±å“ |
| **Firefox å»¶è¿Ÿ** | Firefox 108+ æ‰æ”¯æŒ | ğŸ”´ éƒ¨åˆ†ç”¨æˆ·å—å½±å“ |
| **å…¼å®¹æ€§è¦æ±‚** | ä¸šåŠ¡éœ€è¦æ”¯æŒæ›´å¹¿æ³›çš„æµè§ˆå™¨ | ğŸ”´ å¿…é¡»å¤„ç† |

**å½±å“èŒƒå›´**ï¼š

```
ä¸åšå…¼å®¹å¤„ç†
   â†“
Import Map æ— æ³•è§£æ
   â†“
è£¸æ¨¡å—å¯¼å…¥å¤±è´¥
   â†“
åº”ç”¨æ— æ³•è¿è¡Œ âŒ
```

### 1.3 è§£å†³æ–¹æ¡ˆæ¦‚è¿°

**æ ¸å¿ƒæ–¹æ¡ˆ**ï¼šä½¿ç”¨ **ES Module Shims** å«ç‰‡

**å·¥ä½œåŸç†**ï¼š

```
æ£€æµ‹æµè§ˆå™¨æ”¯æŒ
   â”œâ”€ æ”¯æŒ Import Map
   â”‚     â†“
   â”‚  ä½¿ç”¨åŸç”ŸåŠŸèƒ½
   â”‚
   â””â”€ ä¸æ”¯æŒ
         â†“
      åŠ è½½ ES Module Shims
         â†“
      ä½¿ç”¨å«ç‰‡æä¾›çš„åŠŸèƒ½
```

---

## äºŒã€å¼•å…¥å«ç‰‡

### 2.1 ä»€ä¹ˆæ˜¯ ES Module Shims

**ES Module Shims** æ˜¯ä¸€ä¸ªé«˜æ€§èƒ½çš„ Import Map å«ç‰‡ã€‚

**æ ¸å¿ƒç‰¹æ€§**ï¼š

| ç‰¹æ€§ | è¯´æ˜ |
|------|------|
| **ç”Ÿäº§å¯ç”¨** | ç¨³å®šã€é«˜æ€§èƒ½ |
| **WebAssembly** | åŸºäº WASM çš„è¯æ³•åˆ†æ |
| **å®Œæ•´æ”¯æŒ** | å®Œæ•´å®ç° Import Map è§„èŒƒ |
| **è½»é‡çº§** | å‹ç¼©åçº¦ 10KB |
| **æ— ä¾µå…¥** | åªåœ¨éœ€è¦æ—¶åŠ è½½ |

**é¡¹ç›®åœ°å€**ï¼š[ES Module Shims](https://github.com/guybedford/es-module-shims)

### 2.2 æ ‡å‡†å¼•å…¥æ–¹å¼

#### åŸºç¡€ç‰ˆæœ¬ï¼ˆ2023-12-14 æ›´æ–°ï¼‰

**åœ¨ `<head>` æ ‡ç­¾ä¸­å¼•å…¥**ï¼š

```html
<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>My App</title>
  
  <!-- Import Map å«ç‰‡ -->
  <script>
  if (!HTMLScriptElement.supports || !HTMLScriptElement.supports("importmap")) {
    self.importShim = Object.assign(
      function importShimProxy() {
        const esModuleShimUrl =
          "https://esm.dancf.com/npm:es-module-shims@1.7.3/dist/es-module-shims.js";
        const promise = new Promise((resolve, reject) => {
          document.head.appendChild(
            Object.assign(document.createElement("script"), {
              src: esModuleShimUrl,
              crossorigin: "anonymous",
              async: true,
              onload() {
                if (!importShim.$proxy) {
                  resolve(importShim);
                } else {
                  reject(
                    new Error(
                      "No globalThis.importShim found:" + esModuleShimUrl
                    )
                  );
                }
              },
              onerror(error) {
                reject(error);
              },
            })
          );
        });
        return promise.then((importShim) => importShim(...arguments));
      },
      {
        $proxy: true,
      }
    );
  }
  </script>
  
  <!-- Import Map å®šä¹‰ -->
  <script type="importmap">
  {
    "imports": {
      "vue": "https://esm.dancf.com/npm:vue@2.7.13/dist/vue.runtime.esm.js",
      "react": "https://esm.dancf.com/npm:react@17.0.2/index.js"
    }
  }
  </script>
</head>
<body>
  <!-- é¡µé¢å†…å®¹ -->
</body>
</html>
```

#### ä»£ç è§£æ

**å…³é”®æ­¥éª¤**ï¼š

**æ­¥éª¤ 1ï¼šæ£€æµ‹æµè§ˆå™¨æ”¯æŒ**

```javascript
if (!HTMLScriptElement.supports || !HTMLScriptElement.supports("importmap")) {
  // ä¸æ”¯æŒ Import Mapï¼Œéœ€è¦åŠ è½½å«ç‰‡
}
```

**æ­¥éª¤ 2ï¼šåˆ›å»ºä»£ç†å‡½æ•°**

```javascript
self.importShim = Object.assign(
  function importShimProxy() {
    // ä»£ç†å‡½æ•°ï¼šå»¶è¿ŸåŠ è½½çœŸæ­£çš„ importShim
  },
  {
    $proxy: true,  // æ ‡è®°è¿™æ˜¯ä»£ç†
  }
);
```

**ä½œç”¨**ï¼š
- âœ… ç«‹å³å®šä¹‰ `importShim`ï¼Œé¿å…æŠ¥é”™
- âœ… å»¶è¿ŸåŠ è½½å«ç‰‡è„šæœ¬
- âœ… é¦–æ¬¡è°ƒç”¨æ—¶æ‰ä¸‹è½½

**æ­¥éª¤ 3ï¼šåŠ¨æ€åŠ è½½å«ç‰‡**

```javascript
const esModuleShimUrl =
  "https://esm.dancf.com/npm:es-module-shims@1.7.3/dist/es-module-shims.js";

const promise = new Promise((resolve, reject) => {
  document.head.appendChild(
    Object.assign(document.createElement("script"), {
      src: esModuleShimUrl,
      crossorigin: "anonymous",
      async: true,
      onload() {
        if (!importShim.$proxy) {
          resolve(importShim);  // å«ç‰‡åŠ è½½æˆåŠŸ
        } else {
          reject(new Error("No globalThis.importShim found"));
        }
      },
      onerror(error) {
        reject(error);  // åŠ è½½å¤±è´¥
      },
    })
  );
});
```

**æ­¥éª¤ 4ï¼šè¿”å› Promise**

```javascript
return promise.then((importShim) => importShim(...arguments));
```

**å·¥ä½œæµç¨‹**ï¼š

```
è°ƒç”¨ importShim('vue')
   â†“
æ£€æŸ¥æ˜¯å¦ä¸ºä»£ç† ($proxy === true)
   â”œâ”€ æ˜¯ â†’ åŠ¨æ€åŠ è½½å«ç‰‡
   â”‚        â†“
   â”‚     ç­‰å¾…åŠ è½½å®Œæˆ
   â”‚        â†“
   â”‚     è°ƒç”¨çœŸæ­£çš„ importShim
   â”‚
   â””â”€ å¦ â†’ ç›´æ¥è°ƒç”¨çœŸæ­£çš„ importShim
```

### 2.3 ç‰ˆæœ¬æ›´æ–°è¯´æ˜

**2023-12-14 æ›´æ–°**ï¼š
- âœ… è§£å†³ç‰¹å®šæµè§ˆå™¨ç‰ˆæœ¬å…¼å®¹æ€§é—®é¢˜
- âœ… ä½¿ç”¨ä»£ç†æ¨¡å¼ï¼Œä¼˜åŒ–åŠ è½½æ€§èƒ½
- âœ… æ›´å¥½çš„é”™è¯¯å¤„ç†

**ç‰ˆæœ¬é€‰æ‹©**ï¼š

| ç‰ˆæœ¬ | è¯´æ˜ | æ¨è |
|------|------|------|
| **1.7.3** | æœ€æ–°ç¨³å®šç‰ˆï¼ˆæ–‡æ¡£ä¸­ä½¿ç”¨ï¼‰ | âœ… æ¨è |
| **1.6.2** | æ—§ç‰ˆæœ¬ | âš ï¸ å¯ç”¨ä½†å»ºè®®å‡çº§ |
| **latest** | æœ€æ–°ç‰ˆ | âš ï¸ ç”Ÿäº§ç¯å¢ƒä¸æ¨è |

**CDN åœ°å€**ï¼š

```javascript
// æ¨èï¼šç¨¿å®š CDNï¼ˆå›½å†…å¿«ï¼‰
"https://esm.dancf.com/npm:es-module-shims@1.7.3/dist/es-module-shims.js"

// å¤‡é€‰ï¼šJSPM CDNï¼ˆå›½å¤–ï¼‰
"https://ga.jspm.io/npm:es-module-shims@1.7.3/dist/es-module-shims.js"

// å¤‡é€‰ï¼šjsDelivr CDN
"https://cdn.jsdelivr.net/npm/es-module-shims@1.7.3/dist/es-module-shims.js"
```

---

## ä¸‰ã€åŠ è½½å…¥å£æ–‡ä»¶

### 3.1 åŸºç¡€åŠ è½½æ–¹å¼

#### æ–¹å¼ 1ï¼šå…¼å®¹åŸç”Ÿä¸å«ç‰‡

**åœ¨ `<body>` åº•éƒ¨åŠ è½½**ï¼š

```html
<body>
  <div id="app"></div>
  
  <script>
  const scripts = [
    "@web-widget/web-widget",
    "https://cdn.com/index.js",
  ];

  const loading = typeof importShim === "function" ?
    scripts.map(moduleName => importShim(moduleName))
    : scripts.map(moduleName => import(moduleName));

  Promise.all(loading).then(() => {
    console.log('All modules loaded!');
  });
  </script>
</body>
```

**å·¥ä½œåŸç†**ï¼š

```
æ£€æŸ¥ importShim æ˜¯å¦å­˜åœ¨
   â”œâ”€ å­˜åœ¨ï¼ˆä½¿ç”¨å«ç‰‡ï¼‰
   â”‚     â†“
   â”‚  ä½¿ç”¨ importShim() åŠ è½½
   â”‚
   â””â”€ ä¸å­˜åœ¨ï¼ˆåŸç”Ÿæ”¯æŒï¼‰
         â†“
      ä½¿ç”¨ import() åŠ è½½
```

**åŠ è½½æµç¨‹**ï¼š

| æµè§ˆå™¨ç±»å‹ | ä½¿ç”¨çš„åŠ è½½æ–¹å¼ | è¯´æ˜ |
|-----------|--------------|------|
| **ç°ä»£æµè§ˆå™¨ï¼ˆChrome 89+ï¼‰** | `import()` | åŸç”Ÿ Import Map |
| **æ—§ç‰ˆæµè§ˆå™¨** | `importShim()` | ES Module Shims |

#### æ–¹å¼ 2ï¼šåŒæ—¶å…¼å®¹ Vite å¼€å‘ç¯å¢ƒ

**é€‚ç”¨åœºæ™¯**ï¼š
- âœ… å¼€å‘ç¯å¢ƒä½¿ç”¨ Vite
- âœ… ç”Ÿäº§ç¯å¢ƒä½¿ç”¨ Import Map

**å®ç°æ–¹å¼**ï¼š

```html
<body>
  <div id="app"></div>
  
  <script>
  const scripts = [
    () => import("@web-widget/web-widget"),
    () => import("https://cdn.com/index.js")
  ];

  const loading = typeof importShim === "function" ?
    scripts.map(loader => importShim(String(loader).match(/\bimport\("([^"]*?)"\)/)[1]))
    : scripts.map(loader => loader());

  Promise.all(loading).then(() => {
    console.log('All modules loaded!');
  });
  </script>
</body>
```

**å…³é”®æŠ€æœ¯**ï¼š

**æ­¥éª¤ 1ï¼šå®šä¹‰åŠ è½½å™¨å‡½æ•°**

```javascript
const scripts = [
  () => import("@web-widget/web-widget"),  // å‡½æ•°å½¢å¼
  () => import("https://cdn.com/index.js")
];
```

**æ­¥éª¤ 2ï¼šæå–æ¨¡å—å**

```javascript
// ä»å‡½æ•°å­—ç¬¦ä¸²ä¸­æå–æ¨¡å—å
String(loader)  // 'function() { return import("@web-widget/web-widget"); }'
  .match(/\bimport\("([^"]*?)"\)/)[1]  // æå– "@web-widget/web-widget"
```

**æ­¥éª¤ 3ï¼šåŠ¨æ€é€‰æ‹©åŠ è½½æ–¹å¼**

```javascript
typeof importShim === "function" ?
  // ä½¿ç”¨å«ç‰‡ï¼šæå–æ¨¡å—åå¹¶è°ƒç”¨ importShim
  scripts.map(loader => importShim(String(loader).match(/\bimport\("([^"]*?)"\)/)[1]))
  :
  // åŸç”Ÿæ”¯æŒï¼šç›´æ¥è°ƒç”¨å‡½æ•°
  scripts.map(loader => loader())
```

**å·¥ä½œå¯¹æ¯”**ï¼š

| ç¯å¢ƒ | æ‰§è¡Œæ–¹å¼ | ç»“æœ |
|------|---------|------|
| **Vite å¼€å‘** | ç›´æ¥è°ƒç”¨ `loader()` | `import("@web-widget/web-widget")` |
| **ç”Ÿäº§ï¼ˆåŸç”Ÿï¼‰** | ç›´æ¥è°ƒç”¨ `loader()` | `import("@web-widget/web-widget")` |
| **ç”Ÿäº§ï¼ˆå«ç‰‡ï¼‰** | æå–æ¨¡å—ååè°ƒç”¨ `importShim()` | `importShim("@web-widget/web-widget")` |

**ä¼˜åŠ¿**ï¼š
- âœ… Vite å¼€å‘ç¯å¢ƒæ­£å¸¸å·¥ä½œ
- âœ… ç”Ÿäº§ç¯å¢ƒåŸç”Ÿæ”¯æŒ
- âœ… ç”Ÿäº§ç¯å¢ƒå«ç‰‡æ”¯æŒ
- âœ… ä¸€å¥—ä»£ç ï¼Œä¸‰ç§ç¯å¢ƒ

### 3.2 é”™è¯¯å¤„ç†

**å®Œæ•´çš„é”™è¯¯å¤„ç†ç¤ºä¾‹**ï¼š

```html
<script>
const scripts = [
  "@web-widget/web-widget",
  "https://cdn.com/index.js",
];

const loading = typeof importShim === "function" ?
  scripts.map(moduleName => importShim(moduleName))
  : scripts.map(moduleName => import(moduleName));

Promise.all(loading)
  .then(() => {
    console.log('âœ… All modules loaded successfully!');
    // åˆå§‹åŒ–åº”ç”¨
    window.app.init();
  })
  .catch((error) => {
    console.error('âŒ Failed to load modules:', error);
    
    // æ˜¾ç¤ºç”¨æˆ·å‹å¥½çš„é”™è¯¯æç¤º
    document.body.innerHTML = `
      <div style="padding: 20px; text-align: center;">
        <h2>åŠ è½½å¤±è´¥</h2>
        <p>æŠ±æ­‰ï¼Œåº”ç”¨åŠ è½½å¤±è´¥ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•ã€‚</p>
        <button onclick="location.reload()">åˆ·æ–°é¡µé¢</button>
      </div>
    `;
  });
</script>
```

### 3.3 åŠ è½½ä¼˜åŒ–

#### ä¼˜åŒ– 1ï¼šé¢„åŠ è½½å…³é”®èµ„æº

```html
<head>
  <!-- é¢„åŠ è½½å«ç‰‡è„šæœ¬ -->
  <link rel="preload" 
        href="https://esm.dancf.com/npm:es-module-shims@1.7.3/dist/es-module-shims.js" 
        as="script" 
        crossorigin="anonymous">
  
  <!-- é¢„åŠ è½½å…³é”®æ¨¡å— -->
  <link rel="modulepreload" 
        href="https://cdn.com/index.js">
</head>
```

**æ”¶ç›Š**ï¼š
- âœ… æå‰ä¸‹è½½èµ„æº
- âœ… å‡å°‘åŠ è½½ç­‰å¾…æ—¶é—´
- âœ… æå‡é¦–å±æ€§èƒ½

#### ä¼˜åŒ– 2ï¼šæŒ‰éœ€åŠ è½½

```javascript
// ä¸æ˜¯æ‰€æœ‰æ¨¡å—éƒ½éœ€è¦åœ¨é¦–å±åŠ è½½
const criticalScripts = [
  "@web-widget/web-widget",
];

const nonCriticalScripts = [
  "@web-widget/analytics",
  "@web-widget/logger",
];

// å…ˆåŠ è½½å…³é”®æ¨¡å—
Promise.all(
  criticalScripts.map(name => 
    typeof importShim === "function" ? importShim(name) : import(name)
  )
).then(() => {
  console.log('Critical modules loaded');
  
  // å†åŠ è½½éå…³é”®æ¨¡å—
  nonCriticalScripts.forEach(name => {
    if (typeof importShim === "function") {
      importShim(name);
    } else {
      import(name);
    }
  });
});
```

---

## å››ã€å®Œæ•´ç¤ºä¾‹

### 4.1 åŸºç¡€ HTML æ¨¡æ¿

```html
<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Import Map åº”ç”¨ç¤ºä¾‹</title>
  
  <!-- 1. å¼•å…¥ Import Map å«ç‰‡ -->
  <script>
  if (!HTMLScriptElement.supports || !HTMLScriptElement.supports("importmap")) {
    self.importShim = Object.assign(
      function importShimProxy() {
        const esModuleShimUrl =
          "https://esm.dancf.com/npm:es-module-shims@1.7.3/dist/es-module-shims.js";
        const promise = new Promise((resolve, reject) => {
          document.head.appendChild(
            Object.assign(document.createElement("script"), {
              src: esModuleShimUrl,
              crossorigin: "anonymous",
              async: true,
              onload() {
                if (!importShim.$proxy) {
                  resolve(importShim);
                } else {
                  reject(
                    new Error(
                      "No globalThis.importShim found:" + esModuleShimUrl
                    )
                  );
                }
              },
              onerror(error) {
                reject(error);
              },
            })
          );
        });
        return promise.then((importShim) => importShim(...arguments));
      },
      {
        $proxy: true,
      }
    );
  }
  </script>
  
  <!-- 2. å®šä¹‰ Import Map -->
  <script type="importmap">
  {
    "imports": {
      "vue": "https://esm.dancf.com/npm:vue@2.7.13/dist/vue.runtime.esm.js",
      "react": "https://esm.dancf.com/npm:react@17.0.2/index.js",
      "react-dom": "https://esm.dancf.com/npm:react-dom@17.0.2/index.js"
    }
  }
  </script>
</head>
<body>
  <div id="app">Loading...</div>
  
  <!-- 3. åŠ è½½å…¥å£æ¨¡å— -->
  <script>
  const scripts = [
    "https://cdn.com/my-app.js",
  ];

  const loading = typeof importShim === "function" ?
    scripts.map(moduleName => importShim(moduleName))
    : scripts.map(moduleName => import(moduleName));

  Promise.all(loading)
    .then(() => {
      console.log('âœ… Application loaded successfully!');
    })
    .catch((error) => {
      console.error('âŒ Failed to load application:', error);
      document.getElementById('app').innerHTML = `
        <div style="padding: 20px; text-align: center; color: red;">
          <h2>åŠ è½½å¤±è´¥</h2>
          <p>${error.message}</p>
          <button onclick="location.reload()" 
                  style="padding: 10px 20px; cursor: pointer;">
            åˆ·æ–°é¡µé¢
          </button>
        </div>
      `;
    });
  </script>
</body>
</html>
```

### 4.2 Vite é¡¹ç›®é›†æˆ

**vite.config.js**ï¼š

```javascript
import { defineConfig } from 'vite';

export default defineConfig({
  build: {
    rollupOptions: {
      // å¤–éƒ¨åŒ– Import Map ä¸­çš„åŒ…
      external: ['vue', 'react', 'react-dom'],
    },
  },
  
  plugins: [
    {
      name: 'inject-importmap',
      transformIndexHtml(html) {
        // åªåœ¨ç”Ÿäº§ç¯å¢ƒæ³¨å…¥
        if (process.env.NODE_ENV !== 'production') {
          return html;
        }
        
        // è¯»å– importmap.json
        const importMap = JSON.parse(
          fs.readFileSync('./public/importmap.json', 'utf-8')
        );
        
        // æ³¨å…¥å«ç‰‡å’Œ Import Map
        const importMapScript = `
          <script>
          if (!HTMLScriptElement.supports || !HTMLScriptElement.supports("importmap")) {
            self.importShim = Object.assign(
              function importShimProxy() {
                const esModuleShimUrl =
                  "https://esm.dancf.com/npm:es-module-shims@1.7.3/dist/es-module-shims.js";
                const promise = new Promise((resolve, reject) => {
                  document.head.appendChild(
                    Object.assign(document.createElement("script"), {
                      src: esModuleShimUrl,
                      crossorigin: "anonymous",
                      async: true,
                      onload() {
                        if (!importShim.$proxy) {
                          resolve(importShim);
                        } else {
                          reject(
                            new Error(
                              "No globalThis.importShim found:" + esModuleShimUrl
                            )
                          );
                        }
                      },
                      onerror(error) {
                        reject(error);
                      },
                    })
                  );
                });
                return promise.then((importShim) => importShim(...arguments));
              },
              {
                $proxy: true,
              }
            );
          }
          </script>
          
          <script type="importmap">
            ${JSON.stringify(importMap, null, 2)}
          </script>
        `;
        
        return html.replace('</head>', `${importMapScript}</head>`);
      }
    }
  ]
});
```

---

## äº”ã€æµ‹è¯•ä¸éªŒè¯

### 5.1 å…¼å®¹æ€§æµ‹è¯•

**æµ‹è¯•çŸ©é˜µ**ï¼š

| æµè§ˆå™¨ | ç‰ˆæœ¬ | åŸç”Ÿæ”¯æŒ | æµ‹è¯•ç»“æœ |
|--------|------|---------|---------|
| Chrome | 89+ | âœ… | âœ… é€šè¿‡ |
| Chrome | 88- | âŒ | âœ… é€šè¿‡ï¼ˆå«ç‰‡ï¼‰ |
| Safari | 16.4+ | âœ… | âœ… é€šè¿‡ |
| Safari | 16.3- | âŒ | âœ… é€šè¿‡ï¼ˆå«ç‰‡ï¼‰ |
| Firefox | 108+ | âœ… | âœ… é€šè¿‡ |
| Firefox | 107- | âŒ | âœ… é€šè¿‡ï¼ˆå«ç‰‡ï¼‰ |
| Edge | 89+ | âœ… | âœ… é€šè¿‡ |

### 5.2 åŠŸèƒ½æµ‹è¯•

**æµ‹è¯•æ¸…å•**ï¼š

- [ ] åŸç”Ÿæ”¯æŒçš„æµè§ˆå™¨èƒ½æ­£å¸¸åŠ è½½
- [ ] ä¸æ”¯æŒçš„æµè§ˆå™¨èƒ½é€šè¿‡å«ç‰‡åŠ è½½
- [ ] è£¸æ¨¡å—å¯¼å…¥èƒ½æ­£ç¡®è§£æ
- [ ] é”™è¯¯å¤„ç†èƒ½æ­£å¸¸å·¥ä½œ
- [ ] æ€§èƒ½æŒ‡æ ‡ç¬¦åˆé¢„æœŸ

**æµ‹è¯•ä»£ç **ï¼š

```javascript
// åœ¨æ§åˆ¶å°è¿è¡Œ
console.log('æµè§ˆå™¨æ”¯æŒ Import Map:', 
  HTMLScriptElement.supports && HTMLScriptElement.supports('importmap'));

console.log('ä½¿ç”¨å«ç‰‡:', typeof importShim === 'function');

// æµ‹è¯•åŠ è½½
const testLoad = typeof importShim === 'function' ? 
  importShim('vue') : 
  import('vue');

testLoad
  .then(module => console.log('âœ… åŠ è½½æˆåŠŸ:', module))
  .catch(error => console.error('âŒ åŠ è½½å¤±è´¥:', error));
```

---

## å…­ã€æœ€ä½³å®è·µ

### 6.1 è„šæœ¬æ”¾ç½®ä½ç½®

**æ¨èç»“æ„**ï¼š

```html
<!DOCTYPE html>
<html>
<head>
  <!-- 1. åŸºç¡€ meta æ ‡ç­¾ -->
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <!-- 2. Import Map å«ç‰‡ï¼ˆå°½æ—©åŠ è½½ï¼‰ -->
  <script>/* å«ç‰‡ä»£ç  */</script>
  
  <!-- 3. Import Map å®šä¹‰ -->
  <script type="importmap">/* Import Map */</script>
  
  <!-- 4. å…¶ä»– head å†…å®¹ -->
  <title>...</title>
  <link rel="stylesheet" href="...">
</head>
<body>
  <!-- 5. é¡µé¢å†…å®¹ -->
  
  <!-- 6. åŠ è½½å…¥å£æ¨¡å—ï¼ˆbody åº•éƒ¨ï¼‰ -->
  <script>/* åŠ è½½é€»è¾‘ */</script>
</body>
</html>
```

**åŸå› **ï¼š
- âœ… å«ç‰‡å°½æ—©åŠ è½½ï¼Œé¿å…é˜»å¡
- âœ… Import Map åœ¨ç¬¬ä¸€ä¸ª `<script type="module">` ä¹‹å‰
- âœ… å…¥å£åŠ è½½åœ¨ body åº•éƒ¨ï¼Œç¡®ä¿ DOM å‡†å¤‡å°±ç»ª

### 6.2 ç‰ˆæœ¬ç®¡ç†

**å›ºå®šç‰ˆæœ¬**ï¼š

```javascript
// âœ… æ¨èï¼šå›ºå®šç‰ˆæœ¬
"https://esm.dancf.com/npm:es-module-shims@1.7.3/dist/es-module-shims.js"

// âŒ ä¸æ¨èï¼šæµ®åŠ¨ç‰ˆæœ¬
"https://esm.dancf.com/npm:es-module-shims@1/dist/es-module-shims.js"
"https://esm.dancf.com/npm:es-module-shims/dist/es-module-shims.js"
```

**åŸå› **ï¼š
- âœ… å›ºå®šç‰ˆæœ¬å¯é¢„æµ‹
- âœ… é¿å…breaking changes
- âœ… æ›´å¥½çš„ç¼“å­˜

### 6.3 CDN é™çº§

**ä½¿ç”¨å¤šä¸ª CDN**ï¼š

```javascript
async function loadShim() {
  const cdns = [
    "https://esm.dancf.com/npm:es-module-shims@1.7.3/dist/es-module-shims.js",
    "https://ga.jspm.io/npm:es-module-shims@1.7.3/dist/es-module-shims.js",
    "https://cdn.jsdelivr.net/npm/es-module-shims@1.7.3/dist/es-module-shims.js"
  ];
  
  for (const url of cdns) {
    try {
      await loadScript(url);
      return;
    } catch (error) {
      console.warn('Failed to load from', url);
    }
  }
  
  throw new Error('All CDNs failed');
}

function loadScript(url) {
  return new Promise((resolve, reject) => {
    const script = document.createElement('script');
    script.src = url;
    script.crossOrigin = 'anonymous';
    script.onload = resolve;
    script.onerror = reject;
    document.head.appendChild(script);
  });
}
```

---

## ä¸ƒã€å¸¸è§é—®é¢˜

### 7.1 å«ç‰‡æœªåŠ è½½

**ç°è±¡**ï¼š

```
Uncaught ReferenceError: importShim is not defined
```

**åŸå› **ï¼š
- âŒ å«ç‰‡è„šæœ¬åŠ è½½å¤±è´¥
- âŒ CDN ä¸å¯ç”¨

**è§£å†³æ–¹æ¡ˆ**ï¼š
- âœ… ä½¿ç”¨å¤šä¸ª CDN é™çº§
- âœ… æ·»åŠ é”™è¯¯å¤„ç†
- âœ… æä¾›æœ¬åœ°å¤‡ä»½

### 7.2 Import Map æœªç”Ÿæ•ˆ

**ç°è±¡**ï¼š

```
Uncaught TypeError: Failed to resolve module specifier "vue"
```

**åŸå› **ï¼š
- âŒ Import Map åœ¨æ¨¡å—è„šæœ¬ä¹‹å
- âŒ Import Map æ ¼å¼é”™è¯¯
- âŒ æµè§ˆå™¨ä¸æ”¯æŒä¸”å«ç‰‡æœªåŠ è½½

**è§£å†³æ–¹æ¡ˆ**ï¼š
- âœ… ç¡®ä¿ Import Map åœ¨ç¬¬ä¸€ä¸ª `<script type="module">` ä¹‹å‰
- âœ… éªŒè¯ JSON æ ¼å¼
- âœ… æ£€æŸ¥å«ç‰‡åŠ è½½çŠ¶æ€

### 7.3 æ€§èƒ½é—®é¢˜

**ç°è±¡**ï¼šåŠ è½½é€Ÿåº¦æ…¢

**åŸå› **ï¼š
- âŒ å«ç‰‡åŠ è½½è€—æ—¶
- âŒ CDN å“åº”æ…¢
- âŒ æ¨¡å—è¿‡å¤š

**è§£å†³æ–¹æ¡ˆ**ï¼š
- âœ… ä½¿ç”¨å›½å†… CDN
- âœ… é¢„åŠ è½½å…³é”®èµ„æº
- âœ… æŒ‰éœ€åŠ è½½éå…³é”®æ¨¡å—

---

## å…«ã€æ€»ç»“

### 8.1 æ ¸å¿ƒè¦ç‚¹

**å…¼å®¹æ€§å¤„ç†çš„å…³é”®**ï¼š

| è¦ç‚¹ | è¯´æ˜ | é‡è¦æ€§ |
|------|------|--------|
| **æ£€æµ‹æ”¯æŒ** | æ£€æµ‹æµè§ˆå™¨æ˜¯å¦æ”¯æŒ Import Map | ğŸ”´ å¿…é¡» |
| **å¼•å…¥å«ç‰‡** | ä¸æ”¯æŒæ—¶åŠ è½½ ES Module Shims | ğŸ”´ å¿…é¡» |
| **ç»Ÿä¸€åŠ è½½** | ç»Ÿä¸€çš„æ¨¡å—åŠ è½½é€»è¾‘ | ğŸ”´ å¿…é¡» |
| **é”™è¯¯å¤„ç†** | å®Œå–„çš„é”™è¯¯å¤„ç†æœºåˆ¶ | ğŸŸ¡ æ¨è |
| **CDN é™çº§** | å¤šä¸ª CDN å®¹ç¾ | ğŸŸ¡ æ¨è |

### 8.2 å®æ–½æ¸…å•

**éƒ¨ç½²å‰æ£€æŸ¥**ï¼š

- [ ] âœ… å·²å¼•å…¥ ES Module Shims å«ç‰‡
- [ ] âœ… Import Map åœ¨æ­£ç¡®ä½ç½®
- [ ] âœ… åŠ è½½é€»è¾‘å…¼å®¹åŸç”Ÿå’Œå«ç‰‡
- [ ] âœ… æ·»åŠ é”™è¯¯å¤„ç†
- [ ] âœ… å·²åœ¨ç›®æ ‡æµè§ˆå™¨æµ‹è¯•
- [ ] âœ… æ€§èƒ½æŒ‡æ ‡ç¬¦åˆé¢„æœŸ

### 8.3 å‚è€ƒèµ„æº

**å·¥å…·å’Œåº“**ï¼š
- [ES Module Shims](https://github.com/guybedford/es-module-shims)
- [Import Maps Spec](https://github.com/WICG/import-maps)

**ç›¸å…³æ–‡æ¡£**ï¼š
- [Import Map ä¸ ESM CDN ä»‹ç»](01-åŸºç¡€æ¦‚å¿µ-importmapä¸ESM-CDNä»‹ç».md)
- [RFC 15: WPM2](02-å·¥å…·æ¼”è¿›-RFC15-WPM2.md)
- [RFC 20: WPM3](03-å·¥å…·æ¼”è¿›-RFC20-WPM3.md)

---

**æ–‡æ¡£ç»´æŠ¤**ï¼šå‰ç«¯åŸºå»ºå›¢é˜Ÿ  
**æ•´ç†æ—¥æœŸ**ï¼š2025-01-24  
**æ–‡æ¡£ç‰ˆæœ¬**ï¼šv1.0
